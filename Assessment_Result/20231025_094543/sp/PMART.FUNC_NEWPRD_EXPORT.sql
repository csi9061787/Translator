REPLACE PROCEDURE PMART.FUNC_NEWPRD_EXPORT
(
   IN P_TIMEID VARCHAR(10),  
   IN P_ORGTYPE VARCHAR(20),  
   IN P_ORGID VARCHAR(20)      
)
SP:BEGIN
   DECLARE SQLSTR  VARCHAR(20000);
   DECLARE ORG_REMDFACT VARCHAR(2000);
   DECLARE ORG_BASICMFACT VARCHAR(2000);   
   DECLARE TIMEID VARCHAR(2000);   
   SET TIMEID = TRIM(P_TIMEID);
   IF TRIM(P_ORGTYPE) ='-1' THEN
      SET ORG_REMDFACT = ' ';
      SET ORG_BASICMFACT =' AND M.ORG_ID =-1 ';
   ELSEIF TRIM(P_ORGTYPE)='0' THEN
      SET ORG_REMDFACT = 'AND O.PDEPT_ID = '+ TRIM(P_ORGID) +' ';
      SET ORG_BASICMFACT =' AND M.ORG_ID ='+ TRIM(P_ORGID) +' ';
   ELSEIF TRIM(P_ORGTYPE)='1' THEN
      SET ORG_REMDFACT = 'AND O.DEPT_ID = '+ TRIM(P_ORGID) +' ';
      SET ORG_BASICMFACT =' AND M.ORG_ID ='+ TRIM(P_ORGID) +' ';
   ELSEIF TRIM(P_ORGTYPE)='2' THEN
      SET ORG_REMDFACT = 'AND O.BRANCH_ID = '+ TRIM(P_ORGID) +' ';
      SET ORG_BASICMFACT =' AND M.ORG_ID ='+ TRIM(P_ORGID) +' ';
   ELSEIF TRIM(P_ORGTYPE)='3' THEN
      SET ORG_REMDFACT = 'AND O.RESPON_ID = '+ TRIM(P_ORGID) +' ';
      SET ORG_BASICMFACT =' AND O.RESPON_ID = '+ TRIM(P_ORGID) +' ';
   ELSEIF TRIM(P_ORGTYPE)='4' THEN
      SET ORG_REMDFACT = 'AND O.OSTORE_ID = '+ TRIM(P_ORGID) +' ';
      SET ORG_BASICMFACT =' AND O.OSTORE_ID = '+ TRIM(P_ORGID) +' ';
   END IF;	
   CALL PMART.P_DROP_TABLE ('#VT_NEWPRD_EXPORT');
   SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_NEWPRD_EXPORT ( '
						 + ' L_DAY_NAME VARCHAR(10) , '
						 + ' PRD_ID VARCHAR(7) , '
						 + ' PRD_NM VARCHAR(50) , '
						 + ' PSD_TYPE VARCHAR(50) , '
						 + ' PSD_D01 DECIMAL(10,1), '
						 + ' PSD_D02 DECIMAL(10,1), '
						 + ' PSD_D03 DECIMAL(10,1), '
						 + ' PSD_D04 DECIMAL(10,1), '
						 + ' PSD_D05 DECIMAL(10,1), '
						 + ' PSD_D06 DECIMAL(10,1), '
						 + ' PSD_D07 DECIMAL(10,1), '
						 + ' PSD_D08 DECIMAL(10,1), '
						 + ' PSD_D09 DECIMAL(10,1), '
						 + ' PSD_D10 DECIMAL(10,1), '
						 + ' PSD_D11 DECIMAL(10,1), '
						 + ' PSD_D12 DECIMAL(10,1), '
						 + ' PSD_D13 DECIMAL(10,1), '
						 + ' PSD_D14 DECIMAL(10,1), '
						 + ' AVG_PSD DECIMAL(10,1) ' 
						 +')  PRIMARY  CHARINDEX(PRD_ID,L_DAY_NAME) ON COMMIT PRESERVE ROWS; ';
   EXECUTE IMMEDIATE SQLSTR;  
   SET SQLSTR = 'INSERT INTO #VT_NEWPRD_EXPORT '
						 + ' WITH ';
   SET SQLSTR = SQLSTR
					   + ' T_DAY AS ( '
					   + ' SELECT L_DAY_ID, '
					   + '        CAST(L_DAY_ID - 19000000 AS DATE FORMAT ''YYYYMMDD'') L_DAY_NO '
					   + '   FROM PMART.YMWD_TIME '
					   + '  WHERE L_DAY_ID BETWEEN CAST(CAST('''+ TIMEID +''' AS DATE) - INTERVAL ''13'' DAY AS INTEGER) + 19000000 AND CAST(CAST('''+ TIMEID +''' AS DATE) AS INTEGER) + 19000000  '
					   + '    AND L_DAY_OF_WEEK = 4 '
					   + ' ), ';
   SET SQLSTR = SQLSTR
					   + ' T_PRD AS ( '
					   + ' SELECT D.L_DAY_ID, D.L_DAY_NO, FM_CODE, FM_NAME '
					   + '   FROM T_DAY D '
					   + '   JOIN PDATA.PBMCMDT C '
					   + '     ON (CASE WHEN C.GROUP_CODE IN (''063'',''075'',''187'',''197'') THEN C.DT_ORIST + INTERVAL ''2'' DAY ELSE C.DT_ORIST + INTERVAL ''1'' DAY END ) '
					   + '   BETWEEN D.L_DAY_NO AND D.L_DAY_NO + INTERVAL ''6'' DAY '
					   + '  WHERE FMDP_CODE IN (''01'', ''03'') '
					   + '    AND FG_ORDALLOW = ''Y'' '
					   + '    AND TIME_CODE_FG = ''Y'' '
					   + '    AND LINK_SALE_OA IS NULL '
					   + '    AND KGRP_KIND_CODE NOT IN (''13'') '
					   + ' ), ';
   SET SQLSTR = SQLSTR
					   + ' T_ST AS ( '
					   + ' SELECT L_DAY_ID, SUM(UPLOAD_STNUM) STNUM '
					   + '   FROM PMART.REMD_FACT F '
					   + '   JOIN LAST_ORG_DIM O '
					   + '     ON F.OSTORE_ID = O.OSTORE_ID '
					   + '  WHERE F.L_DAY_ID BETWEEN CAST(CAST('''+ TIMEID +''' AS DATE) - INTERVAL ''13'' DAY AS INTEGER) + 19000000 AND CAST(CURRENT_DATE AS INTEGER) + 19000000  '
					   + ORG_REMDFACT
					   + '  GROUP BY L_DAY_ID '
					   + ' ), ';
   IF TRIM(P_ORGTYPE) IN ('3','4') THEN
		   SET SQLSTR = SQLSTR
							   + ' T_REMD AS ( '
							   + ' SELECT M.TIME_ID , '
							   + '        M.PRD_ID, '
							   + '        SUM(M.ORDER_CNT) ORDER_CNT, '
							   + '        SUM(M.INPRD_CNT) INPRD_CNT, '
							   + '        SUM(M.SALES_CNT)  SALES_CNT '
							   + '   FROM PMART.BASIC_MFACT_DETAIL M '
							   + '   JOIN PMART.LAST_ORG_DIM O '
							   + '     ON M.ORG_ID = O.OSTORE_ID '
							   + ORG_BASICMFACT
							   + '  WHERE M.TIME_ID BETWEEN CAST(CAST('''+ TIMEID +''' AS DATE) - INTERVAL ''13'' DAY AS INTEGER) + 19000000 AND CAST(CURRENT_DATE AS INTEGER) + 19000000  '
							   + '  GROUP BY M.PRD_ID, M.TIME_ID '
							   + ' ),  ';
   ELSE	
		   SET SQLSTR = SQLSTR
							   + ' T_REMD AS ( '
							   + ' SELECT M.TIME_ID , '
							   + '        M.PRD_ID, '
							   + '        M.ORDER_CNT ORDER_CNT, '
							   + '        M.INPRD_CNT INPRD_CNT, '
							   + '        M.SALES_CNT SALES_CNT '
							   + '   FROM PMART.BASIC_MFACT M '
							   + '  WHERE M.TIME_ID BETWEEN CAST(CAST('''+ TIMEID +''' AS DATE) - INTERVAL ''13'' DAY AS INTEGER) + 19000000 AND CAST(CURRENT_DATE AS INTEGER) + 19000000  '
							   + ORG_BASICMFACT
							   + ' ),  ';
   END IF;	
   SET SQLSTR = SQLSTR
					   + ' T_DATA AS ( '
					   + ' SELECT P.L_DAY_NO, '
					   + '        CAST(T.L_DAY_ID - 19000000 AS DATE FORMAT ''YYYYMMDD'') AS TIME_NO, '
					   + '        S.STNUM, '
					   + '        P.FM_CODE, '
					   + '        P.FM_NAME, '
					   + '        M.ORDER_CNT, '
					   + '        M.INPRD_CNT, '
					   + '        M.SALES_CNT '
					   + '   FROM T_DAY D '
					   + '   JOIN PMART.YMWD_TIME T '
					   + '     ON T.L_DAY_ID BETWEEN  CAST(D.L_DAY_NO - INTERVAL ''1'' DAY AS INTEGER) + 19000000 AND  CAST(D.L_DAY_NO + INTERVAL ''13'' DAY AS INTEGER) + 19000000 '
					   + '   JOIN T_PRD P '
					   + '     ON D.L_DAY_ID = P.L_DAY_ID '
					   + '   JOIN T_ST S '
					   + '     ON S.L_DAY_ID = T.L_DAY_ID '
					   + '   LEFT JOIN T_REMD M '
					   + '     ON P.FM_CODE = M.PRD_ID '
					   + '    AND M.TIME_ID = T.L_DAY_ID '
					   + ' )  ';
   SET SQLSTR = SQLSTR
					   + ' SELECT '
					   + '        TO_CHAR(L_DAY_NO,''YYYY/MM/DD'')L_DAY_NM, FM_CODE, FM_NAME ,''OD_PSD'' AS PSD_TYPE, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''00'' DAY -INTERVAL ''01'' DAY THEN ORDER_CNT*1.0/STNUM ELSE NULL END ) PSD_D01, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''01'' DAY -INTERVAL ''01'' DAY THEN ORDER_CNT*1.0/STNUM ELSE NULL END ) PSD_D02, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''02'' DAY -INTERVAL ''01'' DAY THEN ORDER_CNT*1.0/STNUM ELSE NULL END ) PSD_D03, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''03'' DAY -INTERVAL ''01'' DAY THEN ORDER_CNT*1.0/STNUM ELSE NULL END ) PSD_D04, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''04'' DAY -INTERVAL ''01'' DAY THEN ORDER_CNT*1.0/STNUM ELSE NULL END ) PSD_D05, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''05'' DAY -INTERVAL ''01'' DAY THEN ORDER_CNT*1.0/STNUM ELSE NULL END ) PSD_D06, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''06'' DAY -INTERVAL ''01'' DAY THEN ORDER_CNT*1.0/STNUM ELSE NULL END ) PSD_D07, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''07'' DAY -INTERVAL ''01'' DAY THEN ORDER_CNT*1.0/STNUM ELSE NULL END ) PSD_D08, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''08'' DAY -INTERVAL ''01'' DAY THEN ORDER_CNT*1.0/STNUM ELSE NULL END ) PSD_D09, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''09'' DAY -INTERVAL ''01'' DAY THEN ORDER_CNT*1.0/STNUM ELSE NULL END ) PSD_D10, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''10'' DAY -INTERVAL ''01'' DAY THEN ORDER_CNT*1.0/STNUM ELSE NULL END ) PSD_D11, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''11'' DAY -INTERVAL ''01'' DAY THEN ORDER_CNT*1.0/STNUM ELSE NULL END ) PSD_D12, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''12'' DAY -INTERVAL ''01'' DAY THEN ORDER_CNT*1.0/STNUM ELSE NULL END ) PSD_D13, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''13'' DAY -INTERVAL ''01'' DAY THEN ORDER_CNT*1.0/STNUM ELSE NULL END ) PSD_D14, '
					   + '        AVG(ORDER_CNT*1.0/STNUM) AS AVG_PSD '
					   + '   FROM T_DATA '
					   + '  WHERE TIME_NO BETWEEN L_DAY_NO - INTERVAL ''01'' DAY AND L_DAY_NO + INTERVAL ''12'' DAY '
					   + '  GROUP BY L_DAY_NO,FM_CODE,FM_NAME '
					   + '  UNION '
					   + ' SELECT '
					   + '        TO_CHAR(L_DAY_NO,''YYYY/MM/DD'')L_DAY_NM, FM_CODE, FM_NAME ,''IN_PSD'' AS PSD_TYPE, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''00'' DAY THEN INPRD_CNT*1.0/STNUM ELSE NULL END ) PSD_D01, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''01'' DAY THEN INPRD_CNT*1.0/STNUM ELSE NULL END ) PSD_D02, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''02'' DAY THEN INPRD_CNT*1.0/STNUM ELSE NULL END ) PSD_D03, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''03'' DAY THEN INPRD_CNT*1.0/STNUM ELSE NULL END ) PSD_D04, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''04'' DAY THEN INPRD_CNT*1.0/STNUM ELSE NULL END ) PSD_D05, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''05'' DAY THEN INPRD_CNT*1.0/STNUM ELSE NULL END ) PSD_D06, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''06'' DAY THEN INPRD_CNT*1.0/STNUM ELSE NULL END ) PSD_D07, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''07'' DAY THEN INPRD_CNT*1.0/STNUM ELSE NULL END ) PSD_D08, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''08'' DAY THEN INPRD_CNT*1.0/STNUM ELSE NULL END ) PSD_D09, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''09'' DAY THEN INPRD_CNT*1.0/STNUM ELSE NULL END ) PSD_D10, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''10'' DAY THEN INPRD_CNT*1.0/STNUM ELSE NULL END ) PSD_D11, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''11'' DAY THEN INPRD_CNT*1.0/STNUM ELSE NULL END ) PSD_D12, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''12'' DAY THEN INPRD_CNT*1.0/STNUM ELSE NULL END ) PSD_D13, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''13'' DAY THEN INPRD_CNT*1.0/STNUM ELSE NULL END ) PSD_D14, '
					   + '        AVG(INPRD_CNT*1.0/STNUM) AS AVG_PSD '
					   + '   FROM T_DATA '
					   + '  WHERE TIME_NO BETWEEN L_DAY_NO + INTERVAL ''00'' DAY AND L_DAY_NO + INTERVAL ''13'' DAY '
					   + '  GROUP BY L_DAY_NO,FM_CODE,FM_NAME '
					   + '  UNION '
					   + ' SELECT '
					   + '        TO_CHAR(L_DAY_NO,''YYYY/MM/DD'')L_DAY_NM, FM_CODE, FM_NAME ,''SL_PSD'' AS PSD_TYPE, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''00'' DAY THEN SALES_CNT*1.0/STNUM ELSE NULL END ) PSD_D01, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''01'' DAY THEN SALES_CNT*1.0/STNUM ELSE NULL END ) PSD_D02, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''02'' DAY THEN SALES_CNT*1.0/STNUM ELSE NULL END ) PSD_D03, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''03'' DAY THEN SALES_CNT*1.0/STNUM ELSE NULL END ) PSD_D04, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''04'' DAY THEN SALES_CNT*1.0/STNUM ELSE NULL END ) PSD_D05, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''05'' DAY THEN SALES_CNT*1.0/STNUM ELSE NULL END ) PSD_D06, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''06'' DAY THEN SALES_CNT*1.0/STNUM ELSE NULL END ) PSD_D07, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''07'' DAY THEN SALES_CNT*1.0/STNUM ELSE NULL END ) PSD_D08, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''08'' DAY THEN SALES_CNT*1.0/STNUM ELSE NULL END ) PSD_D09, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''09'' DAY THEN SALES_CNT*1.0/STNUM ELSE NULL END ) PSD_D10, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''10'' DAY THEN SALES_CNT*1.0/STNUM ELSE NULL END ) PSD_D11, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''11'' DAY THEN SALES_CNT*1.0/STNUM ELSE NULL END ) PSD_D12, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''12'' DAY THEN SALES_CNT*1.0/STNUM ELSE NULL END ) PSD_D13, '
					   + '        SUM(CASE WHEN TIME_NO =L_DAY_NO+INTERVAL ''13'' DAY THEN SALES_CNT*1.0/STNUM ELSE NULL END ) PSD_D14, '
					   + '        AVG(SALES_CNT*1.0/STNUM) AS AVG_PSD '
					   + '   FROM T_DATA '
					   + '  WHERE TIME_NO BETWEEN L_DAY_NO + INTERVAL ''00'' DAY AND L_DAY_NO + INTERVAL ''13'' DAY '
					   + '  GROUP BY L_DAY_NO,FM_CODE,FM_NAME ';   
	DELETE PMART.T1 WHERE F1=1903;
	INSERT INTO PMART.T1(F1,F2) SELECT 1903,SQLSTR;		
   EXECUTE IMMEDIATE SQLSTR;  
END SP;