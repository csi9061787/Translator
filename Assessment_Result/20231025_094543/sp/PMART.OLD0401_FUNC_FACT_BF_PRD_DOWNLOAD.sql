REPLACE PROCEDURE PMART.OLD0401_FUNC_FACT_BF_PRD_DOWNLOAD
(
   IN P_ORGTYPE VARCHAR(10),				
   IN P_ORGID VARCHAR(2000),					   
   IN P_TIMETYPE VARCHAR(10),		
   IN P_TIMEID VARCHAR(2000),     
   IN P_SLNO VARCHAR(200),     
   IN P_SUBPRDID VARCHAR(2000),   
   IN P_DISTRICT VARCHAR(100) 
)
SP:BEGIN
   DECLARE SQLSTR  VARCHAR(6000);    
   DECLARE ORGWHERE  VARCHAR(2000);  
   DECLARE PRDWHERE VARCHAR(3000); 
   DECLARE TIMENAME  VARCHAR(100);  
   DECLARE TIMEWHERE  VARCHAR(2000);  
     DECLARE P_DISTRICT_IN VARCHAR(100);
	 SET P_DISTRICT_IN = Replace(TRIM(P_DISTRICT),',',''',''');
    IF P_SLNO = '' AND P_SUBPRDID = '' THEN
	 	SET PRDWHERE = ' AND T1.SLNO <> -1 AND T1.PRD_ID = -1';
	 ELSE
	 	SET PRDWHERE = ' AND T1.SLNO = ' + P_SLNO + ' AND T1.PRD_ID IN (' + P_SUBPRDID + ')';
	 END IF;
     IF P_DISTRICT = '' THEN
		SET ORGWHERE = '';
	 ELSE
	 	SET ORGWHERE = ' AND C.SHOP_DISTTRICT_MAIN IN ('''  + P_DISTRICT_IN + ''') ';
	 END IF;	 
   IF P_ORGTYPE = '0' THEN
		SET ORGWHERE = ORGWHERE + ' AND C.PDEPT_ID  = ' + P_ORGID;   
   ELSEIF P_ORGTYPE = '1' THEN
		SET ORGWHERE = ORGWHERE + ' AND C.DEPT_ID  = ' + P_ORGID;   
   ELSEIF P_ORGTYPE = '2' THEN
	    SET ORGWHERE = ORGWHERE + ' AND C.BRANCH_ID = ' + P_ORGID;
   ELSEIF P_ORGTYPE = '3' THEN
	    SET ORGWHERE = ORGWHERE + ' AND C.RESPON_ID = ' + P_ORGID;
   ELSEIF P_ORGTYPE = '4' THEN
	    SET ORGWHERE = ORGWHERE + ' AND C.OSTORE_ID = ' + P_ORGID;
   END IF;   
    IF P_TIMETYPE = 'Y' THEN
	    SET TIMENAME = 'T3.L_YEAR_NAME L_TIME_NM, ';
		SET TIMEWHERE = ' JOIN PMART.TIME_Y T3 ON T1.TIME_ID = T3.L_YEAR_ID AND T3.L_YEAR_ID IN ('+P_TIMEID+') ';
   ELSEIF P_TIMETYPE = 'M' THEN
        SET TIMENAME = 'T3.L_MONTH_NAME L_TIME_NM, ';
	    SET TIMEWHERE = ' JOIN PMART.TIME_M T3 ON T1.TIME_ID = T3.L_MONTH_ID AND T3.L_MONTH_ID IN  ('+P_TIMEID+') ';
   ELSE
		SET TIMENAME = 'T3.L_DAY_NAME L_TIME_NM, ';
	    SET TIMEWHERE = ' JOIN PMART.TIME_D T3 ON T1.TIME_ID = T3.L_DAY_ID AND T3.L_DAY_ID IN  ('+P_TIMEID+') ';
   END IF;
CALL PMART.P_DROP_TABLE ('#VT_FUNC_FACT_BF_PRD_DOWNLOAD');
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FACT_BF_PRD_DOWNLOAD AS('                          										   
						   + ' SELECT T1.ORG_ID, T1.TIME_ID,  '
						   + ' 	            T2.DEPT_NO, T2.BRANCH_NO, T2.STORE_NO, T2.STORE_NAME, ' + TIMENAME
						   + '					T1.SLNO, T4.PRD_NM AS PRD_ID, ' 		
						   + '                 T1.STORE_CNT,T1.SALE_CNT,T1.SALE_AMT,T1.DIS_SUB_AMT,T1.FINAL_SALE_AMT, T2.PDEPT_NO '
						   + ' 	   FROM PMART.FACT_BREAKFASTTICKET_PRD T1 '
						   + ' 	    JOIN ( '
						   + ' 	 		SELECT P.PDEPT_NO, A.DEPT_NO, B.BRANCH_NO, C.STORE_NO, C.STORE_NAME, C.OSTORE_ID '
						   + ' 			   FROM ORG_DEPT A '
						   + ' 			    JOIN ORG_BRANCH B ON A.DEPT_ID = B.DEPT_ID '
						   + ' 			    JOIN PMART.ORG_PDEPT P ON A.PDEPT_ID = P.PDEPT_ID '
						   + ' 				JOIN LAST_ORG_STORE C ON C.BRANCH_ID =  B.BRANCH_ID ' + ORGWHERE
						   + ' 	 ) T2 ON T1.ORG_ID = T2.OSTORE_ID '
						   +        TIMEWHERE								 	
						   + '       JOIN ( '
						   + '						SELECT PRD_ID PRD_ID, (FM_CODE'+ '+''_''+' + 'FM_NAME) PRD_NM '
						   + '						FROM PMART.PRD_PRD '
						   + ' 					UNION ALL '
						   + ' 					SELECT  GRP_ID PRD_ID, (GRP_NO+GRP_NAME) PRD_NM '
						   + ' 					FROM PMART.PRD_GRP '
						   + ' 					UNION ALL '
						   + ' 					SELECT  KND_ID PRD_ID, (KND_NO+KND_NAME) PRD_NM '
						   + ' 					FROM PMART.PRD_KND '
						   + ' 					UNION ALL '
						   + ' 					SELECT DISTINCT -1 (INTEGER) AS PRD_ID, ' + ' ''-1'' PRD_NM'
						   + ' 					FROM PMART.PRD_KND WHERE 1=1 '
						   + '        ) T4 ON T1.PRD_ID = T4.PRD_ID '
						   + '     WHERE T1.TIME_ID IN ('+P_TIMEID+') '					
						   + '           ' + PRDWHERE 								   
                           + ' ) WITH DATA PRIMARY INDEX(ORG_ID, TIME_ID, SLNO, PRD_ID) ON COMMIT PRESERVE ROWS;';
		EXECUTE IMMEDIATE SQLSTR;   
END SP;