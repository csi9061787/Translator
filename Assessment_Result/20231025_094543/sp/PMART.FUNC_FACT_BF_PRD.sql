REPLACE PROCEDURE PMART.FUNC_FACT_BF_PRD
(
   IN P_ORGTYPE VARCHAR(10),   
   IN P_GROUP VARCHAR(500),
   IN P_TIMEID VARCHAR(2000),
   IN P_ORGID VARCHAR(2000),
   IN P_SLNO VARCHAR(200),     
   IN P_SUBPRDID VARCHAR(2000),   
   IN P_DISTRICT VARCHAR(100)
)
SP:BEGIN
     DECLARE SQLSTR  VARCHAR(6000);    
	 DECLARE SQLDATASTR  VARCHAR(2000);   
	 DECLARE SQLCNTSTR  VARCHAR(2000);   
	 DECLARE PRDWHERE VARCHAR(3000); 
	 DECLARE ORGSELECT VARCHAR(2000);
	 DECLARE ORGWHERE VARCHAR(2000);  
	 DECLARE P_GROUP_COL VARCHAR(20);
     DECLARE P_DISTRICT_IN VARCHAR(100);
	 SET P_DISTRICT_IN = Replace(TRIM(P_DISTRICT),',',''',''');
     IF P_SLNO = '' AND P_SUBPRDID = '' THEN
	 	SET PRDWHERE = ' AND T1.SLNO <> -1 AND T1.PRD_ID = -1';
	 ELSE
	 	SET PRDWHERE = ' AND T1.SLNO = ' + P_SLNO + ' AND T1.PRD_ID IN (' + P_SUBPRDID + ')';
	 END IF;
	 IF P_DISTRICT = '' THEN
	 	SET ORGWHERE = ' WHERE 1=1 ';		
	 ELSE
	 	SET ORGWHERE = ' WHERE SHOP_DISTTRICT_MAIN IN ('''  + P_DISTRICT_IN + ''') ';
	 END IF;	 
	IF P_ORGTYPE = '0' THEN
		SET ORGSELECT = 'DEPT_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND PDEPT_ID  = ' + P_ORGID;   
	ELSEIF P_ORGTYPE = '1' THEN
		SET ORGSELECT = 'BRANCH_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND DEPT_ID  = ' + P_ORGID;   
	ELSEIF P_ORGTYPE = '2' THEN
		SET ORGSELECT = 'RESPON_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND BRANCH_ID = ' + P_ORGID;
	ELSEIF P_ORGTYPE = '3' THEN
		SET ORGSELECT = 'OSTORE_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND RESPON_ID = ' + P_ORGID;
	ELSEIF P_ORGTYPE = '4' THEN
		SET ORGSELECT = 'OSTORE_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND OSTORE_ID = ' + P_ORGID;
	ELSE
		SET ORGSELECT = 'PDEPT_ID AS GROUP_ORG_ID, OSTORE_ID';
	END IF;   
CALL PMART.P_DROP_TABLE('#AVLBL_DATA');
SET SQLDATASTR =  ' CREATE VOLATILE TABLE #AVLBL_DATA AS ( '
							+ '    SELECT  *  '
							+ '    FROM PMART.FACT_BREAKFASTTICKET_PRD T1 '  
							+ '	JOIN ( '
							+ '			SELECT ' + ORGSELECT 
						 	+ '			    FROM PMART.LAST_ORG_STORE '
						 	+ '			' + ORGWHERE
						 	+ '		) T2 ON T1.ORG_ID = T2.OSTORE_ID '						 
						 	+ '		WHERE T1.TIME_ID IN ('+P_TIMEID+')'							
						 	+ '            ' + PRDWHERE 				
							+ ' ) WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS; ';
 EXECUTE IMMEDIATE SQLDATASTR;  
CALL PMART.P_DROP_TABLE('#AVLBL_STORE_CNT');
SET SQLCNTSTR = ' CREATE VOLATILE TABLE #AVLBL_STORE_CNT AS ( '
							+ '	SELECT  1 AS DATA_TYPE, NULL TIME_ID, NULL Y_DIM, COUNT(DISTINCT  ORG_ID) AS AVLBL_CNT '
							+ '    FROM #AVLBL_DATA '  						
							+ ' UNION ALL '
							+ '	SELECT  2 AS DATA_TYPE, TIME_ID TIME_ID, NULL Y_DIM, COUNT(DISTINCT  ORG_ID) AS AVLBL_CNT '
							+ '    FROM #AVLBL_DATA '  	
							+ '		 GROUP BY TIME_ID '
							+ ' UNION ALL '
							+ '	SELECT  3 AS DATA_TYPE, NULL TIME_ID, ' + Replace(TRIM(P_GROUP),'TIME_ID,','')  + '  Y_DIM, COUNT(DISTINCT  ORG_ID) AS AVLBL_CNT '							
							+ '    FROM #AVLBL_DATA '  	
							+ '		 GROUP BY ' + Replace(TRIM(P_GROUP),'TIME_ID,','')
							+ ' UNION ALL '
							+ '	SELECT  4 AS DATA_TYPE, TIME_ID, ' + Replace(TRIM(P_GROUP),'TIME_ID,','')  + ' Y_DIM, COUNT(DISTINCT  ORG_ID) AS AVLBL_CNT '
							+ '    FROM #AVLBL_DATA ' 					
							+ '		 GROUP BY ' + P_GROUP
							+ ' ) WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS; ';
EXECUTE IMMEDIATE SQLCNTSTR;   
CALL PMART.P_DROP_TABLE ('#VT_FACT_BREAKFASTTICKET_PRD_TEMP');
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FACT_BREAKFASTTICKET_PRD_TEMP AS('
						 + ' SELECT '
					     + CASE WHEN P_GROUP LIKE '%SLNO%' THEN Replace(P_GROUP,'SLNO','SLNO AS PRD_ID') ELSE P_GROUP END +','
						 + ' 				   SUM(T1.SALE_CNT) AS SALE_CNT, '
						 + '				   SUM(T1.SALE_AMT) AS SALE_AMT, '					
						 + '				   SUM(T1.DIS_SUB_AMT) AS DIS_SUB_AMT, '
						 + '				   SUM(T1.FINAL_SALE_AMT) AS FINAL_SALE_AMT '											
						 + '	    FROM PMART.FACT_BREAKFASTTICKET_PRD T1 '
						 + '		JOIN ( '
						 + '			SELECT ' + ORGSELECT 
						 + '			    FROM PMART.LAST_ORG_STORE '
						 + '			' + ORGWHERE
						 + '		) T2 ON T1.ORG_ID = T2.OSTORE_ID '			
						 + '		WHERE T1.TIME_ID IN ('+P_TIMEID+')'				 
						 + '           ' + PRDWHERE 				
						 + '		 GROUP BY ' + P_GROUP
						 + ' ) WITH DATA PRIMARY CHARINDEX('SLNO','+CASE WHEN P_GROUP LIKE '%SLNO%' THEN Replace(P_GROUP,'PRD_ID') ELSE P_GROUP END+') ON COMMIT PRESERVE ROWS;';
        EXECUTE IMMEDIATE SQLSTR;   
IF CHARINDEX( 'GROUP_ORG_ID',P_GROUP) > 0 THEN
	SET P_GROUP_COL = 'GROUP_ORG_ID';
ELSE
	SET P_GROUP_COL = 'PRD_ID';
END IF;
CALL PMART.P_DROP_TABLE ('#VT_FACT_BREAKFASTTICKET_PRD');
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FACT_BREAKFASTTICKET_PRD AS('											 
						 + '  SELECT T1.DATA_TYPE, T1.TIME_ID, T1.Y_DIM, T2.AVLBL_CNT STORE_CNT, '
						 + '                 T1.SALE_CNT, T1.SALE_AMT, '
						 + '  			    T1.DIS_SUB_AMT, T1.FINAL_SALE_AMT '
						 + '  	FROM ( '
						 + '  					SELECT 1 DATA_TYPE, NULL TIME_ID,NULL Y_DIM,  ' 
						 + '  					SUM(SALE_CNT) AS SALE_CNT, SUM(SALE_AMT) AS SALE_AMT,  '
						 + '  					SUM(DIS_SUB_AMT) AS DIS_SUB_AMT,  '
						 + '  					SUM(FINAL_SALE_AMT) AS FINAL_SALE_AMT '
						 + '  					FROM #VT_FACT_BREAKFASTTICKET_PRD_TEMP '
						 + '  					UNION ALL '
						 + '  					SELECT 2 DATA_TYPE, TIME_ID,NULL Y_DIM,  '
						 + '  					SUM(SALE_CNT) AS SALE_CNT, SUM(SALE_AMT) AS SALE_AMT,  '
						 + '  					SUM(DIS_SUB_AMT) AS DIS_SUB_AMT,  '
						 + '  					SUM(FINAL_SALE_AMT) AS FINAL_SALE_AMT '
						 + '  					FROM #VT_FACT_BREAKFASTTICKET_PRD_TEMP '
						 + '  					GROUP BY TIME_ID '
						 + '  					UNION ALL '
						 + '  					SELECT 3 DATA_TYPE, NULL TIME_ID,  ' + P_GROUP_COL + ' Y_DIM,  '			
						 + '  					SUM(SALE_CNT) AS SALE_CNT, SUM(SALE_AMT) AS SALE_AMT,  '
						 + '  					SUM(DIS_SUB_AMT) AS DIS_SUB_AMT,  '
						 + '  					SUM(FINAL_SALE_AMT) AS FINAL_SALE_AMT '
						 + '  					FROM #VT_FACT_BREAKFASTTICKET_PRD_TEMP '
						 + '  					GROUP BY  ' + P_GROUP_COL 
						 + '  					UNION ALL '
						 + '  					SELECT 4 DATA_TYPE,TIME_ID,  ' + P_GROUP_COL + ' Y_DIM, '
						 + '  					SALE_CNT,SALE_AMT,DIS_SUB_AMT,FINAL_SALE_AMT '
						 + '  					FROM #VT_FACT_BREAKFASTTICKET_PRD_TEMP '
						 + '  	) AS T1 '
						 + '  	LEFT JOIN #AVLBL_STORE_CNT T2 ON T1.DATA_TYPE = T2.DATA_TYPE '
						 + '  	        AND ISNULL(T1.TIME_ID) = ISNULL(T2.TIME_ID) '
						 + '  			AND ISNULL(T1.Y_DIM) = ISNULL(T2.Y_DIM) '
						 + ' ) WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS; ';
        EXECUTE IMMEDIATE SQLSTR;   
END SP;