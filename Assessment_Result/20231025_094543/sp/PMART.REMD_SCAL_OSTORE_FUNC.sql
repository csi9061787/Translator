REPLACE PROCEDURE PMART.REMD_SCAL_OSTORE_FUNC(P_DAY_ID NUMBER,P_RESPON_ID NUMBER)
SQL SECURITY INVOKER
SP:BEGIN 
DECLARE SQLSTR  VARCHAR(10000) DEFAULT ''; 
  CALL PMART.P_DROP_TABLE ('#VT_REMD_SCAL_OSTORE_FUNC'); 
  CALL PMART.REMD_ST_OSTORE_FUNC(P_DAY_ID,P_RESPON_ID); 
  SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_REMD_SCAL_OSTORE_FUNC  
   (
        TOT_ID INTEGER,ORG_ID NUMBER ,R1     NUMBER ,R2     NUMBER ,R3     NUMBER ,
        R4     NUMBER ,R5     NUMBER ,R6     NUMBER ,R7     NUMBER ,R8     NUMBER ,
        R9     NUMBER ,R10    NUMBER ,R11    NUMBER ,R12    NUMBER ,R13    NUMBER ,
        R14    VARCHAR(20) Collate Chinese_Taiwan_Stroke_CI_AS ,
        R14_NAME VARCHAR(20)  ,
        R15    VARCHAR(8) Collate Chinese_Taiwan_Stroke_CI_AS ,
        R16    NUMBER ,R17    NUMBER ,R18    NUMBER ,R19    NUMBER ,R20    NUMBER ,
        R21    NUMBER 
    )   
    ON COMMIT PRESERVE ROWS;';
  EXECUTE IMMEDIATE SQLSTR; 
      SET SQLSTR = 
            'INSERT INTO #VT_REMD_SCAL_OSTORE_FUNC ( TOT_ID,ORG_ID,R1,R2,R3,R4,R5,R6,R7,R8,R9,R10,R11,R12,R13,'+
            ' R14,R14_NAME,R15,R16,R17,R18,R19,R20,R21) '+
                'SELECT '+
                'T1.TOT_ID, '+
                'T1.ORG_ID, '+
                'MAST_STORE_NUM AS R1, '+
                'CASE WHEN DECODE(UPLOAD_STNUM,0,NULL,UPLOAD_STNUM)=0 THEN NULL ELSE AMT/DECODE(UPLOAD_STNUM,0,NULL,UPLOAD_STNUM) END AS R2, '+
                'CASE WHEN DECODE(UPLOAD_STNUM,0,NULL,UPLOAD_STNUM)=0 THEN NULL ELSE CUST_NUM/DECODE(UPLOAD_STNUM,0,NULL,UPLOAD_STNUM) END AS R3, '+
                'CASE WHEN DECODE(CUST_NUM,0,NULL,CUST_NUM) =0 THEN NULL ELSE AMT/DECODE(CUST_NUM,0,NULL,CUST_NUM) END AS R4, '+
                'CASE WHEN DECODE(T1.ACCU_PLAN_STNUM,0,NULL,T1.ACCU_PLAN_STNUM)=0 THEN NULL ELSE (T1.ACCU_AMT/DECODE(T1.ACCU_PLAN_STNUM,0,NULL,T1.ACCU_PLAN_STNUM)) END AS R5, '+
                'T1.ACCU_AMT*0.9561/ '+
                'DECODE(T1.ACCU_PLAN_STNUM*BUDGET_ST_AVG_AMT,0,NULL, '+
                'T1.ACCU_PLAN_STNUM*BUDGET_ST_AVG_AMT)*100 AS R6, '+
				'CASE WHEN (REMD_ADD_TKSL('+P_DAY_ID+',''Y'',CAST(EX_TOT_AMT_LAST_YEAR AS NUMBER),CAST(T1.EX_TOT_TKSL_LAST_YEAR AS NUMBER))/ DECODE(T1.EX_TOT_PLAN_STNUM_LAST_YEAR,0,NULL,EX_TOT_PLAN_STNUM_LAST_YEAR))=0 THEN NULL ELSE ' +
                '((REMD_ADD_TKSL('+P_DAY_ID+',''Y'',CAST(T1.EX_ACCU_AMT AS NUMBER),CAST(T1.EX_ACCU_TKSL AS NUMBER))+0)/DECODE(T1.EX_ACCU_PLAN_STNUM,0,NULL,T1.EX_ACCU_PLAN_STNUM))/ '+
                '   (REMD_ADD_TKSL('+P_DAY_ID+',''Y'',CAST(EX_TOT_AMT_LAST_YEAR AS NUMBER),CAST(T1.EX_TOT_TKSL_LAST_YEAR AS NUMBER))/ '+
                '   DECODE(T1.EX_TOT_PLAN_STNUM_LAST_YEAR,0,NULL,EX_TOT_PLAN_STNUM_LAST_YEAR))*100 END AS R7, '+
                '((REMD_ADD_TKSL('+P_DAY_ID+',''M'',CAST(T1.ACCU_AMT AS NUMBER),CAST(ACCU_TKSL AS NUMBER))+0)/DECODE(T1.ACCU_PLAN_STNUM,0,NULL,T1.ACCU_PLAN_STNUM))/ '+
                '   DECODE(REMD_ADD_TKSL('+P_DAY_ID+',''M'',CAST(T1.TOT_AMT_LAST_MONTH AS NUMBER),CAST(TOT_TKSL_LAST_MONTH AS NUMBER))/ '+
                '   DECODE((CASE WHEN ('+P_DAY_ID+' < 20100101 OR '+P_DAY_ID+' > 20101231) THEN T1.TOT_PLAN_STNUM_LAST_MONTH ELSE 0 END),0,NULL,(CASE WHEN ('+P_DAY_ID+' < 20100101 OR '+P_DAY_ID+' > 20101231) THEN T1.TOT_PLAN_STNUM_LAST_MONTH ELSE 0 END)), '+
                '   0,NULL, REMD_ADD_TKSL('+P_DAY_ID+',''M'',CAST(T1.TOT_AMT_LAST_MONTH AS NUMBER),CAST(T1.TOT_TKSL_LAST_MONTH AS NUMBER))/ '+
                '   DECODE((CASE WHEN ('+P_DAY_ID+' < 20100101 OR '+P_DAY_ID+' > 20101231) THEN T1.TOT_PLAN_STNUM_LAST_MONTH ELSE 0 END),0,NULL,(CASE WHEN ('+P_DAY_ID+' < 20100101 OR '+P_DAY_ID+' > 20101231) THEN T1.TOT_PLAN_STNUM_LAST_MONTH ELSE 0 END)))*100 '+
                'AS R8, '+
                'CASE WHEN DECODE(T1.ACCU_PLAN_STNUM,0,NULL,T1.ACCU_PLAN_STNUM)=0 THEN 0 ELSE (ACCU_CUST_NUM/DECODE(T1.ACCU_PLAN_STNUM,0,NULL,T1.ACCU_PLAN_STNUM)) END AS R9, '+
                ' CASE WHEN  ROUND((ACCU_CUST_NUM_LAST_YEAR/DECODE(T1.ACCU_PLAN_STNUM_LAST_YEAR,0,NULL,T1.ACCU_PLAN_STNUM_LAST_YEAR)),0) =0 THEN NULL ELSE ' +
				' ROUND((ACCU_CUST_NUM/DECODE(T1.ACCU_PLAN_STNUM,0,NULL,T1.ACCU_PLAN_STNUM)),0)/ '+
                'ROUND((ACCU_CUST_NUM_LAST_YEAR/DECODE(T1.ACCU_PLAN_STNUM_LAST_YEAR,0,NULL,T1.ACCU_PLAN_STNUM_LAST_YEAR)),0)*100 END AS R10, '+               
                'CASE WHEN DECODE(ACCU_CUST_NUM,0,NULL,ACCU_CUST_NUM)=0 THEN NULL ELSE (T1.ACCU_AMT/DECODE(ACCU_CUST_NUM,0,NULL,ACCU_CUST_NUM)) END AS R11, '+
                '(REMD_ADD_TKSL('+P_DAY_ID+',''Y'',CAST(T1.ACCU_AMT AS NUMBER),CAST(ACCU_TKSL AS NUMBER))/DECODE(T1.ACCU_CUST_NUM,0,NULL,T1.ACCU_CUST_NUM))- '+
                '   (REMD_ADD_TKSL('+P_DAY_ID+',''Y'',CAST(EX_TOT_AMT_LAST_YEAR AS NUMBER),CAST(EX_TOT_TKSL_LAST_YEAR AS NUMBER))/ '+
                '   DECODE(T1.EX_TOT_CUST_NUM_LAST_YEAR,0,NULL,T1.EX_TOT_CUST_NUM_LAST_YEAR)) '+
                'AS R12, '+
                'CASE WHEN DECODE(BUDGET_ST_TOT_AMT,0,NULL,BUDGET_ST_TOT_AMT)=0 THEN NULL ELSE (T1.ACCU_AMT*0.9561/DECODE(BUDGET_ST_TOT_AMT,0,NULL,BUDGET_ST_TOT_AMT))*100 END AS R13, '+
                'CAST(WEATHER AS VARCHAR(1) )AS R14, '+
                'PMART.GET_WEATHER_NM(WEATHER) AS R14_NAME, '+                
                'CAST(LOTEMP AS VARCHAR(3))+''~''+CAST(HITEMP AS VARCHAR(3)) AS R15, '+				
                'SCUST_NUM/DECODE(UPLOAD_STNUM,0,NULL,UPLOAD_STNUM) AS R16, '+
                '(CASE WHEN DECODE(T1.ACCU_PLAN_STNUM,0,NULL,T1.ACCU_PLAN_STNUM)=0 THEN NULL ELSE ACCU_SCUST_NUM/DECODE(T1.ACCU_PLAN_STNUM,0,NULL,T1.ACCU_PLAN_STNUM) END ) AS R17, '+
                'ROUND((ACCU_CUST_NUM/DECODE(T1.ACCU_PLAN_STNUM,0,NULL,T1.ACCU_PLAN_STNUM)),0)- '+
                'ROUND((ACCU_CUST_NUM_LAST_YEAR/DECODE(T1.ACCU_PLAN_STNUM_LAST_YEAR,0,NULL,T1.ACCU_PLAN_STNUM_LAST_YEAR)),0) AS R18, '+
                'CASE WHEN ROUND((ACCU_SCUST_NUM_LAST_YEAR/DECODE(T1.ACCU_PLAN_STNUM_LAST_YEAR,0,NULL,T1.ACCU_PLAN_STNUM_LAST_YEAR)),0)*100 =0 THEN NULL ELSE 
				ROUND((ACCU_SCUST_NUM/DECODE(T1.ACCU_PLAN_STNUM,0,NULL,T1.ACCU_PLAN_STNUM)),0)/ '+
                'ROUND((ACCU_SCUST_NUM_LAST_YEAR/DECODE(T1.ACCU_PLAN_STNUM_LAST_YEAR,0,NULL,T1.ACCU_PLAN_STNUM_LAST_YEAR)),0)*100 END AS R19, '+
                'ROUND((ACCU_SCUST_NUM/DECODE(T1.ACCU_PLAN_STNUM,0,NULL,T1.ACCU_PLAN_STNUM)),0) - '+
                'ROUND((ACCU_SCUST_NUM_LAST_YEAR/DECODE(T1.ACCU_PLAN_STNUM_LAST_YEAR,0,NULL,T1.ACCU_PLAN_STNUM_LAST_YEAR)),0) AS R20, '+              
                '(T1.ACCU_PLAN_STNUM/DECODE(BUDGET_ST_TOT_PLAN_STNUM,0,NULL,BUDGET_ST_TOT_PLAN_STNUM))*100 AS R21 '+
                'FROM #VT_REMD_ST_OSTORE_FUNC T1 '+
                ';';
    EXECUTE IMMEDIATE SQLSTR;     
END SP;