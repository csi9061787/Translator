REPLACE PROCEDURE PMART.POSN_MFACT_1_9
(
FP_TIME_TYPE CHAR,         
FP_TIME_LIST VARCHAR(400), 
FP_PRD_LEVEL VARCHAR(400), 
FP_PRD_ID    VARCHAR(400), 
FP_PRD_SQL   NUMBER,       
FP_ORG_LEVEL NUMBER,       
FP_ORG_LIST  VARCHAR(400), 
FP_MMA_TYPE  NUMBER,       
FP_MMA_RANGE NUMBER,       
FP_MMA_LIST  VARCHAR(400), 
FP_PRD_TYPE  NUMBER,       
FP_AMT_TYPE  VARCHAR(400)  
)            
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR        VARCHAR(4000);
   DECLARE BASE_AMTUNIT  NUMBER;          
   DECLARE V_SQL_DATA    VARCHAR(2000);   
   DECLARE V_TIME_SQL    VARCHAR(100);   
   DECLARE V_TABLE_NAME  VARCHAR(100);   
   DECLARE V_PRD_NAME    VARCHAR(200);   
   DECLARE V_ORG_NAME    VARCHAR(200);   
   DECLARE V_PRD_IN      VARCHAR(30000);
   DECLARE V_GRP_ID      VARCHAR(20);
   DECLARE V_LATEST_SHOPDIST VARCHAR(2000);
   CALL PMART.P_DROP_TABLE ('#VT_POSN_MFACT_1_9'); 
   SET V_TIME_SQL = ' ';
   SET V_LATEST_SHOPDIST = 'SELECT DISTINCT O.OSTORE_ID AS ORG_ID,O.OSTORE_ID AS OSTORE_ID,O.BRANCH_ID,O.DEPT_ID,O.TOT_ID FROM PMART.LAST_SHOPDIST AS L, PMART.LATEST_ORG_DIM AS O WHERE L.OSTORE_NO = O.OSTORE_ID ';
  IF FP_ORG_LEVEL = 0 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.TOT_ID IN ('+FP_ORG_LIST+')'; END IF;
  IF FP_ORG_LEVEL = 1 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.DEPT_ID IN ('+FP_ORG_LIST+')'; END IF;
  IF FP_ORG_LEVEL = 2 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.BRANCH_ID IN ('+FP_ORG_LIST+')'; END IF;
  IF FP_ORG_LEVEL = 3 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.STORE_ID IN ('+FP_ORG_LIST+')'; END IF;
  IF FP_MMA_TYPE = 1 THEN
     IF FP_MMA_RANGE = 1 THEN
        SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND L.LOCAL0 IN ('''+FP_MMA_LIST+''') ';
     ELSE
        SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND ( L.LOCAL0 IN ('''+FP_MMA_LIST+''') '+
      ' OR L.SEC_1_LOCAL IN ('''+FP_MMA_LIST+''') OR L.SEC_2_LOCAL IN ('''+FP_MMA_LIST+''') )';
     END IF;
  END IF;
  IF FP_MMA_TYPE = 2 THEN
     IF FP_MMA_RANGE = 1 THEN
        SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND ( L.LOCAL1 IN ('''+FP_MMA_LIST+''') '+
      ' OR L.LOCAL2 IN ('''+FP_MMA_LIST+''') )';
  ELSE
        SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND ( L.LOCAL1 IN ('''+FP_MMA_LIST+''') '+
      ' OR L.LOCAL2 IN ('''+FP_MMA_LIST+''') OR L.SEC_LOCAL1 IN ('''+FP_MMA_LIST+''') OR L.SEC_LOCAL2 IN ('''+FP_MMA_LIST+''') )';
     END IF;
  END IF;
  IF FP_MMA_TYPE = 3 THEN
     SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND L.LOCAL0 IN ('''+FP_MMA_LIST+''') AND L.SEC_1_LOCAL IS NULL AND L.SEC_2_LOCAL IS NULL ';
  END IF;
   IF FP_AMT_TYPE='T' THEN SET BASE_AMTUNIT = 1000; ELSE SET BASE_AMTUNIT = 1; END IF;
   IF FP_TIME_TYPE = 'W' THEN
      SET V_TIME_SQL ='SELECT L_DAY_ID,L_WEEK_ID AS P_TIME_ID FROM PMART.YMWD_TIME_W2';
   END IF;
   IF FP_TIME_TYPE = 'M' THEN
      SET V_TIME_SQL ='SELECT L_DAY_ID,L_MONTH_ID AS P_TIME_ID FROM PMART.YMWD_TIME_W2 ';
   END IF;
   IF FP_PRD_LEVEL='PRD' THEN
      IF FP_PRD_TYPE = 1 THEN SET V_TABLE_NAME = 'PMART.BASIC_MLFACT'; ELSE SET V_TABLE_NAME = 'PMART.BASIC_MFACT_DETAIL'; END IF;
   ELSE
      IF FP_PRD_TYPE = 1 THEN SET V_TABLE_NAME = 'PMART.BASIC_MLFACT'; ELSE SET V_TABLE_NAME = 'PMART.BASIC_MFACT'; END IF;
   END IF;
   CASE
      WHEN FP_PRD_LEVEL='ALL' THEN 
           SET V_PRD_NAME = 'SELECT DISTINCT GRP_ID AS I_PRD_ID, TOT_ID AS G_PRD_ID FROM PMART.PRD_DIM';
      WHEN FP_PRD_LEVEL='KND' THEN 
           SET V_PRD_NAME = 'SELECT DISTINCT GRP_ID AS I_PRD_ID, KND_ID AS G_PRD_ID FROM PMART.PRD_DIM'; 
      WHEN FP_PRD_LEVEL='TOT' THEN 
           SET V_PRD_NAME = 'SELECT DISTINCT GRP_ID AS I_PRD_ID, TOT_ID AS G_PRD_ID FROM PMART.ORG_DIM_POSN1 WHERE SEQNO = 1 '; 
      WHEN FP_PRD_LEVEL='DEPT' THEN 
           SET V_PRD_NAME = 'SELECT DISTINCT GRP_ID AS I_PRD_ID, DEPT_ID AS G_PRD_ID FROM PMART.ORG_DIM_POSN1 WHERE SEQNO = 1 '; 
      WHEN FP_PRD_LEVEL='BRANCH' THEN 
           SET V_PRD_NAME = 'SELECT DISTINCT GRP_ID AS I_PRD_ID, BRANCH_ID AS G_PRD_ID FROM PMART.ORG_DIM_POSN1 WHERE SEQNO = 1 '; 
      WHEN FP_PRD_LEVEL='RESPON' THEN 
           SET V_PRD_NAME = 'SELECT DISTINCT GRP_ID AS I_PRD_ID, RESPON_ID AS G_PRD_ID FROM PMART.ORG_DIM_POSN1 WHERE SEQNO = 1 '; 
      WHEN FP_PRD_LEVEL='GRP' THEN 
           SET V_PRD_NAME = 'SELECT DISTINCT GRP_ID AS I_PRD_ID, GRP_ID AS G_PRD_ID FROM PMART.ORG_DIM_POSN1 WHERE SEQNO = 1 '; 
      WHEN FP_PRD_LEVEL='PRD' THEN 
           SET V_PRD_NAME = 'SELECT DISTINCT PRD_ID AS I_PRD_ID, PRD_ID AS G_PRD_ID FROM PMART.PRD_DIM '; 
      ELSE 
           SET V_PRD_NAME = 'SELECT 0 AS I_PRD_ID, 0 AS G_PRD_ID '; 
   END CASE;
   CASE
      WHEN FP_ORG_LEVEL=0 THEN 
           SET V_ORG_NAME = 'L.TOT_ID'; 
      WHEN FP_ORG_LEVEL=1 THEN 
           SET V_ORG_NAME = 'L.DEPT_ID'; 
      WHEN FP_ORG_LEVEL=2 THEN 
           SET V_ORG_NAME = 'L.BRANCH_ID'; 
      WHEN FP_ORG_LEVEL=3 THEN 
           SET V_ORG_NAME = 'L.OSTORE_ID'; 
      ELSE 
           SET V_ORG_NAME = '0'; 
   END CASE;
   SET V_SQL_DATA =
   'SUM(SALES_CNT) AS SALES_CNT, '+
   'SUM(CAST(SALES_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS SALES_AMT, '+
   'SUM(ORDER_CNT) AS ORDER_CNT, '+
   'SUM(CAST(ORDER_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS ORDER_AMT, '+
   'SUM(THROW_CNT) AS THROW_CNT, '+
   'SUM(CAST(THROW_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS THROW_AMT, '+
   'SUM(INPRD_CNT) AS INPRD_CNT, '+
   'SUM(CAST(INPRD_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS INPRD_AMT, '+
   'SUM(RETPRD_CNT) AS RETPRD_CNT, '+
   'SUM(CAST(RETPRD_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS RETPRD_AMT, '+
   'SUM(TRANSPRD_CNT) AS TRANSPRD_CNT, '+
   'SUM(CAST(TRANSPRD_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS TRANSPRD_AMT, '+
   'SUM(CAST(DIS_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS DIS_AMT, '+
   'SUM(CAST(SUB_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS SUB_AMT, '+
   'SUM(CAST(SALES_UNTAX_COST AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS SALES_UNTAX_COST, '+
   'SUM(CAST(SALES_UNTAX_REAL_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS SALES_UNTAX_REAL_AMT, '+
   'SUM(ORDER_SALES_CNT) AS ORDER_SALES_CNT, '+
   'SUM(CAST(ORDER_SALES_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS ORDER_SALES_AMT, '+
   'SUM(INPRD_SALES_CNT) AS INPRD_SALES_CNT, '+
   'SUM(CAST(INPRD_SALES_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS INPRD_SALES_AMT, '+
   'SUM(Y_ORDER_SALES_CNT) AS Y_ORDER_SALES_CNT, '+
   'SUM(CAST(Y_ORDER_SALES_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS Y_ORDER_SALES_AMT, '+
   '(SUM(CAST(SALES_AMT AS DECIMAL(20,6)))-SUM(CAST(DIS_AMT AS DECIMAL(20,6)))-SUM(CAST(SUB_AMT AS DECIMAL(20,6))))/'+BASE_AMTUNIT+' AS REAL_SALES_AMT '; 
    SET V_PRD_IN = FP_PRD_ID;
   IF (FP_TIME_TYPE = 'W' OR FP_TIME_TYPE = 'M' ) THEN 
      SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_POSN_MFACT_1_9  AS('+
                  'SELECT  '+
                  'TT.P_TIME_ID AS TIME_ID, '+ V_ORG_NAME +' AS ORG_ID, '+
                  'P.G_PRD_ID AS PRD_ID, '+
                  '0 AS MMA_ID, '+
                  ' '+V_SQL_DATA+' '+
                  ' FROM '+ V_TABLE_NAME +' T ,('+ V_TIME_SQL +') TT,('+ V_LATEST_SHOPDIST +') L '+
                  ' , ('+ V_PRD_NAME +') P '+
                  ' WHERE TT.P_TIME_ID IN ('+ FP_TIME_LIST +') '+
                  ' AND T.TIME_ID = TT.L_DAY_ID '+
                  ' AND T.ORG_ID =  L.ORG_ID '+
                  ' AND P.I_PRD_ID IN ('+ V_PRD_IN +') '+
                  ' AND T.PRD_ID = P.I_PRD_ID '+
                  ' AND T.TIME_ID <> TO_CHAR(CURRENT_DATE,''YYYYMMDD'') '+
                  ' GROUP BY TT.P_TIME_ID,'+V_ORG_NAME +',P.G_PRD_ID'+
                  ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';
   ELSE
      SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_POSN_MFACT_1_9  AS('+
                  'SELECT  '+
                  'T.TIME_ID, '+ V_ORG_NAME +' AS ORG_ID, '+
                  'P.G_PRD_ID AS PRD_ID, '+
                  '0 AS MMA_ID, ' +
                  ' '+V_SQL_DATA+' '+
                  ' FROM '+ V_TABLE_NAME +' T , ('+ V_LATEST_SHOPDIST +') L , ('+ V_PRD_NAME +') P '+
                  ' WHERE '+
                  ' T.TIME_ID IN ('+ FP_TIME_LIST +') '+
                  ' AND T.ORG_ID = L.ORG_ID '+
                  ' AND P.I_PRD_ID IN ('+ V_PRD_IN +') '+
                  ' AND T.PRD_ID = P.I_PRD_ID '+
                  ' GROUP BY T.TIME_ID,'+V_ORG_NAME +',P.G_PRD_ID'+
                  ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';
   END IF;
  EXECUTE IMMEDIATE SQLSTR;
END SP;