REPLACE PROCEDURE PMART.OLD0401_FUNC_FACT_STMARKETING_PRD
(
   IN P_ACTID INTEGER,
   IN P_CLASSID INTEGER,
   IN P_FMCODE VARCHAR(7), 
   IN P_ORGTYPE VARCHAR(10),   
   IN P_ORGID VARCHAR(2000),
   IN P_TIMEID VARCHAR(2000)
)
SP:BEGIN
    DECLARE SQLSTR  VARCHAR(2000);    
	DECLARE ORGSELECT VARCHAR(2000);
	DECLARE ORGWHERE VARCHAR(2000);  
	DECLARE PRDWHERE VARCHAR(2000);  
	DECLARE SELCOL VARCHAR(2000);  
	DECLARE GRPCOL VARCHAR(2000);  
	SET ORGWHERE = '';
	SET PRDWHERE = '';
	SET SELCOL = '';
	SET GRPCOL ='';
	IF P_CLASSID = '-1' THEN 
		SET SELCOL = 'T1.TIME_ID,T1.ACT_ID, PRD.CLASS_ID AS ID, PRD.CLASS_NM AS NM';
		SET GRPCOL = 'T1.TIME_ID,T1.ACT_ID,PRD.CLASS_ID, PRD.CLASS_NM';
		 SET PRDWHERE = ' AND T1.ACT_ID = '+ P_ACTID;
	ELSE
		SET SELCOL = 'T1.TIME_ID,T1.ACT_ID, CAST(PRD.FM_CODE AS INTEGER) AS ID, PRD.FM_NAME AS NM';
		SET GRPCOL = 'T1.TIME_ID,T1.ACT_ID,PRD.FM_CODE, PRD.FM_NAME';
	    IF P_FMCODE = '' THEN 
	        SET PRDWHERE = ' AND T1.ACT_ID = '+ P_ACTID + ' AND T1.CLASS_ID=' + P_CLASSID;
		ELSE
			SET PRDWHERE = ' AND T1.ACT_ID = '+ P_ACTID + ' AND T1.CLASS_ID=' + P_CLASSID  + ' AND T1.PRD_ID= ' + P_FMCODE ;
		END IF;
	END IF;
	IF P_ORGTYPE = '0' THEN
		SET ORGSELECT = 'DEPT_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND PDEPT_ID  = ' + P_ORGID;   
	ELSEIF P_ORGTYPE = '1' THEN
		SET ORGSELECT = 'BRANCH_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND DEPT_ID  = ' + P_ORGID;   
	ELSEIF P_ORGTYPE = '2' THEN
		SET ORGSELECT = 'RESPON_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND BRANCH_ID = ' + P_ORGID;
	ELSEIF P_ORGTYPE = '3' THEN
		SET ORGSELECT = 'OSTORE_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND RESPON_ID = ' + P_ORGID;
	ELSEIF P_ORGTYPE = '4' THEN
		SET ORGSELECT = 'OSTORE_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND OSTORE_ID = ' + P_ORGID;
	ELSE
		SET ORGSELECT = 'PDEPT_ID AS GROUP_ORG_ID, OSTORE_ID';
	END IF;   
    CALL PMART.P_DROP_TABLE ('#VT_FUNC_FACT_STMARKETING_PRD');
    SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FACT_STMARKETING_PRD AS('
	    			     + ' SELECT  ' + SELCOL
						 + '                ,SUM(T1.ORD_CNT) AS ORD_CNT  ,SUM(T1.SALE_CNT) AS SALE_CNT  ,SUM(T1.SALE_AMT) AS SALE_AMT '
						 + '    FROM PMART.FACT_STMARKETING_PRD T1 ';
	IF P_CLASSID = '-1' THEN 					 
		 SET SQLSTR = SQLSTR +'     INNER JOIN PDATA.STORMKT_PRD_M PRD ON T1.ACT_ID = PRD.ACT_ID AND T1.CLASS_ID = PRD.CLASS_ID '	;
	ELSE
		 SET SQLSTR = SQLSTR +'     INNER JOIN PDATA.STORMKT_PRD_D PRD ON T1.ACT_ID = PRD.ACT_ID AND T1.CLASS_ID = PRD.CLASS_ID AND T1.PRD_ID = CAST(PRD.FM_CODE AS INTEGER) ';
	END IF;
	SET SQLSTR = SQLSTR + '  	 INNER JOIN ( '
				    	 	         + '	                     	SELECT ' + ORGSELECT 
  					                 + '			                    FROM PMART.LAST_ORG_STORE '
						             + '                            WHERE 1=1 ';
    IF P_ORGID<> '' THEN 
        SET SQLSTR = SQLSTR + '			' + ORGWHERE;
    END IF;
	SET SQLSTR = SQLSTR + '		      ) T2 ON T1.ORG_ID = T2.OSTORE_ID '	
	    	  				         + ' WHERE T1.TIME_ID IN ('+P_TIMEID+') '
									 +  PRDWHERE;
	SET SQLSTR = SQLSTR + ' GROUP BY  '  + GRPCOL
					    	         + ' ) WITH DATA PRIMARY INDEX(TIME_ID,ACT_ID,ID,NM) ON COMMIT PRESERVE ROWS;';
    EXECUTE IMMEDIATE SQLSTR; 
END SP;