REPLACE PROCEDURE PMART.DYNAMIC_MFACT
(
	FP_FACT_TYPE VARCHAR(100),
	FP_TIME_LIST VARCHAR(4000),
	FP_ORG_LIST  VARCHAR(4000),
	FP_PRD_LIST  VARCHAR(4000)
)
SQL SECURITY INVOKER
SP:BEGIN
	DECLARE SQLSTR VARCHAR(10000);
	DECLARE V_TABLE_NAME VARCHAR(400);
	CALL PMART.P_DROP_TABLE ('#VT_DYNAMIC_MFACT');
	IF FP_FACT_TYPE = 'D' THEN
		SET V_TABLE_NAME = ' PMART.BASIC_MFACT_DETAIL ';
	ELSE
		SET V_TABLE_NAME = ' PMART.BASIC_MFACT ';
	END IF;
	SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_DYNAMIC_MFACT  AS( ' 
						+ 'SELECT D.TIME_ID AS TIME_ID, '
						+ 'D.ORG_ID AS ORG_ID, '
						+ 'D.PRD_ID AS PRD_ID, '
						+ 'SALES_CNT, '
						+ 'SALES_AMT, '
						+ 'ORDER_CNT, '
						+ 'ORDER_AMT, '
						+ 'THROW_CNT, '
						+ 'THROW_AMT, '
						+ 'INPRD_CNT, '
						+ 'INPRD_AMT, '
						+ 'RETPRD_CNT, '
						+ 'RETPRD_AMT, '
						+ 'TRANSPRD_CNT, '
						+ 'TRANSPRD_AMT, '
						+ '(DIS_AMT+SUB_AMT) AS DIS_SUB_AMT, '
						+ 'SALES_AMT - (DIS_AMT+SUB_AMT) AS FINAL_SALE_AMT '
						+ 'FROM  ('
						+ 'SELECT TIME_ID, ORG_ID, PRD_ID '
						+ 'FROM '
						+ '( '+ FP_TIME_LIST +' ) T,'
						+ '( '+ FP_ORG_LIST +' ) O,'
						+ '( '+ FP_PRD_LIST +' ) P '
						+ ') D, '+ V_TABLE_NAME +' F '
						+ 'WHERE F.TIME_ID = D.TIME_ID '
						+ 'AND F.ORG_ID=D.ORG_ID '
						+ 'AND F.PRD_ID=D.PRD_ID '
						+ ' ) WITH DATA PRIMARY INDEX (TIME_ID, ORG_ID, PRD_ID) ON COMMIT PRESERVE ROWS;'; 
	EXECUTE IMMEDIATE SQLSTR;  
END SP;