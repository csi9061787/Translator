REPLACE PROCEDURE PMART.FUNC_FACT_CARD_PAY_DOWNLOAD
(
   IN P_ORGTYPE VARCHAR(10),			
   IN P_ORGID VARCHAR(2000),					   
   IN P_TIMETYPE VARCHAR(10),			
   IN P_TIMEID VARCHAR(2000),   
   IN P_CARDTYPE VARCHAR(500),		
   IN P_FGTRANTYPE VARCHAR(10)			
)
SP:BEGIN
   DECLARE SQLSTR  VARCHAR(4000);    
   DECLARE ORGWHERE  VARCHAR(2000);  
   DECLARE TIMENAME  VARCHAR(100);  
   DECLARE TIMEWHERE  VARCHAR(2000);  
   DECLARE CARDTYPEWHERE  VARCHAR(200);   
   DECLARE FGTRANTYPEWHERE  VARCHAR(200);  
  CALL PMART.P_DROP_TABLE ('#VT_VW_PBMCODE');
  SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_VW_PBMCODE  
                (    
                  CODE_ID      INTEGER      
                 ,CODE_NAME VARCHAR(50) Collate Chinese_Taiwan_Stroke_CI_AS
                )
                NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';   
  EXECUTE IMMEDIATE SQLSTR; 
  INSERT INTO #VT_VW_PBMCODE(CODE_ID  ,CODE_NAME ) SELECT  1 , 'FG_TRAN_TYPE' ;
  INSERT INTO #VT_VW_PBMCODE(CODE_ID  ,CODE_NAME ) SELECT  2 , 'CARD_TYPE' ;
  INSERT INTO #VT_VW_PBMCODE(CODE_ID  ,CODE_NAME ) SELECT  3 , 'FG_PAY_RANGE' ;
   IF P_ORGTYPE = '0' THEN
		SET ORGWHERE = ' AND C.PDEPT_ID  = ' + P_ORGID;   
   ELSEIF P_ORGTYPE = '1' THEN
		SET ORGWHERE = ' AND C.DEPT_ID  = ' + P_ORGID;   
   ELSEIF P_ORGTYPE = '2' THEN
	    SET ORGWHERE = ' AND C.BRANCH_ID = ' + P_ORGID;
   ELSEIF P_ORGTYPE = '3' THEN
	    SET ORGWHERE = ' AND C.RESPON_ID = ' + P_ORGID;
   ELSEIF P_ORGTYPE = '4' THEN
	    SET ORGWHERE = ' AND C.OSTORE_ID = ' + P_ORGID;
   ELSE
	    SET ORGWHERE = '';
   END IF;   
    IF P_TIMETYPE = 'Y' THEN
	    SET TIMENAME = 'T3.L_YEAR_NAME L_TIME_NM, ';
		SET TIMEWHERE = ' JOIN PMART.TIME_Y T3 ON T1.TIME_ID = T3.L_YEAR_ID AND T3.L_YEAR_ID IN ('+P_TIMEID+') ';
   ELSEIF P_TIMETYPE = 'M' THEN
        SET TIMENAME = 'T3.L_MONTH_NAME L_TIME_NM, ';
	    SET TIMEWHERE = ' JOIN PMART.TIME_M T3 ON T1.TIME_ID = T3.L_MONTH_ID AND T3.L_MONTH_ID IN  ('+P_TIMEID+') ';
   ELSE
		SET TIMENAME = 'T3.L_DAY_NAME L_TIME_NM, ';
	    SET TIMEWHERE = ' JOIN PMART.TIME_D T3 ON T1.TIME_ID = T3.L_DAY_ID AND T3.L_DAY_ID IN  ('+P_TIMEID+') ';
   END IF;
   IF (P_CARDTYPE = '-1' OR P_CARDTYPE = '') THEN
   	   SET CARDTYPEWHERE = ' AND T1.CARD_TYPE <> -1 ';
   ELSE
       SET CARDTYPEWHERE = ' AND T1.CARD_TYPE IN ('+P_CARDTYPE+') ';
   END IF;
   IF P_FGTRANTYPE = '' THEN
   	   SET FGTRANTYPEWHERE = '';
   ELSE
       SET FGTRANTYPEWHERE = ' AND T1.FG_TRAN_TYPE IN ('+P_FGTRANTYPE+') ';
   END IF;	   
CALL PMART.P_DROP_TABLE ('#VT_FACT_CARD_PAY_DOWNLOAD');
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FACT_CARD_PAY_DOWNLOAD AS('                          										   
						   + ' SELECT T1.ORG_ID, T1.TIME_ID, T1.TIME_RANGE, T1.FG_TRAN_TYPE, T1.CARD_TYPE, T1.FG_PAY_RANGE, '
						   + '                   T2.DEPT_NO, T2.BRANCH_NO, T2.STORE_NO, T2.STORE_NAME, ' + TIMENAME	   
						   + ' 		             T1.TIME_RANGE TIME_RANGE_NM, '
					  	   + ' 					 T4.CODE_NAME FG_TRAN_TYPE_NM, '
						   + ' 		             T5.CODE_NAME CARD_TYPE_NM, '
						   + ' 					 T6.CODE_NAME FG_PAY_RANGE_NM, '
						   + ' 					 T1.PAY_AMT, T1.PAY_CNT, T2.PDEPT_NO'
						   + ' 		 FROM PMART.FACT_CARD_PAY T1 '
						   + ' 		 JOIN ( '
						   + ' 		 		SELECT P.PDEPT_NO, A.DEPT_NO, B.BRANCH_NO, C.STORE_NO, C.STORE_NAME, C.OSTORE_ID '
						   + ' 				   FROM PMART.ORG_DEPT A '
						   + ' 				    JOIN PMART.ORG_BRANCH B ON A.DEPT_ID = B.DEPT_ID '
						   + ' 				    JOIN PMART.ORG_PDEPT P ON A.PDEPT_ID = P.PDEPT_ID '
						   + ' 					JOIN PMART.LAST_ORG_STORE C ON C.BRANCH_ID =  B.BRANCH_ID ' + ORGWHERE
						   + ' 		 ) T2 ON T1.ORG_ID = T2.OSTORE_ID '
						   +            TIMEWHERE						   
				           + ' 		 JOIN PMART.VW_PBMCODE T4 ON T1.FG_TRAN_TYPE = T4.CODE_ID AND T4.CODE_TYPE =(SELECT  CODE_NAME FROM #VT_VW_PBMCODE WHERE  CODE_ID=1) '
						   + '		     JOIN PMART.VW_PBMCODE T5 ON T1.CARD_TYPE = T5.CODE_ID AND T5.CODE_TYPE =(SELECT  CODE_NAME FROM #VT_VW_PBMCODE WHERE  CODE_ID=2) '
						   + ' 		 JOIN PMART.VW_PBMCODE T6 ON T1.FG_PAY_RANGE = T6.CODE_ID AND T6.CODE_TYPE =(SELECT  CODE_NAME FROM #VT_VW_PBMCODE WHERE  CODE_ID=3)'
						   + ' 		 WHERE T1.TIME_ID IN ('+P_TIMEID+') '	
						   + ' 			 AND T1.TIME_RANGE = -1 '						   
						   +                CARDTYPEWHERE
						   +                FGTRANTYPEWHERE						   
                           + ' ) WITH DATA PRIMARY INDEX(ORG_ID ,TIME_ID, TIME_RANGE, FG_TRAN_TYPE, CARD_TYPE, FG_PAY_RANGE) ON COMMIT PRESERVE ROWS;';
		EXECUTE IMMEDIATE SQLSTR;   
END SP;