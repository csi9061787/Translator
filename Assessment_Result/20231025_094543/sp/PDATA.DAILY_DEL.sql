REPLACE PROCEDURE PDATA.DAILY_DEL
(
    IN  I_DBNAME VARCHAR(50),   
	IN TIMETYPE VARCHAR(1)   
)
SP:BEGIN
	DECLARE SQLSTR  VARCHAR(4000) DEFAULT '';
	DECLARE SQLSTRDEL  VARCHAR(4000) DEFAULT '';
	DECLARE SQLSTRUPD  VARCHAR(4000) DEFAULT '';
	DECLARE SQLSTRLOOK  VARCHAR(1000) DEFAULT '';
	DECLARE TIME_SELECT VARCHAR(50);
	DECLARE TIME_JOIN VARCHAR(50);
	DECLARE P_DB VARCHAR(50);
	DECLARE P_TABLE VARCHAR(50);
	DECLARE P_COL VARCHAR(50);
	DECLARE P_TYPE VARCHAR(50);
	DECLARE P_COLTYPE VARCHAR(10);  
	DECLARE P_RANGE INTEGER;
	DECLARE P_SDATE INTEGER;
	DECLARE P_SERIAL INTEGER;
	DECLARE P_D INTEGER;
	DECLARE P_W INTEGER;
	DECLARE P_M INTEGER;
	DECLARE P_Y INTEGER;
	DECLARE P_EDATE INTEGER;
	DECLARE STORE_CS
	 CURSOR FOR STORE_SQL;    
	IF TIMETYPE = 'D' THEN  
		SET TIME_SELECT = ',T1.L_DAY_SERIAL';
		SET TIME_JOIN = 'T1.L_DAY_ID';
	ELSEIF TIMETYPE = 'W' THEN  
		SET TIME_SELECT = ',T1.L_WEEK_SERIAL';
		SET TIME_JOIN = 'T1.L_WEEK_ID';
	ELSEIF TIMETYPE = 'M' THEN     
		SET TIME_SELECT = ',T1.L_MONTH_SERIAL';
		SET TIME_JOIN = 'T1.L_MONTH_ID';
	ELSEIF TIMETYPE = 'Y' THEN     
		SET TIME_SELECT = ',T1.L_YEAR_SERIAL';
		SET TIME_JOIN = 'T1.L_YEAR_ID';
	END IF;
	SELECT DISTINCT L_DAY_SERIAL,L_WEEK_SERIAL,L_MONTH_SERIAL ,L_YEAR_SERIAL INTO P_D,P_W,P_M,P_Y
	FROM PMART.YMWD_TIME WHERE L_DAY_ID = CAST(CURRENT_DATE AS INTEGER)+19000000;
	SET SQLSTR =' SELECT DISTINCT R.DB_NAME,R.TABLE_NAME,R.COL_NAME,R.DATE_TYPE,R.DATE_RES, R.COL_TYPE,C.STIME_ID'+TIME_SELECT
						+' FROM PMART.DATA_RESERVE  R JOIN PMART.DATA_RESERVE_CTL C '
						+' ON R.DB_NAME = C.DB_NAME AND R.TABLE_NAME = C.TABLE_NAME '
						+' AND R.COL_NAME = C.COL_NAME AND R.DATE_TYPE = C.DATE_TYPE '
						+' JOIN PMART.YMWD_TIME T1 ON C.STIME_ID = '+TIME_JOIN
						+' WHERE R.DATE_TYPE = '''+TIMETYPE+''''
						+'   AND R.DB_NAME='''+ TRIM(I_DBNAME) +'''';
	INSERT INTO PMART.T1(F1,F2) SELECT 1,SQLSTR;
	PREPARE STORE_SQL FROM SQLSTR;
	OPEN STORE_CS;  
	L1:
		WHILE (SQLCODE =0) 
		DO    
	L1_1:
		BEGIN 
		FETCH STORE_CS INTO P_DB,P_TABLE,P_COL,P_TYPE,P_RANGE,P_COLTYPE,P_SDATE,P_SERIAL ;
		IF SQLSTATE <> '00000' THEN LEAVE L1; END IF; 	   
			IF P_TYPE = 'D' THEN
			    IF P_COLTYPE='INTEGER' THEN 
				   SELECT DISTINCT L_DAY_ID INTO P_EDATE
			   	   FROM  PMART.YMWD_TIME WHERE L_DAY_SERIAL = P_D-P_RANGE;				
				   SET SQLSTRDEL = 'DELETE FROM '+P_DB+'.'+P_TABLE+' WHERE '+P_COL+' >='+P_SDATE+' AND '+P_COL+' <'+P_EDATE+'  AND LENGTH(TO_CHAR(' + P_COL + '))=8;';
				   	INSERT INTO PMART.T1(F1,F2) SELECT 11,SQLSTRDEL;
				ELSEIF  P_COLTYPE='VARCHAR' OR P_COLTYPE='CHAR' THEN 
				      SELECT DISTINCT L_DAY_ID INTO P_EDATE
			   	      FROM  PMART.YMWD_TIME WHERE L_DAY_SERIAL = P_D-P_RANGE;				
				      SET SQLSTRDEL = 'DELETE FROM '+P_DB+'.'+P_TABLE+' WHERE '+P_COL+' >='+P_SDATE+' AND '+P_COL+' <'+P_EDATE+' AND LENGTH(' + P_COL +')=8;';
					  	INSERT INTO PMART.T1(F1,F2) SELECT 12,SQLSTRDEL;
				ELSEIF P_COLTYPE='DATE' THEN 
				      SELECT DISTINCT L_DAY_ID INTO P_EDATE
			   	       FROM PMART.YMWD_TIME WHERE L_DAY_SERIAL = P_D-P_RANGE;			
				      SET SQLSTRDEL = 'DELETE FROM '+P_DB+'.'+P_TABLE+
				    ' WHERE '+P_COL+' >='''+SUBSTRING(CAST(P_SDATE AS VARCHAR(8)),1,4)+'-'+SUBSTRING(CAST(P_SDATE AS VARCHAR(8)),5,2)+'-'+SUBSTRING(CAST(P_SDATE AS VARCHAR(8)),7,2) +'''' + 
					' AND '+  P_COL+' < '''+SUBSTRING(CAST(P_EDATE AS VARCHAR(8)) ,1,4)+'-'+SUBSTRING(CAST(P_EDATE AS VARCHAR(8)),5,2) +'-'+ SUBSTRING(CAST(P_EDATE AS VARCHAR(8)),7,2)+'''' + ' AND LENGTH(TO_CHAR(' + P_COL + '))=8;';					
					INSERT INTO PMART.T1(F1,F2) SELECT 13,SQLSTRDEL;
				ELSEIF P_COLTYPE='TIMESTAMP' THEN 
				       SELECT DISTINCT L_DAY_ID INTO P_EDATE
			    	     FROM PMART.YMWD_TIME WHERE L_DAY_SERIAL = P_D-P_RANGE;		
				       SET SQLSTRDEL = 'DELETE FROM '+P_DB+'.'+P_TABLE+
				       ' WHERE '+P_COL+' >='''+SUBSTRING(CAST(P_SDATE AS VARCHAR(8)),1,4)+'-'+SUBSTRING(CAST(P_SDATE AS VARCHAR(8)),5,2)+'-'+SUBSTRING(CAST(P_SDATE AS VARCHAR(8)),7,2) +' 00:00:00''' + 
				    	' AND '+  P_COL+' < '''+SUBSTRING(CAST(P_EDATE AS VARCHAR(8)) ,1,4)+'-'+SUBSTRING(CAST(P_EDATE AS VARCHAR(8)),5,2) +'-'+ SUBSTRING(CAST(P_EDATE AS VARCHAR(8)),7,2)+' 23:59:59''' + '  AND LENGTH(TO_CHAR(' +P_COL +','+ '''YYYYMMDD''' + '))=8 ;';				  
			            	INSERT INTO PMART.T1(F1,F2) SELECT 14,SQLSTRDEL;
				END IF;
			ELSEIF P_TYPE = 'W' THEN
			  	     SELECT DISTINCT L_WEEK_ID INTO P_EDATE
				    FROM PMART.YMWD_TIME WHERE L_WEEK_SERIAL = P_W-P_RANGE;				
				    SET SQLSTRDEL = 'DELETE FROM '+P_DB+'.'+P_TABLE+' WHERE '+P_COL+' >= '+P_SDATE+' AND '+P_COL+' < '+P_EDATE+' AND CAST(SUBSTRING(TO_CHAR('+P_COL+'),5,2) AS INTEGER) BETWEEN 21 AND 76 AND LENGTH(TO_CHAR(' + P_COL +'))=6; ';
				 	INSERT INTO PMART.T1(F1,F2) SELECT 15,SQLSTRDEL;
			ELSEIF P_TYPE = 'M' THEN			  
			    	SELECT DISTINCT L_MONTH_ID INTO P_EDATE
			  	    FROM PMART.YMWD_TIME WHERE L_MONTH_SERIAL = P_M-P_RANGE;				
				    SET SQLSTRDEL = 'DELETE FROM '+P_DB+'.'+P_TABLE+' WHERE '+P_COL+' >= '+P_SDATE+' AND '+P_COL+' < '+P_EDATE+'  AND CAST(SUBSTRING(TO_CHAR('+P_COL+'),5,2) AS INTEGER)  BETWEEN 01 AND 12 AND LENGTH(TO_CHAR(' + P_COL +'))=6;';
						INSERT INTO PMART.T1(F1,F2) SELECT 16,SQLSTRDEL;
			ELSEIF P_TYPE = 'Y' THEN
				  SELECT DISTINCT L_YEAR_ID INTO P_EDATE
				  FROM PMART.YMWD_TIME WHERE L_YEAR_SERIAL = P_Y-P_RANGE;				
				  SET SQLSTRDEL = 'DELETE FROM '+P_DB+'.'+P_TABLE+' WHERE '+P_COL+' >= '+P_SDATE+' AND '+P_COL+' < '+P_EDATE+' AND LENGTH(TO_CHAR('+ P_COL +'))=4 ;';
				  	INSERT INTO PMART.T1(F1,F2) SELECT 17,SQLSTRDEL;
			END IF;
			  SET SQLSTRLOOK = ' LOCKING  '+P_DB+'.'+P_TABLE+'  FOR ACCESS;';
			 INSERT INTO PMART.T1(F1,F2) SELECT 2,SQLSTRLOOK;				 
			 EXECUTE IMMEDIATE SQLSTRLOOK;  
			INSERT INTO PMART.T1(F1,F2) SELECT 2,SQLSTRDEL;
			EXECUTE IMMEDIATE SQLSTRDEL;
			SET SQLSTRUPD =' UPDATE PMART.DATA_RESERVE_CTL SET STIME_ID = ' +  P_EDATE + ',  UPD_DATE = CURRENT_TIMESTAMP(0) ' +
			                               '    WHERE DB_NAME = ''' +  P_DB + ''' AND TABLE_NAME = ''' + P_TABLE + ''' AND COL_NAME = ''' + P_COL + ''' AND DATE_TYPE = ''' + P_TYPE +'''; ';
		    INSERT INTO PMART.T1(F1,F2) SELECT 99,SQLSTRUPD;
			EXECUTE IMMEDIATE SQLSTRUPD;			
		END L1_1;
	END WHILE L1;      
	CLOSE STORE_CS;
END SP;