REPLACE PROCEDURE PMART.FUNC_FACT_PAS_EXCEL
(
   IN P_RPTID SMALLINT,
   IN P_TIMEID VARCHAR(500),
   IN P_TIMETYPE VARCHAR(1),
   IN P_ORGTYPE SMALLINT,
   IN P_ORGID VARCHAR(10),
   IN P_PREID VARCHAR(1000),
    IN P_PAS_TYPE VARCHAR(100),  
	IN P_ACT_CATEGORY VARCHAR(100)  
)
SP:BEGIN
	DECLARE SQLSTR  VARCHAR(10000);
	DECLARE ORGWHERE VARCHAR(3000);
    DECLARE TIMEWHERE  VARCHAR(2000); 
	DECLARE PREWHERE VARCHAR(5000); 
	DECLARE SRCWHERE  VARCHAR(500);
	DECLARE ACTWHERE  VARCHAR(500);
	DECLARE BASETABLE VARCHAR(50);
	SET ORGWHERE = ' ';  
	SET TIMEWHERE = ' ';
	SET PREWHERE = ' ';
	SET SRCWHERE = ' ';
	SET ACTWHERE = ' ';
    SET BASETABLE = ' PMART.FACT_MEMBER_PAS_PREACT ';
	IF P_RPTID = 1 THEN
		SET PREWHERE = ' AND ( PRE_FMCODE IN ( ' + P_PREID + ' ) OR  PRE_FMCODE IN (SELECT DISTINCT PRE_FMCODE FROM PDATA.PAS_PACK_ITEMD WHERE REP_FMCODE IN ( ' + P_PREID + ' ) ) OR SERIES_FMCODE IN ( ' + P_PREID + ')  )' ;
	ELSEIF P_RPTID = 2 THEN
        SET PREWHERE = ' AND ( PRE_ID IN ( ' + P_PREID + ' )  )' ;
	END IF;	
	IF P_ORGTYPE = 0 THEN
	       SET ORGWHERE = ' AND ORG_ID IN (  SELECT OSTORE_ID FROM PMART.LATEST_ORG_DIM WHERE PDEPT_ID = ' +  P_ORGID  +')';
	ELSEIF P_ORGTYPE = 1 THEN
	     SET ORGWHERE = ' AND ORG_ID IN (  SELECT OSTORE_ID FROM PMART.LATEST_ORG_DIM WHERE DEPT_ID = '+P_ORGID  +')';
	ELSEIF P_ORGTYPE = 2 THEN	    
	      	SET ORGWHERE =' AND ORG_ID IN (  SELECT OSTORE_ID FROM PMART.LATEST_ORG_DIM WHERE BRANCH_ID = '+P_ORGID +')';
	ELSEIF P_ORGTYPE = 3 THEN
		SET ORGWHERE = ' AND ORG_ID IN (  SELECT OSTORE_ID FROM PMART.LATEST_ORG_DIM WHERE RESPON_ID = '+P_ORGID  +')';
	ELSEIF P_ORGTYPE = 4 THEN
		SET ORGWHERE = ' AND ORG_ID IN (  SELECT OSTORE_ID FROM PMART.LATEST_ORG_DIM WHERE OSTORE_ID = ' +P_ORGID +')';
	END IF;   
   IF P_TIMETYPE = 'M' THEN
	   SET TIMEWHERE = '  AND TIME_ID IN ( SELECT L_MONTH_ID FROM PMART.YMWD_TIME WHERE L_MONTH_ID IN (' +P_TIMEID +'))';
   ELSEIF P_TIMETYPE = 'W' THEN
	   SET TIMEWHERE = '  AND TIME_ID IN ( SELECT L_WEEK_ID FROM PMART.YMWD_TIME WHERE L_WEEK_ID IN (' +P_TIMEID +'))';
   ELSE
	   SET TIMEWHERE = '  AND TIME_ID IN ( SELECT L_DAY_ID FROM PMART.YMWD_TIME WHERE L_DAY_ID IN (' +P_TIMEID +'))';
   END IF;	
	IF P_PAS_TYPE = '0' OR SUBSTRING(P_PAS_TYPE,1,1) ='0' THEN 
	     SET SRCWHERE = '  AND SRC IN (SELECT CODE_NAME FROM PDATA.PBMCODE WHERE CODE_TYPE = ''PAS_SRC'') ' ;
	ELSE 	 
	      SET SRCWHERE = ' AND SRC IN (SELECT CODE_NAME FROM PDATA.PBMCODE WHERE CODE_TYPE = ''PAS_SRC'' AND CODE_ID IN ( '+P_PAS_TYPE+'))';
	END IF;
	SET ACTWHERE = ' AND ACT_CATEGORY =  ''' +P_ACT_CATEGORY+'''';  	
    CALL PMART.P_DROP_TABLE ('#VT_FACT_PAS_EXCEL');
	SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FACT_PAS_EXCEL AS('	
						+'SELECT T.TIME_NAME AS TIME_ID , A.ORG_ID , O.STORE_NM'
						+',O.BRANCH_NO,O.BRANCH_NM , O.DEPT_NO,O.DEPT_NM ,O.PDEPT_NO,O.PDEPT_NM '
						+',A.PRE_FMCODE, P1.PRD_NM AS PRE_NM ,P1.GRP_NM AS PRE_GRP , P1.KND_NM  AS PRE_KND ,A.SERIES_FMCODE'
						+',P2.PRD_NM  AS SEREIS_NM, P2.GRP_NM  AS SERIES_GRP, P2.KND_NM  AS SERIES_KND'
						+', A.PRE_ID , M.PRE_DESC,A.SRC , C.CODE_NAME'
						+',A.PAS_CHGCNT ,A.PAS_CHGTXCNT ,A.PAS_CHGQTY ,A.PAS_CHGAMT'
						+',A.PAS_SAMESTORE_QTY , A.PAS_SAMESTORE_AMT , A.PAS_DIFSTORE_QTY , A.PAS_DIFSTORE_AMT'
						+' FROM' 
						+' ('
						+' SELECT * FROM  PMART.FACT_MEMBER_PAS_PREACT'
						+' WHERE  1=1' 
						+TIMEWHERE
						+ORGWHERE
						+PREWHERE
						+ACTWHERE
						+SRCWHERE
						+' )A'
						+' LEFT JOIN '
						+' ( '
						+' SELECT DISTINCT L_DAY_ID AS TIME_ID  , L_DAY_NAME AS TIME_NAME  FROM PMART.YMWD_TIME '
						+' UNION ALL '
						+' SELECT DISTINCT L_WEEK_ID AS TIME_ID  , L_WEEK_NAME AS TIME_NAME  FROM PMART.YMWD_TIME '
   						+' UNION ALL '
						+' SELECT DISTINCT L_MONTH_ID AS TIME_ID  , L_MONTH_NAME AS TIME_NAME  FROM PMART.YMWD_TIME '
						+' )T '
						+' ON A.TIME_ID = T.TIME_ID '
						+' LEFT JOIN PMART.LATEST_ORG_DIM  O ON A.ORG_ID = O.STORE_ID'
						+' LEFT JOIN '
						+' ( '
						+' SELECT DISTINCT D.FM_CODE AS PRD_ID ,D.FM_NAME AS PRD_NM ,G1.KIND_CODE+G1.GROUP_CODE AS GRP_ID , G1.GROUP_NAME AS GRP_NM '
						+' ,G2.KIND_CODE AS KND_ID , G2.KIND_NAME AS KND_NM '
						+' FROM PDATA.PBMCMDT D '
						+' LEFT JOIN (SELECT DISTINCT KIND_CODE, GROUP_CODE, GROUP_NAME FROM PDATA.PBMKGRP WHERE GROUP_CODE <> ''0'') G1 ON  D.GROUP_CODE = G1.KIND_CODE+G1.GROUP_CODE '
						+' LEFT JOIN (SELECT DISTINCT KIND_CODE, KIND_NAME FROM PDATA.PBMKGRP WHERE GROUP_CODE =''0'') G2 ON  D.KGRP_KIND_CODE = G2.KIND_CODE '
						+' )P1 ON A.PRE_FMCODE = P1.PRD_ID'
						+' LEFT JOIN '
						+' ( '
						+' SELECT DISTINCT D.FM_CODE AS PRD_ID ,D.FM_NAME AS PRD_NM ,G1.KIND_CODE+G1.GROUP_CODE AS GRP_ID , G1.GROUP_NAME AS GRP_NM '
						+' ,G2.KIND_CODE AS KND_ID , G2.KIND_NAME AS KND_NM '
						+' FROM PDATA.PBMCMDT D '
						+' LEFT JOIN (SELECT DISTINCT KIND_CODE, GROUP_CODE, GROUP_NAME FROM PDATA.PBMKGRP WHERE GROUP_CODE <> ''0'') G1 ON  D.GROUP_CODE = G1.KIND_CODE+G1.GROUP_CODE '
						+' LEFT JOIN (SELECT DISTINCT KIND_CODE, KIND_NAME FROM PDATA.PBMKGRP WHERE GROUP_CODE =''0'') G2 ON  D.KGRP_KIND_CODE = G2.KIND_CODE '
						+' ) P2 ON A.SERIES_FMCODE = P2.PRD_ID'
						+' LEFT JOIN (SELECT * FROM PDATA.PBMCODE WHERE CODE_TYPE = ''PAS_CATEGORY'') C ON A.ACT_CATEGORY = C.CODE_ID'
						+' LEFT JOIN '
						+' ( '
						+' SELECT DISTINCT PRE_ID ,PRE_DESC FROM PDATA.PAS_PACK_ITEMM'
						+' WHERE PRE_ID+TO_CHAR(EFF_DT) IN '
						+' ('
						+' SELECT PRE_ID+TO_CHAR(MAX(EFF_DT)) FROM PDATA.PAS_PACK_ITEMM'
						+' GROUP BY PRE_ID '
						+' )'
						+ ') M ON A.PRE_ID = M.PRE_ID '
			            +' ) WITH DATA PRIMARY  CHARINDEX(ORG_ID,TIME_ID) ON COMMIT PRESERVE ROWS;';						  					
        EXECUTE IMMEDIATE SQLSTR;   
END SP;