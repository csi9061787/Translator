REPLACE PROCEDURE PMART.MGA_1_4_RPT_FUNC
(
	IN P_ORGTYPE INTEGER, 			
	IN P_ORGID INTEGER,					
	IN P_DAY_ID INTEGER
)
SQL SECURITY INVOKER
SP:BEGIN
	DECLARE SQLSTR  VARCHAR(5000) DEFAULT ''; 
	CALL PMART.P_DROP_TABLE ('#VT_MGA_1_4_RPT_FUNC'); 
	CALL PMART.MGA_1_4_ORG_FUNC(P_ORGTYPE,P_ORGID); 
	SET SQLSTR = 
		'CREATE MULTISET VOLATILE TABLE #VT_MGA_1_4_RPT_FUNC AS('+            
		'SELECT ORG_LEVEL, ORG_ID, ORG_NO,ORG_NM, AMT,CUST_NUM '+
		'FROM ( '+
			'SELECT A.ORG_LEVEL ,CASE WHEN B.ORG_ID IS NULL THEN A.ORG_ID ELSE B.ORG_ID END AS ORG_ID ,A.ORG_NO, A.ORG_NM, AMT, CUST_NUM '+
			'FROM '+
				'(SELECT ORG_LEVEL,ORG_ID, ORG_NO,  CASE WHEN ORG_LEVEL=''-1'' OR ORG_LEVEL>=''4'' THEN ORG_NM ELSE ORG_NM END AS ORG_NM  '+
				'FROM #VT_MGA_1_4_ORG_FUNC) A LEFT OUTER JOIN '+
				'(SELECT ORG_ID, AMT / DECODE(UPLOAD_STNUM,0,NULL,UPLOAD_STNUM) AS AMT, '+
					'CUST_NUM / DECODE(UPLOAD_STNUM,0,NULL,UPLOAD_STNUM) AS CUST_NUM '+
				'FROM PMART.REMD_FACT_SUM_NCIG  '+
				'WHERE L_DAY_ID =  '+ P_DAY_ID +' '+
				'UNION '+
				'SELECT OSTORE_ID AS ORG_ID, AMT, CUST_NUM '+
				'FROM PMART.REMD_FACT_NCIG  '+
				'WHERE L_DAY_ID = '+ P_DAY_ID +' ) B  '+
			'ON A.ORG_ID = B.ORG_ID '+
		') I '+
		') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';
    EXECUTE IMMEDIATE SQLSTR; 
END SP;