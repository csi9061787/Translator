REPLACE PROCEDURE PSTAGE.P_INS_YMWD_TIME
(
   IN P_STARTDATE DATE,
   IN P_ENDDATE DATE
)
SP:BEGIN
	CALL PSTAGE.P_DROP_TABLE('#TP1_YMWD_TIME');
    CREATE VOLATILE TABLE #TP1_YMWD_TIME AS (
    SELECT  TO_CHAR(CALENDAR_DATE,'YYYYMMDD') AS L_DAY_ID
            ,TRIM(CAST(CALENDAR_DATE-DATE'2002-01-01'+1 AS VARCHAR(6))) AS L_DAY_SERIAL  
            ,TO_CHAR(ADD_MONTHS(CALENDAR_DATE,-12*1911) ,'YYY/')  + CAST(MONTH_OF_YEAR AS VARCHAR(2)) +'/'+ CAST(CAST(TO_CHAR(CALENDAR_DATE,'DD') AS INTEGER) AS VARCHAR(2))+'('+CASE DAY_OF_WEEK WHEN 1 THEN '日' WHEN 2 THEN '一' WHEN 3 THEN '二' WHEN 4 THEN '三' WHEN 5 THEN '四' WHEN 6 THEN '五' WHEN 7 THEN '六' END+')' AS L_DAY_NAME 
            ,CAST(DAY_OF_WEEK AS VARCHAR(1)) AS L_DAY_OF_WEEK
            ,TO_CHAR(CALENDAR_DATE-7,'YYYYMMDD')  AS L_DAY_LAST_WEEK
            ,TO_CHAR(CALENDAR_DATE-14,'YYYYMMDD')  AS L_DAY_LAST_2WEEK
            ,TO_CHAR(DateAdd(MONTH,-1,CALENDAR_DATE),'YYYYMM')+'01' AS L_DAY_FIRST_DAY_LAST_MONTH
            ,TO_CHAR(LAST_DAY(DateAdd(MONTH,-1,CALENDAR_DATE)),'YYYYMMDD') AS L_DAY_LAST_DAY_LAT_MONTH
            , CAST('' AS CHAR(8)) AS L_DAY_LAST_YEAR     
            ,CASE WHEN TO_CHAR(CALENDAR_DATE,'YYYY')=TO_CHAR(WEEKEND,'YYYY') THEN TO_CHAR(CALENDAR_DATE,'YYYY')+CAST(WEEK_OF_YEAR+ CASE WHEN YRWK.YEAR_OF_CALENDAR IS NOT NULL THEN  21 ELSE 20 END AS CHAR(2)) ELSE TO_CHAR(WEEKEND,'YYYY')+'21' END AS L_WEEK_ID
            ,TRIM(CAST(S1.WEEK_OF_CALENDAR -5321 AS VARCHAR(4)))  AS L_WEEK_SERIAL
            ,TO_CHAR(ADD_MONTHS(WEEKSTART,-12*1911),'YYY/')+ CAST(CAST(TO_CHAR(WEEKSTART,'MM') AS INTEGER) AS VARCHAR(2)) +'/' + CAST(CAST(TO_CHAR(WEEKSTART,'DD') AS INTEGER) AS VARCHAR(2)) + ' ~ ' +TO_CHAR(ADD_MONTHS(WEEKEND,-12*1911),'YYY/')+CAST(CAST(TO_CHAR(WEEKEND,'MM') AS INTEGER) AS VARCHAR(2))+'/'+CAST(CAST(TO_CHAR(WEEKEND,'DD') AS INTEGER) AS VARCHAR(2))  AS L_WEEK_NAME
            ,TO_CHAR(ADD_MONTHS(WEEKSTART,-12*1911),'YYY/')+ CAST(CAST(TO_CHAR(WEEKSTART,'MM') AS INTEGER) AS VARCHAR(2)) +'/' + CAST(CAST(TO_CHAR(WEEKSTART,'DD') AS INTEGER) AS VARCHAR(2)) AS L_WEEK_SNAME
            ,TRIM(CAST(CASE WHEN TO_CHAR(CALENDAR_DATE,'YYYY')=TO_CHAR(WEEKEND,'YYYY') THEN WEEK_OF_YEAR+ CASE WHEN YRWK.YEAR_OF_CALENDAR IS NOT NULL THEN  1 ELSE 0 END ELSE 1 END AS VARCHAR(3))) AS L_WEEK_OF_YEAR
            ,CASE WHEN TO_CHAR(CALENDAR_DATE,'YYYY')=TO_CHAR(WEEKEND,'YYYY') THEN TO_CHAR(DateAdd(MONTH,-12,CALENDAR_DATE),'YYYY')+ CAST(WEEK_OF_YEAR+ CASE WHEN YRWK.YEAR_OF_CALENDAR IS NOT NULL THEN  21 ELSE 20 END AS CHAR(2)) ELSE TO_CHAR(CALENDAR_DATE,'YYYY')+'21' END AS L_WEEK_LAST_YEAR 
            ,TO_CHAR(WEEKSTART,'YYYYMMDD') AS L_WEEK_START_DAY
            ,TO_CHAR(WEEKEND,'YYYYMMDD') AS L_WEEK_END_DAY
            ,TO_CHAR(CALENDAR_DATE,'YYYYMM') AS L_MONTH_ID
            ,TRIM(CAST(MONTH_OF_CALENDAR-1224 AS VARCHAR(5)))  AS L_MONTH_SERIAL
            ,TO_CHAR(ADD_MONTHS(CALENDAR_DATE,-12*1911),'YYY/')+CAST(CAST(TO_CHAR(CALENDAR_DATE,'MM') AS INTEGER) AS VARCHAR(2)) AS L_MONTH_NAME 
            ,TO_CHAR(DateAdd(MONTH,-12,CALENDAR_DATE),'YYYYMM') AS L_MONTH_LAST_YEAR  
            ,TO_CHAR(CALENDAR_DATE,'YYYYMM')+'01' AS L_MONTH_START_DAY
            ,TO_CHAR(LAST_DAY(CALENDAR_DATE),'YYYYMMDD') AS L_MONTH_END_DAY
            ,TO_CHAR(CALENDAR_DATE,'YYYY') AS L_YEAR_ID
            ,TO_CHAR(ADD_MONTHS(CALENDAR_DATE,-12*2001),'YY') AS L_YEAR_SERIAL  
            ,TO_CHAR(ADD_MONTHS(CALENDAR_DATE,-12*1911),'YYY') AS L_YEAR_NAME   
            ,TO_CHAR(CALENDAR_DATE,'YYYY')+'0101' AS L_YEAR_START_DAY
            ,TO_CHAR(CALENDAR_DATE,'YYYY')+'1231' AS L_YEAR_END_DAY
FROM SYS_CALENDAR.CALENDAR S1
JOIN 
(SELECT WEEK_OF_CALENDAR,MIN(CALENDAR_DATE) AS WEEKSTART,MAX(CALENDAR_DATE) AS WEEKEND
FROM  SYS_CALENDAR.CALENDAR 
WHERE CALENDAR_DATE BETWEEN P_STARTDATE-380 AND P_ENDDATE+7
GROUP BY WEEK_OF_CALENDAR) AS WEEK ON S1.CALENDAR_DATE BETWEEN WEEK.WEEKSTART AND WEEK.WEEKEND
LEFT JOIN 
( SELECT YEAR_OF_CALENDAR FROM SYS_CALENDAR.CALENDAR
WHERE CALENDAR_DATE BETWEEN P_STARTDATE-380 AND P_ENDDATE+7
AND WEEK_OF_YEAR=0 AND MONTH_OF_YEAR=1
GROUP BY YEAR_OF_CALENDAR) AS YRWK ON S1.YEAR_OF_CALENDAR=YRWK.YEAR_OF_CALENDAR 
WHERE CALENDAR_DATE BETWEEN P_STARTDATE-380 AND P_ENDDATE+7
) WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;
UPDATE S1
FROM #TP1_YMWD_TIME S1,#TP1_YMWD_TIME S2
SET L_DAY_LAST_YEAR=S2.L_DAY_ID
WHERE S1.L_DAY_OF_WEEK=S2.L_DAY_OF_WEEK AND 
S1.L_WEEK_SERIAL=S2.L_WEEK_SERIAL+52;  
DELETE PSTAGE.YMWD_TIME_TEMP WHERE L_DAY_ID BETWEEN TO_CHAR(P_STARTDATE,'YYYYMMDD') AND TO_CHAR(P_ENDDATE,'YYYYMMDD');
INSERT INTO PSTAGE.YMWD_TIME_TEMP
SELECT * FROM #TP1_YMWD_TIME
WHERE L_DAY_ID BETWEEN TO_CHAR(P_STARTDATE,'YYYYMMDD') AND TO_CHAR(P_ENDDATE,'YYYYMMDD');
END SP;