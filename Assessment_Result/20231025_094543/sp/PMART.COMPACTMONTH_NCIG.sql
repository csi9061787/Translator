CREATE PROCEDURE PMART.COMPACTMONTH_NCIG (P_MONTH_ID NUMBER)
SQL SECURITY INVOKER
SP:BEGIN
MERGE INTO PMART.REMD_FACT_NCIG T USING
(
SELECT
 A.L_DAY_ID            AS L_DAY_ID
,A.OSTORE_ID           AS OSTORE_ID
,A.STORE_ID            AS STORE_ID
,SUM(A.PLAN_STNUM)     OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID  ROWS UNBOUNDED PRECEDING )  AS ACCU_PLAN_STNUM 
,SUM(A.AMT)            OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID  ROWS UNBOUNDED PRECEDING )  AS ACCU_AMT        
,SUM(A.CUST_NUM)       OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID  ROWS UNBOUNDED PRECEDING )  AS ACCU_CUST_NUM
,SUM(A.PLAN_STNUM)     OVER (PARTITION BY A.OSTORE_ID ) AS TOT_PLAN_STNUM
,SUM(A.AMT)            OVER (PARTITION BY A.OSTORE_ID ) AS TOT_AMT
,SUM(A.CUST_NUM)       OVER (PARTITION BY A.OSTORE_ID ) AS TOT_CUST_NUM
,SUM(A.DEPAMT1)        OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID  ROWS UNBOUNDED PRECEDING )  AS ACCU_DEPAMT1
,SUM(A.DEPAMT2)        OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID  ROWS UNBOUNDED PRECEDING )  AS ACCU_DEPAMT2 
,SUM(A.DEPAMT3)        OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID  ROWS UNBOUNDED PRECEDING )  AS ACCU_DEPAMT3 
,SUM(A.DEPAMT4)        OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID  ROWS UNBOUNDED PRECEDING )  AS ACCU_DEPAMT4 
,SUM(A.DEPAMT5)        OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID  ROWS UNBOUNDED PRECEDING )  AS ACCU_DEPAMT5 
,SUM(A.DEPAMT6)        OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID  ROWS UNBOUNDED PRECEDING )  AS ACCU_DEPAMT6 
,SUM(A.DEPAMT7)        OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID  ROWS UNBOUNDED PRECEDING )  AS ACCU_DEPAMT7 
,SUM(A.DEPAMT8)        OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID  ROWS UNBOUNDED PRECEDING )  AS ACCU_DEPAMT8 
,SUM(A.DEPAMT9)        OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID  ROWS UNBOUNDED PRECEDING )  AS ACCU_DEPAMT9 
,SUM(A.DEPAMT10)       OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID  ROWS UNBOUNDED PRECEDING )  AS ACCU_DEPAMT10
,SUM(A.DEPAMT11)       OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID  ROWS UNBOUNDED PRECEDING )  AS ACCU_DEPAMT11
,SUM(A.DEPAMT12)       OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID  ROWS UNBOUNDED PRECEDING )  AS ACCU_DEPAMT12
,SUM(A.DEPAMT13)       OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID  ROWS UNBOUNDED PRECEDING )  AS ACCU_DEPAMT13
,SUM(A.DEPAMT14)       OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID  ROWS UNBOUNDED PRECEDING )  AS ACCU_DEPAMT14
,SUM(A.BUDGET_ST_AVG_AMT * A.PLAN_STNUM) OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID  ROWS UNBOUNDED PRECEDING ) AS ACCU_BUDGET  
,SUM(A.TKSL)           OVER (PARTITION BY A.OSTORE_ID )                                                AS TOT_TKSL
,SUM(A.TKSL)           OVER (PARTITION BY A.OSTORE_ID ORDER BY A.L_DAY_ID ROWS UNBOUNDED PRECEDING )   AS ACCU_TKSL
FROM PMART.REMD_FACT_NCIG A
WHERE ROUND(A.L_DAY_ID/100)=P_MONTH_ID
) S
 ON (T.L_DAY_ID =S.L_DAY_ID 
AND  T.OSTORE_ID=S.OSTORE_ID)
WHEN MATCHED THEN UPDATE SET
 STORE_ID       =S.STORE_ID
,ACCU_PLAN_STNUM=S.ACCU_PLAN_STNUM
,ACCU_AMT       =S.ACCU_AMT
,ACCU_CUST_NUM  =S.ACCU_CUST_NUM
,TOT_PLAN_STNUM =S.TOT_PLAN_STNUM
,TOT_AMT        =S.TOT_AMT
,TOT_CUST_NUM   =S.TOT_CUST_NUM
,ACCU_DEPAMT1   =S.ACCU_DEPAMT1
,ACCU_DEPAMT2   =S.ACCU_DEPAMT2
,ACCU_DEPAMT3   =S.ACCU_DEPAMT3
,ACCU_DEPAMT4   =S.ACCU_DEPAMT4
,ACCU_DEPAMT5   =S.ACCU_DEPAMT5
,ACCU_DEPAMT6   =S.ACCU_DEPAMT6
,ACCU_DEPAMT7   =S.ACCU_DEPAMT7
,ACCU_DEPAMT8   =S.ACCU_DEPAMT8
,ACCU_DEPAMT9   =S.ACCU_DEPAMT9
,ACCU_DEPAMT10  =S.ACCU_DEPAMT10
,ACCU_DEPAMT11  =S.ACCU_DEPAMT11
,ACCU_DEPAMT12  =S.ACCU_DEPAMT12
,ACCU_DEPAMT13  =S.ACCU_DEPAMT13
,ACCU_DEPAMT14  =S.ACCU_DEPAMT14
,ACCU_BUDGET    =S.ACCU_BUDGET
,TOT_TKSL       =S.TOT_TKSL
,ACCU_TKSL      =S.ACCU_TKSL
WHEN NOT MATCHED THEN INSERT
(
 L_DAY_ID
,OSTORE_ID
,STORE_ID
,ACCU_PLAN_STNUM
,ACCU_AMT
,ACCU_CUST_NUM
,TOT_PLAN_STNUM
,TOT_AMT
,TOT_CUST_NUM
,ACCU_DEPAMT1
,ACCU_DEPAMT2
,ACCU_DEPAMT3
,ACCU_DEPAMT4
,ACCU_DEPAMT5
,ACCU_DEPAMT6
,ACCU_DEPAMT7
,ACCU_DEPAMT8
,ACCU_DEPAMT9
,ACCU_DEPAMT10
,ACCU_DEPAMT11
,ACCU_DEPAMT12
,ACCU_DEPAMT13
,ACCU_DEPAMT14
,ACCU_BUDGET
,TOT_TKSL
,ACCU_TKSL
)
VALUES
(
 S.L_DAY_ID
,S.OSTORE_ID
,S.STORE_ID
,S.ACCU_PLAN_STNUM
,S.ACCU_AMT
,S.ACCU_CUST_NUM
,S.TOT_PLAN_STNUM
,S.TOT_AMT
,S.TOT_CUST_NUM
,S.ACCU_DEPAMT1
,S.ACCU_DEPAMT2
,S.ACCU_DEPAMT3
,S.ACCU_DEPAMT4
,S.ACCU_DEPAMT5
,S.ACCU_DEPAMT6
,S.ACCU_DEPAMT7
,S.ACCU_DEPAMT8
,S.ACCU_DEPAMT9
,S.ACCU_DEPAMT10
,S.ACCU_DEPAMT11
,S.ACCU_DEPAMT12
,S.ACCU_DEPAMT13
,S.ACCU_DEPAMT14
,S.ACCU_BUDGET
,S.TOT_TKSL
,S.ACCU_TKSL
)
;
END SP;