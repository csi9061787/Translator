REPLACE PROCEDURE PMART.FUNC_FACT_MEMBER_CHG_DOWNLOAD
(
   IN P_RPTID SMALLINT,   
   IN P_TIMEID VARCHAR(500),
   IN P_TIMETYPE VARCHAR(1),
   IN P_ORGTYPE SMALLINT,
   IN P_ORGID VARCHAR(10),
   IN P_PRDTYPE SMALLINT,
   IN P_PRDID VARCHAR(20)
)
SP:BEGIN
	DECLARE SQLSTR  VARCHAR(10000);
	DECLARE ORGWHERE VARCHAR(2000);
	DECLARE TIMENAME  VARCHAR(100);
    DECLARE TIMEWHERE  VARCHAR(2000); 
	DECLARE PASSELECT  VARCHAR(50);
	DECLARE PRDJOIN  VARCHAR(2000);
	DECLARE PRDJOINSELECT  VARCHAR(500);	
	DECLARE DATSELECT  VARCHAR(500);
	DECLARE T1SELECT  VARCHAR(500);
	DECLARE PRDWHERE  VARCHAR(100);
	DECLARE BASETABLE VARCHAR(50);
	SET ORGWHERE = ' WHERE 1=1 ';  
	SET PASSELECT = ' ';
	SET T1SELECT = ' ';
	SET PRDWHERE = ' ';
	IF P_RPTID = 1 THEN  
		SET BASETABLE = ' PMART.FACT_MEMBER_CHG ';
		SET DATSELECT = ' , DAT.KND_NM ,DAT.GRP_NM ,DAT.PRD_NM ';
		IF P_PRDTYPE = 1 THEN
			SET PRDWHERE = ' AND T4.KND_ID = '''  + P_PRDID + ''' ';
		ELSEIF P_PRDTYPE = 2 THEN
			SET PRDWHERE = ' AND T4.GRP_ID = '''  + P_PRDID + ''' ';
		ELSEIF P_PRDTYPE = 3 THEN
			SET PRDWHERE = ' AND T4.PRD_ID = '''  + P_PRDID + ''' ';
		ELSE
			SET PRDWHERE = ' ';
		END IF;
		SET PRDJOINSELECT = '  ,T4.KND_NO+'' ''+T4.KND_NM AS KND_NM,T4.GRP_NO+'' ''+T4.GRP_NM AS GRP_NM,T4.PRD_NO+'' ''+T4.PRD_NM AS PRD_NM ';
		SET PRDJOIN = ' INNER JOIN PMART.PRD_DIM T4 ON B.PRD_ID = T4.PRD_ID  ';
			SET PRDJOIN = PRDJOIN+' INNER JOIN (SELECT DISTINCT PRE_FMCODE FROM PDATA.PAS_PACK_ITEMD) D ON D.PRE_FMCODE = T4.PRD_ID ';
		IF P_PRDTYPE = 1 THEN
			SET PRDWHERE = ' AND T4.KND_ID = '''  + P_PRDID + ''' ';
		ELSEIF P_PRDTYPE = 2 THEN
			SET PRDWHERE = ' AND T4.GRP_ID = '''  + P_PRDID + ''' ';
		ELSEIF P_PRDTYPE = 3 THEN
			SET PRDWHERE = ' AND T4.PRD_ID = '''  + P_PRDID + ''' ';
		ELSE
			SET PRDWHERE = ' ';
		END IF;		
	END IF;
	IF P_ORGTYPE = 0 THEN
		SET ORGWHERE = ORGWHERE + ' AND S.PDEPT_ID  = ' + TRIM(P_ORGID); 
	ELSEIF P_ORGTYPE = 1 THEN
		SET ORGWHERE = ORGWHERE + ' AND S.DEPT_ID  = ' + TRIM(P_ORGID); 
	ELSEIF P_ORGTYPE = 2 THEN
		SET ORGWHERE = ORGWHERE + ' AND S.BRANCH_ID = ' + TRIM(P_ORGID);
	ELSEIF P_ORGTYPE = 3 THEN
		SET ORGWHERE = ORGWHERE + ' AND S.RESPON_ID = ' + P_ORGID;
	ELSEIF P_ORGTYPE = 4 THEN
		SET ORGWHERE = ORGWHERE + ' AND S.OSTORE_ID = ' + P_ORGID;
	END IF;   
   IF P_TIMETYPE = 'M' THEN
	   SET TIMENAME = 'T3.L_MONTH_NAME ';
	   SET TIMEWHERE = ' INNER JOIN PMART.TIME_M T3 ON B.TIME_ID = T3.L_MONTH_ID AND B.TIME_ID IN ('+P_TIMEID+')';
   ELSEIF P_TIMETYPE = 'W' THEN
	   SET TIMENAME = 'T3.L_WEEK_NAME ';
	   SET TIMEWHERE = ' INNER JOIN PMART.TIME_W T3 ON B.TIME_ID = T3.L_WEEK_ID AND B.TIME_ID IN ('+P_TIMEID+')';
   ELSE
	   SET TIMENAME = 'T3.L_DAY_NAME ';
	   SET TIMEWHERE = ' INNER JOIN PMART.TIME_D T3 ON B.TIME_ID = T3.L_DAY_ID AND B.TIME_ID IN ('+P_TIMEID+')';
   END IF;	
    CALL PMART.P_DROP_TABLE ('#VT_FACT_MEMBER_CHG_DOWNLOAD');	
	SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FACT_MEMBER_CHG_DOWNLOAD AS('	
	   					 +' SELECT DAT.PDEPT_NO ,DAT.PDEPT_SNAME ,DAT.DEPT_NO ,DAT.DEPT_SNAME ,DAT.BRANCH_NO ,DAT.BRANCH_SNAME ,DAT.STORE_NO ,DAT.STORE_NAME '+DATSELECT
						 +' ,DAT.TIME_ID ,DAT.CHG_CNT ,DAT.CHG_TXCNT ,DAT.CHG_QTY ,DAT.CHG_AMT '				
	   					 +' FROM ( '
						 +'        SELECT '+TIMENAME+' AS TIME_ID ,B.CHG_CNT ,B.CHG_TXCNT ,B.CHG_QTY ,B.CHG_AMT '						 
						 +'        ,T1.* '+PRDJOINSELECT
						 +'        FROM '+BASETABLE+' B ' 
						 +'        INNER JOIN ( '
						 +'          SELECT PDEPT.PDEPT_NO ,PDEPT.PDEPT_SNAME ,DEPT.DEPT_NO ,DEPT.DEPT_SNAME '
						 +'          ,BRANCH.BRANCH_NO ,BRANCH.BRANCH_SNAME ,S.OSTORE_ID ,S.STORE_ID ,S.STORE_NO ,S.STORE_NAME '						 						 
						 +'          FROM PMART.LAST_ORG_STORE S '						 
						 +'          LEFT JOIN PMART.ORG_PDEPT PDEPT ON S.PDEPT_ID = PDEPT.PDEPT_ID '
						 +'          LEFT JOIN PMART.ORG_DEPT DEPT ON S.DEPT_ID = DEPT.DEPT_ID '
						 +'          LEFT JOIN PMART.ORG_BRANCH BRANCH ON S.BRANCH_ID = BRANCH.BRANCH_ID '+ TRIM(ORGWHERE)
						 +'         ) T1 ON B.ORG_ID = T1.OSTORE_ID '+PRDJOIN+PRDWHERE+TIMEWHERE
						 +'         ) DAT '
			             + ' ) WITH DATA PRIMARY  CHARINDEX(STORE_NO,TIME_ID) ON COMMIT PRESERVE ROWS;';			
        EXECUTE IMMEDIATE SQLSTR;   
END SP;