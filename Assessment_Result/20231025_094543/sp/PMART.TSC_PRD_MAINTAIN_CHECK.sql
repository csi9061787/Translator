REPLACE PROCEDURE PMART.TSC_PRD_MAINTAIN_CHECK 
(
OUT DATA_CNT INTEGER,
OUT ERR_CNT INTEGER
)
SQL SECURITY INVOKER
SP:BEGIN
 CALL PMART.P_DROP_TABLE ('#TMP_TSC_PRD_MAINTAIN');
  CREATE MULTISET VOLATILE  TABLE #TMP_TSC_PRD_MAINTAIN AS 
(
SELECT CHANNEL_CODE,FM_CODE,START_DATE,END_DATE,'日期長度有誤' AS ERR_MSG FROM PDATA.TSC_PRD_MAINTAIN_IF
WHERE LENGTH(START_DATE) <> 10 OR LENGTH(END_DATE) <> 10
OR REGEXP_SIMILAR(START_DATE,'[0-9]{4}/[0-9]{2}/[0-9]{2}') = 0 OR REGEXP_SIMILAR(END_DATE,'[0-9]{4}/[0-9]{2}/[0-9]{2}') = 0
)
WITH  DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;
UPDATE PDATA.TSC_PRD_MAINTAIN_IF
FROM  #TMP_TSC_PRD_MAINTAIN B
SET ERR_MSG = NVL(TSC_PRD_MAINTAIN_IF.ERR_MSG,'')+','+ B.ERR_MSG
WHERE TSC_PRD_MAINTAIN_IF.CHANNEL_CODE = B.CHANNEL_CODE
AND TSC_PRD_MAINTAIN_IF.FM_CODE = B.FM_CODE
;
CALL PMART.P_DROP_TABLE ('#TMP_TSC_PRD_MAINTAIN');
 IF (SELECT COUNT(*) FROM  PDATA.TSC_PRD_MAINTAIN_IF WHERE ERR_MSG IS NOT NULL) =0
 THEN 
CREATE MULTISET VOLATILE  TABLE #TMP_TSC_PRD_MAINTAIN AS 
(
SELECT CHANNEL_CODE,FM_CODE,START_DATE,END_DATE,'迄日小於起日' AS ERR_MSG FROM PDATA.TSC_PRD_MAINTAIN_IF
WHERE TO_DATE(END_DATE,'YYYY/MM/DD')-TO_DATE(START_DATE,'YYYY/MM/DD')  < 0
)
WITH  DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;
UPDATE PDATA.TSC_PRD_MAINTAIN_IF
FROM  #TMP_TSC_PRD_MAINTAIN  B
SET ERR_MSG = NVL(TSC_PRD_MAINTAIN_IF.ERR_MSG,'')+','+ B.ERR_MSG
WHERE TSC_PRD_MAINTAIN_IF.CHANNEL_CODE = B.CHANNEL_CODE
AND TSC_PRD_MAINTAIN_IF.FM_CODE = B.FM_CODE
;
END IF;
CALL PMART.P_DROP_TABLE ('#TMP_TSC_PRD_MAINTAIN');
CREATE MULTISET VOLATILE  TABLE #TMP_TSC_PRD_MAINTAIN AS 
(
SELECT CHANNEL_CODE,FM_CODE,START_DATE,END_DATE,'商品代號不存在於主檔' AS ERR_MSG FROM PDATA.TSC_PRD_MAINTAIN_IF
WHERE FM_CODE NOT IN (SELECT DISTINCT FM_CODE FROM PDATA.PBMCMDT)
)
WITH  DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;
UPDATE PDATA.TSC_PRD_MAINTAIN_IF
FROM  #TMP_TSC_PRD_MAINTAIN B
SET ERR_MSG = NVL(TSC_PRD_MAINTAIN_IF.ERR_MSG,'')+','+ B.ERR_MSG
WHERE TSC_PRD_MAINTAIN_IF.CHANNEL_CODE = B.CHANNEL_CODE
AND TSC_PRD_MAINTAIN_IF.FM_CODE = B.FM_CODE
;
 CALL PMART.P_DROP_TABLE ('#TMP_TSC_PRD_MAINTAIN');
 CREATE MULTISET VOLATILE  TABLE #TMP_TSC_PRD_MAINTAIN AS 
(
SELECT CHANNEL_CODE,FM_CODE,START_DATE,END_DATE,'日期為空值' AS ERR_MSG FROM PDATA.TSC_PRD_MAINTAIN_IF
WHERE START_DATE IS NULL OR END_DATE IS NULL
)
WITH  DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;
UPDATE PDATA.TSC_PRD_MAINTAIN_IF
FROM  #TMP_TSC_PRD_MAINTAIN B
SET ERR_MSG = NVL(TSC_PRD_MAINTAIN_IF.ERR_MSG,'')+','+ B.ERR_MSG
WHERE TSC_PRD_MAINTAIN_IF.CHANNEL_CODE = B.CHANNEL_CODE
AND TSC_PRD_MAINTAIN_IF.FM_CODE = B.FM_CODE
;
  CALL PMART.P_DROP_TABLE ('#TMP_TSC_PRD_MAINTAIN');
   SET DATA_CNT = (SELECT COUNT(*) FROM PDATA.TSC_PRD_MAINTAIN_IF);
  SET ERR_CNT = (SELECT COUNT(*) FROM PDATA.TSC_PRD_MAINTAIN_IF WHERE ERR_MSG IS NOT NULL);
END SP;