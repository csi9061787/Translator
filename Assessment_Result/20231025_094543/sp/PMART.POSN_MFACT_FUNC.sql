REPLACE PROCEDURE PMART.POSN_MFACT_FUNC (
FP_TIME_TYPE CHAR, 
FP_TIME_LIST VARCHAR(400), 
FP_PRD_LEVEL VARCHAR(400), 
FP_PRD_ID    VARCHAR(1000), 
FP_PRD_SQL   NUMBER, 
FP_ORG_LEVEL NUMBER, 
FP_ORG_LIST  VARCHAR(400), 
FP_MMA_LEVEL NUMBER, 
FP_MMA_ID    VARCHAR(400), 
FP_PRD_TYPE  NUMBER, 
FP_AMT_TYPE  VARCHAR(400) 
)
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR  VARCHAR(8000); 
   DECLARE V_TABLE_NAME VARCHAR(100);
   DECLARE V_TIME_SQL VARCHAR(100);
   DECLARE V_TIME_WHERE VARCHAR(100);   
   DECLARE V_TIME_W2_SQL VARCHAR(100);
   DECLARE V_MMA VARCHAR(400);
   DECLARE V_MMA_WHERE VARCHAR(400);
   DECLARE V_MMA_GROUP VARCHAR(400);
   DECLARE BASE_AMTUNIT NUMBER;
   DECLARE V_TABLE_NAME2 VARCHAR(400);
   DECLARE V_SQL_DATA VARCHAR(4000);
   DECLARE V_PRD_IN VARCHAR(1000);
   DECLARE V_GRP_ID NUMBER;
   CALL PMART.P_DROP_TABLE ('#VT_POSN_MFACT_FUNC'); 
  SET V_TIME_SQL = ' ';
  SET V_MMA = '0 AS MMA_ID, ';
  SET V_MMA_WHERE = ' ';
  SET V_MMA_GROUP = ' ';
  SET V_TIME_WHERE =' ';
  SET V_TIME_W2_SQL ='';
  IF (FP_AMT_TYPE='T') THEN
      SET BASE_AMTUNIT = 1000;  
  ELSE 
      SET BASE_AMTUNIT = 1;  
  END IF;
  SET V_TIME_WHERE ='AND T.TIME_ID = TT.L_DAY_ID ';
  IF (FP_TIME_TYPE = 'W') THEN
      SET V_TIME_SQL ='SELECT DISTINCT L_WEEK_ID AS P_TIME_ID FROM PMART.YMWD_TIME_W2 ';	 
	    SET V_TIME_WHERE ='AND T.TIME_ID = TT.P_TIME_ID ';
  END IF;
  IF (FP_TIME_TYPE = 'M') THEN
      SET V_TIME_SQL ='SELECT L_DAY_ID,L_MONTH_ID AS P_TIME_ID FROM PMART.YMWD_TIME_W2 ';
  END IF;
  IF (FP_MMA_LEVEL = 0 OR FP_MMA_LEVEL = 1) THEN 
       IF FP_PRD_TYPE = 1 THEN 
           IF (FP_TIME_TYPE = 'W') THEN 
               SET V_TABLE_NAME = 'PMART.BASIC_MLFACT_SHOP_W2'; 
		   ELSE 
		       SET V_TABLE_NAME = 'PMART.BASIC_MLFACT_SHOP'; 
		   END IF;  
        ELSE           
           IF (FP_TIME_TYPE = 'W') THEN 
	           SET V_TABLE_NAME = 'PMART.BASIC_MFACT_SHOP_W2'; 
	 	   ELSE 
               SET V_TABLE_NAME = 'PMART.BASIC_MFACT_SHOP'; 
		   END IF;	
         END IF;
          SET V_MMA ='T.MMA_ID AS MMA_ID, ';
          SET V_MMA_WHERE =' AND T.MMA_ID IN ('+ FP_MMA_ID +')';
          SET V_MMA_GROUP =' ,T.MMA_ID';
  ELSE 
      IF FP_ORG_LEVEL=3 AND FP_PRD_LEVEL='PRD' THEN 
          IF FP_PRD_TYPE = 1 THEN SET V_TABLE_NAME = 'PMART.BASIC_MLFACT'; ELSE SET V_TABLE_NAME = 'PMART.BASIC_MFACT_DETAIL'; END IF;
      ELSE
	      IF FP_TIME_TYPE='W' THEN 
	 	     IF FP_PRD_TYPE = 1 THEN SET V_TABLE_NAME = 'PMART.BASIC_MLFACT_W2'; ELSE SET V_TABLE_NAME = 'PMART.BASIC_MFACT_W2'; END IF;
		  ELSE 
               IF FP_PRD_TYPE = 1 THEN SET V_TABLE_NAME = 'PMART.BASIC_MLFACT'; ELSE SET V_TABLE_NAME = 'PMART.BASIC_MFACT'; END IF;
		  END IF;
      END IF;
  END IF;
   CASE
      WHEN FP_PRD_LEVEL='ALL' THEN 
          SET V_TABLE_NAME2 = 'SELECT DISTINCT GRP_ID AS I_PRD_ID, TOT_ID AS G_PRD_ID FROM PMART.PRD_DIM';
      WHEN FP_PRD_LEVEL='KND' THEN 
          SET V_TABLE_NAME2 = 'SELECT DISTINCT GRP_ID AS I_PRD_ID, KND_ID AS G_PRD_ID FROM PMART.PRD_DIM';
	  WHEN FP_PRD_LEVEL='ALLPRD' THEN 
          SET V_TABLE_NAME2 = 'SELECT DISTINCT GRP_ID AS I_PRD_ID, ''-99'' AS G_PRD_ID FROM PMART.ORG_DIM_POSN1 WHERE SEQNO = 1 ';
      WHEN FP_PRD_LEVEL='TOT'  THEN
          SET V_TABLE_NAME2 = 'SELECT DISTINCT GRP_ID AS I_PRD_ID, TOT_ID AS G_PRD_ID FROM PMART.ORG_DIM_POSN1 WHERE SEQNO = 1 ';
      WHEN FP_PRD_LEVEL='DEPT' THEN 
          SET V_TABLE_NAME2 = 'SELECT DISTINCT GRP_ID AS I_PRD_ID, DEPT_ID AS G_PRD_ID FROM PMART.ORG_DIM_POSN1 WHERE SEQNO = 1 ';
      WHEN FP_PRD_LEVEL='BRANCH' THEN 
          SET V_TABLE_NAME2 = 'SELECT DISTINCT GRP_ID AS I_PRD_ID, BRANCH_ID AS G_PRD_ID FROM PMART.ORG_DIM_POSN1 WHERE SEQNO = 1 ';
      WHEN FP_PRD_LEVEL='RESPON' THEN
          SET V_TABLE_NAME2 = 'SELECT DISTINCT GRP_ID AS I_PRD_ID, RESPON_ID AS G_PRD_ID FROM PMART.ORG_DIM_POSN1 WHERE SEQNO = 1 ';
      ELSE 
         SET V_TABLE_NAME2 = 'SELECT ''0'' AS I_PRD_ID, ''0'' AS G_PRD_ID FROM DUAL';
   END CASE;
   IF(FP_PRD_LEVEL = 'GRP' OR FP_PRD_LEVEL = 'PRD') AND (FP_TIME_TYPE = 'D') THEN 
     SET V_SQL_DATA =
     'T.SALES_CNT AS SALES_CNT, '+
     'CAST(T.SALES_AMT AS DECIMAL(20,6))/'+BASE_AMTUNIT+' AS SALES_AMT, '+
     'T.ORDER_CNT AS ORDER_CNT, '+
     'CAST(T.ORDER_AMT AS DECIMAL(20,6))/'+BASE_AMTUNIT+' AS ORDER_AMT, '+
     'T.THROW_CNT AS THROW_CNT, '+
     'CAST(T.THROW_AMT AS DECIMAL(20,6))/'+BASE_AMTUNIT+' AS THROW_AMT, '+
     'T.INPRD_CNT AS INPRD_CNT, '+
     'CAST(T.INPRD_AMT AS DECIMAL(20,6))/'+BASE_AMTUNIT+' AS INPRD_AMT, '+
     'T.RETPRD_CNT AS RETPRD_CNT, '+
     'CAST(T.RETPRD_AMT AS DECIMAL(20,6))/'+BASE_AMTUNIT+' AS RETPRD_AMT, '+
     'T.TRANSPRD_CNT AS TRANSPRD_CNT, '+
     'CAST(T.TRANSPRD_AMT AS DECIMAL(20,6))/'+BASE_AMTUNIT+' AS TRANSPRD_AMT, '+
     'CAST(T.DIS_AMT AS DECIMAL(20,6))/'+BASE_AMTUNIT+' AS DIS_AMT, '+
     'CAST(T.SUB_AMT AS DECIMAL(20,6))/'+BASE_AMTUNIT+' AS SUB_AMT, '+
     'CAST(T.SALES_UNTAX_COST AS DECIMAL(20,6))/'+BASE_AMTUNIT+' AS SALES_UNTAX_COST, '+
     'CAST(T.SALES_UNTAX_REAL_AMT AS DECIMAL(20,6))/'+BASE_AMTUNIT+' AS SALES_UNTAX_REAL_AMT, '+
     'T.ORDER_SALES_CNT AS ORDER_SALES_CNT, '+
     'CAST(T.ORDER_SALES_AMT AS DECIMAL(20,6))/'+BASE_AMTUNIT+' AS ORDER_SALES_AMT, '+
     'T.INPRD_SALES_CNT AS INPRD_SALES_CNT, '+
     'CAST(T.INPRD_SALES_AMT AS DECIMAL(20,6))/'+BASE_AMTUNIT+' AS INPRD_SALES_AMT, '+
     'T.Y_ORDER_SALES_CNT AS Y_ORDER_SALES_CNT, '+
     'CAST(T.Y_ORDER_SALES_AMT AS DECIMAL(20,6))/'+BASE_AMTUNIT+' AS Y_ORDER_SALES_AMT, '+
     '(CAST(T.SALES_AMT AS DECIMAL(20,6))-CAST(T.DIS_AMT AS DECIMAL(20,6))-CAST(T.SUB_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS REAL_SALES_AMT ';
   ELSE
     SET V_SQL_DATA =
     'SUM(T.SALES_CNT) AS SALES_CNT, '+
     'SUM(CAST(T.SALES_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS SALES_AMT, '+
     'SUM(T.ORDER_CNT) AS ORDER_CNT, '+
     'SUM(CAST(T.ORDER_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS ORDER_AMT, '+
     'SUM(T.THROW_CNT) AS THROW_CNT, '+
     'SUM(CAST(T.THROW_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS THROW_AMT, '+
     'SUM(T.INPRD_CNT) AS INPRD_CNT, '+
     'SUM(CAST(T.INPRD_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS INPRD_AMT, '+
     'SUM(T.RETPRD_CNT) AS RETPRD_CNT, '+
     'SUM(CAST(T.RETPRD_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS RETPRD_AMT, '+
     'SUM(T.TRANSPRD_CNT) AS TRANSPRD_CNT, '+
     'SUM(CAST(T.TRANSPRD_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS TRANSPRD_AMT, '+
     'SUM(CAST(T.DIS_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS DIS_AMT, '+
     'SUM(CAST(T.SUB_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS SUB_AMT, '+
     'SUM(CAST(T.SALES_UNTAX_COST AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS SALES_UNTAX_COST, '+
     'SUM(CAST(T.SALES_UNTAX_REAL_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS SALES_UNTAX_REAL_AMT, '+
     'SUM(T.ORDER_SALES_CNT) AS ORDER_SALES_CNT, '+
     'SUM(CAST(T.ORDER_SALES_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS ORDER_SALES_AMT, '+
     'SUM(T.INPRD_SALES_CNT) AS INPRD_SALES_CNT, '+
     'SUM(CAST(T.INPRD_SALES_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS INPRD_SALES_AMT, '+
     'SUM(T.Y_ORDER_SALES_CNT) AS Y_ORDER_SALES_CNT, '+
     'SUM(CAST(T.Y_ORDER_SALES_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS Y_ORDER_SALES_AMT, '+
     '(SUM(CAST(T.SALES_AMT AS DECIMAL(20,6)))-SUM(CAST(T.DIS_AMT AS DECIMAL(20,6)))-SUM(CAST(T.SUB_AMT AS DECIMAL(20,6))))/'+BASE_AMTUNIT+' AS REAL_SALES_AMT ';
   END IF;
    IF FP_PRD_SQL = 1 AND (FP_PRD_LEVEL = 'ALLPRD' OR FP_PRD_LEVEL = 'TOT') THEN 
		SET V_PRD_IN = FP_PRD_ID + ' AND SEQNO = 1 ';
	ELSE
		SET V_PRD_IN = FP_PRD_ID;
	END IF;
   IF(FP_PRD_LEVEL = 'GRP' OR FP_PRD_LEVEL = 'PRD') THEN 
     IF (FP_TIME_TYPE = 'W' OR FP_TIME_TYPE = 'M') THEN  
    SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_POSN_MFACT_FUNC  AS('+
       'SELECT  '+
       'TT.P_TIME_ID AS TIME_ID, '+
       'T.ORG_ID, '+
       'T.PRD_ID, '+
       ' '+V_MMA+' '+
       ' '+V_SQL_DATA+' '+
       'FROM '+ V_TABLE_NAME +' T ,('+ V_TIME_SQL +') TT '+
       'WHERE TT.P_TIME_ID IN ('+ FP_TIME_LIST +') '+
       V_TIME_WHERE + V_MMA_WHERE +' '+   
       'AND T.ORG_ID IN ('+ FP_ORG_LIST +') '+
       'AND T.PRD_ID IN ('+ V_PRD_IN +') '+
       'AND T.TIME_ID <> TO_CHAR(CURRENT_DATE,''YYYYMMDD'') '+
       'GROUP BY TT.P_TIME_ID,T.ORG_ID,T.PRD_ID'+ V_MMA_GROUP +'  '+
     ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';
     ELSE
    SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_POSN_MFACT_FUNC  AS('+
       'SELECT  '+
       'T.TIME_ID, '+
       'T.ORG_ID, '+
       'T.PRD_ID, '+
       ' '+V_MMA+' '+
       ' '+V_SQL_DATA+' '+
       'FROM '+ V_TABLE_NAME +' T '+
       'WHERE '+
       'T.TIME_ID IN ('+ FP_TIME_LIST +') '+ V_MMA_WHERE +' '+
       'AND T.ORG_ID IN ('+ FP_ORG_LIST +') '+
       'AND T.PRD_ID IN ('+ V_PRD_IN +') '+
     ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';
     END IF;
   ELSE
     IF (FP_TIME_TYPE = 'W' OR FP_TIME_TYPE = 'M') THEN 
    SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_POSN_MFACT_FUNC  AS('+
       'SELECT  '+
       'TT.P_TIME_ID AS TIME_ID, '+
       'T.ORG_ID, '+
       'P.G_PRD_ID AS PRD_ID, '+
       ' '+V_MMA+' '+
       ' '+V_SQL_DATA+' '+
       'FROM '+ V_TABLE_NAME +' T ,('+ V_TIME_SQL +') TT , ('+ V_TABLE_NAME2 +') P '+
       'WHERE TT.P_TIME_ID IN ('+ FP_TIME_LIST +') '+
        V_TIME_WHERE + V_MMA_WHERE +' '+   
       ' AND T.PRD_ID = P.I_PRD_ID '+
       ' AND P.I_PRD_ID IN ('+ V_PRD_IN +') '+
       ' AND T.ORG_ID IN ('+ FP_ORG_LIST +') '+
       'AND T.TIME_ID <> TO_CHAR(CURRENT_DATE,''YYYYMMDD'') '+
       ' GROUP BY TT.P_TIME_ID,T.ORG_ID,P.G_PRD_ID'+ V_MMA_GROUP +' '+
     ')  WITH DATA  PRIMARY INDEX ( PRD_ID, TIME_ID,ORG_ID) ON COMMIT PRESERVE ROWS ;';
     ELSE
    SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_POSN_MFACT_FUNC  AS('+
       'SELECT  '+
       'T.TIME_ID, '+
       'T.ORG_ID, '+
       'P.G_PRD_ID AS PRD_ID, '+
       ' '+V_MMA+' '+
       ' '+V_SQL_DATA+' '+
       'FROM '+ V_TABLE_NAME +' T , ('+ V_TABLE_NAME2 +') P '+
       'WHERE '+
       'T.TIME_ID IN ('+ FP_TIME_LIST +') '+ V_MMA_WHERE +' '+
       ' AND T.PRD_ID = P.I_PRD_ID '+
       ' AND P.I_PRD_ID IN ('+ PMART.CONVERT_STRING_LIST(V_PRD_IN) +') '+
       ' AND T.ORG_ID IN ('+ FP_ORG_LIST +') '+
       ' GROUP BY T.TIME_ID,T.ORG_ID,P.G_PRD_ID'+ V_MMA_GROUP +' '+
     ') WITH DATA  PRIMARY INDEX ( PRD_ID, TIME_ID,ORG_ID) ON COMMIT PRESERVE ROWS ;';
     END IF;
   END IF;
   DELETE FROM PMART.T1 WHERE F1 = 11;
   INSERT INTO PMART.T1(F1,F2) SELECT 11,SQLSTR;		  
  EXECUTE IMMEDIATE SQLSTR;
END SP;