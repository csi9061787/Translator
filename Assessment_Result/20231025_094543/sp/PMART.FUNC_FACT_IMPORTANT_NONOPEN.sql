REPLACE PROCEDURE PMART.FUNC_FACT_IMPORTANT_NONOPEN
(
IN P_ACTID VARCHAR(10),
IN P_ORGTYPE VARCHAR(10),
IN P_GROUP VARCHAR(500),
IN P_ORGID VARCHAR(2000)
)
SP:BEGIN
     DECLARE SQLSTR  VARCHAR(2000);    	
	 DECLARE ORGSELECT VARCHAR(2000);
	 DECLARE ORGWHERE VARCHAR(2000);  
     SET ORGWHERE = ' WHERE 1=1 ';
	IF P_ORGTYPE = '0' THEN
		SET ORGSELECT = 'DEPT_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND PDEPT_ID  = ' + P_ORGID;   
	ELSEIF P_ORGTYPE = '1' THEN
		SET ORGSELECT = 'BRANCH_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND DEPT_ID  = ' + P_ORGID;   
	ELSEIF P_ORGTYPE = '2' THEN
		SET ORGSELECT = 'RESPON_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND BRANCH_ID = ' + P_ORGID;
	ELSEIF P_ORGTYPE = '3' THEN
		SET ORGSELECT = 'OSTORE_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND RESPON_ID = ' + P_ORGID;
	ELSEIF P_ORGTYPE = '4' THEN
		SET ORGSELECT = 'OSTORE_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND OSTORE_ID = ' + P_ORGID;
	ELSE
		SET ORGSELECT = 'PDEPT_ID AS GROUP_ORG_ID, OSTORE_ID';
	END IF;   
CALL PMART.P_DROP_TABLE ('#VT_FACT_IMPORTANT_NONOPEN');
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FACT_IMPORTANT_NONOPEN AS('
						 + ' SELECT T1.ACT_ID, T2.GROUP_ORG_ID, SUM(T1.STORE_CNT) AS STORE_CNT '				     
						 + '	    FROM  PMART.FACT_IMPORTANT_NONOPEN T1 '
						 + '		JOIN ( '
						 + '			SELECT ' + ORGSELECT 
						 + '			    FROM PMART.LAST_ORG_STORE '
						 + '			' + ORGWHERE
						 + '		) T2 ON T1.ORG_ID = T2.OSTORE_ID '
						 + '		WHERE T1.ACT_ID = ' + P_ACTID
						 + '		GROUP BY T1.ACT_ID,T2.GROUP_ORG_ID'
			             + ' ) WITH DATA PRIMARY  CHARINDEX( GROUP_ORG_ID,ACT_ID) ON COMMIT PRESERVE ROWS;';						  					
        EXECUTE IMMEDIATE SQLSTR;   
END SP;