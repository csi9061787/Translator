REPLACE PROCEDURE PMART.WDWH_5_1_TRANS_FUNC
(
)
SQL SECURITY INVOKER
SP:BEGIN
     DELETE FROM PMART.PCB_V_PRDANTICIPATE;
	 INSERT INTO PMART.PCB_V_PRDANTICIPATE 
	(
	 PUBLISH_DATE, 
	 PUBLISH_DATE_DATE, 
	 PUBLISH_DATE_TIME, 
	 PRD_NO, PRD_NAME, 
	 PRD_ANTICIPATE,
	 DENOMINATOR,
	 KPI_DAY
	)
	SELECT	
	 PUBLISH_DATE, 
	 PUBLISH_DATE_DATE, 
	 PUBLISH_DATE_TIME, 
	 PRD_NO,PRD_NAME, 
	 PRD_ANTICIPATE,
	 CASE WHEN SUBSTRING(PRD_ANTICIPATE,POSITION('/' IN PRD_ANTICIPATE)+1,2) ='日'  THEN  1
	      WHEN SUBSTRING(PRD_ANTICIPATE,POSITION('/' IN PRD_ANTICIPATE)+1,2) ='週'  THEN  7
	      WHEN SUBSTRING(PRD_ANTICIPATE,POSITION('/' IN PRD_ANTICIPATE)+1,2) ='月'  THEN  L_MONTH_END_DAY - L_MONTH_START_DAY + 1 	
	      ELSE  365 
	 END  AS DENOMINATOR,
	  CAST (CASE WHEN POSITION('/' IN PRD_ANTICIPATE)<=0 THEN 0 ELSE SUBSTRING(PRD_ANTICIPATE,1,POSITION('/' IN PRD_ANTICIPATE)-1) END  AS FLOAT) / 
	      (CASE WHEN SUBSTRING(PRD_ANTICIPATE,POSITION('/' IN PRD_ANTICIPATE)+1,2) ='日'  THEN  1
		    WHEN SUBSTRING(PRD_ANTICIPATE,POSITION('/' IN PRD_ANTICIPATE)+1,2) ='週'  THEN  7
		    WHEN SUBSTRING(PRD_ANTICIPATE,POSITION('/' IN PRD_ANTICIPATE)+1,2) ='月'  THEN  L_MONTH_END_DAY - L_MONTH_START_DAY + 1 	
		    ELSE  365  
	       END ) AS KPI_DAY
	FROM PSTAGE.PCB_V_PRDANTICIPATE AS A
	LEFT JOIN PMART.YMWD_TIME AS B ON CAST(A.PUBLISH_DATE_DATE AS INTEGER) + 19000000 = B.L_DAY_ID
	WHERE CASE WHEN POSITION('/' IN PRD_ANTICIPATE) <=0 THEN 0 ELSE TO_NUMBER(SUBSTRING(PRD_ANTICIPATE, 1,POSITION('/' IN PRD_ANTICIPATE)-1)) END IS NOT NULL;
END SP;