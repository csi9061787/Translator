REPLACE PROCEDURE PMART.NEW_PRD_FACT
(FP_TIME_LIST VARCHAR(200)
,FP_ORG_LEVEL  INTEGER
,FP_ORG_LIST VARCHAR(200)
,FP_PRD_LIST VARCHAR(4000)
,FP_STAS  INTEGER  
,FP_MEAS  INTEGER  
)
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR  VARCHAR(64000); 	
   DECLARE V_TABLE_NAME VARCHAR(30);
   DECLARE V_JOCOL_NAME VARCHAR(30);
   DECLARE V_COCOL_NAME VARCHAR(30);
   DECLARE V_STAS_NAME VARCHAR(30);
   DECLARE V_MEAS_NAME VARCHAR(200);   
   CALL PMART.P_DROP_TABLE ('#VT_NEW_PRD_FACT'); 
   CASE WHEN (FP_ORG_LEVEL=2 )THEN  
        SET V_TABLE_NAME = 'PMART.NEW_FACT';
        SET V_JOCOL_NAME = 'B.OSTORE_ID';
        SET V_COCOL_NAME = 'B.STORE_ID';
   ELSE
        SET V_TABLE_NAME = 'PMART.NEW_FACT_SUM';
        SET V_JOCOL_NAME = 'B.ORG_ID';
        SET V_COCOL_NAME = 'B.ORG_ID';
   END CASE;
   SET V_STAS_NAME = '1';
   IF (FP_STAS = 1 )THEN  SET V_STAS_NAME = '1' ; END IF;
   IF (FP_STAS = 2 )THEN  SET V_STAS_NAME = 'STNUM_STORE_NUM' ; END IF;
   IF (FP_STAS = 3 )THEN  SET V_STAS_NAME = 'MAST_STORE_NUM'  ; END IF;
   SET V_MEAS_NAME = ' ';
   IF (FP_MEAS = 1 )THEN  SET V_MEAS_NAME = 'CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE CAST(ORDER_CNT AS NUMBER) /'+ V_STAS_NAME + ' '; END IF;
   IF (FP_MEAS = 2 )THEN  SET V_MEAS_NAME = 'CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE CAST(INPRD_CNT AS NUMBER) /'+ V_STAS_NAME + ' '; END IF;
   IF (FP_MEAS = 3 )THEN  SET V_MEAS_NAME = 'CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE CAST(SALE_CNT AS NUMBER)  /'+ V_STAS_NAME + ' '; END IF;
   IF (FP_MEAS = 4 )THEN  SET V_MEAS_NAME = 'CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE CAST(THROW_CNT AS NUMBER) /'+ V_STAS_NAME + ' '; END IF;
   IF (FP_MEAS = 5 )THEN 
	SET  V_MEAS_NAME = 'CASE WHEN INPRD_CNT = 0 THEN 0 ELSE ROUND((CAST(SALE_CNT AS NUMBER)/' + V_STAS_NAME + '),2)/ROUND((CAST(INPRD_CNT AS NUMBER)/' +  V_STAS_NAME + '),2) ';       
   END IF;
   SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_NEW_PRD_FACT  AS('+
                'SELECT L_DAY_ID,PRD_ID '+
                ' ,'+ V_MEAS_NAME + ' END AS PSD '+
                ' FROM ( '+
                'SELECT B.* '+
                ',BIT_EXTRACT(BIT_AND(C.STNUM_STORE_NUM,D.MASK)) AS STNUM_STORE_NUM '+
                ',BIT_EXTRACT(BIT_AND(C.MAST_STORE_NUM,D.MASK)) AS MAST_STORE_NUM '+
                'FROM PMART.NEW_SET A  INNER JOIN  '+ V_TABLE_NAME + ' B '+
                'ON A.PRD_ID=B.PRD_ID '+
                '                 INNER JOIN PMART.BASIC_MAST_FACT C '+
                'ON B.L_DAY_ID = C.TIME_ID '+
                '                 INNER JOIN PMART.LAST_ORG_DIM_MASK D '+
                'ON '+ V_JOCOL_NAME + ' = D.ORG_ID '+
                'WHERE '+ V_COCOL_NAME + '= '+ FP_ORG_LIST+' '+
                '  AND B.L_DAY_ID IN(' + FP_TIME_LIST + ') '+
                '  AND B.PRD_ID IN(' + FP_PRD_LIST + ') '+
                ' ) AA ' +
                ') WITH DATA UNIQUE PRIMARY  CHARINDEX(PRD_ID , L_DAY_ID) ON COMMIT PRESERVE ROWS;'; 
	EXECUTE IMMEDIATE SQLSTR;
END SP;