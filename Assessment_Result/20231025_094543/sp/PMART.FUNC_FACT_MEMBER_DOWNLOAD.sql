REPLACE PROCEDURE PMART.FUNC_FACT_MEMBER_DOWNLOAD
(
   IN P_RPTID SMALLINT,
   IN P_TIMEID VARCHAR(500),
   IN P_TIMETYPE VARCHAR(1),
   IN P_ORGTYPE SMALLINT,
   IN P_ORGID VARCHAR(10),
   IN P_DISTRICTTYPE SMALLINT,
   IN P_DISTRICT VARCHAR(20)
)
SP:BEGIN
     DECLARE SQLSTR  VARCHAR(10000);
	 DECLARE ORGSELECT VARCHAR(2000);
	 DECLARE ORGWHERE VARCHAR(2000);  
	 DECLARE V_GROUP VARCHAR(200);
	 DECLARE V_CAST_TYPE VARCHAR(50);
	 DECLARE V_YDIM_VAL VARCHAR(50);
     DECLARE TIMENAME  VARCHAR(100);  
     DECLARE TIMEWHERE  VARCHAR(2000); 
	 DECLARE MTIMEWHERE  VARCHAR(1000);  
	 DECLARE SELECT_RPT VARCHAR(50);
	  SET V_YDIM_VAL ='-1';
      IF P_RPTID = 1  THEN
	       SET V_GROUP = 'TIME_ID, GROUP_ORG_ID';
		   IF P_ORGTYPE <> -1 THEN
		       SET V_YDIM_VAL = P_ORGID;
		   END IF;
		   SET SELECT_RPT = ' ';
      ELSEIF P_RPTID = 2  THEN
	       IF P_DISTRICTTYPE = -1 THEN 
               SET V_GROUP = 'TIME_ID, SHOP_DISTTRICT';
		   ELSEIF P_DISTRICTTYPE = 1  THEN  
		       SET V_GROUP = 'TIME_ID, SEC_DISTRICT';
			   SET V_YDIM_VAL = P_DISTRICT;
		   END IF ;
		   SET SELECT_RPT = ',DAT.SHOP_DISTTRICT_NM';
      END IF;   
   SET ORGWHERE = ' WHERE 1=1 ';
   IF P_ORGTYPE = 1 THEN
	    SET ORGSELECT = 'DEPT_ID AS GROUP_ORG_ID, OSTORE_ID, SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT, NVL(SHOP_ZONE_MAIN,'''')+NVL(SHOP_ZONE_SEC1,'''')+NVL(SHOP_ZONE_SEC2,'''') AS SEC_DISTRICT';
		SET ORGWHERE = ORGWHERE + ' AND S.PDEPT_ID  = ' + TRIM(P_ORGID); 
   ELSEIF P_ORGTYPE = 1 THEN
	    SET ORGSELECT = 'BRANCH_ID AS GROUP_ORG_ID, OSTORE_ID, SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT, NVL(SHOP_ZONE_MAIN,'''')+NVL(SHOP_ZONE_SEC1,'''')+NVL(SHOP_ZONE_SEC2,'''') AS SEC_DISTRICT';
		SET ORGWHERE = ORGWHERE + ' AND S.DEPT_ID  = ' + TRIM(P_ORGID); 
   ELSEIF P_ORGTYPE = 2 THEN
        SET ORGSELECT = 'RESPON_ID AS GROUP_ORG_ID, OSTORE_ID, SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT, NVL(SHOP_ZONE_MAIN,'''')+NVL(SHOP_ZONE_SEC1,'''')+NVL(SHOP_ZONE_SEC2,'''') AS SEC_DISTRICT';
	    SET ORGWHERE = ORGWHERE + ' AND S.BRANCH_ID = ' + TRIM(P_ORGID);
   ELSEIF P_ORGTYPE = 3 THEN
        SET ORGSELECT = 'S.OSTORE_ID AS GROUP_ORG_ID, OSTORE_ID, SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT, NVL(SHOP_ZONE_MAIN,'''')+NVL(SHOP_ZONE_SEC1,'''')+NVL(SHOP_ZONE_SEC2,'''') AS SEC_DISTRICT';
	    SET ORGWHERE = ORGWHERE + ' AND S.RESPON_ID = ' + P_ORGID;
   ELSEIF P_ORGTYPE = 4 THEN
        SET ORGSELECT = 'S.OSTORE_ID AS GROUP_ORG_ID, OSTORE_ID, SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT, NVL(SHOP_ZONE_MAIN,'''')+NVL(SHOP_ZONE_SEC1,'''')+NVL(SHOP_ZONE_SEC2,'''') AS SEC_DISTRICT';
	    SET ORGWHERE = ORGWHERE + ' AND S.OSTORE_ID = ' + P_ORGID;
   ELSE
        SET ORGSELECT = 'PDEPT_ID AS GROUP_ORG_ID, OSTORE_ID, SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT, NVL(SHOP_ZONE_MAIN,'''')+NVL(SHOP_ZONE_SEC1,'''')+NVL(SHOP_ZONE_SEC2,'''') AS SEC_DISTRICT';
   END IF;   
   IF P_RPTID = 2 THEN
	      SET V_CAST_TYPE = 'CAST('''+ TRIM(V_YDIM_VAL) +'''  AS VARCHAR(9))';
	  ELSE
	      SET V_CAST_TYPE = 'CAST('''+ TRIM(V_YDIM_VAL) +'''  AS INTEGER )';
   END IF;
   IF P_DISTRICTTYPE = 1 THEN
	 	SET ORGWHERE = ORGWHERE + ' AND SHOP_DISTTRICT_MAIN = '''  + P_DISTRICT + ''' ';		  
   END IF;	 
	  IF P_TIMETYPE = 'Y' THEN
	    SET TIMENAME = 'T3.L_YEAR_NAME ';
	  SET TIMEWHERE = ' LEFT JOIN   ( SELECT  D.L_DAY_ID, Y.L_YEAR_ID ,Y.L_YEAR_NAME FROM PMART.TIME_D D,PMART.TIME_Y  Y  WHERE D.L_YEAR_ID=Y.L_YEAR_ID  GROUP BY D.L_DAY_ID,Y.L_YEAR_ID, Y.L_YEAR_NAME) T3 ON T1.TIME_ID = T3.L_DAY_ID ';
	  SET MTIMEWHERE =' WHERE T3.L_YEAR_ID IN ('+P_TIMEID+')' ;
   ELSEIF P_TIMETYPE = 'M' THEN
        SET TIMENAME = 'T3.L_MONTH_NAME ';
	    SET TIMEWHERE = ' LEFT JOIN   ( SELECT  D.L_DAY_ID,M.L_MONTH_ID, M.L_MONTH_NAME FROM PMART.TIME_D D,PMART.TIME_M  M  WHERE M.L_MONTH_ID=D.L_MONTH_ID  GROUP BY D.L_DAY_ID,M.L_MONTH_ID, M.L_MONTH_NAME) T3 ON T1.TIME_ID = T3.L_DAY_ID ';
        SET MTIMEWHERE =' WHERE T3.L_MONTH_ID IN ('+P_TIMEID+')' ;
   ELSE
		SET TIMENAME = 'T3.L_DAY_NAME ';
	    SET TIMEWHERE = ' LEFT JOIN PMART.TIME_D T3 ON T1.TIME_ID = T3.L_DAY_ID ';
	    SET MTIMEWHERE =' WHERE T1.TIME_ID IN ('+P_TIMEID+')' ;
   END IF;	
    CALL PMART.P_DROP_TABLE ('#VT_FACT_MEMBER_DOWNLOAD');
    SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FACT_MEMBER_DOWNLOAD AS('		
	   					 +' SELECT DAT.DEPT_NO,DAT.DEPT_SNAME,DAT.BRANCH_NO,DAT.BRANCH_SNAME,DAT.STORE_NO,DAT.STORE_NAME '+SELECT_RPT
						 +'               , DAT.TIME_ID,DAT.ALL_AMT_PSD,DAT.ALL_CNT_PSD '
						 +'               ,ROUND(DAT.ALL_AMT_PSD /CASE WHEN DAT.ALL_CNT_PSD=0 THEN 1 ELSE DAT.ALL_CNT_PSD END,0)  AS ALL_CUSTPRICE_PSD '
						 +'               ,ALL_NCIGAMT_PSD,ALL_NCIGCNT_PSD,DAT.MEMBER_TXAMT_PSD,DAT.MEMBER_TXCNT_PSD '  
						 +'               ,ROUND(DAT.MEMBER_TXAMT_PSD /CASE WHEN DAT.MEMBER_TXCNT_PSD=0 THEN 1 ELSE DAT.MEMBER_TXCNT_PSD END,0)  AS MEMBER_CUSTPRICE_PSD '
						 +'               ,MEMBER_NCIGTXAMT_PSD,MEMBER_NCIGTXCNT_PSD '
						 +'               ,ROUND(MEMBER_NCIGTXAMT_PSD /CASE WHEN MEMBER_NCIGTXCNT_PSD=0 THEN 1 ELSE MEMBER_NCIGTXCNT_PSD END,0) AS MEMBER_NCIGCUSTPRICE_PSD '
						 +'               ,MEMBER_CUSTPRICE_TX '
						 +'               ,CAST(CAST(MEMBER_NCIGTXAMT_PSD AS DECIMAL(16,4)) / CASE WHEN MEMBER_NAGNCIGAMT=0 THEN 1 ELSE MEMBER_NAGNCIGAMT END *100 AS DECIMAL(16,2)) AS MEMBER_NCIGAMT_RATE '
						 +'               ,CAST(CAST(MEMBER_NCIGTXCNT_PSD AS DECIMAL(16,4)) / CASE WHEN MEMBER_NAGNCIGCNT=0 THEN 1 ELSE MEMBER_NAGNCIGCNT END *100 AS DECIMAL(16,2)) AS MEMBER_NCIGCNT_RATE '
						 +'               ,DAT.PDEPT_NO, DAT.PDEPT_NAME '
	   					 +' FROM (	 '
	   					 +' SELECT T2.PDEPT_NO, T2.PDEPT_NAME,T2.DEPT_NO,T2.DEPT_SNAME,T2.BRANCH_NO,T2.BRANCH_SNAME,T2.STORE_NO,T2.STORE_NAME '
						 +'               ,T2.SHOP_DISTTRICT_NM, ' + TIMENAME+' AS TIME_ID '
                         +'               ,ROUND(T1.ALL_AMT /CASE WHEN T1.PLAN_STNUM =0 THEN 1 ELSE T1.PLAN_STNUM END,0) AS ALL_AMT_PSD '
                         +'               ,ROUND(T1.ALL_CNT /CASE WHEN T1.PLAN_STNUM =0 THEN 1 ELSE T1.PLAN_STNUM END,0) AS ALL_CNT_PSD '
                         +'               ,ROUND(T1.MEMBER_AMTNET /CASE WHEN T1.PLAN_STNUM=0 THEN 1 ELSE T1.PLAN_STNUM END,0) AS MEMBER_TXAMT_PSD '
                         +'               ,ROUND(T1.MEMBER_CUSTCNT /CASE WHEN T1.PLAN_STNUM=0 THEN 1 ELSE T1.PLAN_STNUM END,0) AS MEMBER_TXCNT_PSD '  
						 +'               ,ROUND(T1.ALL_NCIGAMT /CASE WHEN T1.PLAN_STNUM=0 THEN 1 ELSE T1.PLAN_STNUM END,0) AS ALL_NCIGAMT_PSD '
                         +'               ,ROUND(T1.ALL_NCIGCNT /CASE WHEN T1.PLAN_STNUM =0 THEN 1 ELSE T1.PLAN_STNUM END,0) AS ALL_NCIGCNT_PSD '
						 +'               ,ROUND(T1.MEMBER_AGNCIGAMTNET /CASE WHEN T1.PLAN_STNUM=0 THEN 1 ELSE T1.PLAN_STNUM END,0) AS MEMBER_NCIGTXAMT_PSD '
                         +'               ,ROUND(T1.MEMBER_AGNCIGCNT /CASE WHEN T1.PLAN_STNUM=0 THEN 1 ELSE T1.PLAN_STNUM END,0) AS MEMBER_NCIGTXCNT_PSD '  
						 +'               ,ROUND(T1.MEMBER_AMTNET /CASE WHEN T1.MEMBER_CUSTCNT=0 THEN 1 ELSE T1.MEMBER_CUSTCNT END,0) AS MEMBER_CUSTPRICE_TX '  
						 +'               ,MEMBER_NAGNCIGAMT ,MEMBER_NAGNCIGCNT '
						 +'    FROM PMART.FACT_MEMBER_REMD T1 '
						 +'               INNER JOIN ( '
						 +'                                       SELECT PDEPT.PDEPT_NO,PDEPT.PDEPT_NAME,DEPT.DEPT_NO,DEPT.DEPT_SNAME,BRANCH.BRANCH_NO,BRANCH.BRANCH_SNAME,S.OSTORE_ID,S.STORE_NO,S.STORE_NAME '
						 +'                                                      ,SHOP.SHOPDIST_NAME AS SHOP_DISTTRICT_NM '
						 +'                                                      ,S.SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT '
						 +'                                          FROM PMART.LAST_ORG_STORE S '
						 +'                                                     LEFT JOIN PMART.VW_SHOPDIST_DIM SHOP ON S.SHOP_DISTTRICT_MAIN = SHOP.SHOPDIST_ID '
						 +'                                                     LEFT JOIN PMART.ORG_DEPT DEPT ON S.DEPT_ID = DEPT.DEPT_ID '
						 +'                                                     LEFT JOIN PMART.ORG_BRANCH BRANCH ON S.BRANCH_ID = BRANCH.BRANCH_ID '
						 +'                                                     LEFT JOIN PDATA.PBMSTTP T ON S.STORE_TYPE = T.STORE_TYPE '
						 +'                                                     LEFT JOIN PMART.ORG_PDEPT PDEPT ON S.PDEPT_ID = PDEPT.PDEPT_ID '
						 +'                       ' + TRIM(ORGWHERE)
						 +'                                    ) T2 ON T1.ORG_ID = T2.OSTORE_ID '
						 +                                    TIMEWHERE					
						  +  MTIMEWHERE
						 +'  )DAT '
			             + ' ) WITH DATA PRIMARY  CHARINDEX(STORE_NO,TIME_ID) ON COMMIT PRESERVE ROWS;';						  					
        EXECUTE IMMEDIATE SQLSTR;   
END SP;