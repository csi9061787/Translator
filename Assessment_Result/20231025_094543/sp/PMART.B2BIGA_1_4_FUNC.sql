REPLACE PROCEDURE PMART.B2BIGA_1_4_FUNC
(
	IN P_A_ID VARCHAR(40),
	IN P_CPC_ID VARCHAR(30) CHARACTER SET UNICODE CASESPECIFIC,
	IN P_TIME_TYPE VARCHAR(1),
	IN P_TIME_START VARCHAR(10),
	IN P_TIME_END VARCHAR(10),
	IN P_PRD_TYPE VARCHAR(1),
	IN P_PRD_LIST VARCHAR(2000)
)
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR VARCHAR(20000) Collate Chinese_Taiwan_Stroke_CI_AS;
   DECLARE V_TABLE_NAME VARCHAR(30);
   DECLARE V_PRD_ID_STR VARCHAR(2000) Collate Chinese_Taiwan_Stroke_CI_AS; 
   DECLARE V_TIME_STR VARCHAR(400); 
   CALL PMART.P_DROP_TABLE ('#VT_B2BIGA_1_4_FUNC'); 
	IF P_TIME_TYPE='M' THEN
		SET V_TABLE_NAME = ' PMART.GCT_MONTH ';
		SET V_TIME_STR = ' A.SDATE IN ( SELECT CAST(CAST(L_MONTH_START_DAY AS VARCHAR(8)) AS DATE FORMAT ''YYYYMMDD'') FROM PMART.YMWD_TIME WHERE L_MONTH_ID = '+ P_TIME_START +' ) ';
	ELSEIF P_TIME_TYPE='W' THEN
		SET V_TABLE_NAME = ' PMART.GCT_WEEK ';
		SET V_TIME_STR = ' A.SDATE IN ( SELECT CAST(CAST(L_WEEK_START_DAY AS VARCHAR(8)) AS DATE FORMAT ''YYYYMMDD'') FROM PMART.YMWD_TIME WHERE L_DAY_ID = '+ P_TIME_START +' ) ';
	ELSEIF P_TIME_TYPE='D' THEN
		SET V_TABLE_NAME = ' PMART.GCT_DAY ';
		SET V_TIME_STR = ' A.SDATE BETWEEN CAST(CAST('+ P_TIME_START +' AS VARCHAR(8)) AS DATE FORMAT ''YYYYMMDD'') AND CAST(CAST('+ P_TIME_END +' AS VARCHAR(8)) AS DATE FORMAT ''YYYYMMDD'') ';
	END IF;
	IF P_PRD_TYPE = '0' THEN
		SET V_PRD_ID_STR = ' A.CMNO IN (SELECT CMNO FROM PDATA.CPC_PROD WHERE A_ID = '''+ P_A_ID +''' AND CPC_ID = '''+ P_CPC_ID +''') ';
	ELSE
		SET V_PRD_ID_STR = ' A.CMNO IN ('+ PMART.CONVERT_STRING_LIST(P_PRD_LIST) +') ';
	END IF;
   SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_B2BIGA_1_4_FUNC  AS( '
        + ' SELECT C.FM_NAME AS CMNM, '
		+ ' B.CMNO AS CMNO, '
		+ ' B.COUNT1, ' 
		+ ' B.TIME01, '
		+ ' B.TIME02, '
		+ ' B.TIME03, '
		+ ' B.TIME04, '
		+ ' B.TIME05, '
		+ ' B.TIME06, '
		+ ' B.TIME07, '
		+ ' B.TIME08, '
		+ ' B.TIME09, '
		+ ' B.TIME10, '
		+ ' B.TIME11, '
		+ ' B.TIME12, '
		+ ' B.TIME13, '
		+ ' B.TIME14, '
		+ ' B.TIME15, '
		+ ' B.TIME16, '
		+ ' B.TIME17, '
		+ ' B.TIME18, '
		+ ' B.TIME19, '
		+ ' B.TIME20, '
		+ ' B.TIME21, '
		+ ' B.TIME22, '
		+ ' B.TIME23, '
		+ ' B.TIME24 '
		+ ' FROM ( '
		+ ' SELECT A.CMNO, '
		+ ' SUM(A.TIME01) AS TIME01, '
		+ ' SUM(A.TIME02) AS TIME02, '
		+ ' SUM(A.TIME03) AS TIME03, '
		+ ' SUM(A.TIME04) AS TIME04, '
		+ ' SUM(A.TIME05) AS TIME05, '
		+ ' SUM(A.TIME06) AS TIME06, '
		+ ' SUM(A.TIME07) AS TIME07, '
		+ ' SUM(A.TIME08) AS TIME08, '
		+ ' SUM(A.TIME09) AS TIME09, '
		+ ' SUM(A.TIME10) AS TIME10, '
		+ ' SUM(A.TIME11) AS TIME11, '
		+ ' SUM(A.TIME12) AS TIME12, '
		+ ' SUM(A.TIME13) AS TIME13, '
		+ ' SUM(A.TIME14) AS TIME14, '
		+ ' SUM(A.TIME15) AS TIME15, '
		+ ' SUM(A.TIME16) AS TIME16, '
		+ ' SUM(A.TIME17) AS TIME17, '
		+ ' SUM(A.TIME18) AS TIME18, '
		+ ' SUM(A.TIME19) AS TIME19, '
		+ ' SUM(A.TIME20) AS TIME20, '
		+ ' SUM(A.TIME21) AS TIME21, '
		+ ' SUM(A.TIME22) AS TIME22, '
		+ ' SUM(A.TIME23) AS TIME23, '
		+ ' SUM(A.TIME24) AS TIME24, '
		+ ' SUM(A.COUNT1) AS COUNT1 ' 
		+ ' FROM '+ V_TABLE_NAME +' A '
		+ ' WHERE '+ V_TIME_STR +' ' 
		+ ' AND '+ V_PRD_ID_STR +' '
		+ ' GROUP BY A.CMNO) B, '
		+ ' PDATA.PBMCMDT C '
		+ ' WHERE B.CMNO = C.FM_CODE ' 
		+ ' ) WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;' ; 
	EXECUTE IMMEDIATE SQLSTR;
END SP;