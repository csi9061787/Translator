REPLACE PROCEDURE PMART.FD_EXPORT_CHK
(
   IN P_EMP_NO  VARCHAR(10)
)
SP:BEGIN
DECLARE SQLSTR  VARCHAR(2000);    
DECLARE SQLCREATETB VARCHAR(2000);    
DECLARE ERROR_CNT INTEGER;
DECLARE ERROR_MSG VARCHAR(20) ;
DECLARE P_EMP_CNT INTEGER;
DECLARE P_TYPE_CNT INTEGER;
DECLARE P_SET_TYPE INTEGER;
DECLARE P_DUPLICATE_MSG VARCHAR(20) ;
   SET ERROR_CNT = 0;
	SELECT COUNT(*) 
	    INTO P_EMP_CNT
	   FROM PMART.FD_EXPORT_SET	   
	WHERE EMP_NO = P_EMP_NO
	     AND  SET_FLAG = 'P';
	 SELECT COUNT(*)
	    INTO P_TYPE_CNT
		FROM (
		SELECT DISTINCT EMP_NO, SET_TYPE
			   FROM PMART.FD_EXPORT_SET
			 WHERE EMP_NO = P_EMP_NO
			 AND SET_FLAG = 'P'
		) T;
	IF (P_EMP_CNT <= 0) THEN
		SET ERROR_CNT = 1;	
		SET ERROR_MSG = '查無該員工編號設定';
	ELSEIF(P_TYPE_CNT <> 1) THEN
		SET ERROR_CNT = 1;	
		SET ERROR_MSG = '輸入商品條件的層級只能一種';
	ELSE
			SELECT DISTINCT SET_TYPE
			      INTO P_SET_TYPE
				FROM PMART.FD_EXPORT_SET
			WHERE EMP_NO = P_EMP_NO
			     AND SET_FLAG = 'P';
			IF (P_SET_TYPE = 1) OR  (P_SET_TYPE = 2) OR (P_SET_TYPE = 3) THEN			
					CALL PMART.P_DROP_TABLE('#CHECKERROR_TEMP');
			   		IF (P_SET_TYPE = 1) THEN
							CREATE VOLATILE TABLE #CHECKERROR_TEMP AS (
							SELECT TRIM(A.SET_NO) AS SET_NO, 
										   B.KND_ID AS SET_ID,
							               B.KND_NAME AS SET_NM, 
										   CASE WHEN B.KND_NO IS NULL THEN 1 ELSE 0 END AS SET_ERR,
										   CASE WHEN B.KND_NO IS NULL THEN '品番代號不存在' ELSE NULL END AS SET_ERR_NM
							    FROM PMART.FD_EXPORT_SET A
								LEFT JOIN PMART.PRD_KND B ON  A.SET_NO = B.KND_NO						
								   WHERE A.EMP_NO = P_EMP_NO
					            	   AND A.SET_FLAG = 'P'
							) WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;				
							SET P_DUPLICATE_MSG = '品番代號重複輸入';
					ELSEIF(P_SET_TYPE = 2) THEN
							CREATE VOLATILE TABLE #CHECKERROR_TEMP AS (
							SELECT TRIM(A.SET_NO) AS SET_NO, 
										   B.GRP_ID AS SET_ID,
							               B.GRP_NAME AS SET_NM, 
										   CASE WHEN B.GRP_NO IS NULL THEN 1 ELSE 0 END AS SET_ERR,
										   CASE WHEN B.GRP_NO IS NULL THEN '群番代號不存在' ELSE NULL END AS SET_ERR_NM
							    FROM PMART.FD_EXPORT_SET A
								LEFT JOIN (SELECT GRP_ID, GRP_NO, GRP_NAME FROM PMART.PRD_GRP) B ON  A.SET_NO = B.GRP_NO
								   WHERE A.EMP_NO = P_EMP_NO
					            	   AND A.SET_FLAG = 'P'
							) WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;				
							SET P_DUPLICATE_MSG = '群番代號重複輸入';
					ELSEIF(P_SET_TYPE = 3) THEN
							CREATE VOLATILE TABLE #CHECKERROR_TEMP AS (
							SELECT TRIM(A.SET_NO) AS SET_NO, 
										   B.FM_CODE_ID AS SET_ID,
							               B.FM_NAME AS SET_NM, 
										   CASE WHEN B.FM_CODE IS NULL THEN 1 ELSE 0 END AS SET_ERR,
										   CASE WHEN B.FM_CODE IS NULL THEN '商品代號不存在' ELSE NULL END AS SET_ERR_NM
							    FROM PMART.FD_EXPORT_SET A
								LEFT JOIN (SELECT TO_NUMBER(FM_CODE) FM_CODE_ID, FM_CODE, FM_NAME FROM PMART.PRD_PRD) B ON  A.SET_NO = B.FM_CODE
								   WHERE A.EMP_NO = P_EMP_NO
					            	   AND A.SET_FLAG = 'P'
							) WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;
							SET P_DUPLICATE_MSG = '商品代號重複輸入';
					END IF;					
					UPDATE A
					FROM  PMART.FD_EXPORT_SET  A, (SELECT DISTINCT * FROM #CHECKERROR_TEMP) B
					       SET SET_ID = B.SET_ID,
						   		   SET_NM = B.SET_NM,
								   SET_ERR = B.SET_ERR,
								   SET_ERR_NM = B.SET_ERR_NM
						WHERE A.EMP_NO = P_EMP_NO
			                 AND A.SET_FLAG = 'P'
							 AND A.SET_NO = B.SET_NO;	
					UPDATE A
					FROM  PMART.FD_EXPORT_SET  A,
					(	SELECT DISTINCT TRIM(SET_NO) AS SET_NO
					        FROM #CHECKERROR_TEMP					
						 GROUP BY SET_NO 
						     HAVING COUNT(*) > 1) B
					SET SET_ERR = 1,
							SET_ERR_NM = P_DUPLICATE_MSG
					WHERE A.EMP_NO = P_EMP_NO
			             AND A.SET_FLAG = 'P'
						 AND A.SET_NO = B.SET_NO;
			ELSE			
				SET ERROR_CNT = 1;	
				SET ERROR_MSG = '輸入錯誤的商品條件層級';			
			END IF;	
	END IF;
	 CALL PMART.P_DROP_TABLE('#VT_FD_EXPORT_CHK');
	  SET SQLCREATETB = 
	  'CREATE MULTISET VOLATILE TABLE #VT_FD_EXPORT_CHK 
	  (
	  	RETURN_VAL		INTEGER,
	  	RETURN_DESCR		VARCHAR(20) 
	  )
	   NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';
	EXECUTE IMMEDIATE SQLCREATETB;
	 IF (ERROR_CNT = 0) THEN 	
	INSERT INTO #VT_FD_EXPORT_CHK
	SELECT 0 AS RETURN_VAL,'SUCCESS' AS RETURN_DESCR;
	ELSE
	INSERT INTO #VT_FD_EXPORT_CHK
	SELECT 1 AS RETURN_VAL, ERROR_MSG AS RETURN_DESCR;
	END IF;
END SP;