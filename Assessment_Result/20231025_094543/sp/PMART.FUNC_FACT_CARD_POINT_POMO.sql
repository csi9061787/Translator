REPLACE PROCEDURE PMART.FUNC_FACT_CARD_POINT_POMO
(
   IN P_GROUP VARCHAR(500),
   IN P_TIMEID VARCHAR(2000),
   IN P_ORGID VARCHAR(2000),
   IN P_CARDTYPE VARCHAR(500),
   IN P_POMO_ID VARCHAR(2000)
)
SP:BEGIN
   DECLARE SQLSTR  VARCHAR(2000);    
CALL PMART.P_DROP_TABLE ('#VT_FACT_CARD_POINT_POMO');
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FACT_CARD_POINT_POMO AS('
                          +' SELECT '
                          + CASE WHEN P_GROUP LIKE '%RESPON_ID%' THEN Replace(P_GROUP,'RESPON_ID','RESPON_ID AS ORG_ID') ELSE P_GROUP END +',SUM(SALE_QTY) SALE_QTY,SUM(SALE_AMT) SALE_AMT,SUM(TRAN_CNT) TRAN_CNT,SUM(ADD_POINT) ADD_POINT'
                          + ' FROM PMART.FACT_CARD_POINT_POMO'
        + CASE WHEN P_GROUP LIKE '%RESPON_ID%'  THEN  ' JOIN PMART.ORG_STORE ON ORG_ID=OSTORE_ID ' ELSE '' END
                          + ' WHERE ' 
                          + CASE WHEN TRIM(P_ORGID)='' AND POSITION('ORG_ID' IN P_GROUP)=0 THEN 'ORG_ID=-1 ' WHEN TRIM(P_ORGID)='' THEN '1=1'  ELSE 'ORG_ID IN('+P_ORGID+') ' END
                          + ' AND TIME_ID IN ('+P_TIMEID+')' 
                          + CASE WHEN TRIM(P_CARDTYPE)='' AND POSITION('CARD_TYPE' IN P_GROUP)=0 THEN ' AND CARD_TYPE=-1 ' WHEN TRIM(P_CARDTYPE)='' THEN ''  ELSE ' AND CARD_TYPE IN('+P_CARDTYPE+') ' END
                          + CASE WHEN TRIM(P_POMO_ID)='' AND POSITION('POMO_ID' IN P_GROUP)=0 THEN ' AND POMO_ID=-1 ' WHEN TRIM(P_POMO_ID)='' THEN ''  ELSE ' AND POMO_ID IN('+P_POMO_ID+') ' END
                          + ' GROUP BY '+  P_GROUP                     
                          + ' ) WITH DATA PRIMARY CHARINDEX('RESPON_ID','+CASE WHEN P_GROUP LIKE '%RESPON_ID%' THEN Replace(P_GROUP,'ORG_ID') ELSE P_GROUP END+') ON COMMIT PRESERVE ROWS;';
        INSERT INTO PMART.T1(F1,F2) SELECT 0,SQLSTR;
		EXECUTE IMMEDIATE SQLSTR;   
END SP;