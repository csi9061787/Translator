REPLACE PROCEDURE PMART.FUNC_FACT_CHGPOINT
(
   IN P_TIMEID VARCHAR(500),   			
   IN P_TIMETYPE VARCHAR(1),  		   
   IN P_YTYPE VARCHAR(1),         		  
   IN P_ORGTYPE INTEGER,          		 
   IN P_ORGID INTEGER,                		
   IN P_PRE_PRDTYPE INTEGER,     	 
   IN P_PRE_PRDID VARCHAR(10),      
   IN P_REP_PRDTYPE INTEGER,     	 
   IN P_REP_PRDID VARCHAR(10),      
   IN P_PAYTYPE VARCHAR(10),          		   
   IN P_ACTTYPE VARCHAR(10)       		
)
SP:
BEGIN
   DECLARE SQLSTR  VARCHAR(20000);
   DECLARE ORGWHERE_1 VARCHAR(500);
   DECLARE ORGWHERE_2 VARCHAR(500);
   DECLARE ORG_COL_1 VARCHAR(20);
   DECLARE ORG_COL_2 VARCHAR(20);
   DECLARE TIMEWHERE VARCHAR(500);
   DECLARE PREPRDWHERE VARCHAR(500);
   DECLARE REPPRDWHERE VARCHAR(500);
   DECLARE PRD_COL_1 VARCHAR(20);
   DECLARE PRD_COL_2 VARCHAR(20);
   DECLARE SELECTABLE VARCHAR(100);
   DECLARE Y_COL VARCHAR(40);
    CALL PMART.P_DROP_TABLE ('#VT_FACT_CHGPOINT');
       SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_FACT_CHGPOINT ,NO FALLBACK,NO JOURNAL,NO LOG ( '
	                     ||'DATA_TYPE  INTEGER, '
						 ||'TIME_ID  INTEGER, '
						 ||'Y_DIM  VARCHAR(50) CHARACTER SET UNICODE, '
					     ||' PAY_PAYCNT INTEGER, '
					     ||' PAY_PAYTXCNT INTEGER, '
					     ||' PAY_PAYQTY INTEGER, '
					     ||' PAY_PAYAMT DECIMAL(10,2), '
						 ||' CHG_CHGCNT INTEGER, '
					     ||' CHG_CHGTXCNT INTEGER, '
					     ||' CHG_CHGQTY INTEGER, '
					     ||' CHG_CHGPOINT DECIMAL(38,2) '	 
	                     ||')  PRIMARY INDEX(DATA_TYPE,TIME_ID,Y_DIM) ON COMMIT PRESERVE ROWS; ';
	EXECUTE IMMEDIATE SQLSTR;   
IF P_YTYPE = 'O'
   THEN 
   	IF P_ORGTYPE = 0  THEN
		SET ORG_COL_1 = ' PDEPT_ID ' ;
		SET ORG_COL_2 = ' DEPT_ID ';
	ELSEIF P_ORGTYPE = 1 THEN
		SET ORG_COL_1 = ' DEPT_ID ' ;
		SET ORG_COL_2 = ' BRANCH_ID ';
	ELSEIF P_ORGTYPE = 2 THEN
		SET ORG_COL_1 = ' BRANCH_ID ' ;
		SET ORG_COL_2 = ' RESPON_ID ';
	ELSEIF P_ORGTYPE = 3 THEN
		SET ORG_COL_1 = ' RESPON_ID ' ;
		SET ORG_COL_2 = ' OSTORE_ID ';
	ELSEIF P_ORGTYPE = 4 THEN
		SET ORG_COL_1 = ' OSTORE_ID ' ;
		SET ORG_COL_2 = ' OSTORE_ID ';
	ELSEIF P_ORGTYPE = -1 THEN
		SET ORG_COL_1 = ' TOT_ID ' ;
		SET ORG_COL_2 = ' PDEPT_ID ';
	END IF; 
	IF P_PRE_PRDTYPE = 1  THEN
		SET PRD_COL_1 = ' KND_ID ' ;
	ELSEIF P_PRE_PRDTYPE = 2 THEN
		SET PRD_COL_1 = ' GRP_ID ' ;
	ELSEIF P_PRE_PRDTYPE = 3 THEN
		SET PRD_COL_1 = ' PRD_ID ' ;
	ELSEIF P_PRE_PRDTYPE = -1 THEN
		SET PRD_COL_1 = ' TOT_ID ' ;
	END IF; 
	IF P_REP_PRDTYPE = 1  THEN
		SET PRD_COL_2 = ' KND_ID ' ;
	ELSEIF P_REP_PRDTYPE = 2 THEN
		SET PRD_COL_2 = ' GRP_ID ' ;
	ELSEIF P_REP_PRDTYPE = 3 THEN
		SET PRD_COL_2 = ' PRD_ID ' ;
	ELSEIF P_REP_PRDTYPE = -1 THEN
		SET PRD_COL_2 = ' TOT_ID ' ;
	END IF; 
	SET Y_COL = ' TO_CHAR(ORG_ID) ';
	IF P_ORGTYPE = 4 AND P_TIMETYPE = 'D' THEN
	SET SELECTABLE = ' PMART.FACT_ACTCODE_DTL ';
	ELSE 
	SET SELECTABLE = ' PMART.FACT_ACTCODE ';
	END IF; 
    SET PREPRDWHERE = 'AND PRE_FMCODE IN (SELECT DISTINCT PRD_ID FROM PMART.PRD_DIM WHERE '||PRD_COL_1||' = '''|| P_PRE_PRDID || ''') ';
    SET REPPRDWHERE = 'AND P_FMCODE IN (SELECT DISTINCT PRD_ID FROM PMART.PRD_DIM WHERE '||PRD_COL_2||' = '''|| P_REP_PRDID || ''') ';
ELSEIF 	P_YTYPE = 'P'
THEN 
   	IF P_ORGTYPE = 0  THEN
		SET ORG_COL_1 = ' PDEPT_ID ' ;
		SET ORG_COL_2 = ' PDEPT_ID ';
	ELSEIF P_ORGTYPE = 1 THEN
		SET ORG_COL_1 = ' DEPT_ID ' ;
		SET ORG_COL_2 = ' DEPT_ID ';
	ELSEIF P_ORGTYPE = 2 THEN
		SET ORG_COL_1 = ' BRANCH_ID ' ;
		SET ORG_COL_2 = ' BRANCH_ID ';
	ELSEIF P_ORGTYPE = 3 THEN
		SET ORG_COL_1 = ' RESPON_ID ' ;
		SET ORG_COL_2 = ' RESPON_ID ';
	ELSEIF P_ORGTYPE = 4 THEN
		SET ORG_COL_1 = ' OSTORE_ID ' ;
		SET ORG_COL_2 = ' OSTORE_ID ';
	ELSEIF P_ORGTYPE = -1 THEN
		SET ORG_COL_1 = ' TOT_ID ' ;
		SET ORG_COL_2 = ' TOT_ID ';
	END IF; 
	IF P_PRE_PRDTYPE = 1  THEN
		SET PRD_COL_1 = ' KND_ID ' ;
	ELSEIF P_PRE_PRDTYPE = 2 THEN
		SET PRD_COL_1 = ' GRP_ID ' ;
	ELSEIF P_PRE_PRDTYPE = 3 THEN
		SET PRD_COL_1 = ' PRD_ID ' ;
	ELSEIF P_PRE_PRDTYPE = -1 THEN
		SET PRD_COL_1 = ' TOT_ID ' ;
	END IF; 
	IF P_REP_PRDTYPE = 1  THEN
		SET PRD_COL_2 = ' KND_ID ' ;
	ELSEIF P_REP_PRDTYPE = 2 THEN
		SET PRD_COL_2 = ' GRP_ID ' ;
	ELSEIF P_REP_PRDTYPE = 3 THEN
		SET PRD_COL_2 = ' PRD_ID ' ;
	ELSEIF P_REP_PRDTYPE = -1 THEN
		SET PRD_COL_2 = ' TOT_ID ' ;
	END IF; 
	SET Y_COL = ' PRE_FMCODE ||'' X ''|| P_FMCODE ';
	SET SELECTABLE = ' PMART.FACT_ACTCODE ';
    SET PREPRDWHERE = 'AND PRE_FMCODE IN (SELECT DISTINCT PRD_ID FROM PMART.PRD_DIM WHERE '||PRD_COL_1||' = '''|| P_PRE_PRDID || ''') ';
    SET REPPRDWHERE = 'AND P_FMCODE IN (SELECT DISTINCT PRD_ID FROM PMART.PRD_DIM WHERE '||PRD_COL_2||' = '''|| P_REP_PRDID || ''') ';
END IF;	
   SET ORGWHERE_1 = 'AND ORG_ID IN (SELECT DISTINCT '||ORG_COL_1||' FROM PMART.LATEST_ORG_DIM WHERE '||ORG_COL_1||' = ' || P_ORGID  ||') ';
   SET ORGWHERE_2 = 'AND ORG_ID IN (SELECT DISTINCT '||ORG_COL_2||' FROM PMART.LATEST_ORG_DIM WHERE '||ORG_COL_1||' = ' || P_ORGID  ||') ';
   SET TIMEWHERE = 'AND TIME_ID IN (' || P_TIMEID || ')'; 
   SET SQLSTR = 'INSERT INTO #VT_FACT_CHGPOINT(DATA_TYPE,TIME_ID,Y_DIM,PAY_PAYCNT,PAY_PAYTXCNT,PAY_PAYQTY,PAY_PAYAMT, '
                       || ' CHG_CHGCNT, CHG_CHGTXCNT, CHG_CHGQTY, CHG_CHGPOINT '
                       || ' )';
   SET SQLSTR =SQLSTR 
					||'SELECT '
					||'CASE WHEN (TIME_ID<>-1 AND YDIM_ID<>CAST(-1 AS VARCHAR(2)))  THEN 4    '
					||'WHEN (TIME_ID=-1 AND YDIM_ID<>CAST(-1 AS VARCHAR(2)))  THEN 2    '
					||'WHEN (TIME_ID<>-1 AND YDIM_ID=CAST(-1 AS VARCHAR(2)))  THEN 3 	'	
					||'ELSE  1 END  AS DATA_TYPE ,  '
					||'A.*  '
					||'FROM ' 
					||'(SELECT '
					||'CAST(-1 AS INTEGER)  AS TIME_ID ,YDIM_ID  , '
					||'SUM(PAY_PAYCNT) AS PAY_PAYCNT,'
					||'SUM(PAY_PAYTXCNT) AS PAY_PAYTXCNT,'
					||'SUM(PAY_PAYQTY) AS PAY_PAYQTY,'
					||'SUM(PAY_PAYAMT) AS PAY_PAYAMT,'
					||'SUM(CHG_CHGCNT) AS CHG_CHGCNT,'
					||'SUM(CHG_CHGTXCNT) AS CHG_CHGTXCNT,'
					||'SUM(CHG_CHGQTY) AS CHG_CHGQTY,'
					||'SUM(CAST(CHG_CHGPOINT AS BIGINT)) AS CHG_CHGPOINT'
					||' FROM '
					||'( SELECT DISTINCT * FROM ('
					||'SELECT TIME_ID ,'||Y_COL||' AS YDIM_ID '
					||',PAY_MEM_CNT AS PAY_PAYCNT ,PAY_SUM AS PAY_PAYTXCNT'
					||',PAY_CNT AS PAY_PAYQTY,PAY_AMT AS PAY_PAYAMT '
					||',CHG_MEM_CNT AS CHG_CHGCNT,CHG_SUM AS CHG_CHGTXCNT'
					||', CHG_CNT AS CHG_CHGQTY ,CHG_POINT AS CHG_CHGPOINT'
					||' FROM ' || SELECTABLE
					||'WHERE 1=1 '
					||TIMEWHERE
					||ORGWHERE_1
					||PREPRDWHERE
					||REPPRDWHERE
					||'AND PAY_TYPE IN ('||P_PAYTYPE||')'
					||'AND ACT_TYPE IN (1,3,4) '
					||'UNION ALL '
					||'SELECT TIME_ID ,'||Y_COL||' AS YDIM_ID '
					||',PAY_MEM_CNT AS PAY_PAYCNT ,PAY_SUM AS PAY_PAYTXCNT'
					||',PAY_CNT AS PAY_PAYQTY,PAY_AMT AS PAY_PAYAMT '
					||',CHG_MEM_CNT AS CHG_CHGCNT,CHG_SUM AS CHG_CHGTXCNT'
					||', CHG_CNT AS CHG_CHGQTY ,CHG_POINT AS CHG_CHGPOINT'
					||' FROM ' || SELECTABLE
					||'WHERE 1=1 '
					||TIMEWHERE
					||ORGWHERE_2
					||PREPRDWHERE
					||REPPRDWHERE
					||'AND PAY_TYPE IN ('||P_PAYTYPE||')'
					||'AND ACT_TYPE IN (1,3,4)'
					||')F)A '
					||'GROUP BY YDIM_ID '
					||'UNION ALL '
					||' SELECT  TIME_ID ,YDIM_ID '
					||', SUM(PAY_PAYCNT) AS PAY_PAYCNT'
					||', SUM(PAY_PAYTXCNT) AS PAY_PAYTXCNT'
					||', SUM(PAY_PAYQTY) AS PAY_PAYQTY'
					||', SUM(PAY_PAYAMT) AS PAY_PAYAMT'
					||', SUM(CHG_CHGCNT) AS CHG_CHGCNT'
					||', SUM(CHG_CHGTXCNT) AS CHG_CHGTXCNT'
					||', SUM(CHG_CHGQTY) AS CHG_CHGQTY'
					||', SUM(CAST(CHG_CHGPOINT AS BIGINT)) AS CHG_CHGPOINT'
					||' FROM'
					||'('
					||'SELECT DISTINCT * FROM '
					||'( '
					||'SELECT TIME_ID ,'||Y_COL||' AS YDIM_ID  '
					||',PAY_MEM_CNT AS PAY_PAYCNT ,PAY_SUM AS PAY_PAYTXCNT'
					||',PAY_CNT AS PAY_PAYQTY,PAY_AMT AS PAY_PAYAMT '
					||',CHG_MEM_CNT AS CHG_CHGCNT,CHG_SUM AS CHG_CHGTXCNT'
					||', CHG_CNT AS CHG_CHGQTY ,CHG_POINT AS CHG_CHGPOINT'
					||' FROM  ' || SELECTABLE
					||'WHERE 1=1 '
					||TIMEWHERE
					||ORGWHERE_1
					||PREPRDWHERE
					||REPPRDWHERE
					||'AND PAY_TYPE IN ('||P_PAYTYPE||')'
					||'AND ACT_TYPE IN (1,3,4)'
					||'UNION ALL '
					||'SELECT TIME_ID ,'||Y_COL||' AS YDIM_ID  '
					||',PAY_MEM_CNT AS PAY_PAYCNT ,PAY_SUM AS PAY_PAYTXCNT'
					||',PAY_CNT AS PAY_PAYQTY,PAY_AMT AS PAY_PAYAMT '
					||',CHG_MEM_CNT AS CHG_CHGCNT,CHG_SUM AS CHG_CHGTXCNT'
					||', CHG_CNT AS CHG_CHGQTY ,CHG_POINT AS CHG_CHGPOINT'
					||' FROM  ' || SELECTABLE
					||'WHERE 1=1 '
					||TIMEWHERE
					||ORGWHERE_2
					||PREPRDWHERE
					||REPPRDWHERE
					||'AND PAY_TYPE IN ('||P_PAYTYPE||')'
					||'AND ACT_TYPE IN (1,3,4)'
					||') B )C'
					||'	GROUP BY TIME_ID, YDIM_ID'
					||')A'
					|| ' ;'
					;
	EXECUTE IMMEDIATE SQLSTR;  
END SP;