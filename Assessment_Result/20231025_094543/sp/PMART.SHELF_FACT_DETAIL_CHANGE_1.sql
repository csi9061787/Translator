REPLACE PROCEDURE PMART.SHELF_FACT_DETAIL_CHANGE_1 (IN P_DAY_ID NUMBER)
SQL SECURITY INVOKER
SP:BEGIN
  DECLARE SQLSTR  VARCHAR(4000) DEFAULT '';
  DECLARE P_L_DAY_ID NUMBER;
  DECLARE STORE_CS CURSOR FOR STORE_SQL;    
  DELETE FROM PTEMP.SHELF_FACT_DAY_CHANGE WHERE STYPE ='1' ;
  SET SQLSTR =' SELECT L_DAY_ID                        ' +
              '   FROM PMART.YMWD_TIME A INNER JOIN (  ' +
              '   SELECT DISTINCT TIME_ID_S,TIME_ID_E  ' +
              '     FROM PMART.SHELF_DIM A             ' +
              '    WHERE L_DAY_ID  =  '+P_DAY_ID+') B' +
              '       ON A.L_DAY_ID >= B.TIME_ID_S     ' +
              '      AND A.L_DAY_ID <= B.TIME_ID_E     ' +
              '    ORDER BY A.L_DAY_ID                 ' +
              '  '; 
  PREPARE STORE_SQL FROM SQLSTR;
  OPEN STORE_CS;  
  L1:
  WHILE (SQLCODE =0) 
  DO    
     L1_1:
        BEGIN 
         FETCH STORE_CS INTO P_L_DAY_ID ;
         IF SQLSTATE <> '00000' THEN LEAVE L1; END IF; 	   
         INSERT INTO PTEMP.SHELF_FACT_DAY_CHANGE (L_DAY_ID,STYPE,UPDATE_TIME) 
         VALUES (P_L_DAY_ID,'1' ,CURRENT_TIMESTAMP(0));          
DELETE FROM PMART.SHELF_DIM WHERE L_DAY_ID= P_L_DAY_ID ;
INSERT INTO PMART.SHELF_DIM
(L_DAY_ID
,TIME_ID_S
,TIME_ID_E
,SHELF_CLASS_ID
,SHELF_CLASS_NAME
,SHELF_TYPE_ID
,SHELF_TYPE_NAME
,SHELF_GROUP_ID
,SHELF_GROUP_NAME
,SHELF_ID
,SHELF_NAME
,PRD_ID
,FM_CODE
,PUBLISH_SEQ
,LAYER_NO
,STYLE
,SHELF_ID2
,SHELF_NAME2
,LAYER_NO2)
SELECT CAST(TO_CHAR(P.SCH_PUBLISH_DATE_DATE, 'YYYYMMDD') AS INTEGER) AS L_DAY_ID
      ,CAST(TO_CHAR(P.SCH_PUBLISH_DATE_DATE, 'YYYYMMDD') AS INTEGER) AS TIME_ID_S
      ,CAST(TO_CHAR(P.SCH_PUBLISH_DATE_DATE + INTERVAL '13' DAY,'YYYYMMDD') AS INTEGER) AS TIME_ID_E
      ,CAST(P.SHELF_CLASS_ID AS INTEGER) AS SHELF_CLASS_ID
      ,SHELF_CLASS_NAME
      ,CAST(P.SHELF_TYPE_ID AS INTEGER) AS SHELF_TYPE_ID
      ,SHELF_TYPE_NAME
      ,CAST(P.SHELF_GROUP_ID AS INTEGER) AS SHELF_GROUP_ID
      ,SHELF_GROUP_NAME
      ,CAST(P.SHELF_ID AS INTEGER) AS SHELF_ID
      ,SHELF_NAME
      ,CAST(P.FM_CODE AS INTEGER) AS PRD_ID
      ,P.FM_CODE AS FM_CODE
      ,M.PUBLISH_SEQ
      ,CAST(P.LAYER_NO AS INTEGER) AS LAYER_NO
      ,CAST(P.STYLE AS INTEGER) AS STYLE
      ,CAST(P.SHELF_ID2 AS INTEGER) AS SHELF_ID2
      ,SHELF_NAME2
      ,CAST(P.LAYER_NO2 AS INTEGER) AS LAYER_NO2
  FROM PSTAGE.DS_SHE_SHELF_PRD P INNER JOIN PSTAGE.DS_SHE_M_PUBLISH M 
    ON P.SCH_PUBLISH_DATE = M.SCH_PUBLISH_DATE_DATE 
   AND P.SHELF_GROUP_ID = M.SHELF_GROUP_ID
  WHERE P.SCH_PUBLISH_DATE = CAST(P_L_DAY_ID -19000000 AS DATE)
;
DELETE FROM PTEMP.TP1_DAY_STORE_SHELF_CHANGE;
DELETE FROM PTEMP.TP5_SHE_SHELF_STORE_CHANGE;
INSERT INTO PTEMP.TP1_DAY_STORE_SHELF_CHANGE
SELECT CAST(P_L_DAY_ID AS INTEGER) AS L_DAY_ID
      ,D.SHELF_GROUP_ID
      ,D.PRD_ID
      ,CAST(S.OSTORE_NO AS INTEGER) AS OSTORE_ID
  FROM PMART.SHELF_DIM D INNER JOIN PSTAGE.DS_SHE_SHELF_STORE S 
    ON S.SHELF_GROUP_ID = D.SHELF_GROUP_ID
 WHERE D.STYLE=1
   AND P_L_DAY_ID >= D.TIME_ID_S
   AND P_L_DAY_ID <= D.TIME_ID_E
UNION ALL
SELECT CAST(P_L_DAY_ID AS INTEGER) AS L_DAY_ID
      ,D.SHELF_GROUP_ID
      ,D.PRD_ID
      ,CAST(S.OSTORE_NO AS INTEGER) AS OSTORE_ID
  FROM PMART.SHELF_DIM D INNER JOIN (SELECT DISTINCT L_DAY_ID,TIME_ID_S,TIME_ID_E
                                             ,SHELF_CLASS_ID,SHELF_CLASS_NAME
                                             ,SHELF_TYPE_ID,SHELF_TYPE_NAME
                                             ,SHELF_GROUP_ID,SHELF_GROUP_NAME
                                             ,SHELF_ID,SHELF_NAME 
                                         FROM PMART.SHELF_DIM) D1 
    ON D1.L_DAY_ID=D.L_DAY_ID 
   AND D1.SHELF_CLASS_ID=D.SHELF_CLASS_ID 
   AND D1.SHELF_ID = D.SHELF_ID2 
  JOIN PSTAGE.DS_SHE_SHELF_STORE S 
    ON S.SHELF_GROUP_ID = D1.SHELF_GROUP_ID
 WHERE D.STYLE=2
   AND P_L_DAY_ID >= D.TIME_ID_S
   AND P_L_DAY_ID <= D.TIME_ID_E
;
DELETE FROM PSTAGE.ST_DAY_STORE_SHELF WHERE L_DAY_ID=CAST(P_L_DAY_ID AS INTEGER);
INSERT INTO PSTAGE.ST_DAY_STORE_SHELF 
(L_DAY_ID
,SHELF_GROUP_ID
,PRD_ID
,OSTORE_ID)
SELECT L_DAY_ID
      ,SHELF_GROUP_ID
      ,PRD_ID
      ,OSTORE_ID 
  FROM PTEMP.TP1_DAY_STORE_SHELF_CHANGE;
INSERT INTO PTEMP.TP5_SHE_SHELF_STORE_CHANGE
SELECT P_L_DAY_ID AS L_DAY_ID
, CAST(S.OSTORE_NO AS INTEGER) AS OSTORE_ID
,S.SHELF_CLASS_ID
,S.SHELF_TYPE_ID
,S.SHELF_GROUP_ID
  FROM PSTAGE.DS_SHE_SHELF_STORE S
;
DELETE FROM PSTAGE.ST_SHE_SHELF_STORE WHERE L_DAY_ID = P_L_DAY_ID ;
INSERT INTO PSTAGE.ST_SHE_SHELF_STORE(L_DAY_ID,OSTORE_ID,SHELF_CLASS_ID,SHELF_TYPE_ID,SHELF_GROUP_ID)
SELECT L_DAY_ID,OSTORE_ID,SHELF_CLASS_ID,SHELF_TYPE_ID,SHELF_GROUP_ID FROM PTEMP.TP5_SHE_SHELF_STORE_CHANGE;
         UPDATE PTEMP.SHELF_FACT_DAY_CHANGE
         SET FINISH_TIME = CURRENT_TIMESTAMP(0)
         WHERE L_DAY_ID = P_L_DAY_ID
         AND STYPE ='1'
         ;
     END L1_1;
  END WHILE L1;      
  CLOSE STORE_CS;
END SP;