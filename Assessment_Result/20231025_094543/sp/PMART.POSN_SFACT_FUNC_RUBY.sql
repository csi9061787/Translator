REPLACE PROCEDURE PMART.POSN_SFACT_FUNC_RUBY
(
FP_TIME_TYPE CHAR,         
FP_TIME_LIST VARCHAR(400), 
FP_ORG_LEVEL NUMBER,       
FP_ORG_LIST  VARCHAR(400), 
FP_MMA_LEVEL NUMBER,       
FP_MMA_ID    VARCHAR(400)  
)
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR     VARCHAR(4000);
   DECLARE V_REMD_SQL VARCHAR(400); 
   DECLARE V_TABLE_NAME2 VARCHAR(100); 
   DECLARE V_MMA VARCHAR(200); 
   DECLARE V_MMA_WHERE VARCHAR(200); 
   CALL PMART.P_DROP_TABLE ('#VT_POSN_SFACT_FUNC'); 
   SET V_REMD_SQL = '0';
   SET V_MMA = '0 AS MMA_ID, ';
   SET V_MMA_WHERE = ' ';
   IF (FP_MMA_LEVEL = 0 OR FP_MMA_LEVEL = 1) THEN 
      SET V_MMA ='A.MMA_ID AS MMA_ID, ';
      SET V_MMA_WHERE =' AND A.MMA_ID IN ('+ FP_MMA_ID +')';
      SET V_TABLE_NAME2 ='PMART.BASIC_MAST_FACT_SHOP ';
   ELSE 
      SET V_TABLE_NAME2 ='PMART.BASIC_MAST_FACT ';
   END IF;
   IF FP_TIME_TYPE = 'D' THEN
      IF FP_ORG_LEVEL=3 THEN 
        SET V_REMD_SQL ='SELECT UPLOAD_STNUM  FROM PMART.REMD_FACT WHERE L_DAY_ID = A.TIME_ID AND OSTORE_ID = Y.ORG_ID';
      ELSE
        SET V_REMD_SQL ='SELECT UPLOAD_STNUM  FROM PMART.REMD_FACT_SUM WHERE L_DAY_ID = A.TIME_ID AND ORG_ID = Y.ORG_ID';
      END IF;
   END IF;
   IF FP_TIME_TYPE = 'W' THEN
        IF FP_ORG_LEVEL=3 THEN 
        SET V_REMD_SQL ='SELECT SUM(UPLOAD_STNUM)  FROM PMART.REMD_FACT T, PMART.YMWD_TIME_W2 YW WHERE T.L_DAY_ID=YW.L_DAY_ID AND YW.L_WEEK_ID = A.TIME_ID AND OSTORE_ID = Y.ORG_ID AND T.L_DAY_ID <> TO_CHAR(CURRENT_DATE,''YYYYMMDD'') ';
      ELSE
        SET V_REMD_SQL ='SELECT SUM(UPLOAD_STNUM)  FROM PMART.REMD_FACT_SUM T, PMART.YMWD_TIME_W2 YW WHERE T.L_DAY_ID=YW.L_DAY_ID AND YW.L_WEEK_ID = A.TIME_ID AND ORG_ID = Y.ORG_ID AND T.L_DAY_ID <> TO_CHAR(CURRENT_DATE,''YYYYMMDD'') ';
      END IF;
   END IF;
   IF FP_TIME_TYPE = 'M' THEN
        IF FP_ORG_LEVEL=3 THEN 
          SET V_REMD_SQL ='SELECT SUM(UPLOAD_STNUM)  FROM PMART.REMD_FACT T, PMART.YMWD_TIME_W2 YW WHERE T.L_DAY_ID=YW.L_DAY_ID AND YW.L_MONTH_ID = A.TIME_ID AND OSTORE_ID = Y.ORG_ID AND T.L_DAY_ID <> TO_CHAR(CURRENT_DATE,''YYYYMMDD'') ';
      ELSE
          SET V_REMD_SQL ='SELECT SUM(UPLOAD_STNUM)  FROM PMART.REMD_FACT_SUM T, PMART.YMWD_TIME_W2 YW WHERE T.L_DAY_ID=YW.L_DAY_ID AND YW.L_MONTH_ID = A.TIME_ID AND ORG_ID = Y.ORG_ID AND T.L_DAY_ID <> TO_CHAR(CURRENT_DATE,''YYYYMMDD'')';
      END IF;
   END IF;
   SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_POSN_SFACT_FUNC  AS('+
      'SELECT    '+
      'A.TIME_ID AS TIME_ID,    '+
      'Y.ORG_ID AS ORG_ID,    '+
      ' '+V_MMA+' '+
      'BIT_EXTRACT(BIT_AND(A.MAST_STORE_NUM,Y.MASK)) AS MAST_STORE_NUM,   '+  
      '('+V_REMD_SQL+') AS STNUM_STORE_NUM  '+  
      'FROM '+
      V_TABLE_NAME2 +' A, PMART.LAST_ORG_DIM_MASK Y   '+
      ' WHERE '+
      ' A.TIME_ID IN (  '+ FP_TIME_LIST +'  )  '+
      V_MMA_WHERE +' '+
      ' AND Y.ORG_ID IN ( '+ FP_ORG_LIST +' )' +
      ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';
  EXECUTE IMMEDIATE SQLSTR;
END SP;