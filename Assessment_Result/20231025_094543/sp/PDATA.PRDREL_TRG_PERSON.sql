REPLACE  PROCEDURE PDATA.PRDREL_TRG_PERSON()
SP:BEGIN
	DECLARE V_JOB_ID BIGINT;
	DECLARE V_TRG_PERSON SMALLINT;
	DECLARE V_SQL VARCHAR(20000);
	SET V_JOB_ID = (SELECT JOB_ID FROM PTEMP.PRDREL_SET);
	SET V_TRG_PERSON = (SELECT TRG_PERSON FROM PTEMP.PRDREL_SET);
	CALL PMART.P_DROP_TABLE ('#VT_TRANS_MEM');
	IF V_TRG_PERSON = 2 THEN
		SET V_SQL = 
			'CREATE MULTISET VOLATILE TABLE #VT_TRANS_MEM AS(
			  SELECT T.TX_SEQ,T.MEMBER_ID,M.SEX ,CAST(M.BIRTHDAY AS DATE FORMAT ''YYYYMMDD'') AS BIRTHDAY, CAST(-1 AS INT) AS AGES
			  FROM PTEMP.PS_TRANS T
			    INNER JOIN PDATA.CRM_MEMBER M ON M.CUSTOMET_KD=''01'' AND M.CUSTOMER_NO=T.MEMBER_ID
			  WHERE T.MEMBER_ID IS NOT NULL)WITH DATA PRIMARY INDEX(TX_SEQ) ON COMMIT PRESERVE ROWS';
		EXECUTE IMMEDIATE V_SQL;
		SET V_SQL = 
			'UPDATE #VT_TRANS_MEM SET AGES = (CURRENT_DATE - BIRTHDAY) YEAR WHERE BIRTHDAY IS NOT NULL AND BIRTHDAY > (CURRENT_DATE- INTERVAL ''99'' YEAR)';
		EXECUTE IMMEDIATE V_SQL;
		SET V_SQL = 
			'UPDATE #VT_TRANS_MEM SET AGES = 100  WHERE BIRTHDAY IS NOT NULL AND AGES=0';
		EXECUTE IMMEDIATE V_SQL;
		SET V_SQL = 
			'UPDATE #VT_TRANS_MEM SET SEX = 2 WHERE SEX IS NULL';
		EXECUTE IMMEDIATE V_SQL;
		SET V_SQL = 
			'DELETE PTEMP.PS_TRANS
			WHERE TX_SEQ NOT IN (
			  SELECT TX_SEQ 
			  FROM #VT_TRANS_MEM A 
			    INNER JOIN PDATA.PRDREL_CAGE_SET B ON A.AGES BETWEEN B.AGE_BGN AND AGE_END
			    INNER JOIN PDATA.PRDREL_CSEX_SET C ON A.SEX = C.SEX_TYPE
			  WHERE B.JOB_ID = ' + V_JOB_ID + '
			    AND C.JOB_ID = ' + V_JOB_ID + ')';
		EXECUTE IMMEDIATE V_SQL;
		SET V_SQL = 
			'DELETE PTEMP.PS_TRANS_PRODUCT_DETAIL
			WHERE TX_SEQ NOT IN (
			  SELECT TX_SEQ 
			  FROM #VT_TRANS_MEM A 
			    INNER JOIN PDATA.PRDREL_CAGE_SET B ON A.AGES BETWEEN B.AGE_BGN AND AGE_END
			    INNER JOIN PDATA.PRDREL_CSEX_SET C ON A.SEX = C.SEX_TYPE
			  WHERE B.JOB_ID  = ' + V_JOB_ID + '
			    AND C.JOB_ID  = ' + V_JOB_ID + ')';
		EXECUTE IMMEDIATE V_SQL;
		SET V_SQL = 
			'DELETE PTEMP.PS_TRANS_MM_PROMO
			WHERE TX_SEQ NOT IN (
			  SELECT TX_SEQ 
			  FROM #VT_TRANS_MEM A 
			    INNER JOIN PDATA.PRDREL_CAGE_SET B ON A.AGES BETWEEN B.AGE_BGN AND AGE_END
			    INNER JOIN PDATA.PRDREL_CSEX_SET C ON A.SEX = C.SEX_TYPE
			  WHERE B.JOB_ID  = ' + V_JOB_ID + '
			    AND C.JOB_ID  = ' + V_JOB_ID + ')';
		EXECUTE IMMEDIATE V_SQL;
	END IF;
END SP;