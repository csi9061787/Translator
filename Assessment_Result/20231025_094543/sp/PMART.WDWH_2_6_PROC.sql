REPLACE  PROCEDURE PMART.WDWH_2_6_PROC
(
	P_DAY_ID INTEGER
)            
SQL SECURITY INVOKER
SP:BEGIN
	DECLARE VCOUNTOFITEMS INTEGER;
	DECLARE VFILTER_TERM INTEGER;
	DECLARE VFILTER_VAL INTEGER;
	DECLARE VEMP_NO VARCHAR(10);
	DECLARE CURSOR1 CURSOR FOR 
		SELECT FILTER_TERM, FILTER_VAL, EMP_NO
		FROM PDATA.WDWH_2_5_FILTER
		WHERE MAIL_ENABLE = 1;
	SELECT COUNT(*) INTO VCOUNTOFITEMS FROM PDATA.WDWH_2_5_FILTER WHERE MAIL_ENABLE = 1;
	IF VCOUNTOFITEMS <> 0 THEN
		OPEN CURSOR1;
		LABEL1:
			LOOP FETCH CURSOR1 INTO VFILTER_TERM, VFILTER_VAL, VEMP_NO ;
				IF VFILTER_TERM = 0 THEN
					INSERT INTO PMART.WDWH_2_6_DATA_D (L_DAY_ID, OSTORE_ID, PRD_ID, STK_STD, STK_CNT_INST, UNUSUAL_VAL, EMP_NO)
					SELECT DAY_ID, OST_NO, PRD_ID, STK_STD, STK_CNT_INST, ROUND(UNUSUAL_VAL, 0) UNUSUAL_VAL, VEMP_NO EMP_NO
					FROM (
						SELECT A.DAY_ID, A.OST_NO, A.PRD_ID, NVL(A.STK_STD,0) STK_STD, NVL(A.STK_CNT_INST,0) STK_CNT_INST,
						CASE WHEN NVL(A.STK_STD,0) <> 0 THEN (NVL(A.STK_CNT_INST,0) / NVL(A.STK_STD,0)) ELSE 0 END UNUSUAL_VAL
						FROM PMART.WDWH_STK_INST_STD A
						JOIN (
							SELECT B.PRD_ID
							FROM PDATA.WDWH_2_5_PRDSET A
							JOIN PMART.PRD_DIM B ON A.PRD_NO = B.GRP_NO
							WHERE A.EMP_NO = VEMP_NO
							AND A.PRD_TYPE = 0 
							UNION
							SELECT B.PRD_ID
							FROM PDATA.WDWH_2_5_PRDSET A
							JOIN PMART.PRD_DIM B ON A.PRD_NO = B.PRD_NO
							WHERE A.EMP_NO = VEMP_NO
							AND A.PRD_TYPE = 1 
						) 
						B ON A.PRD_ID = B.PRD_ID
					) X 
					WHERE STK_CNT_INST >= 0  
					AND UNUSUAL_VAL > VFILTER_VAL; 
				ELSEIF VFILTER_TERM = 1 THEN
					INSERT INTO PMART.WDWH_2_6_DATA_D (L_DAY_ID, OSTORE_ID, PRD_ID, STK_STD, STK_CNT_INST, UNUSUAL_VAL, EMP_NO)
					SELECT DAY_ID, OST_NO, PRD_ID, STK_STD, STK_CNT_INST, UNUSUAL_VAL, VEMP_NO EMP_NO
					FROM (
						SELECT A.DAY_ID, A.OST_NO, A.PRD_ID, NVL(A.STK_STD,0) STK_STD, NVL(A.STK_CNT_INST,0) STK_CNT_INST,
						'' UNUSUAL_VAL
						FROM PMART.WDWH_STK_INST_STD A
						JOIN (
							SELECT B.PRD_ID
							FROM PDATA.WDWH_2_5_PRDSET A
							JOIN PMART.PRD_DIM B ON A.PRD_NO = B.GRP_NO
							WHERE EMP_NO = VEMP_NO
							AND PRD_TYPE = 0 
							UNION
							SELECT B.PRD_ID
							FROM PDATA.WDWH_2_5_PRDSET A
							JOIN PMART.PRD_DIM B ON A.PRD_NO = B.PRD_NO
							WHERE A.EMP_NO = VEMP_NO
							AND A.PRD_TYPE = 1 
						) B 
						ON A.PRD_ID = B.PRD_ID
					) X 
					WHERE STK_CNT_INST < 0;
				ELSEIF VFILTER_TERM = 2 THEN
					INSERT INTO PMART.WDWH_2_6_DATA_D (L_DAY_ID, OSTORE_ID, PRD_ID, STK_STD, STK_CNT_INST, UNUSUAL_VAL, EMP_NO)
					SELECT DAY_ID, OST_NO, PRD_ID, STK_STD, STK_CNT_INST,
					CASE WHEN STK_CNT_INST < 0 THEN '' ELSE TO_CHAR(ROUND(UNUSUAL_VAL, 0)) END UNUSUAL_VAL, VEMP_NO EMP_NO
					FROM (
						SELECT A.DAY_ID, A.OST_NO, A.PRD_ID, NVL(A.STK_STD,0) STK_STD, NVL(A.STK_CNT_INST,0) STK_CNT_INST,
						CASE WHEN NVL(A.STK_STD,0) <> 0 THEN (NVL(A.STK_CNT_INST,0) / NVL(A.STK_STD,0)) ELSE 0 END UNUSUAL_VAL
						FROM PMART.WDWH_STK_INST_STD A
						JOIN (
							SELECT B.PRD_ID
							FROM PDATA.WDWH_2_5_PRDSET A
							JOIN PMART.PRD_DIM B ON A.PRD_NO = B.GRP_NO
							WHERE A.EMP_NO = VEMP_NO
							AND A.PRD_TYPE = 0 
							UNION
							SELECT B.PRD_ID
							FROM PDATA.WDWH_2_5_PRDSET A
							JOIN PMART.PRD_DIM B ON A.PRD_NO = B.PRD_NO
							WHERE A.EMP_NO = VEMP_NO
							AND A.PRD_TYPE = 1 
						) B 
						ON A.PRD_ID = B.PRD_ID
					) X
					WHERE STK_CNT_INST < 0 OR UNUSUAL_VAL > VFILTER_VAL;
				END IF;
				INSERT INTO PMART.WDWH_2_6_DATA_M
				SELECT L_DAY_ID, COUNT(DISTINCT OSTORE_ID), COUNT(L_DAY_ID), VFILTER_TERM, VFILTER_VAL, VEMP_NO, CURRENT_TIMESTAMP(0)
				FROM PMART.WDWH_2_6_DATA_D
				WHERE L_DAY_ID = P_DAY_ID
				AND EMP_NO = VEMP_NO
				GROUP BY L_DAY_ID;
				SELECT VCOUNTOFITEMS-1 INTO VCOUNTOFITEMS; 
                IF VCOUNTOFITEMS = 0 THEN 
                        LEAVE LABEL1;
                END IF;
            END LOOP LABEL1;
			INSERT INTO PMART.WDWH_2_6_DATA_M
			SELECT L_DAY_ID, COUNT(DISTINCT OSTORE_ID), COUNT(L_DAY_ID), VFILTER_TERM FILTER_TERM, VFILTER_VAL FILTER_VAL, VEMP_NO EMP_NO, CURRENT_TIMESTAMP(0)
			FROM PMART.WDWH_2_6_DATA_D
			WHERE L_DAY_ID = P_DAY_ID
			AND EMP_NO = VEMP_NO
			GROUP BY L_DAY_ID;
		CLOSE CURSOR1;
		DELETE FROM PMART.WDWH_2_6_DATA_M
		WHERE L_DAY_ID <= CAST(((CAST(CAST(P_DAY_ID AS VARCHAR(8)) AS DATE FORMAT 'YYYYMMDD')  - INTERVAL '7' DAY) (FORMAT 'YYYYMMDD')) AS VARCHAR(10));
		DELETE FROM PMART.WDWH_2_6_DATA_D
		WHERE L_DAY_ID <= CAST(((CAST(CAST(P_DAY_ID AS VARCHAR(8)) AS DATE FORMAT 'YYYYMMDD')  - INTERVAL '7' DAY) (FORMAT 'YYYYMMDD')) AS VARCHAR(10));
	END IF;
END SP;