REPLACE PROCEDURE PMART.POS_4_2_FUNC
(
	P_DAY_ID INTEGER,
	P_ORDER_STAGE VARCHAR(1)
)
SQL SECURITY INVOKER
SP:BEGIN
INSERT INTO PDATA.ORDER_DTLFACT
WITH
MAX_ (SEQ1) AS
(
SELECT NVL(MAX(SEQ1), 0)
  FROM PDATA.ORDER_DTLFACT
)
, ORD (L_DAY_ID, STORE_ID, PRD_ID, SEQ1, BASE_CNT, SC_UNITS, FINAL_UNITS, RESULT_ID, SRC_ID, ORDER_STAGE, ORDER_STATE) AS
(
SELECT A.L_DAY_ID, A.STORE_ID, A.PRD_ID
	, ROW_NUMBER() OVER(ORDER BY A.L_DAY_ID, A.STORE_ID, A.PRD_ID) + MAX_.SEQ1
	, B.QT_DRDBASE
	, CASE WHEN A.ORDER_SRC   IN ('O','A')        THEN A.ORDER_MQTY ELSE 0 END
	, CASE WHEN A.ORDER_STATE IN ('00','28','29') THEN A.ORDER_MQTY ELSE 0 END
	, CASE WHEN A.ORDER_SRC   NOT IN ('O','A')    THEN '99'
	       WHEN A.ORDER_STATE <> '00'             THEN A.ORDER_STATE
		   ELSE '' END
	, CASE WHEN A.ORDER_STATE IN ('00','28','29') AND A.ORDER_SRC IN ('O')     THEN '' 
	       WHEN A.ORDER_STATE IN ('00','28','29') OR  A.ORDER_SRC IN ('O','A') THEN A.ORDER_SRC
		   ELSE '' END
	, A.ORDER_STAGE
	, A.ORDER_STATE
  FROM PDATA.ORDDETAIL A
 INNER JOIN PDATA.PBMCMDT B ON B.FM_CODE = A.PRD_ID
 INNER JOIN PMART.LATEST_ORG_DIM C ON C.STORE_ID = A.STORE_ID
 INNER JOIN MAX_ ON 1 = 1
 WHERE A.L_DAY_ID = P_DAY_ID
     AND  A.ORDER_STAGE = P_ORDER_STAGE
)
, FNL (L_DAY_ID, STORE_ID, PRD_ID, SEQ1, BASE_CNT, SC_UNITS, FINAL_UNITS, RESULT_ID, SRC_ID, ORDER_STAGE) AS
(
SELECT L_DAY_ID, STORE_ID, PRD_ID, SEQ1, BASE_CNT, SC_UNITS, FINAL_UNITS, RESULT_ID, SRC_ID, ORDER_STAGE
  FROM ORD
 WHERE ORDER_STATE IN ('00','28','29')
)
, UNI (L_DAY_ID, STORE_ID, PRD_ID, SEQ1, BASE_CNT, SC_UNITS, FINAL_UNITS, RESULT_ID, SRC_ID, ORDER_STAGE) AS
(
SELECT L_DAY_ID, STORE_ID, PRD_ID, MAX(SEQ1), MAX(BASE_CNT), MAX(SC_UNITS), MAX(FINAL_UNITS), MAX(RESULT_ID), MAX(SRC_ID), ORDER_STAGE
  FROM
(
SELECT U.*, F.L_DAY_ID EXISTED_DATE
  FROM ORD U
 LEFT JOIN FNL F ON F.L_DAY_ID = U.L_DAY_ID AND F.STORE_ID = U.STORE_ID AND F.PRD_ID = U.PRD_ID
 WHERE ORDER_STATE NOT IN ('00','28','29')
) T
 WHERE EXISTED_DATE IS NULL
 GROUP BY L_DAY_ID, STORE_ID, PRD_ID, ORDER_STAGE
)
, RST (L_DAY_ID, STORE_ID, PRD_ID, SEQ1, BASE_CNT, SC_UNITS, FINAL_UNITS, RESULT_ID, SRC_ID, ORDER_STAGE) AS
(
SELECT *
  FROM FNL
 UNION ALL
SELECT *
  FROM UNI
)
SELECT RST.*
  FROM RST;
END SP;