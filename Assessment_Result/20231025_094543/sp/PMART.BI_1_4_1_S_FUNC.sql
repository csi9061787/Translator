REPLACE PROCEDURE PMART.BI_1_4_1_S_FUNC
(
   IN P_TIME_ID NUMBER,
   IN P_LEVEL NUMBER,
   IN P_ORG_ID NUMBER,
   IN P_PRD_LIST VARCHAR(200),
   IN P_SELECT_PRD_DIM_VALUE NUMBER
)
SQL SECURITY INVOKER
SP:BEGIN
	DECLARE SQLSTR VARCHAR(1000);
	DECLARE SQLSTR_ORG VARCHAR(400);
	DECLARE SQLSTR_TABLE VARCHAR(100);
	CALL PMART.P_DROP_TABLE ('#VT_BI_1_4_1_S_FUNC');
	IF P_LEVEL = -1 THEN
		SET SQLSTR_ORG = 'SELECT DISTINCT STORE_ID FROM PMART.LAST_ORG_DIM WHERE TOT_ID=-1';
	ELSEIF P_LEVEL = 0 THEN
		SET SQLSTR_ORG = 'SELECT DISTINCT STORE_ID FROM PMART.LAST_ORG_DIM WHERE PDEPT_ID=' + P_ORG_ID;
	ELSEIF P_LEVEL = 1 THEN
		SET SQLSTR_ORG = 'SELECT DISTINCT STORE_ID FROM PMART.LAST_ORG_DIM WHERE DEPT_ID=' + P_ORG_ID;
	ELSEIF P_LEVEL = 2 THEN
		SET SQLSTR_ORG = 'SELECT DISTINCT STORE_ID FROM PMART.LAST_ORG_DIM WHERE BRANCH_ID=' + P_ORG_ID;
	END IF;
	IF P_SELECT_PRD_DIM_VALUE = 1 THEN
		SET SQLSTR_TABLE = ' PMART.BASIC_MFACT ';
	ELSE 
		SET SQLSTR_TABLE = ' PMART.BASIC_MLFACT ';
	END IF;
	SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_BI_1_4_1_S_FUNC  AS( ' 
						+ ' SELECT TIME_ID, ORG_ID, PRD_ID, ORDER_CNT, SALES_CNT, THROW_CNT '
						+ ' FROM ' + SQLSTR_TABLE 
						+ ' WHERE PRD_ID IN ('+ PMART.CONVERT_STRING_LIST(P_PRD_LIST) +') '
						+ ' AND ORG_ID IN ('+ SQLSTR_ORG +') '
						+ ' AND TIME_ID = '+ P_TIME_ID
						+ ' ) WITH DATA PRIMARY  CHARINDEX( ORG_ID,PRD_ID) ON COMMIT PRESERVE ROWS;'; 	 
	EXECUTE IMMEDIATE SQLSTR;  
END SP;