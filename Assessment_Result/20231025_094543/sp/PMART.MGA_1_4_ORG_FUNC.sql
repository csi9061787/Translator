REPLACE PROCEDURE PMART.MGA_1_4_ORG_FUNC
(
	IN P_INPUTTYPE INTEGER, 		
	IN P_ORGID INTEGER
)
SQL SECURITY INVOKER
SP:BEGIN
	DECLARE SQLSTR VARCHAR(4000)  DEFAULT '';
	DECLARE SQL_TOT_ID     VARCHAR(4000)  DEFAULT '';
	DECLARE SQL_PDEPT_ID   VARCHAR(4000)  DEFAULT '';
	DECLARE SQL_DEPT_ID    VARCHAR(4000)  DEFAULT '';
	DECLARE SQL_BRANCH_ID  VARCHAR(4000)  DEFAULT '';
	DECLARE SQL_RESPON_ID  VARCHAR(4000)  DEFAULT '';
	DECLARE SQL_OSTORE_ID  VARCHAR(4000)  DEFAULT '';
	DECLARE SQL_WHEREPDEPT_ID   VARCHAR(4000)  DEFAULT '';
	DECLARE SQL_WHEREDEPT_ID    VARCHAR(4000)  DEFAULT '';
	DECLARE SQL_WHEREBRANCH_ID  VARCHAR(4000)  DEFAULT '';
	DECLARE SQL_WHERERESPON_ID  VARCHAR(4000)  DEFAULT '';
	DECLARE SQL_WHEREOSTORE_ID  VARCHAR(4000)  DEFAULT '';
	CALL PMART.P_DROP_TABLE('#VT_MGA_1_4_ORG_FUNC');	  
	SET SQL_TOT_ID = 'SELECT PARENT_ORG_ID,ORG_ID,ORG_VAL,ORG_NM,ORG_NO,ALLOW_DRILL_DOWN,ORG_LEVEL,DRILL_ORG_LEVEL,DRILL_ORG_ID '+
		'FROM ( '+
			'SELECT X.* '+
			'FROM ( '+
				'SELECT 0 AS SEQ, CAST(-2 AS INTEGER) AS PARENT_ORG_ID, CAST(-1 AS INTEGER) AS ORG_ID, CAST(-1 AS INTEGER) AS ORG_VAL, CAST('''+'全公司'+''' AS VARCHAR(100)) AS ORG_NM, CAST(''-1'' AS VARCHAR(10)) AS ORG_NO '+
				',''N'' AS ALLOW_DRILL_DOWN,-1 AS ORG_LEVEL,-2 AS DRILL_ORG_LEVEL, CAST(-2 AS INTEGER) AS DRILL_ORG_ID '+ 
			') X ' +
			'UNION ALL ' +
			'SELECT ROW_NUMBER() OVER (ORDER BY ORG_ID  ) AS SEQ ,A.*  '+
			'FROM ( '+
				'SELECT DISTINCT -1 AS PARENT_ORG_ID, D.PDEPT_ID AS ORG_ID, D.PDEPT_ID AS ORG_VAL '+
				',T.DEPT_SNAME AS ORG_NM, D.PDEPT_NO AS ORG_NO, ''Y'' AS ALLOW_DRILL_DOWN '+
				',0 AS ORG_LEVEL, 0 AS DRILL_ORG_LEVEL, D.PDEPT_ID AS DRILL_ORG_ID '+
				'FROM PMART.LATEST_ORG_DIM D '+
				'JOIN PDATA.PBMDEPT T ON D.PDEPT_NO = T.DEPT_ID '+
				'WHERE T.DEPT_LEVEL = ''1'' '+
				'AND T.EXIST_FLAG = ''Y'' '+
				'AND T.STORE_ACC_ID IS NOT NULL '+
			') A ';
	IF P_INPUTTYPE = 1 THEN 
		 SET SQL_WHEREPDEPT_ID  =' AND D.PDEPT_ID = ' + P_ORGID;
		 SET SQL_WHEREDEPT_ID   =' AND D.PDEPT_ID = ' + P_ORGID;
		 SET SQL_WHEREBRANCH_ID =' AND D.PDEPT_ID = ' + P_ORGID;
		 SET SQL_WHERERESPON_ID =' AND D.PDEPT_ID = ' + P_ORGID;
		 SET SQL_WHEREOSTORE_ID =' AND D.PDEPT_ID = ' + P_ORGID;
	END IF;
	IF P_INPUTTYPE = 2 THEN 
		SET SQL_WHEREPDEPT_ID  =' AND D.DEPT_ID =' + P_ORGID;
		SET SQL_WHEREDEPT_ID   =' AND D.DEPT_ID =' + P_ORGID;
		SET SQL_WHEREBRANCH_ID =' AND D.DEPT_ID =' + P_ORGID;
		SET SQL_WHERERESPON_ID =' AND D.DEPT_ID =' + P_ORGID;
		SET SQL_WHEREOSTORE_ID =' AND D.DEPT_ID =' + P_ORGID;
	END IF;
	IF P_INPUTTYPE = 3 THEN 
		SET SQL_WHEREPDEPT_ID  =' AND D.BRANCH_ID =' + P_ORGID;
		SET SQL_WHEREDEPT_ID   =' AND D.BRANCH_ID =' + P_ORGID;
		SET SQL_WHEREBRANCH_ID =' AND D.BRANCH_ID =' + P_ORGID;
		SET SQL_WHERERESPON_ID =' AND D.BRANCH_ID =' + P_ORGID;
		SET SQL_WHEREOSTORE_ID =' AND D.BRANCH_ID =' + P_ORGID;
	END IF;
	IF P_INPUTTYPE = 4 THEN 
		SET SQL_WHEREPDEPT_ID  =' AND D.RESPON_ID =' + P_ORGID;
		SET SQL_WHEREDEPT_ID   =' AND D.RESPON_ID =' + P_ORGID;
		SET SQL_WHEREBRANCH_ID =' AND D.RESPON_ID =' + P_ORGID;
		SET SQL_WHERERESPON_ID =' AND D.RESPON_ID =' + P_ORGID;
		SET SQL_WHEREOSTORE_ID =' AND D.RESPON_ID =' + P_ORGID;
	END IF;
	IF P_INPUTTYPE = 5 THEN 
		SET SQL_WHEREPDEPT_ID  =' AND D.OSTORE_ID =' + P_ORGID;
		SET SQL_WHEREDEPT_ID   =' AND D.OSTORE_ID =' + P_ORGID;
		SET SQL_WHEREBRANCH_ID =' AND D.OSTORE_ID =' + P_ORGID;
		SET SQL_WHERERESPON_ID =' AND D.OSTORE_ID =' + P_ORGID;
		SET SQL_WHEREOSTORE_ID =' AND D.OSTORE_ID =' + P_ORGID;
	END IF;
	IF (P_INPUTTYPE>=1 AND P_INPUTTYPE<=5) THEN 
		SET SQL_PDEPT_ID = ' UNION ALL ' + 
			'SELECT ROW_NUMBER() OVER (ORDER BY ORG_ID) AS SEQ ,B.*  ' +
			'FROM ( ' +
				'SELECT DISTINCT D.PDEPT_ID AS PARENT_ORG_ID, D.DEPT_ID AS ORG_ID, D.DEPT_ID AS ORG_VAL ' +
				',T.DEPT_SNAME AS ORG_NM, D.DEPT_NO AS ORG_NO, ''Y'' AS ALLOW_DRILL_DOWN ' +
				',1 AS ORG_LEVEL, 1 AS DRILL_ORG_LEVEL, D.DEPT_ID AS DRILL_ORG_ID ' +
				'FROM PMART.LATEST_ORG_DIM D ' +
				'JOIN PDATA.PBMDEPT T ON D.PDEPT_NO = T.PARENT_DEPT_ID AND D.DEPT_NO=T.DEPT_ID ' +
				'WHERE T.DEPT_LEVEL = ''2'' ' +
				'AND T.EXIST_FLAG = ''Y'' ' +
				'AND T.STORE_ACC_ID IS NOT NULL ' +
				' '+ SQL_WHEREPDEPT_ID +' '+
			') B ';
	END IF;
	IF (P_INPUTTYPE>=2 AND P_INPUTTYPE<=5)  THEN 
		SET SQL_DEPT_ID = ' UNION ALL ' + 
			'SELECT ROW_NUMBER() OVER (ORDER BY ORG_ID) AS SEQ ,C.*  ' +
			'FROM (  ' +
				'SELECT DISTINCT D.DEPT_ID AS PARENT_ORG_ID, D.BRANCH_ID AS ORG_ID, D.BRANCH_ID AS ORG_VAL, ' +
				'T.DEPT_SNAME AS ORG_NM, D.BRANCH_NO AS ORG_NO, ''Y'' AS ALLOW_DRILL_DOWN, ' +
				'2 AS ORG_LEVEL, 2 AS DRILL_ORG_LEVEL, D.BRANCH_ID AS DRILL_ORG_ID ' +
				'FROM PMART.LATEST_ORG_DIM D ' +
				'JOIN PDATA.PBMDEPT T ON D.DEPT_NO = T.PARENT_DEPT_ID AND D.BRANCH_NO=T.DEPT_ID ' +
				'WHERE T.DEPT_LEVEL = ''3'' ' +
				'AND T.EXIST_FLAG = ''Y'' ' +
				'AND T.STORE_ACC_ID IS NOT NULL ' +
				' '+ SQL_WHEREPDEPT_ID +' '+
			') C ';
	END IF;
	IF (P_INPUTTYPE>=3 AND P_INPUTTYPE<=5)  THEN  
		IF (P_INPUTTYPE>=4 AND P_INPUTTYPE<=5) THEN
			SET SQL_BRANCH_ID =' UNION ALL '+ 
				'SELECT ROW_NUMBER() OVER (ORDER BY ORG_ID) AS SEQ ,D.*  '+
				'FROM ( '+
					'SELECT DISTINCT D.BRANCH_ID AS PARENT_ORG_ID, D.RESPON_ID AS ORG_ID, D.RESPON_ID AS ORG_VAL, '+
					'P.EMP_NAME AS ORG_NM, D.RESPON_NO AS ORG_NO, ''Y'' AS ALLOW_DRILL_DOWN, '+
					'3 AS ORG_LEVEL, 3 AS DRILL_ORG_LEVEL, D.RESPON_ID AS DRILL_ORG_ID '+
					'FROM PMART.LATEST_ORG_DIM D '+
					'JOIN PDATA.PBMEMP P ON D.RESPON_NO = P.EMP_NO '+
					'WHERE P.QUIT_DATE = TO_DATE(''99991231'',''YYYYMMDD'') '+
					'AND D.OPNDT <> 99999999 '+
					' '+ SQL_WHEREBRANCH_ID +' '+
				') D  '+
				'UNION ALL '+
				'SELECT DISTINCT 99 AS SEQ, D.BRANCH_ID AS PARENT_ORG_ID, TO_NUMBER(''999''+SUBSTRING(TO_CHAR(D.BRANCH_ID),2,6)) AS ORG_ID,TO_NUMBER(''999''+SUBSTRING(TO_CHAR(D.BRANCH_ID),2,6))  AS ORG_VAL, '+
				'CAST('''+'已閉店'+''' AS VARCHAR(100)) AS ORG_NM, ''999''+SUBSTRING(TO_CHAR(D.BRANCH_ID),2,6) AS ORG_NO, ''Y'' AS ALLOW_DRILL_DOWN, '+
				'3 AS ORG_LEVEL, 3 AS DRILL_ORG_LEVEL, TO_NUMBER(''999''+SUBSTRING(TO_CHAR(D.BRANCH_ID),2,6)) AS DRILL_ORG_ID '+
				'FROM PMART.LATEST_ORG_DIM D '+
				'WHERE D.BRANCH_ID = '+ 
				' '+ P_ORGID +' '
			;
		ELSE
			SET SQL_BRANCH_ID =' UNION ALL  '+ 
				'SELECT ROW_NUMBER() OVER (ORDER BY ORG_ID) AS SEQ ,D.*  '+
				'FROM ( '+
					'SELECT DISTINCT D.BRANCH_ID AS PARENT_ORG_ID, D.RESPON_ID AS ORG_ID, D.RESPON_ID AS ORG_VAL, '+
					'P.EMP_NAME AS ORG_NM, D.RESPON_NO AS ORG_NO, ''Y'' AS ALLOW_DRILL_DOWN, '+
					'3 AS ORG_LEVEL, 3 AS DRILL_ORG_LEVEL, D.RESPON_ID AS DRILL_ORG_ID '+
					'FROM PMART.LATEST_ORG_DIM D '+
					'JOIN PDATA.PBMEMP P ON D.RESPON_NO = P.EMP_NO '+
					'WHERE P.QUIT_DATE = TO_DATE(''99991231'',''YYYYMMDD'') '+
					'AND D.OPNDT <> 99999999 '+
					' '+ SQL_WHEREBRANCH_ID +' '+
				') D '+
				'UNION ALL '+
				'SELECT DISTINCT 99 AS SEQ, D.BRANCH_ID AS PARENT_ORG_ID, TO_NUMBER(''999''+SUBSTRING(TO_CHAR(D.BRANCH_ID),2,6)) AS ORG_ID,TO_NUMBER(''999''+SUBSTRING(TO_CHAR(D.BRANCH_ID),2,6))  AS ORG_VAL, '+
				'CAST('''+'已閉店'+''' AS VARCHAR(100))  AS ORG_NM, ''999''+SUBSTRING(TO_CHAR(D.BRANCH_ID),2,6) AS ORG_NO, ''Y'' AS ALLOW_DRILL_DOWN, '+
				'3 AS ORG_LEVEL, 3 AS DRILL_ORG_LEVEL, TO_NUMBER(''999''+SUBSTRING(TO_CHAR(D.BRANCH_ID),2,6)) AS DRILL_ORG_ID '+
				'FROM PMART.LATEST_ORG_DIM D '+
				'WHERE 1=1 ' +
				' '+ SQL_WHEREBRANCH_ID +' '
			;
		END IF;
	END IF;
	IF (P_INPUTTYPE>=4 AND P_INPUTTYPE<=5) THEN
		IF  (P_INPUTTYPE=5) THEN
			IF SUBSTRING(TO_CHAR(P_ORGID),1,3) <> '999' THEN
				SET SQL_RESPON_ID ='  UNION ALL '+ 
					'SELECT ROW_NUMBER() OVER (ORDER BY LPAD(TO_CHAR(ORG_ID),5,''0'')) AS SEQ,E.* '+
					'FROM ( '+
						'SELECT DISTINCT D.RESPON_ID AS PARENT_ORG_ID, D.OSTORE_ID AS ORG_ID, D.OSTORE_ID AS ORG_VAL, '+
						'D.STORE_NO+''_''+D.STORE_NM AS ORG_NM, D.STORE_NO AS ORG_NO, ''N'' AS ALLOW_DRILL_DOWN, '+
						'4 AS ORG_LEVEL, 4 AS DRILL_ORG_LEVEL, D.STORE_ID AS DRILL_ORG_ID '+
						'FROM PMART.LAST_ORG_DIM D '+
						'JOIN PDATA.PBMEMP P ON D.RESPON_ID = P.EMP_NO '+
						'WHERE D.RESPON_ID= '+
						' '+ P_ORGID +' '
					') E '
					;
			ELSEIF SUBSTRING(TO_CHAR(P_ORGID),1,3) ='999' THEN
				SET SQL_RESPON_ID = '  UNION ALL '+
					'SELECT DISTINCT 99 AS SEQ, D.RESPON_ID AS PARENT_ORG_ID, D.OSTORE_ID AS ORG_ID, D.OSTORE_ID AS ORG_VAL, '+
					'D.STORE_NO+''_''+D.STORE_NM AS ORG_NM, D.STORE_NO AS ORG_NO,''N'' AS ALLOW_DRILL_DOWN, '+
					'4 AS ORG_LEVEL, 4 AS DRILL_ORG_LEVEL,  D.STORE_ID AS DRILL_ORG_ID '+
					'FROM PMART.LATEST_ORG_DIM D '+
					'WHERE D.ENDDT <= CAST(TO_CHAR(SYSDATE,''YYYYMMDD'') AS INTEGER) AND D.RESPON_ID= '+
					' '+ P_ORGID +' '
					;
			END IF;
		ELSE
			IF SUBSTRING(TO_CHAR(P_ORGID),1,3) <> '999' THEN
				SET SQL_RESPON_ID = '  UNION ALL '+ 
					'SELECT ROW_NUMBER() OVER (ORDER BY LPAD(TO_CHAR(ORG_ID),5,''0'')) AS SEQ, E.* '+
					'FROM ( '+
						'SELECT DISTINCT D.RESPON_ID AS PARENT_ORG_ID, D.OSTORE_ID AS ORG_ID, D.OSTORE_ID AS ORG_VAL, '+
						'D.STORE_NO+''_''+D.STORE_NM AS ORG_NM, D.STORE_NO AS ORG_NO, ''N'' AS ALLOW_DRILL_DOWN, '+
						'4 AS ORG_LEVEL, 4 AS DRILL_ORG_LEVEL, D.STORE_ID AS DRILL_ORG_ID '+
						'FROM PMART.LAST_ORG_DIM D '+
						'JOIN PDATA.PBMEMP P ON D.RESPON_ID = P.EMP_NO '+
						'WHERE 1=1 '+ 
						' '+ SQL_WHERERESPON_ID +' '+
						') E '
						;
			ELSEIF SUBSTRING(TO_CHAR(P_ORGID),1,3) = '999' THEN
				SET SQL_RESPON_ID ='  UNION ALL '+
					'SELECT DISTINCT 99 AS SEQ, D.RESPON_ID AS PARENT_ORG_ID, D.OSTORE_ID AS ORG_ID, D.OSTORE_ID AS ORG_VAL, '+
					'D.STORE_NO+''_''+D.STORE_NM AS ORG_NM, D.STORE_NO AS ORG_NO,''N'' AS ALLOW_DRILL_DOWN, '+
					'4 AS ORG_LEVEL, 4 AS DRILL_ORG_LEVEL,  D.STORE_ID AS DRILL_ORG_ID '+
					'FROM PMART.LATEST_ORG_DIM D '+
					'WHERE D.ENDDT <= CAST(TO_CHAR(CURRENT_DATE,''YYYYMMDD'') AS INTEGER) '+
					' '+ SQL_WHERERESPON_ID +' '
					;
			END IF;
		END IF;
	END IF;
	IF (P_INPUTTYPE=5) THEN
		SET SQL_OSTORE_ID ='  UNION ALL '+ 
			'SELECT ROW_NUMBER() OVER (ORDER BY ORG_ID) AS SEQ,F.* '+
			'FROM ( '+
				'SELECT DISTINCT D.RESPON_ID AS PARENT_ORG_ID, D.OSTORE_ID AS ORG_ID, D.OSTORE_ID AS ORG_VAL, '+
				'D.STORE_NO+''_''+D.STORE_NM AS ORG_NM, D.STORE_NO AS ORG_NO, ''N'' AS ALLOW_DRILL_DOWN, '+
				'4 AS ORG_LEVEL, 5 AS DRILL_ORG_LEVEL, D.RESPON_ID AS DRILL_ORG_ID '+
				'FROM PMART.LAST_ORG_DIM D '+
				'WHERE 1=1 '+
				' '+ SQL_WHEREOSTORE_ID +' '+
			') F '
			;
	END IF;
	SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_MGA_1_4_ORG_FUNC  AS( '+
		    ' '+SQL_TOT_ID+' '+
		    ' '+SQL_PDEPT_ID+' '+
			' '+SQL_DEPT_ID+' '+
			' '+SQL_BRANCH_ID+' '+
			' '+SQL_RESPON_ID+' '+
			' '+SQL_OSTORE_ID+' '+
			' ) Z '+
		    ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;'; 
   EXECUTE IMMEDIATE SQLSTR;
END SP;