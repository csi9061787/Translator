REPLACE PROCEDURE PMART.WDWH_2_4_2_1_FUNC
(
	I_YYYYMM VARCHAR(10),
	I_ORG_LEVEL VARCHAR(100),
	I_ORG_ID VARCHAR(100),
	I_KND_TYPE VARCHAR(100),
	I_STK_TYPE VARCHAR(100),
	I_STK_CMP VARCHAR(100),
	I_STK_NUM VARCHAR(100)
)
SQL SECURITY INVOKER
SP:BEGIN
	DECLARE SQLSTR VARCHAR(10000);
	DECLARE V_SQLSTR VARCHAR(10000);
	CALL PMART.P_DROP_TABLE ('#VT_WDWH_2_4_2_1_FUNC');
	IF I_ORG_LEVEL = '3' AND I_STK_TYPE = '0' THEN
		SET V_SQLSTR =  'SELECT T.YYYYMM AS V_YYYYMM, '
									+ 'T.PDEPT_ID AS V_PDEPT_ID, '
									+ 'T.DEPT_ID AS V_DEPT_ID, '
									+ 'T.BRANCH_ID AS V_BRANCH_ID, '
									+ 'B.RESPON_NO AS V_SREMP_NO, '
									+ 'T.OSTORE_NO AS V_OST_NO '
									+ 'FROM PDATA.WDWH_CAL_STK_MONTH_AC T   ' 
									+ ' INNER JOIN ( SELECT DISTINCT OSTORE_ID, M.RESPON_NO  ' 
									+ '   FROM PMART.LAST_ORG_DIM M     '
									+ '  WHERE M.RESPON_NO = '''+ I_ORG_ID +''' '
									+ ' ) B ON T.OSTORE_NO=B.OSTORE_ID  '
									+ 'WHERE T.YYYYMM = '+ I_YYYYMM +' '
									+ 'AND T.KND_TYPE = '''+ I_KND_TYPE +''' '
									+ 'AND B.RESPON_NO = '''+ I_ORG_ID +''' '
									+ 'AND T.STK_AMT '+ I_STK_CMP +' '+ I_STK_NUM +' ';
	ELSEIF I_ORG_LEVEL = '4' AND I_STK_TYPE = '0' THEN
		SET V_SQLSTR =  'SELECT T.YYYYMM AS V_YYYYMM, '
									+ 'T.PDEPT_ID AS V_PDEPT_ID, '
									+ 'T.DEPT_ID AS V_DEPT_ID, '
									+ 'T.BRANCH_ID AS V_BRANCH_ID, '
									+ 'B.RESPON_NO AS V_SREMP_NO, '
									+ 'T.OSTORE_NO AS V_OST_NO '
									+ 'FROM PDATA.WDWH_CAL_STK_MONTH_AC T INNER JOIN  '
									+ ' ( SELECT DISTINCT OSTORE_ID, M.RESPON_NO ' 
									+ '   FROM PMART.LAST_ORG_DIM M ' 
									+ '  WHERE M.OSTORE_ID ='+ I_ORG_ID +' '
									+ ') B ON T.OSTORE_NO=B.OSTORE_ID  ' 
									+ 'WHERE T.YYYYMM = '+ I_YYYYMM +' '
									+ 'AND T.KND_TYPE = '''+ I_KND_TYPE +''' '
									+ 'AND T.OSTORE_NO = '+ I_ORG_ID +' '
									+ 'AND T.STK_AMT '+ I_STK_CMP +' '+ I_STK_NUM +' ';
	ELSEIF I_ORG_LEVEL = '4' AND I_STK_TYPE = '1' THEN
		SET V_SQLSTR =  'SELECT S.YYYYMM AS V_YYYYMM,'
									+ 'S.PDEPT_ID AS V_PDEPT_ID, '
									+ 'S.DEPT_ID AS V_DEPT_ID, '
									+ 'S.BRANCH_ID AS V_BRANCH_ID, '
									+ 'B.RESPON_NO AS V_SREMP_NO, '
									+ 'S.OSTORE_NO AS V_OST_NO '
									+ 'FROM PDATA.WDWH_CAL_STK_MONTH_AC S INNER JOIN  '
									+ ' ( SELECT DISTINCT OSTORE_ID, M.RESPON_NO ' 
									+ '   FROM PMART.LAST_ORG_DIM M      ' 
									+ '  WHERE M.OSTORE_ID ='+ I_ORG_ID +' '
									+ ') B ON S.OSTORE_NO=B.OSTORE_ID  ' 
									+ 'WHERE S.YYYYMM = '+ I_YYYYMM +' '
									+ 'AND S.KND_TYPE = '''+ I_KND_TYPE +''' '
									+ 'AND S.STK_DAYS '+ I_STK_CMP +' '+ I_STK_NUM +' '
									+ 'AND S.OSTORE_NO = '+ I_ORG_ID +' ';
	ELSEIF I_ORG_LEVEL = '3' AND I_STK_TYPE = '1' THEN
		SET V_SQLSTR =  'SELECT S.YYYYMM AS V_YYYYMM,'
									+ 'S.PDEPT_ID AS V_PDEPT_ID, '
									+ 'S.DEPT_ID AS V_DEPT_ID, '
									+ 'S.BRANCH_ID AS V_BRANCH_ID, '
									+ 'B.RESPON_NO AS V_SREMP_NO, '
									+ 'S.OSTORE_NO AS V_OST_NO '
									+ 'FROM PDATA.WDWH_CAL_STK_MONTH_AC S INNER JOIN  '
									+ ' ( SELECT DISTINCT OSTORE_ID, M.RESPON_NO ' 
									+ '   FROM PMART.LAST_ORG_DIM M      ' 
									+ '  WHERE M.RESPON_NO ='''+ I_ORG_ID +''' '
									+ ') B ON S.OSTORE_NO=B.OSTORE_ID  ' 
									+ 'WHERE S.YYYYMM >= '+ I_YYYYMM +' '
									+ 'AND S.KND_TYPE = '''+ I_KND_TYPE +''' '
									+ 'AND S.STK_DAYS '+ I_STK_CMP +' '+ I_STK_NUM +' '
									+ 'AND B.RESPON_NO = '''+ I_ORG_ID +''' ';
	END IF;
	SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_WDWH_2_4_2_1_FUNC  AS( ' 
						+ V_SQLSTR
						+ ' ) WITH DATA PRIMARY INDEX (V_YYYYMM) ON COMMIT PRESERVE ROWS;'; 
	EXECUTE IMMEDIATE SQLSTR;  
END SP;