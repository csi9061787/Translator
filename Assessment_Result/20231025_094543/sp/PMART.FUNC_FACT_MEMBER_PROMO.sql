REPLACE PROCEDURE PMART.FUNC_FACT_MEMBER_PROMO
(
   IN P_RPTID SMALLINT,
   IN P_TIMEID VARCHAR(1000),
   IN P_TIMETYPE VARCHAR(1),   
   IN P_ORGTYPE SMALLINT,
   IN P_ORGID VARCHAR(20),
   IN P_PRDTYPE SMALLINT,
   IN P_PRDID VARCHAR(20),
   IN P_POMOID VARCHAR(20),
   IN P_ACTID VARCHAR(20),
   IN P_MSG VARCHAR(100) CHARACTER SET UNICODE,
   IN P_PRDNM VARCHAR(50) CHARACTER SET UNICODE
)
SP:BEGIN
   DECLARE SQLSTR  VARCHAR(20000) ;
   DECLARE ORGWHERE VARCHAR(2000);
   DECLARE SELECTORG VARCHAR(200);
   DECLARE FSELECTORG VARCHAR(200); 
   DECLARE PRDWHERE VARCHAR(2000);
   DECLARE SELECTPRD VARCHAR(200);
   DECLARE FSELECTPRD VARCHAR(200); 
   DECLARE SELECTWHERE VARCHAR(500);
   DECLARE BASETABLE VARCHAR(200);
   DECLARE SELECT_CALCNT VARCHAR(200);
   DECLARE PNMWHERE VARCHAR(100) ;
   DECLARE POMOWHERE VARCHAR(100);
   DECLARE ACTWHERE VARCHAR(100);
   DECLARE MSGWHERE VARCHAR(100) ;
   DECLARE JOINPOMO VARCHAR(500);
	 SET PRDWHERE = ' WHERE 1=1 ';
	 SET SELECTWHERE = ' ';
	 SET PNMWHERE = ' ';
	  IF P_ORGTYPE <> -1 THEN
		  SET ORGWHERE = ' WHERE ORG_ID = ' + TRIM(P_ORGID);
	  ELSE
		  SET ORGWHERE = ' WHERE ORG_ID = -1 ';
	  END IF; 
	  IF P_PRDTYPE = 1 THEN
		  SET PRDWHERE = ' WHERE KND_ID = '''+ P_PRDID + ''' ';
		  SET SELECTPRD = ' GRP_ID ';	  
		  SET FSELECTPRD = ' KND_ID ';
		  IF TRIM(P_PRDNM) <> '' THEN
			  SET PNMWHERE = 'AND GRP_NM LIKE ''%'+P_PRDNM+'%''';
		  END IF;
	  ELSEIF P_PRDTYPE = 2 THEN
		  SET PRDWHERE = ' WHERE GRP_ID = '''+ P_PRDID + ''' ';
		  SET SELECTPRD = ' PRD_ID ';	  
		  SET FSELECTPRD = ' GRP_ID ';
		  IF TRIM(P_PRDNM) <> '' THEN
			  SET PNMWHERE = 'AND PRD_NM LIKE ''%'+P_PRDNM+'%''';
		  END IF;
	  ELSEIF P_PRDTYPE = 3 THEN
		  SET PRDWHERE = ' WHERE PRD_ID = '''+ P_PRDID + ''' ';
		  SET SELECTPRD = ' PRD_ID ';	  
		  SET FSELECTPRD = ' PRD_ID ';
		  IF TRIM(P_PRDNM) <> '' THEN
			  SET PNMWHERE = 'AND PRD_NM LIKE ''%'+P_PRDNM+'%''';
		  END IF;
	  ELSE
	      SET SELECTPRD = ' KND_ID ';	  
		  SET FSELECTPRD = '''-1''';
		  IF TRIM(P_PRDNM) <> '' THEN
			  SET PNMWHERE = 'AND KND_NM LIKE ''%'+P_PRDNM+'%''';
		  END IF;
	  END IF;
	  IF P_POMOID <> '-1' AND P_ACTID <> '-1' THEN
		  SET ORGWHERE = ORGWHERE+' AND PROMO_ID = '+ TRIM(P_ACTID);
	  ELSE
		  SET ORGWHERE = ORGWHERE+' AND PROMO_ID = -1 ';
	  END IF;
	  IF P_MSG <> '' THEN
		  SET MSGWHERE = ' AND P0.MM_MSG LIKE ''%'+P_MSG+'%''';
		  SET JOINPOMO = ' JOIN #VT_POMO M ON P.PRD_ID = M.PRD_ID ';
	  ELSE
		  SET MSGWHERE = ' ';
		  SET JOINPOMO = ' ';
	  END IF;
	  SET BASETABLE = ' PMART.FACT_MEMBER_PROMO ';
	  CALL PMART.P_DROP_TABLE ('#VT_BASE_PRD');
	  CALL PMART.P_DROP_TABLE ('#VT_PROMO_TEMP');
	  CALL PMART.P_DROP_TABLE ('#VT_FACT_MEMBER_PROMO');
	  CALL PMART.P_DROP_TABLE ('#VT_YDIM');
CALL PMART.P_DROP_TABLE ('#VT_POMO');
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_POMO AS( '
						 + ' SELECT DISTINCT P2.'+SELECTPRD+' AS PRD_ID '
						 + ' FROM PDATA.PROMO P0 '
						 + ' JOIN PDATA.PROMO_PRODUCT P1 ON P0.POMOYM = P1.POMOYM AND P0.POMOID = P1.POMOID '
						 + ' JOIN PMART.PRD_DIM P2 ON P1.CMNO = P2.PRD_ID '
						 + ' WHERE 1=1 '+MSGWHERE
						 + ' ) WITH DATA PRIMARY INDEX(PRD_ID) ON COMMIT PRESERVE ROWS;';			
EXECUTE IMMEDIATE SQLSTR;  
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_BASE_PRD AS( '
						 + ' SELECT DISTINCT '+SELECTPRD+' AS PRD_ID ,4 AS DATA_TYPE'
						 + ' FROM PMART.PRD_DIM ' +PRDWHERE +PNMWHERE
						 + ' UNION '
						 + ' SELECT DISTINCT '+FSELECTPRD+' AS PRD_ID ,2 AS DATA_TYPE'
						 + ' FROM PMART.PRD_DIM ' +PRDWHERE +PNMWHERE
						 + ' ) WITH DATA PRIMARY INDEX(PRD_ID) ON COMMIT PRESERVE ROWS;';			
EXECUTE IMMEDIATE SQLSTR;  
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_PROMO_TEMP AS( '
						 + ' SELECT  B.*,P.DATA_TYPE '
						 + '	    FROM ' + BASETABLE + ' B '
						 + ' 	    JOIN #VT_BASE_PRD P ON P.PRD_ID = B.PRD_ID '+JOINPOMO
						 + ' 	    AND B.TIME_ID IN ('+P_TIMEID+')' +ORGWHERE
						 + ' ) WITH DATA PRIMARY  CHARINDEX(PRD_ID,TIME_ID) ON COMMIT PRESERVE ROWS;';			
EXECUTE IMMEDIATE SQLSTR;  
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FACT_MEMBER_PROMO AS( '
						 + ' SELECT  CASE WHEN DATA_TYPE = 2 THEN 1 ELSE 3 END AS DATA_TYPE'
						 + '                ,CAST(-1 AS INTEGER)  AS TIME_ID '
						 + '                ,PRD_ID AS Y_DIM '
						 + '                ,SUM(ALL_NUM) AS ALL_NUM'
						 + '                ,SUM(ALL_CNT) AS ALL_CNT'
						 + '                ,SUM(ALL_AMT) AS ALL_AMT'
						 + '                ,SUM(ALL_ACTNUM) AS ALL_ACTNUM'
						 + '                ,SUM(ALL_ACTCNT) AS ALL_ACTCNT'
						 + '                ,SUM(ALL_ACTAMT) AS ALL_ACTAMT'
						 + '                ,SUM(MEMBER_NUM) AS MEMBER_NUM'
						 + '                ,SUM(MEMBER_CNT) AS MEMBER_CNT'
						 + '                ,SUM(MEMBER_AMT) AS MEMBER_AMT'
						 + '                ,SUM(MEMBER_PCNT) AS MEMBER_PCNT'
						 + '                ,SUM(MEMBER_ACTNUM) AS MEMBER_ACTNUM'
						 + '                ,SUM(MEMBER_ACTCNT) AS MEMBER_ACTCNT'
						 + '                ,SUM(MEMBER_ACTAMT) AS MEMBER_ACTAMT'
						 + '                ,SUM(MEMBER_ACTPCNT) AS MEMBER_ACTPCNT'
						 + '	    FROM #VT_PROMO_TEMP T '
						 + ' 	    GROUP BY PRD_ID,DATA_TYPE '
						 + ' UNION ALL '
						 + ' SELECT  DATA_TYPE'
						 + '                ,T.TIME_ID  AS TIME_ID '
						 + '                ,PRD_ID AS Y_DIM '
						 + '                ,SUM(ALL_NUM) AS ALL_NUM'
						 + '                ,SUM(ALL_CNT) AS ALL_CNT'
						 + '                ,SUM(ALL_AMT) AS ALL_AMT'
						 + '                ,SUM(ALL_ACTNUM) AS ALL_ACTNUM'
						 + '                ,SUM(ALL_ACTCNT) AS ALL_ACTCNT'
						 + '                ,SUM(ALL_ACTAMT) AS ALL_ACTAMT'
						 + '                ,SUM(MEMBER_NUM) AS MEMBER_NUM'
						 + '                ,SUM(MEMBER_CNT) AS MEMBER_CNT'
						 + '                ,SUM(MEMBER_AMT) AS MEMBER_AMT'
						 + '                ,SUM(MEMBER_PCNT) AS MEMBER_PCNT'
						 + '                ,SUM(MEMBER_ACTNUM) AS MEMBER_ACTNUM'
						 + '                ,SUM(MEMBER_ACTCNT) AS MEMBER_ACTCNT'
						 + '                ,SUM(MEMBER_ACTAMT) AS MEMBER_ACTAMT'
						 + '                ,SUM(MEMBER_ACTPCNT) AS MEMBER_ACTPCNT'
						 + '	    FROM #VT_PROMO_TEMP T '
						 + ' 	    GROUP BY T.TIME_ID,PRD_ID,DATA_TYPE '
						 + ' ) WITH DATA PRIMARY  CHARINDEX(Y_DIM,TIME_ID) ON COMMIT PRESERVE ROWS;';			
EXECUTE IMMEDIATE SQLSTR;  
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_YDIM AS( '
					  +' SELECT DISTINCT S.*,CASE WHEN S.PRD_LEVEL=1 THEN -1 ELSE (S.PRD_LEVEL-1) END AS DRILL_PRD_LEVEL,S.PARENT_PRD_ID AS DRILL_PRD_ID ' 
	                  +' FROM #VT_FACT_MEMBER_PROMO V  '
					  +' JOIN PMART.VW_PRD_DIM_NEW S ON V.Y_DIM = S.PRD_ID AND V.DATA_TYPE = 1 '
					  +' UNION ALL '
					  +' SELECT DISTINCT S.*,S.PRD_LEVEL AS DRILL_PRD_LEVEL,S.PRD_ID AS DRILL_PRD_ID ' 
	                  +' FROM #VT_FACT_MEMBER_PROMO V  '
					  +' JOIN PMART.VW_PRD_DIM_NEW S ON V.Y_DIM = S.PRD_ID AND V.DATA_TYPE = 3 '
					  + ' ) WITH DATA PRIMARY INDEX(PRD_ID) ON COMMIT PRESERVE ROWS;';	
EXECUTE IMMEDIATE SQLSTR;   
END SP;