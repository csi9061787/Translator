REPLACE PROCEDURE PMART.MSGSOUR_DEP_FUNC(P_DAY_ID  NUMBER)
SQL SECURITY INVOKER
SP:BEGIN
  DECLARE SQLSTR  VARCHAR(4000) DEFAULT '';
  DECLARE P_DATA_1 VARCHAR(100) Collate Chinese_Taiwan_Stroke_CI_AS;   
  DECLARE V_DATA_1 VARCHAR(100) Collate Chinese_Taiwan_Stroke_CI_AS;   
  DECLARE STORE_CS CURSOR FOR STORE_SQL;    
  CALL PMART.P_DROP_TABLE ('#VT_MSGSOUR_DEP_FUNC_P'); 
  CALL PMART.P_DROP_TABLE ('#VT_MSGSOUR_DEP_FUNC_L'); 
  CALL PMART.P_DROP_TABLE ('#VT_MSGSOUR_DEP_FUNC'); 
  SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_MSGSOUR_DEP_FUNC_P  
                (    
                  ORG_ID INTEGER
                 ,DATA_1 VARCHAR(200) Collate Chinese_Taiwan_Stroke_CI_AS
                )
                NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';   
  EXECUTE IMMEDIATE SQLSTR;     
  SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_MSGSOUR_DEP_FUNC_L  
                (    
                  ORG_ID INTEGER
                 ,DATA_1 VARCHAR(200) Collate Chinese_Taiwan_Stroke_CI_AS
                )
                NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';   
  EXECUTE IMMEDIATE SQLSTR;         
  SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_MSGSOUR_DEP_FUNC  
                (    
                  DATA_1 VARCHAR(200) Collate Chinese_Taiwan_Stroke_CI_AS
                )
                NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';   
  EXECUTE IMMEDIATE SQLSTR; 
  CALL  PMART.REMD_SCAL_TOT_FUNC(P_DAY_ID) ;  
   INSERT INTO #VT_MSGSOUR_DEP_FUNC_P(ORG_ID  ,DATA_1 )
   SELECT  0
          ,'全'+CAST(TRIM(TO_CHAR(R2,'999999')) AS VARCHAR(6))
         +'達'+CAST(ROUND(R6,1)AS  VARCHAR(5))
         +'前'+CAST(ROUND(R7,1)AS  VARCHAR(5))
   FROM #VT_REMD_SCAL_TOT_FUNC;
   CALL  PMART.REMD_SCAL_PDEPT_FUNC(P_DAY_ID) ;
   INSERT INTO #VT_MSGSOUR_DEP_FUNC_L (ORG_ID  ,DATA_1)
   SELECT A.ORG_ID 
   ,O.PDEPT_NM+TRIM(TO_CHAR(CAST(R2 AS DECIMAL(12,1))/1000)) AS DATA_1
   FROM #VT_REMD_SCAL_PDEPT_FUNC A,  
   (SELECT DISTINCT PDEPT_ID,PDEPT_NM FROM PMART.LAST_ORG_DIM) O  
   WHERE A.ORG_ID = O.PDEPT_ID ;
   SET SQLSTR = ' '+
                ' SELECT DATA_1 ' +
                ' FROM ( ' +
                ' SELECT ORG_ID, DATA_1 FROM #VT_MSGSOUR_DEP_FUNC_P ' +
                ' UNION ' +
		' SELECT ORG_ID, DATA_1 FROM #VT_MSGSOUR_DEP_FUNC_L ' +
		'   ) AA ' +
                ' ORDER BY AA.ORG_ID ' ;			
  PREPARE STORE_SQL FROM SQLSTR;
  OPEN STORE_CS;  
  SET V_DATA_1='';
  L1:
  WHILE (SQLCODE =0) 
  DO    
     L1_1:
        BEGIN 		
         FETCH STORE_CS INTO P_DATA_1 ;         
         IF SQLSTATE <> '00000' THEN 
            LEAVE L1; 
         END IF;  	   
         SET V_DATA_1 = V_DATA_1+P_DATA_1 ;
     END L1_1;     
  END WHILE L1;
  INSERT INTO #VT_MSGSOUR_DEP_FUNC (DATA_1) VALUES (V_DATA_1);	 
  CLOSE STORE_CS;    
END SP;