REPLACE PROCEDURE PMART.POSI_ADD_TKSL(P_TIME_ID NUMBER, P_PRD_ID NUMBER, P_SALES_AMT NUMBER, P_DAY_TYPE VARCHAR(10) )
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR  VARCHAR(4000); 	
   DECLARE V_SALES_AMT NUMBER DEFAULT -1; 
   DECLARE V_TIMD_ID NUMBER ;
   CALL PMART.P_DROP_TABLE ('#VT_POSI_ADD_TKSL'); 
   SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_POSI_ADD_TKSL  
                (TIME_ID NUMBER, PRD_ID NUMBER,DAY_TYPE VARCHAR(10), SALES_AMT NUMBER 
                ) NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';
   EXECUTE IMMEDIATE SQLSTR;        
   L1:
    BEGIN 
         IF(P_PRD_ID NOT IN(10000581,10000582,10000584,10000585,10000586,10000587)) THEN 
            SET V_SALES_AMT = P_SALES_AMT;
	    IF (P_DAY_TYPE='YEAR_L') THEN
              SET V_TIMD_ID = P_TIME_ID -1 ;
            END IF; 
            IF (P_DAY_TYPE='MONTH_L') THEN
              SET V_TIMD_ID =  TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(CAST(P_TIME_ID AS CHAR(6)),'YYYYMM'),-12),'YYYYMM')) ; 
            END IF; 
            IF (P_DAY_TYPE='MONTH_PRE') THEN
              SET V_TIMD_ID =  TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(CAST(P_TIME_ID AS CHAR(6)),'YYYYMM'),-1),'YYYYMM')) ; 
            END IF; 
            IF (P_DAY_TYPE='MONTH_PRE2') THEN            
              SET V_TIMD_ID =  FLOOR(TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(CAST(P_TIME_ID AS CHAR(6)),'YYYYMM'),-1),'YYYYMM'))/100 ) ; 
            END IF; 
	    INSERT INTO #VT_POSI_ADD_TKSL(TIME_ID,PRD_ID,DAY_TYPE,SALES_AMT)
            VALUES (V_TIMD_ID, P_PRD_ID ,P_DAY_TYPE,V_SALES_AMT);
	    LEAVE L1;
         END IF;
         IF (P_DAY_TYPE='MONTH_L') THEN
             IF(P_TIME_ID < 201009 OR P_TIME_ID > 201108) THEN 
                SET V_SALES_AMT = P_SALES_AMT;
		SET V_TIMD_ID =  TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(CAST(P_TIME_ID AS CHAR(6)),'YYYYMM'),-12),'YYYYMM')) ; 
	        INSERT INTO #VT_POSI_ADD_TKSL(TIME_ID,PRD_ID,DAY_TYPE,SALES_AMT)
                VALUES (V_TIMD_ID, P_PRD_ID ,P_DAY_TYPE,V_SALES_AMT);
	        LEAVE L1;
             END IF;
         END IF;
         IF (P_DAY_TYPE='MONTH_PRE') THEN
             IF(P_TIME_ID < 201108 OR P_TIME_ID > 201108) THEN 
                SET V_SALES_AMT = P_SALES_AMT;
                SET V_TIMD_ID =  TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(CAST(P_TIME_ID AS CHAR(6)),'YYYYMM'),-1),'YYYYMM')) ; 
	        INSERT INTO #VT_POSI_ADD_TKSL(TIME_ID,PRD_ID,DAY_TYPE,SALES_AMT)
                VALUES (V_TIMD_ID, P_PRD_ID ,P_DAY_TYPE,V_SALES_AMT);
	        LEAVE L1; 
             END IF;
         END IF;
         IF (P_DAY_TYPE='MONTH_PRE2') THEN
             IF(P_TIME_ID < 201108 OR P_TIME_ID > 201108) THEN 
                SET V_SALES_AMT = P_SALES_AMT;
                SET V_TIMD_ID =  FLOOR(TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(CAST(P_TIME_ID AS CHAR(6)),'YYYYMM'),-1),'YYYYMM'))/100 ) ; 
	        INSERT INTO #VT_POSI_ADD_TKSL(TIME_ID,PRD_ID,DAY_TYPE,SALES_AMT)
                VALUES (V_TIMD_ID, P_PRD_ID ,P_DAY_TYPE,V_SALES_AMT);
	        LEAVE L1; 
             END IF;
         END IF;
         IF (P_DAY_TYPE='YEAR_L') THEN
             IF(P_TIME_ID < 2010 OR P_TIME_ID > 2011) THEN 
                SET V_SALES_AMT = P_SALES_AMT;
	        SET V_TIMD_ID =  P_TIME_ID - 1 ; 
	        INSERT INTO #VT_POSI_ADD_TKSL(TIME_ID,PRD_ID,DAY_TYPE,SALES_AMT)
                VALUES (V_TIMD_ID, P_PRD_ID ,P_DAY_TYPE,V_SALES_AMT);
	        LEAVE L1; 
             END IF;
         END IF; 
    IF (P_DAY_TYPE='YEAR_L') THEN
       L2:
          FOR CUR2  AS POSI_ADD_TKSL_C2 CURSOR  FOR 	
          SELECT TIME_ID
                , PRD_ID
                , P_DAY_TYPE AS DAY_TYPE
                , SALES_AMT 
           FROM PMART.BASIC_MFACT_BUDGET_TKSL A 
          WHERE A.TIME_ID = P_TIME_ID - 1 
          DO	
          SET V_SALES_AMT = CUR2.SALES_AMT;         
         INSERT INTO #VT_POSI_ADD_TKSL(TIME_ID,PRD_ID,DAY_TYPE,SALES_AMT) 
         VALUES (CUR2.TIME_ID, CUR2.PRD_ID, CUR2.DAY_TYPE ,V_SALES_AMT);
       END FOR L2;   
    END IF;
    IF (P_DAY_TYPE='MONTH_L') THEN
       L3:
          FOR CUR3  AS POSI_ADD_TKSL_C3 CURSOR  FOR 	
          SELECT TIME_ID
                , PRD_ID
                , P_DAY_TYPE AS DAY_TYPE
                , SALES_AMT 
           FROM PMART.BASIC_MFACT_BUDGET_TKSL A 
          WHERE A.TIME_ID =  TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(CAST(P_TIME_ID AS CHAR(6)),'YYYYMM'),-12),'YYYYMM'))
          DO	
          SET V_SALES_AMT = CUR3.SALES_AMT;         
         INSERT INTO #VT_POSI_ADD_TKSL(TIME_ID,PRD_ID,DAY_TYPE,SALES_AMT) 
         VALUES (CUR3.TIME_ID, CUR3.PRD_ID, CUR3.DAY_TYPE ,V_SALES_AMT);
       END FOR L3;   	   
    END IF;
    IF (P_DAY_TYPE='MONTH_PRE') THEN
       L4:
          FOR CUR4  AS POSI_ADD_TKSL_C4 CURSOR  FOR 	
          SELECT TIME_ID
                , PRD_ID
                , P_DAY_TYPE AS DAY_TYPE
                , SALES_AMT 
           FROM PMART.BASIC_MFACT_BUDGET_TKSL A 
          WHERE A.TIME_ID =  TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(CAST(P_TIME_ID AS CHAR(6)),'YYYYMM'),-1),'YYYYMM'))
          DO	
          SET V_SALES_AMT = CUR4.SALES_AMT;         
         INSERT INTO #VT_POSI_ADD_TKSL(TIME_ID,PRD_ID,DAY_TYPE,SALES_AMT) 
         VALUES (CUR4.TIME_ID, CUR4.PRD_ID, CUR4.DAY_TYPE ,V_SALES_AMT);
       END FOR L4;   	   
    END IF;
    IF (P_DAY_TYPE='MONTH_PRE2') THEN
       L5:
          FOR CUR5  AS POSI_ADD_TKSL_C5 CURSOR  FOR 	
          SELECT TIME_ID
                , PRD_ID
                , P_DAY_TYPE AS DAY_TYPE
                , SALES_AMT 
           FROM PMART.BASIC_MFACT_BUDGET_TKSL A 
          WHERE A.TIME_ID = FLOOR(TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(CAST(P_TIME_ID AS CHAR(6)),'YYYYMM'),-1),'YYYYMM'))/100 ) 
          DO	
          SET V_SALES_AMT = CUR5.SALES_AMT;         
         INSERT INTO #VT_POSI_ADD_TKSL(TIME_ID,PRD_ID,DAY_TYPE,SALES_AMT) 
         VALUES (CUR5.TIME_ID, CUR5.PRD_ID, CUR5.DAY_TYPE ,V_SALES_AMT);
       END FOR L5;   	   
    END IF;   
   END L1;
END SP;