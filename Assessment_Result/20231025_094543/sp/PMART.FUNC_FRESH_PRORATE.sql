REPLACE PROCEDURE PMART.FUNC_FRESH_PRORATE
(
   IN P_TIMETYPE SMALLINT,            
   IN P_SDATE VARCHAR(8),              
   IN P_EDATE VARCHAR(8),              
   IN P_TIMEID VARCHAR(6),              
   IN P_ORGTYPE SMALLINT,             
   IN P_ORGID VARCHAR(500),           
   IN P_DISTRICTTYPE SMALLINT,   
   IN P_DISTRICT VARCHAR(10),       
   IN P_PRORATE VARCHAR(1),        
   IN P_PRDTYPE SMALLINT,              
   IN P_PRDID VARCHAR(500)             
)
SQL SECURITY INVOKER
SP:BEGIN
        DECLARE SQLSTR    VARCHAR(10000);  
	DECLARE ORGSELECT VARCHAR(2000);
	DECLARE ORGWHERE  VARCHAR(2000); 
	DECLARE ORGWHERE1 VARCHAR(2000);
	DECLARE ORGWHERE2 VARCHAR(2000);	
	DECLARE ORGWHERE3 VARCHAR(2000);
	DECLARE DAYWHERE  VARCHAR(2000);
	DECLARE P_FIELD   VARCHAR(10);
	DECLARE V_PRORATE NUMBER;
	SET ORGWHERE = '';
	SET DAYWHERE = '';
	SET P_FIELD  = '';
	IF P_TIMETYPE=1 THEN 
		SET ORGWHERE = ORGWHERE + ' AND A.TIME_ID BETWEEN ' + P_SDATE + '  AND ' + P_EDATE ;  
		SET DAYWHERE = DAYWHERE + ' AND FACT.L_DAY_ID BETWEEN ' + P_SDATE + '  AND ' + P_EDATE ;  
	ELSE 
		SET ORGWHERE = ORGWHERE + ' AND SUBSTRING(CAST(A.TIME_ID AS CHAR(8)),1,6)= ' + P_TIMEID;
		SET DAYWHERE = DAYWHERE + ' AND SUBSTRING(TRIM(FACT.L_DAY_ID),1,6)= ' + P_TIMEID;
	END IF;
	IF P_ORGTYPE=0 THEN 
		SET DAYWHERE = DAYWHERE + ' AND DIM.PDEPT_ID IN  (' + P_ORGID + ')';
		SET P_FIELD  = ' PDEPT_ID ';
	ELSEIF P_ORGTYPE=1 THEN 
		SET DAYWHERE = DAYWHERE + ' AND DIM.DEPT_ID IN  (' + P_ORGID + ')';
		SET P_FIELD  = ' DEPT_ID ';
	ELSEIF P_ORGTYPE=2 THEN
		SET DAYWHERE = DAYWHERE + ' AND DIM.BRANCH_ID IN   (' + P_ORGID + ')';
		SET P_FIELD  = ' BRANCH_ID ';
	ELSE
		SET DAYWHERE = DAYWHERE + ' AND DIM.STORE_ID IN   (' + P_ORGID + ')';
		SET P_FIELD  = ' STORE_ID ';
	END IF; 
	CALL PMART.P_DROP_TABLE('#VT_DAYCNT_0');
        SET ORGWHERE1 = '' ;
	IF P_DISTRICTTYPE=1 THEN 		
		 SET ORGWHERE1 = ' AND LST.MMA_NO  = ''' + P_DISTRICT + ''' ';	
	END IF;	
	SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_DAYCNT_0 AS('
		  + ' SELECT DIM.OSTORE_ID,DIM.STORE_ID,DIM.STORE_NM,DIM.DEPT_ID,DIM.DEPT_NM'
		  + '       ,DIM.BRANCH_ID, DIM.BRANCH_NM,TP.STTP_TYPE , TP.STTP_TYPE_NM,E.PRORATE'
		  + ' ,SUM(UPLOAD_STNUM) AS PLAN_STNUM'
		  + ' FROM PMART.REMD_FACT FACT'
		  + ' INNER JOIN PMART.LAST_ORG_DIM DIM ON FACT.OSTORE_ID=DIM.OSTORE_ID'
         	  + ' INNER JOIN PMART.LAST_STORE_TYPE_DIM LST ON FACT.OSTORE_ID=LST.OSTORE_ID'
		  + ' INNER JOIN PDATA.PBMSTTP TP ON LST.STYPE_NO=TP.STORE_TYPE'		  
		  + ' INNER JOIN PDATA.FRESH_PRORATE E ON TP.STTP_TYPE=E.PBMSTTP AND E.PRORATE_ID=' + P_PRORATE
		  + ' WHERE 1=1 ' + DAYWHERE +  ORGWHERE1
		  + ' GROUP BY DIM.OSTORE_ID,DIM.STORE_ID,DIM.STORE_NM,DIM.DEPT_ID,DIM.DEPT_NM, DIM.BRANCH_ID,DIM.BRANCH_NM, TP.STTP_TYPE,TP.STTP_TYPE_NM,E.PRORATE'
                  + ' ) WITH DATA PRIMARY  CHARINDEX(STORE_ID,OSTORE_ID) ON COMMIT PRESERVE ROWS;';					  
	EXECUTE IMMEDIATE SQLSTR;
	CALL PMART.P_DROP_TABLE('#VT_DAYCNT');
	SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_DAYCNT AS('
		  + ' SELECT OSTORE_ID,STORE_ID,STORE_NM,DEPT_ID,DEPT_NM'
		  + '       ,BRANCH_ID, BRANCH_NM,STTP_TYPE , STTP_TYPE_NM,PRORATE'
		  + ' ,PLAN_STNUM AS PLAN_STNUM_S '
		  + ' ,SUM(PLAN_STNUM) OVER (PARTITION BY STTP_TYPE )  AS PLAN_STNUM'
		  + ' FROM #VT_DAYCNT_0 '
                  + ' ) WITH DATA PRIMARY  CHARINDEX(STORE_ID,OSTORE_ID) ON COMMIT PRESERVE ROWS;';	
	EXECUTE IMMEDIATE SQLSTR;	
	CALL PMART.P_DROP_TABLE('#VT_PRDID');
	SET ORGSELECT = '' ;
	SET ORGWHERE2 = '' ;
	IF P_PRDTYPE=1 THEN 
		SET ORGSELECT = 'P.KIND_CODE AS FMCODE, P.KIND_NAME AS FMNAME,DT.FM_CODE AS FMCODE_X, DT.FM_NAME AS FMNAME_X';  
		SET ORGWHERE2 = ' AND P.KIND_CODE IN (' + P_PRDID + ')';
	ELSEIF P_PRDTYPE=2 THEN 
		SET ORGSELECT = 'P.KIND_CODE+P.GROUP_CODE AS FMCODE, P.GROUP_NAME AS FMNAME,DT.FM_CODE AS FMCODE_X, DT.FM_NAME AS FMNAME_X';  
		SET ORGWHERE2 = ' AND P.KIND_CODE+P.GROUP_CODE IN (' + P_PRDID + ')';
	ELSE 
		SET ORGSELECT = 'DT.FM_CODE AS FMCODE, DT.FM_NAME AS FMNAME,DT.FM_CODE AS FMCODE_X, DT.FM_NAME AS FMNAME_X';
		SET ORGWHERE2 = ' AND TRIM(DT.FM_CODE) IN (' + P_PRDID + ')';
	END IF;
	SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_PRDID AS('
		  + ' SELECT ' + ORGSELECT 
		  + '       ,DT.PRICE, DT.COST_STOR'
		  + ' FROM PDATA.PBMCMDT DT'
		  + ' INNER JOIN PDATA.FRESH_PBMKGRP P '
         	  + ' ON SUBSTRING(TRIM(DT.GROUP_CODE),1,3)=P.KIND_CODE+P.GROUP_CODE'	  
		  + ' WHERE 1=1 ' + ORGWHERE2		  
                  + ' ) WITH DATA PRIMARY INDEX(FMCODE_X) ON COMMIT PRESERVE ROWS;';	
	EXECUTE IMMEDIATE SQLSTR;  
	CALL PMART.P_DROP_TABLE('#VT_FUNC_FRESH_PRORATE_1');
	SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FRESH_PRORATE_1 AS('
		  + ' SELECT A.TIME_ID,A.ORG_ID,A.PRD_ID,A.SALES_CNT,A.THROW_CNT'
		  + ',B.STORE_ID,B.STORE_NM,B.DEPT_ID,B.DEPT_NM,B.BRANCH_ID,B.BRANCH_NM,B.STTP_TYPE,B.STTP_TYPE_NM,B.PRORATE,B.PLAN_STNUM'
		  + ',C.FMCODE,C.FMNAME,C.FMCODE_X,C.FMNAME_X,C.PRICE,C.COST_STOR'
		  + '   FROM PMART.BASIC_MFACT_DETAIL A INNER JOIN #VT_DAYCNT B'
         	  + '     ON A.ORG_ID = B.OSTORE_ID'
         	  + '                                INNER JOIN #VT_PRDID C'
         	  + '     ON A.PRD_ID = C.FMCODE_X'
		  + '  WHERE 1=1 ' + ORGWHERE		  
                  + ' ) WITH DATA PRIMARY INDEX(DEPT_ID,BRANCH_ID,STTP_TYPE,FMCODE) ON COMMIT PRESERVE ROWS;';
	EXECUTE IMMEDIATE SQLSTR;
	CALL PMART.P_DROP_TABLE('#VT_FUNC_FRESH_PRORATE_2');
	SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FRESH_PRORATE_2 AS('
		  + ' SELECT SUM((A.SALES_CNT*(A.PRICE*0.956 - A.COST_STOR))- (A.THROW_CNT*A.COST_STOR)) AS PROFIT '
		  + ',A.DEPT_ID,A.DEPT_NM,A.BRANCH_ID,A.BRANCH_NM,A.STTP_TYPE,A.STTP_TYPE_NM ' 
		  + ',A.FMCODE,A.FMNAME '
		  + '   FROM #VT_FUNC_FRESH_PRORATE_1 A '
		  + '  GROUP BY A.DEPT_ID,A.DEPT_NM,A.BRANCH_ID,A.BRANCH_NM,A.STTP_TYPE,A.STTP_TYPE_NM,A.FMCODE,A.FMNAME '
                  + ' ) WITH DATA PRIMARY INDEX(DEPT_ID,BRANCH_ID,STTP_TYPE,FMCODE) ON COMMIT PRESERVE ROWS;';
	EXECUTE IMMEDIATE SQLSTR;
	CALL PMART.P_DROP_TABLE('#VT_FUNC_FRESH_PRORATE_3');
	SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FRESH_PRORATE_3 AS('
		  + ' SELECT MIN(A.PRORATE) AS PRORATE ,COUNT(DISTINCT ORG_ID) AS STORE_CNT'
		  + ',A.DEPT_ID,A.DEPT_NM,A.BRANCH_ID,A.BRANCH_NM,A.STTP_TYPE,A.STTP_TYPE_NM ' 
		  + ',A.FMCODE,A.FMNAME '
		  + '   FROM #VT_FUNC_FRESH_PRORATE_1 A '
		  + '  GROUP BY A.DEPT_ID,A.DEPT_NM,A.BRANCH_ID,A.BRANCH_NM,A.STTP_TYPE,A.STTP_TYPE_NM,A.FMCODE,A.FMNAME '
                  + ' ) WITH DATA PRIMARY INDEX(DEPT_ID,BRANCH_ID,STTP_TYPE,FMCODE) ON COMMIT PRESERVE ROWS;';
	EXECUTE IMMEDIATE SQLSTR;
	CALL PMART.P_DROP_TABLE('#VT_FUNC_FRESH_PRORATE_4');
	SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FRESH_PRORATE_4 AS('
		  + ' SELECT MIN(A.PLAN_STNUM) AS PLAN_STNUM '
		  + ',A.DEPT_ID,A.DEPT_NM,A.BRANCH_ID,A.BRANCH_NM,A.STTP_TYPE,A.STTP_TYPE_NM ' 
		  + ',A.FMCODE,A.FMNAME '
		  + '   FROM #VT_FUNC_FRESH_PRORATE_1 A '
		  + '  GROUP BY A.DEPT_ID,A.DEPT_NM,A.BRANCH_ID,A.BRANCH_NM,A.STTP_TYPE,A.STTP_TYPE_NM,A.FMCODE,A.FMNAME '
                  + ' ) WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS; '; 
	EXECUTE IMMEDIATE SQLSTR;	
	CALL PMART.P_DROP_TABLE('#VT_FUNC_FRESH_PRORATE');
	IF P_PRDTYPE=1 THEN 
		SET ORGWHERE3 = ',A.FMCODE AS KIND_CODE  , A.FMNAME AS KIND_NAME ';
	ELSEIF P_PRDTYPE=2 THEN 
		SET ORGWHERE3 = ',A.FMCODE AS GROUP_CODE , A.FMNAME AS GROUP_NAME ';
	ELSE 
		SET ORGWHERE3 = ',A.FMCODE AS FM_CODE    , A.FMNAME AS FM_NAME ';
	END IF;	
	SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FRESH_PRORATE AS('
		  + ' SELECT ROW_NUMBER() OVER (ORDER BY  A.DEPT_ID,A.BRANCH_ID,A.STTP_TYPE,A.FMCODE ) AS ROWNUM '
		  + ',A.DEPT_ID,A.DEPT_NM,A.BRANCH_ID,A.BRANCH_NM,A.STTP_TYPE,A.STTP_TYPE_NM ' 
		  + ORGWHERE3
		  + ',B.STORE_CNT '
		  + ',CAST((A.PROFIT*B.PRORATE/100/C.PLAN_STNUM) AS DECIMAL(12,2)) AS PSD '
		  + '   FROM #VT_FUNC_FRESH_PRORATE_2  A INNER JOIN #VT_FUNC_FRESH_PRORATE_3 B '
                  + '     ON A.DEPT_ID   = B.DEPT_ID '
                  + '    AND A.BRANCH_ID = B.BRANCH_ID '
                  + '    AND A.STTP_TYPE = B.STTP_TYPE '
                  + '    AND A.FMCODE    = B.FMCODE '
                  + '                                   INNER JOIN #VT_FUNC_FRESH_PRORATE_4 C '
                  + '     ON A.DEPT_ID   = C.DEPT_ID '
                  + '    AND A.BRANCH_ID = C.BRANCH_ID '
                  + '    AND A.STTP_TYPE = C.STTP_TYPE '
                  + '    AND A.FMCODE    = C.FMCODE '
                  + ' ) WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS; '; 
	EXECUTE IMMEDIATE SQLSTR;	
END SP;