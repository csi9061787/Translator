REPLACE PROCEDURE PMART.POSN_STFACT_1_4(
P_TIME_TYPE VARCHAR(400), 
P_TIME_LIST VARCHAR(400), 
P_PRD_LEVEL VARCHAR(400), 
P_PRD_ID    VARCHAR(400), 
P_PRD_SQL   NUMBER, 
P_ORG_LEVEL NUMBER, 
P_ORG_LIST  VARCHAR(400), 
P_MMA_LEVEL NUMBER, 
P_MMA_ID    VARCHAR(400), 
P_PRD_TYPE  NUMBER    
) 
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR VARCHAR(4000);
   DECLARE V_TABLE_NAME2 VARCHAR(4000); 
   DECLARE V_MMA VARCHAR(4000); 
   DECLARE V_MMA_AND VARCHAR(4000); 
   DECLARE V_LATEST_SHOPDIST VARCHAR(4000);
   CALL PMART.P_DROP_TABLE('#VT_POSN_STFACT_1_4');
   CALL PMART.POSN_STFACT_1_FUNC(P_TIME_TYPE,P_TIME_LIST,P_PRD_LEVEL,P_PRD_ID,P_PRD_SQL,P_ORG_LEVEL,P_ORG_LIST,-1,'-1',P_PRD_TYPE);
   SET V_MMA = '0 AS MMA_ID, ';
   SET V_MMA_AND = ' ';
   SET V_LATEST_SHOPDIST = 'SELECT DISTINCT OSTORE_NO AS ORG_ID, '+
                           'CASE '+
                           'WHEN LOCAL0=''A'' THEN 10000001 '+
                           'WHEN LOCAL0=''B'' THEN 10000002 '+
                           'WHEN LOCAL0=''C'' THEN 10000003 '+
                           'WHEN LOCAL0=''D'' THEN 10000004 '+
                           'WHEN LOCAL0=''E'' THEN 10000005 '+
                           'WHEN LOCAL0=''F'' THEN 10000006 '+
                           'WHEN LOCAL0=''G'' THEN 10000007 '+
                           'WHEN LOCAL0=''H'' THEN 10000008 '+
                           'WHEN LOCAL0=''I'' THEN 10000009 '+
                           'WHEN LOCAL0=''J'' THEN 10000010 '+
                           'END AS MMA_ID, '+
                           'CASE '+
                           'WHEN SEC_1_LOCAL=''A'' THEN 10000001 '+
                           'WHEN SEC_1_LOCAL=''B'' THEN 10000002 '+
                           'WHEN SEC_1_LOCAL=''C'' THEN 10000003 '+
                           'WHEN SEC_1_LOCAL=''D'' THEN 10000004 '+
                           'WHEN SEC_1_LOCAL=''E'' THEN 10000005 '+
                           'WHEN SEC_1_LOCAL=''F'' THEN 10000006 '+
                           'WHEN SEC_1_LOCAL=''G'' THEN 10000007 '+
                           'WHEN SEC_1_LOCAL=''H'' THEN 10000008 '+
                           'WHEN SEC_1_LOCAL=''I'' THEN 10000009 '+
                           'WHEN SEC_1_LOCAL=''J'' THEN 10000010 '+
                           'ELSE 0 '+
                           'END AS SUB_MMA_ID '+
                           ' FROM PMART.LAST_SHOPDIST L, PMART.LATEST_ORG_DIM O WHERE L.OSTORE_NO = O.OSTORE_ID ';
   IF P_ORG_LEVEL = 0 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.TOT_ID = '+P_ORG_LIST; END IF;
   IF P_ORG_LEVEL = 1 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.DEPT_ID = '+P_ORG_LIST; END IF;
   IF P_ORG_LEVEL = 2 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.BRANCH_ID = '+P_ORG_LIST; END IF;
   IF P_ORG_LEVEL = 3 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.STORE_ID = '+P_ORG_LIST; END IF;
   SET V_TABLE_NAME2='PMART.BASIC_MAST_FACT ';
    SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_POSN_STFACT_1_4  AS('+
      'SELECT    '+
      'B.TIME_ID AS TIME_ID,    '+
      '0 AS ORG_ID,    '+
      '0 AS PRD_ID,   '+
      'Y.SUB_MMA_ID AS MMA_ID, '+
      '0 AS MAST_STORE_NUM,   '+
      '0 AS STNUM_STORE_NUM,  '+
      'BIT_EXTRACT(BIT_AND(B.SALES_STORE_NUM,Y.MASK)) AS SALES_STORE_NUM,  '+
      'BIT_EXTRACT(BIT_AND(B.ORDER_STORE_NUM,Y.MASK)) AS ORDER_STORE_NUM,  '+
      'BIT_EXTRACT(BIT_AND(B.THROW_STORE_NUM,Y.MASK)) AS THROW_STORE_NUM,  '+
      'BIT_EXTRACT(BIT_AND(B.INPRD_STORE_NUM,Y.MASK)) AS INPRD_STORE_NUM,  '+
      'BIT_EXTRACT(BIT_AND(B.RETPRD_STORE_NUM,Y.MASK)) AS RETPRD_STORE_NUM,  '+
      'BIT_EXTRACT(BIT_AND(B.TRANSPRD_STORE_NUM,Y.MASK)) AS TRANSPRD_STORE_NUM,  '+
      'BIT_EXTRACT(BIT_AND(B.TRANSPRD_IN_STORE_NUM,Y.MASK)) AS TRANSPRD_IN_STORE_NUM,  '+
      'BIT_EXTRACT(BIT_AND(B.Y_ORDER_STORE_NUM,Y.MASK)) AS Y_ORDER_STORE_NUM, '+
      'BIT_EXTRACT(BIT_AND(B.SALES_STORE_NUM,Y.MASK)) AS SALES_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.ORDER_STORE_NUM,Y.MASK)) AS ORDER_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.THROW_STORE_NUM,Y.MASK)) AS THROW_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.INPRD_STORE_NUM,Y.MASK)) AS INPRD_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.RETPRD_STORE_NUM,Y.MASK)) AS RETPRD_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.TRANSPRD_STORE_NUM,Y.MASK)) AS TRANSPRD_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.TRANSPRD_IN_STORE_NUM,Y.MASK)) AS TRANSPRD_IN_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.Y_ORDER_STORE_NUM,Y.MASK)) AS Y_ORDER_STNUM  '+
      ' FROM'+
      '( '+
      'SELECT '+
      'B.TIME_ID AS TIME_ID,  '+
      'B.PRD_ID AS PRD_ID,  '+
      ' '+V_MMA+' '+
      'B.SALES_STORE_NUM AS SALES_STORE_NUM,  '+
      'B.ORDER_STORE_NUM AS ORDER_STORE_NUM,  '+
      'B.THROW_STORE_NUM AS THROW_STORE_NUM,  '+
      'B.INPRD_STORE_NUM AS INPRD_STORE_NUM,  '+
      'B.RETPRD_STORE_NUM AS RETPRD_STORE_NUM,  '+
      'B.TRANSPRD_STORE_NUM AS TRANSPRD_STORE_NUM,  '+
      'B.TRANSPRD_IN_STORE_NUM AS TRANSPRD_IN_STORE_NUM,  '+
      'B.Y_ORDER_STORE_NUM AS Y_ORDER_STORE_NUM,   '+
      'BIT_EXTRACT(BIT_AND(B.SALES_STORE_NUM,A.STNUM_STORE_NUM)) AS SALES_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.ORDER_STORE_NUM,A.STNUM_STORE_NUM)) AS ORDER_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.THROW_STORE_NUM,A.STNUM_STORE_NUM)) AS THROW_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.INPRD_STORE_NUM,A.STNUM_STORE_NUM)) AS INPRD_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.RETPRD_STORE_NUM,A.STNUM_STORE_NUM)) AS RETPRD_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.TRANSPRD_STORE_NUM,A.STNUM_STORE_NUM)) AS TRANSPRD_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.TRANSPRD_IN_STORE_NUM,A.STNUM_STORE_NUM)) AS TRANSPRD_IN_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.Y_ORDER_STORE_NUM,A.STNUM_STORE_NUM)) AS Y_ORDER_STNUM  '+
      ' FROM  '+
      ' #VT_POSN_STFACT_1_FUNC B '+
      ', '+ V_TABLE_NAME2 +' A '+
      ' WHERE A.TIME_ID = B.TIME_ID '+ V_MMA_AND +' '+
      ') B, '+
      ' ( SELECT SUB_MMA_ID,BIT_GEN_AGGT(T2.OSTORE_BIT_SEQ) AS MASK FROM ('+ V_LATEST_SHOPDIST +') T1, PMART.ORG_BIT_MAPPING T2 '+
      ' WHERE T1.ORG_ID = T2.OSTORE_ID AND MMA_ID = '+ P_MMA_ID +' GROUP BY SUB_MMA_ID '+
      ' ) Y '+
   ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;'; 
   EXECUTE IMMEDIATE SQLSTR;
END SP;