REPLACE PROCEDURE FUN_PRCT_FACT_PBOA
(
IN P_TIMEIDT INTEGER 
)
BEGIN
DECLARE SQLSTR VARCHAR(3000);
 CALL PMART.P_DROP_TABLE ('#VT_PBOABASE_COMM_AT4');  
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_PBOABASE_COMM_AT4,NO FALLBACK,NO JOURNAL,NO LOG AS( '
                        ||  'SELECT * '
						|| 'FROM PDATA.COMM_AT4  '
                        || 'WHERE DT_ORD BETWEEN ' || P_TIMEIDT || ' AND ' || P_TIMEIDT                                             
					 || ' ) WITH DATA PRIMARY INDEX(STORE_ID,DT_ORD,CD_FMCODE) ON COMMIT PRESERVE ROWS;';			
EXECUTE IMMEDIATE SQLSTR;  
DELETE PTEMP.TMP_FACT_PBOA ALL;
INSERT INTO PTEMP.TMP_FACT_PBOA (
  TIME_ID, ORG_ID, PRD_ID, 
  STORE_QTY, 
  USEST_QTY,
  PRD_QTY,
  UCPRD_QTY,
  STORD_QTY,
  SYSORD_QTY,
  STSET_PCT,
  MINORD_QTY,
  STORE_ID,
  P1DT_ORD,
  P14DT_ORD,
  PRD_USDT
)
SELECT A.DT_ORD, A.OSTORE_ID, P.PRD_ID, 
  1 AS STORE_QTY, 
  CASE WHEN A.FG_AUTO3 = '1' THEN 1 ELSE 0 END AS USEST_QTY,
  1 AS PRD_QTY, 
  CASE WHEN A.QT_ORD = A.QT_ITEM THEN 1 ELSE 0 END AS UCPRD_QTY,
  A.QT_ITEM AS STORD_QTY,
  A.QT_ORD AS SYSORD_QTY,
  CAST(A.RA_STORE AS INT) AS STSET_PCT,
  CAST(A.MIN_QTORD AS INT) AS MINORD_QTY,
  A.STORE_ID,
  TO_NUMBER(TO_CHAR(TO_DATE(TO_CHAR(A.DT_ORD),'YYYYMMDD') - 1,'YYYYMMDD')),
  TO_NUMBER(TO_CHAR(TO_DATE(TO_CHAR(A.DT_ORD),'YYYYMMDD') - 14,'YYYYMMDD')),
  P.PRD_USDT
FROM #VT_PBOABASE_COMM_AT4 A
  INNER JOIN PMART.PRD_DIM P ON A.CD_FMCODE=P.PRD_NO
  INNER JOIN (SELECT OSTORE_ID,MIN(OPNDT) OPNDT,MAX(ENDDT) ENDDT,MAX(PDEPT_ID) PDEPT_ID FROM PMART.ORG_DIM GROUP BY OSTORE_ID) O ON A.OSTORE_ID=O.OSTORE_ID
WHERE  O.OPNDT <= TO_NUMBER(TO_CHAR(TO_DATE(TO_CHAR(A.DT_ORD),'YYYYMMDD') - 14,'YYYYMMDD')) 
  AND O.ENDDT > TO_NUMBER(TO_CHAR(TO_DATE(TO_CHAR(A.DT_ORD),'YYYYMMDD'),'YYYYMMDD'))   
  AND A.CREATE_AT IS NULL;    
 CALL  PTEMP.P_DROP_TABLE('PTEMP.TMP_DEL_PBOA');
CREATE TABLE PTEMP.TMP_DEL_PBOA AS (
  SELECT TIME_ID, PRD_ID, ORG_ID
  FROM PTEMP.TMP_FACT_PBOA A
    INNER JOIN (SELECT OSTORE_ID,MIN(OPNDT) OPNDT,MAX(ENDDT) ENDDT FROM PMART.ORG_DIM GROUP BY OSTORE_ID) O ON A.ORG_ID=O.OSTORE_ID
  WHERE (O.OPNDT > A.P14DT_ORD OR O.ENDDT < A.TIME_ID OR A.PRD_USDT >  A.P14DT_ORD)
  ) WITH DATA NO PRIMARY INDEX;
DELETE PTEMP.TMP_FACT_PBOA
WHERE (TIME_ID, PRD_ID, ORG_ID) IN (
  SELECT TIME_ID, PRD_ID, ORG_ID FROM PTEMP.TMP_DEL_PBOA);
CALL  PTEMP.P_DROP_TABLE('PTEMP.TMP_WORKDAY_PBOA');
CREATE TABLE PTEMP.TMP_WORKDAY_PBOA AS (
SELECT  F.TIME_ID,F.ORG_ID, F.PRD_ID,
  SUM(CASE WHEN C.TIME_ID=F.TIME_ID THEN BIT_EXTRACT(BIT_AND(C.STNUM_STORE_NUM,D.MASK)) ELSE 0 END) AS WORK_DAYS, 
  SUM(CASE WHEN C.TIME_ID BETWEEN F.P14DT_ORD AND F.P1DT_ORD THEN BIT_EXTRACT(BIT_AND(C.STNUM_STORE_NUM,D.MASK)) ELSE 0 END) AS P14_WORK_DAYS 
FROM  PMART.BASIC_MAST_FACT C 
  INNER JOIN PMART.LAST_ORG_DIM_MASK D ON 1=1
  INNER JOIN PTEMP.TMP_FACT_PBOA F ON C.TIME_ID BETWEEN F.P14DT_ORD AND  F.TIME_ID  AND F.ORG_ID=D.ORG_ID
GROUP BY F.TIME_ID,F.ORG_ID, F.PRD_ID
) WITH DATA NO PRIMARY INDEX;
UPDATE PTEMP.TMP_FACT_PBOA
FROM PTEMP.TMP_WORKDAY_PBOA W
SET WORK_DAYS=W.WORK_DAYS, 
  P14_WORK_DAYS=W.P14_WORK_DAYS
WHERE TMP_FACT_PBOA.TIME_ID = W.TIME_ID
AND TMP_FACT_PBOA.ORG_ID = W.ORG_ID
AND TMP_FACT_PBOA.PRD_ID = W.PRD_ID;
CALL  PTEMP.P_DROP_TABLE('PTEMP.TMP_SALCNT_PBOA');
CREATE TABLE PTEMP.TMP_SALCNT_PBOA AS (
  SELECT F.TIME_ID, F.ORG_ID,F.PRD_ID,SUM(M.SALES_CNT) AS SALES_CNT
  FROM PMART.BASIC_MFACT_DETAIL M
    INNER JOIN PTEMP.TMP_FACT_PBOA F ON M.TIME_ID BETWEEN F.P14DT_ORD AND F.P1DT_ORD
      AND F.ORG_ID=M.ORG_ID AND F.PRD_ID=M.PRD_ID
  WHERE M.TIME_ID >= (SELECT MIN(P14DT_ORD) FROM PTEMP.TMP_FACT_PBOA)
    AND M.TIME_ID <= (SELECT MAX(P1DT_ORD) FROM PTEMP.TMP_FACT_PBOA)
  GROUP BY F.TIME_ID, F.ORG_ID,F.PRD_ID
) WITH DATA NO PRIMARY INDEX;
UPDATE PTEMP.TMP_FACT_PBOA
FROM PTEMP.TMP_SALCNT_PBOA S
SET P14_SALE_QTY=S.SALES_CNT
WHERE TMP_FACT_PBOA.TIME_ID=S.TIME_ID
  AND TMP_FACT_PBOA.ORG_ID = S.ORG_ID
  AND TMP_FACT_PBOA.PRD_ID = S.PRD_ID;
DELETE PMART.FACT_PBOA_DETAIL  WHERE TIME_ID BETWEEN P_TIMEIDT AND P_TIMEIDT;
INSERT INTO PMART.FACT_PBOA_DETAIL (
  TIME_ID,ORG_ID,PRD_ID,
  STORE_QTY,USEST_QTY,
  PRD_QTY,UCPRD_QTY,
  STORD_QTY,SYSORD_QTY,
  WORK_DAYS,USE_SYS,
  P14_SALE_QTY,P14_WORK_DAYS,
  STSET_PCT,MINORD_QTY)
SELECT TIME_ID,ORG_ID,PRD_ID,
  STORE_QTY,USEST_QTY,
  PRD_QTY,UCPRD_QTY,
  STORD_QTY,SYSORD_QTY,
  WORK_DAYS,CASE WHEN USEST_QTY > 0 THEN 'Y' ELSE 'N' END,
  P14_SALE_QTY,P14_WORK_DAYS,
  STSET_PCT,MINORD_QTY
FROM PTEMP.TMP_FACT_PBOA;
DELETE PMART.FACT_PBOA  WHERE TIME_ID BETWEEN P_TIMEIDT AND P_TIMEIDT;
INSERT INTO PMART.FACT_PBOA (
  TIME_ID,ORG_ID,PRD_ID,
  STORE_QTY,USEST_QTY,
  PRD_QTY,UCPRD_QTY,
  STORD_QTY,SYSORD_QTY,
  WORK_DAYS,USE_SYS,
  P14_SALE_QTY,P14_WORK_DAYS,
  STSET_PCT,MINORD_QTY)
SELECT F.TIME_ID, O.ORG_ID, F.PRD_ID,
  MAX(OS.ORGCOUNT) STORE_QTY, SUM(F.USEST_QTY) USEST_QTY,
  SUM(F.PRD_QTY) PRD_QTY,SUM(F.UCPRD_QTY) UCPRD_QTY,
  SUM(F.STORD_QTY) STORD_QTY,SUM(F.SYSORD_QTY) SYSORD_QTY,
  MAX(OS.WORKDAYS) WORK_DAYS, CASE WHEN SUM(F.USEST_QTY) > 0 THEN 'Y' ELSE 'N' END USE_SYS,
  SUM(F.P14_SALE_QTY) P14_SALE_QTY,MAX(OS.P14WORKDAYS) P14_WORK_DAYS,
  AVG(F.STSET_PCT) STSET_PCT,AVG(F.MINORD_QTY) MINORD_QTY
FROM PTEMP.TMP_FACT_PBOA F
  INNER JOIN (
    SELECT STORE_ID, BRANCH_ID ORG_ID FROM PMART.LATEST_ORG_DIM
	UNION ALL
    SELECT STORE_ID, DEPT_ID ORG_ID FROM PMART.LATEST_ORG_DIM
	UNION ALL
    SELECT STORE_ID, PDEPT_ID ORG_ID FROM PMART.LATEST_ORG_DIM
	UNION ALL
    SELECT STORE_ID, RESPON_ID ORG_ID FROM PMART.LATEST_ORG_DIM
	UNION ALL
    SELECT STORE_ID, TOT_ID ORG_ID FROM PMART.LATEST_ORG_DIM
	) O ON F.STORE_ID=O.STORE_ID
INNER JOIN ( 	
	SELECT BRANCH_ID ORG_ID,COUNT(BRANCH_ID)  ORGCOUNT,SUM(WORK_DAYS) WORKDAYS ,SUM(P14_WORK_DAYS) P14WORKDAYS 
FROM (
SELECT DISTINCT BRANCH_ID,WORK_DAYS,P14_WORK_DAYS,OSTORE_ID        
FROM   PMART.LATEST_ORG_DIM 
LEFT JOIN (SELECT DISTINCT TIME_ID,ORG_ID,WORK_DAYS,P14_WORK_DAYS FROM PTEMP.TMP_WORKDAY_PBOA)  WP ON WP.ORG_ID = OSTORE_ID 
WHERE OPNDT <= P_TIMEIDT AND  ENDDT >= P_TIMEIDT 
) A1
GROUP BY BRANCH_ID
	UNION ALL	
SELECT DEPT_ID ORG_ID,COUNT(DEPT_ID)  ORGCOUNT,SUM(WORK_DAYS) WORKDAYS ,SUM(P14_WORK_DAYS) P14WORKDAYS 
FROM (
SELECT DISTINCT DEPT_ID,WORK_DAYS,P14_WORK_DAYS,OSTORE_ID        
FROM   PMART.LATEST_ORG_DIM 
LEFT JOIN (SELECT DISTINCT TIME_ID,ORG_ID,WORK_DAYS,P14_WORK_DAYS FROM PTEMP.TMP_WORKDAY_PBOA)  WP ON WP.ORG_ID = OSTORE_ID 
WHERE OPNDT <= P_TIMEIDT AND  ENDDT >= P_TIMEIDT 
) A2
GROUP BY DEPT_ID
	UNION ALL	
	SELECT PDEPT_ID ORG_ID,COUNT(PDEPT_ID)  ORGCOUNT,SUM(WORK_DAYS) WORKDAYS ,SUM(P14_WORK_DAYS) P14WORKDAYS 
FROM (
SELECT DISTINCT PDEPT_ID,WORK_DAYS,P14_WORK_DAYS,OSTORE_ID        
FROM   PMART.LATEST_ORG_DIM 
LEFT JOIN (SELECT DISTINCT TIME_ID,ORG_ID,WORK_DAYS,P14_WORK_DAYS FROM PTEMP.TMP_WORKDAY_PBOA)  WP ON WP.ORG_ID = OSTORE_ID 
WHERE OPNDT <= P_TIMEIDT AND  ENDDT >= P_TIMEIDT 
) A3
GROUP BY PDEPT_ID
	UNION ALL	
	SELECT RESPON_ID ORG_ID,COUNT(RESPON_ID)  ORGCOUNT,SUM(WORK_DAYS) WORKDAYS ,SUM(P14_WORK_DAYS) P14WORKDAYS 
FROM (
SELECT DISTINCT RESPON_ID,WORK_DAYS,P14_WORK_DAYS,OSTORE_ID        
FROM   PMART.LATEST_ORG_DIM 
LEFT JOIN (SELECT DISTINCT TIME_ID,ORG_ID,WORK_DAYS,P14_WORK_DAYS FROM PTEMP.TMP_WORKDAY_PBOA)  WP ON WP.ORG_ID = OSTORE_ID 
WHERE OPNDT <= P_TIMEIDT AND  ENDDT >= P_TIMEIDT 
) A4
GROUP BY RESPON_ID
	UNION ALL	
	SELECT TOT_ID ORG_ID,COUNT(TOT_ID)  ORGCOUNT,SUM(WORK_DAYS) WORKDAYS ,SUM(P14_WORK_DAYS) P14WORKDAYS 
FROM (
SELECT DISTINCT TOT_ID,WORK_DAYS,P14_WORK_DAYS,OSTORE_ID        
FROM   PMART.LATEST_ORG_DIM 
LEFT JOIN (SELECT DISTINCT TIME_ID,ORG_ID,WORK_DAYS,P14_WORK_DAYS FROM PTEMP.TMP_WORKDAY_PBOA)  WP ON WP.ORG_ID = OSTORE_ID 
WHERE OPNDT <= P_TIMEIDT AND  ENDDT >= P_TIMEIDT 
) A5
GROUP BY TOT_ID
 ) OS ON O.ORG_ID = OS.ORG_ID		
GROUP BY F.TIME_ID, O.ORG_ID, F.PRD_ID;
INSERT INTO PMART.FACT_PBOA (
  TIME_ID,ORG_ID,PRD_ID,
  STORE_QTY,USEST_QTY,
  PRD_QTY,UCPRD_QTY,
  STORD_QTY,SYSORD_QTY,
  WORK_DAYS,USE_SYS,
  P14_SALE_QTY,P14_WORK_DAYS,
  STSET_PCT,MINORD_QTY)
SELECT F.TIME_ID, F.ORG_ID, P.GROUP_ID,
  MAX(F.STORE_QTY) STORE_QTY, MAX(F.USEST_QTY) USEST_QTY,
  SUM(F.PRD_QTY) PRD_QTY,SUM(F.UCPRD_QTY) UCPRD_QTY,
  SUM(F.STORD_QTY) STORD_QTY,SUM(F.SYSORD_QTY) SYSORD_QTY,
  MAX(F.WORK_DAYS) WORK_DAYS, CASE WHEN MAX(F.USEST_QTY) > 0 THEN 'Y' ELSE 'N' END USE_SYS,
  SUM(F.P14_SALE_QTY) P14_SALE_QTY,MAX(F.P14_WORK_DAYS) P14_WORK_DAYS,
  AVG(F.STSET_PCT) STSET_PCT,AVG(F.MINORD_QTY) MINORD_QTY
FROM PTEMP.TMP_FACT_PBOA F
  INNER JOIN (
    SELECT PRD_ID, GRP_ID GROUP_ID FROM PMART.PRD_DIM
	UNION ALL
    SELECT PRD_ID, KND_ID GROUP_ID FROM PMART.PRD_DIM
	UNION ALL
    SELECT PRD_ID, TOT_ID GROUP_ID FROM PMART.PRD_DIM
	) P ON F.PRD_ID=P.PRD_ID
GROUP BY F.TIME_ID, F.ORG_ID, P.GROUP_ID;
INSERT INTO PMART.FACT_PBOA (
  TIME_ID,ORG_ID,PRD_ID,
  STORE_QTY,USEST_QTY,
  PRD_QTY,UCPRD_QTY,
  STORD_QTY,SYSORD_QTY,
  WORK_DAYS,USE_SYS,
  P14_SALE_QTY,P14_WORK_DAYS,
  STSET_PCT,MINORD_QTY)
SELECT A.TIME_ID, A.ORG_ID, A.GROUP_ID,
  MAX(OS.ORGCOUNT) STORE_QTY, SUM(A.USEST_QTY) USEST_QTY,
  SUM(A.PRD_QTY) PRD_QTY,SUM(A.UCPRD_QTY) UCPRD_QTY,
  SUM(A.STORD_QTY) STORD_QTY,SUM(A.SYSORD_QTY) SYSORD_QTY,
  MAX(OS.WORKDAYS) WORK_DAYS, CASE WHEN SUM(A.USEST_QTY) > 0 THEN 'Y' ELSE 'N' END USE_SYS,
  SUM(A.P14_SALE_QTY) P14_SALE_QTY,MAX(OS.P14WORKDAYS) P14_WORK_DAYS,
  AVG(A.STSET_PCT) STSET_PCT,AVG(A.MINORD_QTY) MINORD_QTY
FROM  (
SELECT F.TIME_ID,F.STORE_ID, O.ORG_ID, P.GROUP_ID,MAX(F.USEST_QTY) USEST_QTY,
SUM(F.PRD_QTY) PRD_QTY,SUM(F.UCPRD_QTY) UCPRD_QTY,
 SUM(F.STORD_QTY) STORD_QTY,SUM(F.SYSORD_QTY) SYSORD_QTY,
 SUM(F.P14_SALE_QTY) P14_SALE_QTY,
AVG(F.STSET_PCT) STSET_PCT,AVG(F.MINORD_QTY) MINORD_QTY
FROM PTEMP.TMP_FACT_PBOA F
  INNER JOIN (
    SELECT STORE_ID, BRANCH_ID ORG_ID FROM PMART.LATEST_ORG_DIM
	UNION ALL
    SELECT STORE_ID, DEPT_ID ORG_ID FROM PMART.LATEST_ORG_DIM
	UNION ALL
    SELECT STORE_ID, PDEPT_ID ORG_ID FROM PMART.LATEST_ORG_DIM
	UNION ALL
    SELECT STORE_ID, RESPON_ID ORG_ID FROM PMART.LATEST_ORG_DIM
	UNION ALL
    SELECT STORE_ID, TOT_ID ORG_ID FROM PMART.LATEST_ORG_DIM
	) O ON F.STORE_ID=O.STORE_ID
  INNER JOIN (
    SELECT PRD_ID, GRP_ID GROUP_ID FROM PMART.PRD_DIM
	UNION ALL
    SELECT PRD_ID, KND_ID GROUP_ID FROM PMART.PRD_DIM
	UNION ALL
    SELECT PRD_ID, TOT_ID GROUP_ID FROM PMART.PRD_DIM
	) P ON F.PRD_ID=P.PRD_ID
GROUP BY F.TIME_ID,F.STORE_ID, O.ORG_ID, P.GROUP_ID
)  A
INNER JOIN ( 
	SELECT BRANCH_ID ORG_ID,COUNT(BRANCH_ID)  ORGCOUNT,SUM(WORK_DAYS) WORKDAYS ,SUM(P14_WORK_DAYS) P14WORKDAYS 
FROM (
SELECT DISTINCT BRANCH_ID,WORK_DAYS,P14_WORK_DAYS,OSTORE_ID        
FROM   PMART.LATEST_ORG_DIM 
LEFT JOIN (SELECT DISTINCT TIME_ID,ORG_ID,WORK_DAYS,P14_WORK_DAYS FROM PTEMP.TMP_WORKDAY_PBOA)  WP ON WP.ORG_ID = OSTORE_ID 
WHERE OPNDT <= P_TIMEIDT AND  ENDDT >= P_TIMEIDT 
) A1
GROUP BY BRANCH_ID
	UNION ALL	
SELECT DEPT_ID ORG_ID,COUNT(DEPT_ID)  ORGCOUNT,SUM(WORK_DAYS) WORKDAYS ,SUM(P14_WORK_DAYS) P14WORKDAYS 
FROM (
SELECT DISTINCT DEPT_ID,WORK_DAYS,P14_WORK_DAYS,OSTORE_ID        
FROM   PMART.LATEST_ORG_DIM 
LEFT JOIN (SELECT DISTINCT TIME_ID,ORG_ID,WORK_DAYS,P14_WORK_DAYS FROM PTEMP.TMP_WORKDAY_PBOA)  WP ON WP.ORG_ID = OSTORE_ID 
WHERE OPNDT <= P_TIMEIDT AND  ENDDT >= P_TIMEIDT 
) A2
GROUP BY DEPT_ID
	UNION ALL	
	SELECT PDEPT_ID ORG_ID,COUNT(PDEPT_ID)  ORGCOUNT,SUM(WORK_DAYS) WORKDAYS ,SUM(P14_WORK_DAYS) P14WORKDAYS 
FROM (
SELECT DISTINCT PDEPT_ID,WORK_DAYS,P14_WORK_DAYS,OSTORE_ID        
FROM   PMART.LATEST_ORG_DIM 
LEFT JOIN (SELECT DISTINCT TIME_ID,ORG_ID,WORK_DAYS,P14_WORK_DAYS FROM PTEMP.TMP_WORKDAY_PBOA)  WP ON WP.ORG_ID = OSTORE_ID 
WHERE OPNDT <= P_TIMEIDT AND  ENDDT >= P_TIMEIDT 
) A3
GROUP BY PDEPT_ID
	UNION ALL	
	SELECT RESPON_ID ORG_ID,COUNT(RESPON_ID)  ORGCOUNT,SUM(WORK_DAYS) WORKDAYS ,SUM(P14_WORK_DAYS) P14WORKDAYS 
FROM (
SELECT DISTINCT RESPON_ID,WORK_DAYS,P14_WORK_DAYS,OSTORE_ID        
FROM   PMART.LATEST_ORG_DIM 
LEFT JOIN (SELECT DISTINCT TIME_ID,ORG_ID,WORK_DAYS,P14_WORK_DAYS FROM PTEMP.TMP_WORKDAY_PBOA)  WP ON WP.ORG_ID = OSTORE_ID 
WHERE OPNDT <= P_TIMEIDT AND  ENDDT >= P_TIMEIDT 
) A4
GROUP BY RESPON_ID
	UNION ALL	
	SELECT TOT_ID ORG_ID,COUNT(TOT_ID)  ORGCOUNT,SUM(WORK_DAYS) WORKDAYS ,SUM(P14_WORK_DAYS) P14WORKDAYS 
FROM (
SELECT DISTINCT TOT_ID,WORK_DAYS,P14_WORK_DAYS,OSTORE_ID        
FROM   PMART.LATEST_ORG_DIM 
LEFT JOIN (SELECT DISTINCT TIME_ID,ORG_ID,WORK_DAYS,P14_WORK_DAYS FROM PTEMP.TMP_WORKDAY_PBOA)  WP ON WP.ORG_ID = OSTORE_ID 
WHERE OPNDT <= P_TIMEIDT AND  ENDDT >= P_TIMEIDT 
) A5
GROUP BY TOT_ID
 ) OS ON A.ORG_ID = OS.ORG_ID	
GROUP BY A.TIME_ID, A.ORG_ID, A.GROUP_ID;
DELETE PMART.FACT_PBOA WHERE TIME_ID =  (SELECT L_WEEK_ID FROM PMART.YMWD_TIME WHERE L_DAY_ID = P_TIMEIDT);
INSERT INTO PMART.FACT_PBOA (
TIME_ID,ORG_ID,PRD_ID,STORE_QTY,USEST_QTY,PRD_QTY,UCPRD_QTY,STORD_QTY
,SYSORD_QTY,WORK_DAYS,USE_SYS,P14_SALE_QTY,P14_WORK_DAYS,STSET_PCT,MINORD_QTY
)
SELECT B.L_WEEK_ID TIME_ID,A.ORG_ID,A.PRD_ID,AVG(STORE_QTY) STORE_QTY,AVG(USEST_QTY) USEST_QTY,SUM(PRD_QTY) PRD_QTY
,SUM(UCPRD_QTY) UCPRD_QTY,SUM(STORD_QTY) STORD_QTY,SUM(SYSORD_QTY) SYSORD_QTY,AVG(WORK_DAYS) WORK_DAYS
,MAX(USE_SYS) USE_SYS,SUM(P14_SALE_QTY) P14_SALE_QTY,AVG(P14_WORK_DAYS) P14_WORK_DAYS,AVG(STSET_PCT) STSET_PCT
,AVG(MINORD_QTY) MINORD_QTY
FROM PMART.FACT_PBOA A
LEFT JOIN PMART.YMWD_TIME B ON A.TIME_ID = B.L_DAY_ID
WHERE B.L_WEEK_ID = (SELECT L_WEEK_ID FROM PMART.YMWD_TIME WHERE L_DAY_ID =P_TIMEIDT)   
GROUP BY B.L_WEEK_ID,A.ORG_ID,A.PRD_ID;
DELETE PMART.FACT_PBOA_DETAIL WHERE TIME_ID =  (SELECT L_WEEK_ID FROM PMART.YMWD_TIME WHERE L_DAY_ID = P_TIMEIDT );
INSERT INTO PMART.FACT_PBOA_DETAIL (
TIME_ID,ORG_ID,PRD_ID,STORE_QTY,USEST_QTY,PRD_QTY,UCPRD_QTY,STORD_QTY
,SYSORD_QTY,WORK_DAYS,USE_SYS,P14_SALE_QTY,P14_WORK_DAYS,STSET_PCT,MINORD_QTY
)
SELECT B.L_WEEK_ID TIME_ID,A.ORG_ID,A.PRD_ID,AVG(STORE_QTY) STORE_QTY,AVG(USEST_QTY) USEST_QTY,SUM(PRD_QTY) PRD_QTY
,SUM(UCPRD_QTY) UCPRD_QTY,SUM(STORD_QTY) STORD_QTY,SUM(SYSORD_QTY) SYSORD_QTY,AVG(WORK_DAYS) WORK_DAYS
,MAX(USE_SYS) USE_SYS,SUM(P14_SALE_QTY) P14_SALE_QTY,AVG(P14_WORK_DAYS) P14_WORK_DAYS,AVG(STSET_PCT) STSET_PCT
,AVG(MINORD_QTY) MINORD_QTY
FROM PMART.FACT_PBOA_DETAIL A
LEFT JOIN PMART.YMWD_TIME B ON A.TIME_ID = B.L_DAY_ID
WHERE B.L_WEEK_ID = (SELECT L_WEEK_ID FROM PMART.YMWD_TIME WHERE L_DAY_ID =P_TIMEIDT)   
GROUP BY B.L_WEEK_ID,A.ORG_ID,A.PRD_ID;
DELETE PMART.FACT_PBOA WHERE TIME_ID =  (SELECT L_MONTH_ID FROM PMART.YMWD_TIME WHERE L_DAY_ID = P_TIMEIDT);
INSERT INTO PMART.FACT_PBOA (
TIME_ID,ORG_ID,PRD_ID,STORE_QTY,USEST_QTY,PRD_QTY,UCPRD_QTY,STORD_QTY
,SYSORD_QTY,WORK_DAYS,USE_SYS,P14_SALE_QTY,P14_WORK_DAYS,STSET_PCT,MINORD_QTY
)
SELECT B.L_MONTH_ID TIME_ID,A.ORG_ID,A.PRD_ID,AVG(STORE_QTY) STORE_QTY,AVG(USEST_QTY) USEST_QTY,SUM(PRD_QTY) PRD_QTY
,SUM(UCPRD_QTY) UCPRD_QTY,SUM(STORD_QTY) STORD_QTY,SUM(SYSORD_QTY) SYSORD_QTY,AVG(WORK_DAYS) WORK_DAYS
,MAX(USE_SYS) USE_SYS,SUM(P14_SALE_QTY) P14_SALE_QTY,AVG(P14_WORK_DAYS) P14_WORK_DAYS,AVG(STSET_PCT) STSET_PCT
,AVG(MINORD_QTY) MINORD_QTY
FROM PMART.FACT_PBOA A
LEFT JOIN PMART.YMWD_TIME B ON A.TIME_ID = B.L_DAY_ID
WHERE B.L_MONTH_ID = (SELECT L_MONTH_ID FROM PMART.YMWD_TIME WHERE L_DAY_ID = P_TIMEIDT)   
GROUP BY B.L_MONTH_ID,A.ORG_ID,A.PRD_ID;
DELETE PMART.FACT_PBOA_DETAIL WHERE TIME_ID =  (SELECT L_MONTH_ID FROM PMART.YMWD_TIME WHERE L_DAY_ID = P_TIMEIDT);
INSERT INTO PMART.FACT_PBOA_DETAIL (
TIME_ID,ORG_ID,PRD_ID,STORE_QTY,USEST_QTY,PRD_QTY,UCPRD_QTY,STORD_QTY
,SYSORD_QTY,WORK_DAYS,USE_SYS,P14_SALE_QTY,P14_WORK_DAYS,STSET_PCT,MINORD_QTY
)
SELECT B.L_MONTH_ID TIME_ID,A.ORG_ID,A.PRD_ID,AVG(STORE_QTY) STORE_QTY,AVG(USEST_QTY) USEST_QTY,SUM(PRD_QTY) PRD_QTY
,SUM(UCPRD_QTY) UCPRD_QTY,SUM(STORD_QTY) STORD_QTY,SUM(SYSORD_QTY) SYSORD_QTY,AVG(WORK_DAYS) WORK_DAYS
,MAX(USE_SYS) USE_SYS,SUM(P14_SALE_QTY) P14_SALE_QTY,AVG(P14_WORK_DAYS) P14_WORK_DAYS,AVG(STSET_PCT) STSET_PCT
,AVG(MINORD_QTY) MINORD_QTY
FROM PMART.FACT_PBOA_DETAIL A
LEFT JOIN PMART.YMWD_TIME B ON A.TIME_ID = B.L_DAY_ID
WHERE B.L_MONTH_ID = (SELECT L_MONTH_ID FROM PMART.YMWD_TIME WHERE L_DAY_ID =P_TIMEIDT)   
GROUP BY B.L_MONTH_ID,A.ORG_ID,A.PRD_ID;
END;