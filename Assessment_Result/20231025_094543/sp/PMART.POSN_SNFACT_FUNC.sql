REPLACE PROCEDURE PMART.POSN_SNFACT_FUNC(
FP_TIME_TYPE CHAR,         
FP_TIME_LIST VARCHAR(400), 
FP_ORG_LEVEL NUMBER,       
FP_ORG_LIST  VARCHAR(400), 
FP_MMA_LEVEL NUMBER,       
FP_MMA_ID    VARCHAR(400)  
)
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE V_REMD_SQL    VARCHAR(400);   
   DECLARE V_TABLE_NAME2 VARCHAR(400);   
   DECLARE V_MMA         VARCHAR(400);   
   DECLARE V_MMA_WHERE   VARCHAR(200);  
   DECLARE V_TIME_SQL    VARCHAR(200);  
   DECLARE V_MMA_GROUP   VARCHAR(200);  
   DECLARE SQLSTR        VARCHAR(4000);
   CALL PMART.P_DROP_TABLE ('#VT_POSN_SNFACT_FUNC'); 
   SET V_REMD_SQL = '0';
   SET V_MMA = '0 AS MMA_ID, ';
   SET V_MMA_WHERE = ' ';
   SET V_TIME_SQL = ' ';
   SET V_MMA_GROUP = ' ';
   IF (FP_MMA_LEVEL = 0 OR FP_MMA_LEVEL = 1) THEN 
      SET V_MMA ='A.MMA_ID AS MMA_ID, ';
      SET V_MMA_WHERE =' AND A.MMA_ID IN ('+ FP_MMA_ID +')';
      SET V_TABLE_NAME2 ='PMART.BASIC_MAST_FACT_SHOP ';
      SET V_MMA_GROUP =',A.MMA_ID';
   ELSE 
      SET V_TABLE_NAME2 ='PMART.BASIC_MAST_FACT ';
   END IF;
   SET V_REMD_SQL ='BIT_EXTRACT(BIT_AND(A.STNUM_STORE_NUM,Y.MASK))';
   IF (FP_TIME_TYPE = 'D') THEN 
      SET V_TIME_SQL = 'C.L_DAY_ID';
   END IF;
   IF (FP_TIME_TYPE = 'W') THEN 
      SET V_TIME_SQL = 'C.L_WEEK_ID';
   END IF;
   IF (FP_TIME_TYPE = 'M') THEN 
      SET V_TIME_SQL = 'C.L_MONTH_ID';
   END IF;
   SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_POSN_SNFACT_FUNC  AS('+
      'SELECT '+ 
      V_TIME_SQL + ' AS TIME_ID,    '+
      'Y.ORG_ID AS ORG_ID,    '+
      ' '+V_MMA+' '+
      '0 AS MAST_STORE_NUM,   '+  
      'SUM('+V_REMD_SQL+') AS STNUM_STORE_NUM  '+  
      'FROM '+
      V_TABLE_NAME2 +' A LEFT JOIN PMART.YMWD_TIME_W2 C ON (A.TIME_ID=C.L_DAY_ID), PMART.LAST_ORG_DIM_MASK Y   '+
      ' WHERE '+
      V_TIME_SQL +' IN (  '+ FP_TIME_LIST +'  )  '+
      ' AND A.TIME_ID <> TO_CHAR(CURRENT_DATE,''YYYYMMDD'') '+
      V_MMA_WHERE +' '+
      ' AND Y.ORG_ID IN ( '+ FP_ORG_LIST +' ) GROUP BY '+V_TIME_SQL+',Y.ORG_ID'+V_MMA_GROUP +
      ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';    
  EXECUTE IMMEDIATE SQLSTR;
END SP;