REPLACE PROCEDURE PMART.OLD0401_FUNC_FACT_IMPORTANT
(
   IN P_ACTID VARCHAR(10),
   IN P_ORGTYPE VARCHAR(10),
   IN P_GROUP VARCHAR(500),
   IN P_TIMEID VARCHAR(2000),
   IN P_ORGID VARCHAR(2000),
   IN P_PRDTYPE VARCHAR(100), 
   IN P_PRDID VARCHAR(2000)
)
SP:BEGIN
     DECLARE SQLSTR  VARCHAR(6000);    
	 DECLARE ORGSELECT VARCHAR(2000);
	 DECLARE ORGWHERE VARCHAR(2000);  
	 DECLARE PRDSELECT VARCHAR(500);
	 DECLARE V_PRDTYPE INTEGER;
   SET ORGWHERE = ' WHERE 1=1 ';
	IF P_ORGTYPE = '0' THEN
		SET ORGSELECT = 'DEPT_ID AS GROUP_ORG_ID, OSTORE_ID, SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT';
		SET ORGWHERE = ORGWHERE + ' AND PDEPT_ID  = ' + P_ORGID;   
	ELSEIF P_ORGTYPE = '1' THEN
		SET ORGSELECT = 'BRANCH_ID AS GROUP_ORG_ID, OSTORE_ID, SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT';
		SET ORGWHERE = ORGWHERE + ' AND DEPT_ID  = ' + P_ORGID;   
	ELSEIF P_ORGTYPE = '2' THEN
		SET ORGSELECT = 'RESPON_ID AS GROUP_ORG_ID, OSTORE_ID, SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT';
		SET ORGWHERE = ORGWHERE + ' AND BRANCH_ID = ' + P_ORGID;
	ELSEIF P_ORGTYPE = '3' THEN
		SET ORGSELECT = 'OSTORE_ID AS GROUP_ORG_ID, OSTORE_ID, SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT';
		SET ORGWHERE = ORGWHERE + ' AND RESPON_ID = ' + P_ORGID;
	ELSEIF P_ORGTYPE = '4' THEN
		SET ORGSELECT = 'OSTORE_ID AS GROUP_ORG_ID, OSTORE_ID, SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT';
		SET ORGWHERE = ORGWHERE + ' AND OSTORE_ID = ' + P_ORGID;
	ELSE
		SET ORGSELECT = 'PDEPT_ID AS GROUP_ORG_ID, OSTORE_ID, SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT';
	END IF;   
	IF P_PRDTYPE = '-1' THEN
		SET V_PRDTYPE = 1;
	ELSEIF P_PRDTYPE = '1' THEN
		SET V_PRDTYPE = 3;
		SET PRDSELECT = 'SELECT DIVISION_ID FROM PDATA.FESTL_DIVISION WHERE ACT_ID = ' +P_ACTID + ' AND CLASS_ID = ' + P_PRDID;
	ELSEIF P_PRDTYPE = '2' THEN
		SET V_PRDTYPE = 4;
		SET PRDSELECT = 'SELECT FM_CODE FROM PDATA.FESTL_PRD_SET WHERE ACT_ID = ' +P_ACTID + ' AND DIVISION_ID =  ' + P_PRDID;
	ELSEIF P_PRDTYPE = '3' THEN
		SET V_PRDTYPE = 4;
		SET PRDSELECT = 'SELECT FM_CODE FROM PDATA.FESTL_PRD_SET WHERE ACT_ID = ' +P_ACTID + ' AND FM_CODE =  ' + P_PRDID;
	END IF;
CALL PMART.P_DROP_TABLE ('#VT_FACT_IMPORTANT');
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FACT_IMPORTANT AS('
						 + ' SELECT ' + P_GROUP + ', '
					     + '               SUM(T1.SALE_CNT) AS SALE_CNT, SUM(T1.SALE_AMT) AS SALE_AMT, '
						 + '				SUM(T1.FINAL_SALE_AMT) AS FINAL_SALE_AMT '
						 + '	    FROM PMART.FACT_IMPORTANT T1 '
						 + '		JOIN ( '
						 + '			SELECT ' + ORGSELECT 
						 + '			    FROM PMART.LAST_ORG_STORE '
						 + '			' + ORGWHERE
						 + '		) T2 ON T1.ORG_ID = T2.OSTORE_ID '
						 + '		WHERE T1.ACT_ID = ' + P_ACTID + ' AND T1.TIME_ID IN ('+P_TIMEID+')' 
						 + '           AND T1.PRD_TYPE = ' + V_PRDTYPE
						 + CASE WHEN TRIM(P_PRDID)='' THEN ' ' ELSE ' AND T1.PRD_ID IN('+PRDSELECT+') ' END				 
						 + '		 GROUP BY ' + P_GROUP
			             + ' ) WITH DATA PRIMARY INDEX('+ P_GROUP +') ON COMMIT PRESERVE ROWS;';						  					
        EXECUTE IMMEDIATE SQLSTR;   
END SP;