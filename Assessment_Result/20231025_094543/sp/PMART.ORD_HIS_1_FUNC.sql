REPLACE PROCEDURE PMART.ORD_HIS_1_FUNC
(
	L_DAY_ID_S INTEGER,
	L_DAY_ID_E INTEGER,
	ORGSELECTLEVEL INTEGER,
	CURRENTORGID VARCHAR(10)
)            
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR        VARCHAR(4000) ;
   DECLARE V_SQL              VARCHAR(4000) ;   
   DECLARE V_SQLWHERE     VARCHAR(1000) ; 
   CALL PMART.P_DROP_TABLE ('#VT_ORD_HIS_1_FUNC'); 
   SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_ORD_HIS_1_FUNC  (  
                L_DAY_ID INTEGER, 
				STORE_ID INTEGER, 
				ORDER_STAGE INTEGER, 
				DETAIL VARCHAR(1000) Collate Chinese_Taiwan_Stroke_CI_AS, 
				STORE_NO VARCHAR(6), 
				STORE_NM VARCHAR(18) Collate Chinese_Taiwan_Stroke_CI_AS, 
				RESPON_ID NUMBER, 
				RESPON_NO VARCHAR(10), 
				RESPON_NM VARCHAR(50) Collate Chinese_Taiwan_Stroke_CI_AS,
				BRANCH_ID INTEGER, 
				BRANCH_NO VARCHAR(6), 
				BRANCH_NM VARCHAR(50) Collate Chinese_Taiwan_Stroke_CI_AS, 
				OPNDT INTEGER, 
				DEPT_ID INTEGER, 
				PDEPT_ID INTEGER
                ) NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';
   EXECUTE IMMEDIATE SQLSTR;
   INSERT INTO #VT_ORD_HIS_1_FUNC (L_DAY_ID, STORE_ID, ORDER_STAGE, DETAIL)
WITH
ORD (L_DAY_ID, STORE_ID, ORDER_STAGE, DETAIL) AS
(
SELECT S.L_DAY_ID, S.STORE_ID, S.ORDER_STAGE, G.CODE_NAME+'('+TRIM(COUNT(1))+')'
  FROM PDATA.ORDDETAIL S
 INNER JOIN PDATA.PBMCMDT P ON P.FM_CODE = S.PRD_ID
 INNER JOIN PDATA.ODVFMGP G ON P.GROUP_CODE = G.GROUP_ID
 WHERE S.ORDER_SRC = 'H' 
   AND S.ORDER_STATE = '00' 
   AND S.L_DAY_ID >= L_DAY_ID_S
   AND S.L_DAY_ID <= L_DAY_ID_E
 GROUP BY S.L_DAY_ID, S.STORE_ID, S.ORDER_STAGE, G.CODE_NAME
)
, RST (L_DAY_ID, STORE_ID, ORDER_STAGE, DETAIL) AS
(
SELECT L_DAY_ID, STORE_ID, ORDER_STAGE
	, CAST(XMLAGG(DETAIL) AS VARCHAR(500) )
  FROM ORD
 GROUP BY L_DAY_ID, STORE_ID, ORDER_STAGE
)
SELECT *
  FROM RST;
	IF ORGSELECTLEVEL = -1 THEN 
		SET V_SQLWHERE = '  1=1 ';
	ELSEIF ORGSELECTLEVEL = 0 THEN 
		SET V_SQLWHERE = '  LATEST.PDEPT_ID = '+ CURRENTORGID ;
	ELSEIF ORGSELECTLEVEL = 1 THEN 
		SET V_SQLWHERE = '  LATEST.DEPT_ID = '+ CURRENTORGID ;
	ELSEIF ORGSELECTLEVEL = 2 THEN 
		SET V_SQLWHERE = '  LATEST.BRANCH_ID = '+ CURRENTORGID;
	ELSEIF ORGSELECTLEVEL = 3 THEN 
		SET V_SQLWHERE = '  LATEST.RESPON_ID = '+ CURRENTORGID;
	END IF;
	SET V_SQL = 'INSERT INTO #VT_ORD_HIS_1_FUNC '
						+ ' SELECT MAIN.L_DAY_ID, MAIN.STORE_ID, MAIN.ORDER_STAGE, MAIN.DETAIL, '
						+ ' LATEST.STORE_NO, LATEST.STORE_NM,LATEST.RESPON_ID,LATEST.RESPON_NO, LATEST.RESPON_NM '
						+ ' ,LATEST.BRANCH_ID, LATEST.BRANCH_NO, LATEST.BRANCH_NM,LATEST.OPNDT,LATEST.DEPT_ID, LATEST.PDEPT_ID '
						+ ' FROM #VT_ORD_HIS_1_FUNC MAIN '
						+ ' JOIN PMART.LATEST_ORG_DIM LATEST ON LATEST.STORE_ID = MAIN.STORE_ID '
						+ ' WHERE ' + V_SQLWHERE ;
	EXECUTE IMMEDIATE V_SQL;
END SP;