REPLACE PROCEDURE PMART.OA_EXCL_STOR_CHECK
(
	IN P_TIME_ID VARCHAR(6),
	OUT DATA_CNT INTEGER,
	OUT ERR_CNT INTEGER
)
SQL SECURITY INVOKER
SP:BEGIN
	CALL PMART.P_DROP_TABLE ('#TMP_OA_EXCL_STOR_CHECK');
	CREATE MULTISET VOLATILE TABLE #TMP_OA_EXCL_STOR_CHECK AS 
	(
	SELECT DISTINCT TIME_ID, EXCL_ID, STORE_NO, '店鋪非既存店' AS ERR_MSG 
	FROM PSTAGE.OA_EXCL_STOR_IF
	WHERE LPAD(STORE_NO, 6, '0') NOT IN (SELECT STORE_NO FROM PDATA.PBMSTOR WHERE OPEN_DATE_DATE <= LAST_DAY(CAST(P_TIME_ID+'01' AS DATE FORMAT 'YYYYMMDD'))  AND CLOSE_DATE_DATE >= CAST(P_TIME_ID+'01' AS DATE FORMAT 'YYYYMMDD'))
	AND (STORE_NO IS NOT NULL AND TRIM(STORE_NO) <> '')
	)  
	WITH  DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;
	UPDATE PSTAGE.OA_EXCL_STOR_IF
	FROM  #TMP_OA_EXCL_STOR_CHECK B
	SET ERR_MSG = NVL(OA_EXCL_STOR_IF.ERR_MSG,'')+','+ B.ERR_MSG
	WHERE OA_EXCL_STOR_IF.TIME_ID = B.TIME_ID
	AND OA_EXCL_STOR_IF.EXCL_ID = B.EXCL_ID
	AND OA_EXCL_STOR_IF.STORE_NO = B.STORE_NO
	;
	CALL PMART.P_DROP_TABLE ('#TMP_OA_EXCL_STOR_CHECK');
	CREATE MULTISET VOLATILE TABLE #TMP_OA_EXCL_STOR_CHECK AS 
	(
	SELECT DISTINCT TIME_ID, EXCL_ID, STORE_NO, '店號不可重複設定' AS ERR_MSG 
	FROM PSTAGE.OA_EXCL_STOR_IF A
	WHERE EXISTS (SELECT STORE_NO, COUNT(1) FROM PSTAGE.OA_EXCL_STOR_IF B WHERE A.TIME_ID = B.TIME_ID AND A.STORE_NO = B.STORE_NO GROUP BY STORE_NO HAVING COUNT(1) > 1)
	)
	WITH  DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;
	UPDATE PSTAGE.OA_EXCL_STOR_IF
	FROM  #TMP_OA_EXCL_STOR_CHECK B
	SET ERR_MSG = NVL(OA_EXCL_STOR_IF.ERR_MSG,'')+','+ B.ERR_MSG
	WHERE OA_EXCL_STOR_IF.TIME_ID = B.TIME_ID
	AND OA_EXCL_STOR_IF.EXCL_ID = B.EXCL_ID
	AND OA_EXCL_STOR_IF.STORE_NO = B.STORE_NO
	;
	CALL PMART.P_DROP_TABLE ('#TMP_OA_EXCL_STOR_CHECK');
	CREATE MULTISET VOLATILE TABLE #TMP_OA_EXCL_STOR_CHECK AS 
	(
	SELECT DISTINCT TIME_ID, EXCL_ID, STORE_NO, '排除代號設定錯誤' AS ERR_MSG 
	FROM PSTAGE.OA_EXCL_STOR_IF A
	WHERE EXCL_ID NOT BETWEEN 1000 AND 1002
	AND (EXCL_ID IS NOT NULL AND TRIM(EXCL_ID) <> '')
	)
	WITH  DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;
	UPDATE PSTAGE.OA_EXCL_STOR_IF
	FROM  #TMP_OA_EXCL_STOR_CHECK B
	SET ERR_MSG = NVL(OA_EXCL_STOR_IF.ERR_MSG,'')+','+ B.ERR_MSG
	WHERE OA_EXCL_STOR_IF.TIME_ID = B.TIME_ID
	AND OA_EXCL_STOR_IF.EXCL_ID = B.EXCL_ID
	AND OA_EXCL_STOR_IF.STORE_NO = B.STORE_NO
	;
	CALL PMART.P_DROP_TABLE ('#TMP_OA_EXCL_STOR_CHECK');
	UPDATE PSTAGE.OA_EXCL_STOR_IF
	SET ERR_MSG = NVL(ERR_MSG,'')+','+ '排除月份未設定'
	WHERE TIME_ID IS NULL OR TRIM(TIME_ID) = ''
	;
	UPDATE PSTAGE.OA_EXCL_STOR_IF
	SET ERR_MSG = NVL(ERR_MSG,'')+','+ '店號未設定'
	WHERE STORE_NO IS NULL OR TRIM(STORE_NO) = ''
	;
	UPDATE PSTAGE.OA_EXCL_STOR_IF
	SET ERR_MSG = NVL(ERR_MSG,'')+','+ '排除代號未設定'
	WHERE EXCL_ID IS NULL OR TRIM(EXCL_ID) = ''
	;
	SET DATA_CNT = (SELECT COUNT(*) FROM PSTAGE.OA_EXCL_STOR_IF );
	SET ERR_CNT = (SELECT COUNT(*) FROM PSTAGE.OA_EXCL_STOR_IF  WHERE ERR_MSG IS NOT NULL);
END SP;