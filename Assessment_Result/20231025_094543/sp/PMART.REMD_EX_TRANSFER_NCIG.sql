CREATE PROCEDURE PMART.REMD_EX_TRANSFER_NCIG (P_MONTH_ID NUMBER)
SQL SECURITY INVOKER
SP:BEGIN
MERGE INTO PMART.REMD_FACT_NCIG T USING
(
SELECT
 C.L_DAY_ID        AS L_DAY_ID
,C.OSTORE_ID       AS OSTORE_ID
,C.STORE_ID        AS STORE_ID
,C.ACCU_AMT        AS EX_ACCU_AMT
,C.ACCU_PLAN_STNUM AS EX_ACCU_PLAN_STNUM
,C.ACCU_CUST_NUM   AS EX_ACCU_CUST_NUM
,D.TOT_AMT         AS EX_TOT_AMT_LAST_YEAR
,D.TOT_PLAN_STNUM  AS EX_TOT_PLAN_STNUM_LAST_YEAR
,D.TOT_CUST_NUM    AS EX_TOT_CUST_NUM_LAST_YEAR
,D.TOT_TKSL        AS EX_TOT_TKSL_LAST_YEAR
,C.ACCU_TKSL       AS EX_ACCU_TKSL
FROM
(
SELECT
 A.L_DAY_ID                AS L_DAY_ID
,A.OSTORE_ID               AS OSTORE_ID
,A.STORE_ID                AS STORE_ID
,B.L_MONTH_LAST_YEAR*100+1 AS L_DAY_FIRST_DAY_LAST_YEAR
,A.ACCU_AMT                AS ACCU_AMT
,A.ACCU_PLAN_STNUM         AS ACCU_PLAN_STNUM
,A.ACCU_CUST_NUM	   AS ACCU_CUST_NUM
,A.ACCU_TKSL               AS ACCU_TKSL
FROM PMART.REMD_FACT_NCIG A , PMART.YMWD_TIME B
WHERE A.L_DAY_ID=B.L_DAY_ID AND ROUND(A.L_DAY_ID/100)=P_MONTH_ID 
) C, PMART.REMD_FACT_NCIG D
WHERE C.OSTORE_ID=D.OSTORE_ID 
  AND C.L_DAY_FIRST_DAY_LAST_YEAR=D.L_DAY_ID
) S
 ON (T.L_DAY_ID=S.L_DAY_ID 
AND  T.OSTORE_ID=S.OSTORE_ID)
WHEN MATCHED THEN UPDATE SET
 EX_ACCU_AMT                =S.EX_ACCU_AMT
,EX_ACCU_PLAN_STNUM         =S.EX_ACCU_PLAN_STNUM
,EX_ACCU_CUST_NUM           =S.EX_ACCU_CUST_NUM
,EX_TOT_AMT_LAST_YEAR       =S.EX_TOT_AMT_LAST_YEAR
,EX_TOT_PLAN_STNUM_LAST_YEAR=S.EX_TOT_PLAN_STNUM_LAST_YEAR
,EX_TOT_CUST_NUM_LAST_YEAR  =S.EX_TOT_CUST_NUM_LAST_YEAR
,EX_TOT_TKSL_LAST_YEAR      =S.EX_TOT_TKSL_LAST_YEAR
,EX_ACCU_TKSL               =S.EX_ACCU_TKSL
WHEN NOT MATCHED THEN INSERT
(
 L_DAY_ID
,OSTORE_ID
,STORE_ID
,EX_ACCU_AMT
,EX_ACCU_PLAN_STNUM
,EX_TOT_AMT_LAST_YEAR
,EX_TOT_PLAN_STNUM_LAST_YEAR
,EX_ACCU_CUST_NUM
,EX_TOT_CUST_NUM_LAST_YEAR
,EX_TOT_TKSL_LAST_YEAR
,EX_ACCU_TKSL
)
VALUES
(
 S.L_DAY_ID
,S.OSTORE_ID
,S.STORE_ID
,S.EX_ACCU_AMT
,S.EX_ACCU_PLAN_STNUM
,S.EX_TOT_AMT_LAST_YEAR
,S.EX_TOT_PLAN_STNUM_LAST_YEAR
,S.EX_ACCU_CUST_NUM
,S.EX_TOT_CUST_NUM_LAST_YEAR
,S.EX_TOT_TKSL_LAST_YEAR
,S.EX_ACCU_TKSL
)
;
END SP;