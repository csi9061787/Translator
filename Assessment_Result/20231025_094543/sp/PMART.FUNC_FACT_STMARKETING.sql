REPLACE PROCEDURE PMART.FUNC_FACT_STMARKETING
(
   IN P_ACTID INTEGER,
   IN P_ORGTYPE VARCHAR(10),   
   IN P_ORGID VARCHAR(2000),
   IN P_TIMEID VARCHAR(2000)
)
SP:BEGIN
    DECLARE SQLSTR  VARCHAR(10000);    
	DECLARE ORGSELECT VARCHAR(2000);
	DECLARE ORGWHERE VARCHAR(2000);  
	SET ORGWHERE = '';
    IF P_ORGTYPE = '1' THEN
	    SET ORGSELECT = 'DEPT_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND PDEPT_ID  = ' + P_ORGID;   
	ELSEIF P_ORGTYPE = '1' THEN
	    SET ORGSELECT = 'BRANCH_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND DEPT_ID  = ' + P_ORGID;   
   ELSEIF P_ORGTYPE = '2' THEN
		SET ORGSELECT = 'RESPON_ID AS GROUP_ORG_ID, OSTORE_ID';
	    SET ORGWHERE = ORGWHERE + ' AND BRANCH_ID = ' + P_ORGID;
   ELSEIF P_ORGTYPE = '3' THEN
        SET ORGSELECT = 'OSTORE_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND RESPON_ID = ' + P_ORGID;
   ELSEIF P_ORGTYPE = '4' THEN
        SET ORGSELECT = 'OSTORE_ID AS GROUP_ORG_ID, OSTORE_ID';
	    SET ORGWHERE = ORGWHERE + ' AND OSTORE_ID = ' + P_ORGID;
   ELSE
        SET ORGSELECT = 'PDEPT_ID AS GROUP_ORG_ID, OSTORE_ID';
   END IF;   
    CALL PMART.P_DROP_TABLE ('#VT_FUNC_FACT_STMARKETING_TMP');
	CALL PMART.P_DROP_TABLE ('#VT_FUNC_FACT_STMARKETING_RAISE_TMP');
	CALL PMART.P_DROP_TABLE ('#VT_FUNC_FACT_STMARKETING');
    SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FACT_STMARKETING_TMP AS('
	    			     + ' SELECT  T2.GROUP_ORG_ID AS ORG_ID,T1.TIME_ID,T1.ACT_ID, '
	    			     + '                 SUM(TX_AMT)SALE_AMT,SUM(CIG_AMT)CIG_AMT,SUM(DIS_SUB_AMT)DIS_SUB_AMT, '
	    			     + '                 SUM(TX_CNT)TRAN_CNT,SUM(DAISO_AMT)DAISO_AMT,SUM(DAIFU_AMT)DAIFU_AMT '
	    			     + '                 ,SUM(MARKETING_TRAN_CNT)MARKETING_TRAN_CNT,SUM(MARKETING_TOT_POINT)MARKETING_TOT_POINT,SUM(MARKETING_NOTRAN_POINT)MARKETING_NOTRAN_POINT,SUM(MARKETING_CAL_POINT)MARKETING_CAL_POINT,SUM(MARKETING_POINT)MARKETING_POINT,SUM(MARKETING_POMO_POINT)MARKETING_POMO_POINT '
						 + '    FROM PMART.FACT_STMARKETING T1  '
						 + '  	 INNER JOIN ( '
						 + '	                     	SELECT ' + ORGSELECT 
  					     + '			                    FROM PMART.LAST_ORG_STORE '
						 + '                            WHERE 1=1 ';
    IF P_ORGID<> '' THEN 
        SET SQLSTR = SQLSTR + '			' + ORGWHERE;
    END IF;
	SET SQLSTR = SQLSTR + '		      ) T2 ON T1.ORG_ID = T2.OSTORE_ID '	
	    	  				         + ' WHERE T1.TIME_ID IN ('+P_TIMEID+')'				 
			    			         + '       AND T1.ACT_ID = '  + P_ACTID
	                                 + '  GROUP BY  T2.GROUP_ORG_ID,T1.TIME_ID,T1.ACT_ID '
					    	         + ' ) WITH DATA PRIMARY INDEX(ORG_ID,TIME_ID,ACT_ID) ON COMMIT PRESERVE ROWS;';
    EXECUTE IMMEDIATE SQLSTR;   
    SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FACT_STMARKETING_RAISE_TMP AS('
	    			     + ' SELECT  T2.GROUP_ORG_ID AS ORG_ID,T1.TIME_ID,T1.ACT_ID, RAISE_ID, '
	    			     + '                 SUM(SALE_CNT)SALE_CNT  '
						 +'			      ,SUM(SHOW_POINT_CNT) AS POINT_CNT '					 
						 + '    FROM PMART.FACT_STMARKETING_RAISE T1  '
						 + '  	 INNER JOIN ( '
						 + '	                     	SELECT ' + ORGSELECT 
  					     + '			                    FROM PMART.LAST_ORG_STORE '
						 + '                            WHERE 1=1 ';
    IF P_ORGID<> '' THEN 
        SET SQLSTR = SQLSTR + '			' + ORGWHERE;
    END IF;
	SET SQLSTR = SQLSTR + '		      ) T2 ON T1.ORG_ID = T2.OSTORE_ID '	
	    	  				         + ' WHERE T1.TIME_ID IN ('+P_TIMEID+')'				 
			    			         + '       AND T1.ACT_ID = '  + P_ACTID
	                                 + '  GROUP BY  T2.GROUP_ORG_ID,T1.TIME_ID,T1.ACT_ID,T1.RAISE_ID  '
					    	         + ' ) WITH DATA PRIMARY INDEX(ORG_ID,TIME_ID,ACT_ID,RAISE_ID ) ON COMMIT PRESERVE ROWS;';
    EXECUTE IMMEDIATE SQLSTR;   	
	CALL PMART.FUNC_FACT_STMARKETING_DIM(P_ACTID);
	SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FACT_STMARKETING AS(' 
                        + ' SELECT V1.ORG_ID,V1.TIME_ID,V2.ITEM_ID,V1.SALE_AMT VAL '
                        + '     FROM #VT_FUNC_FACT_STMARKETING_TMP V1 INNER JOIN #VT_FUNC_FACT_STMARKETING_DIM V2 ON ITEM_COL=''SALE_AMT'' '
                        + ' UNION ALL	'
                        + ' SELECT V1.ORG_ID,V1.TIME_ID,V2.ITEM_ID,V1.CIG_AMT VAL '
                        + '     FROM #VT_FUNC_FACT_STMARKETING_TMP V1 INNER JOIN #VT_FUNC_FACT_STMARKETING_DIM V2 ON ITEM_COL=''CIG_AMT'' '
                        + ' UNION ALL	'
                        + ' SELECT V1.ORG_ID,V1.TIME_ID,V2.ITEM_ID,V1.DIS_SUB_AMT VAL'
                        + '     FROM #VT_FUNC_FACT_STMARKETING_TMP V1 INNER JOIN #VT_FUNC_FACT_STMARKETING_DIM V2 ON ITEM_COL=''DIS_SUB_AMT'' '
                        + ' UNION ALL	'
                        + ' SELECT V1.ORG_ID,V1.TIME_ID,V2.ITEM_ID,V1.TRAN_CNT VAL '
                        + '     FROM #VT_FUNC_FACT_STMARKETING_TMP V1 INNER JOIN #VT_FUNC_FACT_STMARKETING_DIM V2 ON ITEM_COL=''TRAN_CNT'' '
                        + ' UNION ALL	'
                        + ' SELECT V1.ORG_ID,V1.TIME_ID,V2.ITEM_ID,V1.DAISO_AMT VAL '
                        + '     FROM #VT_FUNC_FACT_STMARKETING_TMP V1 INNER JOIN #VT_FUNC_FACT_STMARKETING_DIM V2 ON ITEM_COL=''DAISO_AMT''  '
                        + ' UNION ALL	'
                        + ' SELECT V1.ORG_ID,V1.TIME_ID,V2.ITEM_ID,V1.DAIFU_AMT VAL '
                        + '     FROM #VT_FUNC_FACT_STMARKETING_TMP V1 INNER JOIN #VT_FUNC_FACT_STMARKETING_DIM V2 ON ITEM_COL=''DAIFU_AMT'' '
                        + ' UNION ALL	'
                        + ' SELECT V1.ORG_ID,V1.TIME_ID,V2.ITEM_ID,V1.MARKETING_TRAN_CNT VAL '
                        + '     FROM #VT_FUNC_FACT_STMARKETING_TMP V1 INNER JOIN #VT_FUNC_FACT_STMARKETING_DIM V2 ON ITEM_COL=''MARKETING_TRAN_CNT''  '
                        + ' UNION ALL	'
                        + ' SELECT V1.ORG_ID,V1.TIME_ID,V2.ITEM_ID,V1.MARKETING_TOT_POINT VAL '
                         + '    FROM #VT_FUNC_FACT_STMARKETING_TMP V1 INNER JOIN #VT_FUNC_FACT_STMARKETING_DIM V2 ON ITEM_COL=''MARKETING_TOT_POINT'' '
                        + ' UNION ALL	'
                        + ' SELECT V1.ORG_ID,V1.TIME_ID,V2.ITEM_ID,V1.MARKETING_CAL_POINT VAL '
                         + '    FROM #VT_FUNC_FACT_STMARKETING_TMP V1 INNER JOIN #VT_FUNC_FACT_STMARKETING_DIM V2 ON ITEM_COL=''MARKETING_CAL_POINT'' '						 
                        + ' UNION ALL	'						
                        + ' SELECT V1.ORG_ID,V1.TIME_ID,V2.ITEM_ID,V1.MARKETING_NOTRAN_POINT VAL '
                        + '     FROM #VT_FUNC_FACT_STMARKETING_TMP V1 INNER JOIN #VT_FUNC_FACT_STMARKETING_DIM V2 ON ITEM_COL=''MARKETING_NOTRAN_POINT'' '
                        + ' UNION ALL	'								
                        + ' SELECT V1.ORG_ID,V1.TIME_ID,V2.ITEM_ID,V1.MARKETING_POINT VAL '
                        + '     FROM #VT_FUNC_FACT_STMARKETING_TMP V1 INNER JOIN #VT_FUNC_FACT_STMARKETING_DIM V2 ON ITEM_COL=''MARKETING_POINT'' '
                        + ' UNION ALL	'
                        + ' SELECT V1.ORG_ID,V1.TIME_ID,V2.ITEM_ID,V1.MARKETING_POMO_POINT VAL '
                        + '     FROM #VT_FUNC_FACT_STMARKETING_TMP V1 INNER JOIN #VT_FUNC_FACT_STMARKETING_DIM V2 ON ITEM_COL=''MARKETING_POMO_POINT'' '
                        + ' UNION ALL	'
                        + ' SELECT V1.ORG_ID,V1.TIME_ID,V2.ITEM_ID,V1.POINT_CNT VAL '
                        + '     FROM #VT_FUNC_FACT_STMARKETING_RAISE_TMP V1 INNER JOIN #VT_FUNC_FACT_STMARKETING_DIM V2 ON V1.RAISE_ID = V2.RAISE_ID '												
        	            + ' ) WITH DATA PRIMARY INDEX(ORG_ID,TIME_ID,ITEM_ID) ON COMMIT PRESERVE ROWS;';
	EXECUTE IMMEDIATE SQLSTR; 			
END SP;