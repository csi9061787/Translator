REPLACE PROCEDURE PMART.FUNC_FACT_FESTIVAL
(
   IN P_ACTID VARCHAR(10),
   IN P_ORGTYPE VARCHAR(10),
   IN P_GROUP VARCHAR(500),
   IN P_TIMEID VARCHAR(2000),
   IN P_ORGID VARCHAR(2000),
   IN P_PRDTYPE VARCHAR(100), 
   IN P_PRDID VARCHAR(2000),
   IN P_BRANDID VARCHAR(2000)
)
SP:BEGIN
     DECLARE SQLSTR  VARCHAR(6000);
	 DECLARE ORGSELECT VARCHAR(2000);
	 DECLARE ORGWHERE VARCHAR(2000);
	 DECLARE PRDJOIN  VARCHAR(2000); 
     DECLARE PRDANDWHERE VARCHAR(200);
	 DECLARE BRANDANDWHERE VARCHAR(2000);
	 DECLARE P_GROUP_COL VARCHAR(500);   
	 DECLARE P_GROUP_BY VARCHAR(500);   
   SET ORGWHERE = ' WHERE 1=1 ';
   IF P_ORGTYPE = '0' THEN
	    SET ORGSELECT = 'DEPT_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND PDEPT_ID  = ' + P_ORGID;
   ELSEIF P_ORGTYPE = '1' THEN
	    SET ORGSELECT = 'BRANCH_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND DEPT_ID  = ' + P_ORGID;   
   ELSEIF P_ORGTYPE = '2' THEN
        SET ORGSELECT = 'RESPON_ID AS GROUP_ORG_ID, OSTORE_ID';
	    SET ORGWHERE = ORGWHERE + ' AND BRANCH_ID = ' + P_ORGID;
   ELSEIF P_ORGTYPE = '3' THEN
        SET ORGSELECT = 'OSTORE_ID AS GROUP_ORG_ID, OSTORE_ID';
	    SET ORGWHERE = ORGWHERE + ' AND RESPON_ID = ' + P_ORGID;
   ELSEIF P_ORGTYPE = '4' THEN
        SET ORGSELECT = 'OSTORE_ID AS GROUP_ORG_ID, OSTORE_ID';
	    SET ORGWHERE = ORGWHERE + ' AND OSTORE_ID = ' + P_ORGID;
   ELSE
        SET ORGSELECT = 'PDEPT_ID AS GROUP_ORG_ID, OSTORE_ID';
   END IF;   
   	   IF P_PRDTYPE = '-1' THEN			   
	        SET PRDJOIN = ' JOIN PDATA.FESTL_PRD_SET T3 ON T3.ACT_ID = ' + P_ACTID + ' AND T1.PRD_ID = CAST(T3.FM_CODE AS VARCHAR(7)) ';
			SET PRDANDWHERE = '';			
	   ELSEIF P_PRDTYPE = '1' THEN
			SET PRDJOIN = ' JOIN PDATA.FESTL_PRD_SET T3 ON T3.ACT_ID = ' + P_ACTID + ' AND T1.PRD_ID = CAST(T3.FM_CODE AS VARCHAR(7)) ';			
	   		IF  POSITION('BRAND_ID' IN P_GROUP) <> 0 THEN   
			    SET PRDANDWHERE = '';		
			ELSE				
			    SET PRDANDWHERE = ' AND T3.CLASS_ID = ' + P_PRDID;
			END IF;
	   ELSEIF P_PRDTYPE = '2' THEN   
		    SET PRDJOIN = ' JOIN PDATA.FESTL_PRD_SET T3 ON T3.ACT_ID = ' + P_ACTID + ' AND T1.PRD_ID = CAST(T3.FM_CODE AS VARCHAR(7)) ';
			SET PRDANDWHERE = ' AND T3.DIVISION_ID = ' + P_PRDID;			
	   ELSEIF P_PRDTYPE = '3' THEN
		    SET PRDJOIN = ' JOIN PDATA.FESTL_PRD_SET T3 ON T3.ACT_ID = ' + P_ACTID + ' AND T1.PRD_ID = CAST(T3.FM_CODE AS VARCHAR(7)) ';
			SET PRDANDWHERE = ' AND T1.PRD_ID IN (' + P_PRDID + ')';	
	   END IF;
   IF POSITION('PRD_ID' IN P_GROUP) <> 0 THEN   		
			IF P_PRDTYPE = '-1' THEN
				SET P_GROUP_COL = ' TIME_ID, TO_CHAR(T3.CLASS_ID) AS PRD_ID ';
				SET P_GROUP_BY = ' TIME_ID, T3.CLASS_ID ';
		   ELSEIF P_PRDTYPE = '1' THEN   
				SET P_GROUP_COL = ' TIME_ID, TO_CHAR(T3.DIVISION_ID) AS PRD_ID ';
				SET P_GROUP_BY = ' TIME_ID, T3.DIVISION_ID ';
		   ELSEIF P_PRDTYPE = '2' THEN   
				SET P_GROUP_COL = ' TIME_ID, T1.PRD_ID AS PRD_ID ';
				SET P_GROUP_BY = ' TIME_ID, T1.PRD_ID ';
		   ELSEIF P_PRDTYPE = '3' THEN
				SET P_GROUP_COL = ' TIME_ID, T1.PRD_ID AS PRD_ID ';
				SET P_GROUP_BY = ' TIME_ID, T1.PRD_ID ';
		   END IF;		   
   ELSEIF POSITION('BRAND_ID' IN P_GROUP) <> 0 THEN   						
   			IF P_PRDTYPE = '-1' THEN
				SET P_GROUP_COL = P_GROUP;
				SET P_GROUP_BY = P_GROUP;
		   ELSEIF P_PRDTYPE = '1' THEN   
				SET P_GROUP_COL = ' TIME_ID, T3.DIVISION_ID AS BRAND_ID ';
				SET P_GROUP_BY = ' TIME_ID, T3.DIVISION_ID ';
		   ELSEIF P_PRDTYPE = '2' THEN   
				SET P_GROUP_COL = ' TIME_ID, T1.PRD_ID AS BRAND_ID ';
				SET P_GROUP_BY = ' TIME_ID, T1.PRD_ID ';
		   ELSEIF P_PRDTYPE = '3' THEN
				SET P_GROUP_COL = ' TIME_ID, T1.PRD_ID AS BRAND_ID ';
				SET P_GROUP_BY = ' TIME_ID, T1.PRD_ID ' ;
		   END IF;	
   ELSE
   			SET P_GROUP_COL = P_GROUP;
			SET P_GROUP_BY = P_GROUP;
   END IF;
   	IF P_BRANDID = '' THEN
		SET BRANDANDWHERE = '';
	ELSE
		SET BRANDANDWHERE = ' AND T3.BRAND_ID = ' + P_BRANDID;
	END IF;	
CALL PMART.P_DROP_TABLE ('#VT_FACT_FESTIVAL');
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FACT_FESTIVAL AS('
						 + ' SELECT ' + P_GROUP_COL + ', '
					     + '               SUM(T1.SALE_CNT) AS SALE_CNT, SUM(T1.SALE_AMT) AS SALE_AMT, '
						 + '				SUM(T1.FINAL_SALE_AMT) AS FINAL_SALE_AMT '
						 + '	    FROM PMART.FACT_FESTIVAL T1 '
						 + '		JOIN ( '
						 + '			SELECT ' + ORGSELECT 
						 + '			    FROM PMART.LAST_ORG_STORE '
						 + '			' + ORGWHERE
						 + '		) T2 ON T1.ORG_ID = T2.OSTORE_ID '
						 + '           ' + PRDJOIN
						 + '      JOIN PDATA.FESTL_CSPRG T4 ON T3.ACT_ID = T4.ACT_ID AND T3.PRICE BETWEEN T4.SCSP AND T4.ECSP '
						 + '		WHERE T1.ACT_ID = ' + P_ACTID + ' AND T1.TIME_ID IN ('+P_TIMEID+')' 						
					     +         PRDANDWHERE + BRANDANDWHERE
						 + '		 GROUP BY ' + P_GROUP_BY
			             + ' ) WITH DATA PRIMARY INDEX('+ P_GROUP +') ON COMMIT PRESERVE ROWS;';						  					
    EXECUTE IMMEDIATE SQLSTR;   
END SP;