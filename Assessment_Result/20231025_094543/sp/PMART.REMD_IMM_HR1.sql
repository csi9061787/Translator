REPLACE PROCEDURE PMART.REMD_IMM_HR1
(P_INST_DATE VARCHAR(8),P_AUTH_LEVEL NUMBER,P_DEPT_NO VARCHAR(10))
SQL SECURITY INVOKER
SP:BEGIN
	DECLARE V_SQL VARCHAR(4000) DEFAULT ''; 
	DECLARE V_YESTERDAY VARCHAR(8);
	DECLARE V_LW_DATE VARCHAR(8);
	DECLARE V_COND VARCHAR(1000);
	SET V_YESTERDAY = TO_CHAR(TO_DATE(P_INST_DATE, 'YYYYMMDD') - 1,'YYYYMMDD');
	SELECT TO_CHAR(L_DAY_LAST_WEEK,'FM00000000') INTO V_LW_DATE 
	FROM PMART.YMWD_TIME WHERE L_DAY_ID=P_INST_DATE;
	SET V_COND = (
		CASE P_AUTH_LEVEL 
			WHEN -1 THEN ''
			WHEN 0 THEN ' AND O.PDEPT_NO=''' + P_DEPT_NO + ''''
			WHEN 1 THEN ' AND O.DEPT_NO=''' + P_DEPT_NO + ''''
			WHEN 2 THEN ' AND O.BRANCH_NO=''' + P_DEPT_NO + ''''
			WHEN 3 THEN ' AND O.RESPON_NO=''' + P_DEPT_NO + ''''
		END);
	CALL PMART.P_DROP_TABLE ('#VT_REMD_IMM_HR');
	CALL PMART.P_DROP_TABLE ('#VT_REMD_IMM_HR_TMP');
	SET V_SQL =
		'CREATE MULTISET VOLATILE TABLE #VT_REMD_IMM_HR_TMP AS (
			SELECT MAX(L_DAY_ID_HR) L_DAY_ID_HR,
				SUM(CAST(AMT AS BIGINT)) / SUM(PLAN_STNUM) DAYAMT,
				SUM(CAST(LW_AMT AS BIGINT))/SUM(LW_PLAN_STNUM) LW_DAYAMT,
				SUM(CAST(LD_AMT AS BIGINT))/SUM(LD_PLAN_STNUM) LD_DAYAMT
			FROM PMART.TSC_REMD_FACT_ALL R
				INNER JOIN PMART.LAST_ORG_DIM O ON O.OSTORE_ID=R.OSTORE_ID
			WHERE L_DAY_ID=' + P_INST_DATE + V_COND +
			') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS';
	INSERT INTO #VT_SQL VALUES(V_SQL);
	EXECUTE IMMEDIATE V_SQL; 		
	SET V_SQL =
		'CREATE MULTISET VOLATILE TABLE #VT_REMD_IMM_HR AS (
		SELECT 1 AS DATA_FLAG, CAST(''' + V_LW_DATE + ''' + TO_CHAR(L_DAY_ID_HR, ''HH24MI'') AS TIMESTAMP(0) FORMAT ''Y4MMDDHHMI'') AS L_DAY_ID_HR, LW_DAYAMT AS DAYAMT
		FROM #VT_REMD_IMM_HR_TMP
		UNION ALL
		SELECT 2 AS DATA_FLAG, L_DAY_ID_HR, DAYAMT AS DAYAMT
		FROM #VT_REMD_IMM_HR_TMP
		UNION ALL
		SELECT 3 AS DATA_FLAG, CAST(''' + V_YESTERDAY + ''' + TO_CHAR(L_DAY_ID_HR, ''HH24MI'') AS TIMESTAMP(0) FORMAT ''Y4MMDDHHMI'') AS L_DAY_ID_HR, LD_DAYAMT AS DAYAMT
		FROM #VT_REMD_IMM_HR_TMP
		) WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS';
	INSERT INTO #VT_SQL VALUES(V_SQL);
	EXECUTE IMMEDIATE V_SQL; 		
	CALL PMART.P_DROP_TABLE ('#VT_REMD_IMM_HR_TMP');
END SP;