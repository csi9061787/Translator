REPLACE PROCEDURE PMART.FUNC_FACT_MMK_TRAFFIC
(
   IN P_RPTID SMALLINT,
   IN P_TIMEID VARCHAR(500),   
   IN P_ORGTYPE SMALLINT,
   IN P_ORGID VARCHAR(10),
   IN P_MMKTYPE SMALLINT,
   IN P_MMKID VARCHAR(12),   
   IN P_STATUS VARCHAR(2)   
)
SP:BEGIN
     DECLARE SQLSTR  VARCHAR(2000);
	 DECLARE ORGSELECT VARCHAR(2000);
	 DECLARE ORGWHERE VARCHAR(2000);  
	 DECLARE MMKWHERE VARCHAR(2000);  
	 DECLARE ID_VAL VARCHAR(12);
CALL PMART.P_DROP_TABLE ('#VT_FACT_MMK_TRAFFIC_TEMP');
CALL PMART.P_DROP_TABLE ('#VT_FACT_MMK_TRAFFIC');
IF P_RPTID = 1  THEN
	SET ID_VAL = P_ORGID;
	IF P_ORGTYPE = '0' THEN
		SET ORGWHERE = 'SELECT DEPT_ID GROUP_BY_ID, DEPT_ID ORG_ID FROM PMART.ORG_DEPT WHERE PDEPT_ID = ' + P_ORGID;
	ELSEIF P_ORGTYPE = '1' THEN
		SET ORGWHERE = 'SELECT BRANCH_ID GROUP_BY_ID, BRANCH_ID ORG_ID FROM PMART.ORG_BRANCH WHERE DEPT_ID = ' + P_ORGID;
	ELSEIF P_ORGTYPE = '2' THEN   
		SET ORGWHERE = 'SELECT RESPON_ID GROUP_BY_ID, OSTORE_ID ORG_ID FROM PMART.ORG_STORE WHERE BRANCH_ID = ' + P_ORGID;
	ELSEIF P_ORGTYPE = '3' THEN
		SET ORGWHERE = 'SELECT OSTORE_ID GROUP_BY_ID, OSTORE_ID ORG_ID FROM PMART.ORG_STORE WHERE RESPON_ID = ' + P_ORGID;
	ELSEIF P_ORGTYPE = '4' THEN
		SET ORGWHERE = 'SELECT OSTORE_ID GROUP_BY_ID, OSTORE_ID ORG_ID FROM PMART.ORG_STORE WHERE OSTORE_ID = ' + P_ORGID;
	ELSE
		SET ORGWHERE = 'SELECT PDEPT_ID GROUP_BY_ID, PDEPT_ID ORG_ID FROM PMART.ORG_PDEPT';
	END IF;
	 SET SQLSTR =  ' CREATE MULTISET VOLATILE TABLE #VT_FACT_MMK_TRAFFIC_TEMP  AS('		  
	                          + 'SELECT T1.TIME_ID, T2.GROUP_BY_ID, '
			                  + ' SUM(T1.TRAN_CNT) TRAN_CNT, SUM(T1.SLQTY) SLQTY, SUM(T1.SLUNT) SLUNT '
	                          + ' FROM PMART.FACT_MMK_TRAFFIC T1 '
							  + ' JOIN ( ' + ORGWHERE 
							  + ' ) T2 ON  T1.ORG_ID = T2.ORG_ID '
							  + ' WHERE T1.TIME_ID IN (' + P_TIMEID +') '
							  + ' AND T1.MMK_ID = ''' + P_MMKID + ''' '
							  + CASE WHEN P_STATUS = '-1' THEN 'AND 1=1' ELSE ' AND T1.STATUS = ' + P_STATUS END
							  + ' GROUP BY T1.TIME_ID, T2.GROUP_BY_ID '
							  + ' ) WITH DATA PRIMARY  CHARINDEX( GROUP_BY_ID,TIME_ID) ON COMMIT PRESERVE ROWS;';	
ELSE
   	 SET ID_VAL = P_MMKID;
      IF P_ORGTYPE = '3' THEN
	  		SET ORGWHERE = 'AND T1.ORG_ID IN (SELECT OSTORE_ID ORG_ID FROM PMART.ORG_STORE WHERE RESPON_ID = ' + P_ORGID + ')';
	  ELSE
	  		SET ORGWHERE = 'AND T1.ORG_ID = ' + P_ORGID;
	  END IF;
	  IF P_MMKTYPE = '2' THEN
	 		CALL PMART.FUNC_FACT_MMK_DIM(1,'2','04', SUBSTRING(TRIM(P_MMKID),1,3)); 
			SET MMKWHERE = 'SELECT MMK_VAL GROUP_BY_ID, MMK_VAL MMK_ID '
										     + ' FROM #VT_FUNC_FACT_MMK_DIM '
                                             + ' WHERE MMK_VAL <> ''-1'' '
											 + ' AND MMK_VAL = ''' + P_MMKID + '''';
	  ELSE
	  		CALL PMART.FUNC_FACT_MMK_DIM(1,'2','04', P_MMKID);
			SET MMKWHERE = 'SELECT MMK_VAL GROUP_BY_ID, MMK_VAL MMK_ID '
										     + ' FROM #VT_FUNC_FACT_MMK_DIM '
                                             + ' WHERE MMK_VAL <> ''-1'' ';
	  END IF;	 
	 SET SQLSTR =  ' CREATE MULTISET VOLATILE TABLE #VT_FACT_MMK_TRAFFIC_TEMP  AS( '
							   + ' SELECT T1.TIME_ID, T2.GROUP_BY_ID, '
							   + '			        SUM(T1.TRAN_CNT) TRAN_CNT, SUM(T1.SLQTY) SLQTY, SUM(T1.SLUNT) SLUNT '
							   + '	    FROM PMART.FACT_MMK_TRAFFIC T1 '
							   + '		JOIN (' + MMKWHERE 
							   + '		) T2 ON T1.MMK_ID = T2.MMK_ID '
							   + ' WHERE T1.TIME_ID IN (' + P_TIMEID +') '
							   +   ORGWHERE
							   + CASE WHEN P_STATUS = '-1' THEN 'AND 1=1' ELSE ' AND T1.STATUS = ' + P_STATUS END
							   + ' GROUP BY T1.TIME_ID, T2.GROUP_BY_ID '
					           + ' ) WITH DATA PRIMARY  CHARINDEX( GROUP_BY_ID,TIME_ID) ON COMMIT PRESERVE ROWS;';			  
END IF;
		        EXECUTE IMMEDIATE SQLSTR;   
				SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_FACT_MMK_TRAFFIC AS( '
										 + ' SELECT 1 DATA_TYPE, CAST(-1 AS INTEGER)  AS TIME_ID,CAST(''' + ID_VAL + ''' AS VARCHAR(12)) AS  Y_DIM, '
										 + '		          SUM(TRAN_CNT) TRAN_CNT, SUM(SLQTY) SLQTY,  SUM(CAST(SLUNT AS DECIMAL(14,0)))  SLUNT '
										 + '    FROM #VT_FACT_MMK_TRAFFIC_TEMP '
						                 + ' UNION ALL '
										 + ' SELECT 2 DATA_TYPE, CAST(TIME_ID AS INTEGER) AS TIME_ID,CAST(''' + ID_VAL + ''' AS VARCHAR(12)) AS   Y_DIM, '
						                 + '                 SUM(TRAN_CNT) TRAN_CNT, SUM(SLQTY) SLQTY,  SUM(CAST(SLUNT AS DECIMAL(14,0)))  SLUNT '
							             + ' FROM #VT_FACT_MMK_TRAFFIC_TEMP '
							             + ' GROUP BY TIME_ID '
							             + ' UNION ALL '
										 + ' SELECT 3 DATA_TYPE,CAST(-1 AS INTEGER)  AS TIME_ID, CAST(GROUP_BY_ID AS VARCHAR(12)) Y_DIM, '
						                 + '                  SUM(TRAN_CNT) TRAN_CNT, SUM(SLQTY) SLQTY,  SUM(CAST(SLUNT AS DECIMAL(14,0)))  SLUNT '
							             + ' FROM #VT_FACT_MMK_TRAFFIC_TEMP '
							             + ' GROUP BY Y_DIM '
										 + ' UNION ALL '
										 + ' SELECT 4 DATA_TYPE,CAST(TIME_ID AS INTEGER) AS TIME_ID, CAST(GROUP_BY_ID AS VARCHAR(12)) Y_DIM, '
						                 + '                 TRAN_CNT, SLQTY, CAST(SLUNT AS DECIMAL(14,0)) SLUNT '
							             + ' FROM #VT_FACT_MMK_TRAFFIC_TEMP '	
					                     + ' ) WITH DATA PRIMARY INDEX(DATA_TYPE,TIME_ID,Y_DIM) ON COMMIT PRESERVE ROWS;';
        EXECUTE IMMEDIATE SQLSTR;   		
END SP;