CREATE  PROCEDURE PMART.PICL2N_FUNC
(P_L_MONTH_ID NUMBER,P_ORG_ID NUMBER,P_LEVEL NUMBER)
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR  VARCHAR(4000); 	
   DECLARE V_TABLE_NAME VARCHAR(30);
   DECLARE V_L_MONTH_ID NUMBER;
   CALL PMART.P_DROP_TABLE ('#VT_PICL2N_FUNC'); 
   CASE P_LEVEL
      WHEN -1 THEN  
           SET SQLSTR = 
              'CREATE MULTISET VOLATILE TABLE #VT_PICL2N_FUNC  AS('+
                    'SELECT  -1 AS TOT_ID,ORG_ID, INAMT8, SALAMT8, INSALD8, ACCTAMT8, '+
                    '   INAMT11, SALAMT11, INSALD11, ACCTAMT11, '+
                    '   INAMT12, SALAMT12, INSALD12, ACCTAMT12, ACCTAMT90 '+
                    'FROM PMART.PICL3090M_SUM '+
                    'WHERE L_MONTH_ID='+P_L_MONTH_ID+' AND '+
                    'ORG_ID IN (SELECT DISTINCT PDEPT_ID FROM PMART.LATEST_ORG_DIM WHERE TOT_ID=-1 )'+
              ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';     
	  WHEN 0 THEN  
           SET SQLSTR = 
              'CREATE MULTISET VOLATILE TABLE #VT_PICL2N_FUNC  AS('+
                    'SELECT  -1 AS TOT_ID,ORG_ID, INAMT8, SALAMT8, INSALD8, ACCTAMT8, '+
                    '   INAMT11, SALAMT11, INSALD11, ACCTAMT11, '+
                    '   INAMT12, SALAMT12, INSALD12, ACCTAMT12, ACCTAMT90 '+
                    'FROM PMART.PICL3090M_SUM '+
                    'WHERE L_MONTH_ID='+P_L_MONTH_ID+' AND '+
                    'ORG_ID IN (SELECT DISTINCT DEPT_ID FROM PMART.LATEST_ORG_DIM WHERE PDEPT_ID='+P_ORG_ID+') '+
              ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';      
      WHEN 1 THEN  
           SET SQLSTR = 
              'CREATE MULTISET VOLATILE TABLE #VT_PICL2N_FUNC  AS('+
                    'SELECT  -1 AS TOT_ID,ORG_ID, INAMT8, SALAMT8, INSALD8, ACCTAMT8, '+
                    '   INAMT11, SALAMT11, INSALD11, ACCTAMT11, '+
                    '   INAMT12, SALAMT12, INSALD12, ACCTAMT12, ACCTAMT90 '+
                    'FROM PMART.PICL3090M_SUM '+
                    'WHERE L_MONTH_ID='+P_L_MONTH_ID+' AND '+
                    'ORG_ID IN '+
                    '(SELECT DISTINCT BRANCH_ID FROM PMART.LATEST_ORG_DIM WHERE DEPT_ID='+P_ORG_ID+') '+
              ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';       
      WHEN 2 THEN 
           SET SQLSTR = 
              'CREATE MULTISET VOLATILE TABLE #VT_PICL2N_FUNC  AS('+
                    'SELECT  -1 AS TOT_ID,STORE_ID AS ORG_ID, INAMT8, SALAMT8, INSALD8, ACCTAMT8, '+
                    '   INAMT11, SALAMT11, INSALD11, ACCTAMT11, '+
                    '   INAMT12, SALAMT12, INSALD12, ACCTAMT12, ACCTAMT90 '+
                    'FROM PMART.PICL3090M '+
                    'WHERE L_MONTH_ID='+P_L_MONTH_ID+' AND '+
                    'STORE_ID IN '+
                    '(SELECT DISTINCT STORE_ID FROM PMART.LATEST_ORG_DIM WHERE BRANCH_ID='+P_ORG_ID+') '+
              ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';       
   END CASE;
	EXECUTE IMMEDIATE SQLSTR;
END SP;