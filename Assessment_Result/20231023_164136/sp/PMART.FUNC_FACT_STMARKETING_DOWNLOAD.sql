REPLACE PROCEDURE PMART.FUNC_FACT_STMARKETING_DOWNLOAD
(
   IN P_ACTID INTEGER,
   IN P_ORGTYPE VARCHAR(10),   
   IN P_ORGID VARCHAR(2000),
   IN P_TIMEID VARCHAR(2000),
   IN P_TIMETYPE VARCHAR(10)
)
SP:BEGIN
    DECLARE SQLSTR  VARCHAR(10000);    
	DECLARE ORGSELECT VARCHAR(2000);
	DECLARE ORGWHERE VARCHAR(2000);  
    DECLARE TIMENAME  VARCHAR(100);  
    DECLARE TIMEWHERE  VARCHAR(2000);  		
	DECLARE V_RAISEID  INTEGER;
	DECLARE V_RAISEDLIST_OUTER  VARCHAR(2000);
	DECLARE V_RAISEDLIST_INNER  VARCHAR(2000);
	DECLARE CUR_RAISE_LIST CURSOR FOR SELECT RAISE_ID   FROM PDATA.STORMKT_RAISE_M  WHERE ACT_ID = P_ACTID  ORDER BY RAISE_ID;
	SET ORGWHERE = '';
	SET TIMENAME = '';
	SET TIMEWHERE = '';		
	SET V_RAISEDLIST_OUTER = ',A.L_TIME_NM';
	SET V_RAISEDLIST_INNER = '';
	IF P_ORGTYPE = '0' THEN
		SET ORGSELECT = 'DEPT_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND PDEPT_ID  = ' + P_ORGID;   
	ELSEIF P_ORGTYPE = '1' THEN
		SET ORGSELECT = 'BRANCH_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND DEPT_ID  = ' + P_ORGID;   
	ELSEIF P_ORGTYPE = '2' THEN
		SET ORGSELECT = 'RESPON_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND BRANCH_ID = ' + P_ORGID;
	ELSEIF P_ORGTYPE = '3' THEN
		SET ORGSELECT = 'OSTORE_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND RESPON_ID = ' + P_ORGID;
	ELSEIF P_ORGTYPE = '4' THEN
		SET ORGSELECT = 'OSTORE_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND OSTORE_ID = ' + P_ORGID;
	ELSE
		SET ORGSELECT = 'PDEPT_ID AS GROUP_ORG_ID, OSTORE_ID';
	END IF;   
    IF P_TIMETYPE = 'Y' THEN
	    SET TIMENAME = 'T3.L_YEAR_NAME L_TIME_NM ';
		SET TIMEWHERE = ' JOIN PMART.TIME_Y T3 ON T1.TIME_ID = T3.L_YEAR_ID AND T3.L_YEAR_ID IN ('+P_TIMEID+') ';
   ELSEIF P_TIMETYPE = 'M' THEN
        SET TIMENAME = 'T3.L_MONTH_NAME L_TIME_NM ';
	    SET TIMEWHERE = ' JOIN PMART.TIME_M T3 ON T1.TIME_ID = T3.L_MONTH_ID AND T3.L_MONTH_ID IN  ('+P_TIMEID+') ';
   ELSEIF P_TIMETYPE = 'D' THEN
		SET TIMENAME = 'T3.L_DAY_NAME L_TIME_NM ';
	    SET TIMEWHERE = ' JOIN PMART.TIME_D T3 ON T1.TIME_ID = T3.L_DAY_ID AND T3.L_DAY_ID IN  ('+P_TIMEID+') ';
   ELSEIF P_TIMETYPE = 'W' THEN
		SET TIMENAME = 'T3.L_WEEK_ID L_TIME_NM ';
	    SET TIMEWHERE = '  JOIN (SELECT DISTINCT ACT_ID,L_WEEK_ID FROM PDATA.ACT_TIME_W WHERE ACT_TYPE=4 )T3 ON T1.TIME_ID = T3.L_WEEK_ID AND  T1.ACT_ID = T3.ACT_ID AND T3.L_WEEK_ID IN  ('+P_TIMEID+') ';		
   END IF;		
    CALL PMART.P_DROP_TABLE ('#VT_FUNC_FACT_STMARKETING_TMP_DOWNLOAD');
	CALL PMART.P_DROP_TABLE ('#VT_FUNC_FACT_STMARKETING_RAISE_TMP_DOWNLOAD');
	CALL PMART.P_DROP_TABLE ('#VT_FUNC_FACT_STMARKETING_DOWNLOAD');
	OPEN CUR_RAISE_LIST;
	LABEL1:
	LOOP
	FETCH CUR_RAISE_LIST INTO V_RAISEID;
	IF (SQLSTATE = '02000') THEN
	  LEAVE LABEL1;
	END IF;
	SET V_RAISEDLIST_OUTER = V_RAISEDLIST_OUTER +  ',NVL(B.COL'+TRIM(CAST(V_RAISEID AS VARCHAR(50))) +',0) AS COL'+TRIM(CAST(V_RAISEID AS VARCHAR(50)));
    SET V_RAISEDLIST_INNER = V_RAISEDLIST_INNER +   ',SUM(NVL(CASE WHEN D.RAISE_ID='+TRIM(CAST(V_RAISEID AS VARCHAR(50))) +' THEN D.POINT_CNT END,0)) AS   COL'+TRIM(CAST(V_RAISEID AS VARCHAR(50)));
	END LOOP LABEL1;
	CLOSE CUR_RAISE_LIST;
    SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FACT_STMARKETING_TMP_DOWNLOAD AS('
	                     + ' SELECT T1.ORG_ID,T1.TIME_ID,T1.ACT_ID,T2.DEPT_NO,T2.BRANCH_NO,T2.STORE_NO,T2.STORE_NAME '
	    			     + '                 ,T1.SALE_AMT,T1.CIG_AMT,T1.DIS_SUB_AMT,T1.TX_CNT AS TRAN_CNT,T1.DAISO_AMT,T1.DAIFU_AMT '
	    			     + '                 ,T1.MARKETING_TRAN_CNT,T1.MARKETING_TOT_POINT,T1.MARKETING_NOTRAN_POINT,T1.MARKETING_CAL_POINT,T1.MARKETING_POINT,T1.MARKETING_POMO_POINT, ' + TIMENAME + ', T2.PDEPT_NO '
						 + '    FROM PMART.FACT_STMARKETING T1  '
						 + '  	 INNER JOIN ( '
					     + ' 	 		SELECT P.PDEPT_NO, A.DEPT_NO, B.BRANCH_NO, C.STORE_NO, C.STORE_NAME, C.OSTORE_ID '
						 + ' 			   FROM PMART.ORG_DEPT A '
					     + ' 			    JOIN PMART.ORG_BRANCH B ON A.DEPT_ID = B.DEPT_ID '
						 + ' 			    JOIN PMART.ORG_PDEPT P ON A.PDEPT_ID = P.PDEPT_ID '
					     + ' 				JOIN PMART.LAST_ORG_STORE C ON C.BRANCH_ID =  B.BRANCH_ID ';
    IF P_ORGID<> '' THEN 
        SET SQLSTR = SQLSTR + '			' + ORGWHERE;
    END IF;
	SET SQLSTR = SQLSTR + '		      ) T2 ON T1.ORG_ID = T2.OSTORE_ID '	
	                                 +    TIMEWHERE
	    	  				         + ' WHERE T1.TIME_ID IN ('+P_TIMEID+')'				 
			    			         + '       AND T1.ACT_ID = '  + P_ACTID
					    	         + ' ) WITH DATA PRIMARY INDEX(ORG_ID,TIME_ID,ACT_ID) ON COMMIT PRESERVE ROWS;';
    EXECUTE IMMEDIATE SQLSTR;   			 
    SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FACT_STMARKETING_RAISE_TMP_DOWNLOAD AS('
	                     + ' SELECT T1.ORG_ID,T1.TIME_ID,T1.ACT_ID,T2.DEPT_NO,T2.BRANCH_NO,T2.STORE_NO,T2.STORE_NAME, T1.RAISE_ID '
	    			     + '                ,T1.SHOW_POINT_CNT AS POINT_CNT  , ' + TIMENAME + ', T2.PDEPT_NO '
						 + '    FROM PMART.FACT_STMARKETING_RAISE T1  '
						 + '  	 INNER JOIN ( '
					     + ' 	 		SELECT P.PDEPT_NO, A.DEPT_NO, B.BRANCH_NO, C.STORE_NO, C.STORE_NAME, C.OSTORE_ID '
						 + ' 			   FROM PMART.ORG_DEPT A '
					     + ' 			    JOIN PMART.ORG_BRANCH B ON A.DEPT_ID = B.DEPT_ID '
						 + ' 			    JOIN PMART.ORG_PDEPT P ON A.PDEPT_ID = P.PDEPT_ID '
					     + ' 				JOIN PMART.LAST_ORG_STORE C ON C.BRANCH_ID =  B.BRANCH_ID ';
    IF P_ORGID<> '' THEN 
        SET SQLSTR = SQLSTR + '			' + ORGWHERE;
    END IF;
	SET SQLSTR = SQLSTR + '		      ) T2 ON T1.ORG_ID = T2.OSTORE_ID '	
           	                         +    TIMEWHERE
	    	  				         + ' WHERE T1.TIME_ID IN ('+P_TIMEID+')'				 
			    			         + '       AND T1.ACT_ID = '  + P_ACTID
					    	         + ' ) WITH DATA PRIMARY INDEX(ORG_ID,TIME_ID,ACT_ID,RAISE_ID ) ON COMMIT PRESERVE ROWS;';
    EXECUTE IMMEDIATE SQLSTR;   	
    SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FACT_STMARKETING_DOWNLOAD AS('
	          	          +' SELECT A.ORG_ID,A.TIME_ID,A.ACT_ID,A.DEPT_NO,A.BRANCH_NO,A.STORE_NO,A.STORE_NAME ,A.SALE_AMT,A.CIG_AMT,A.DIS_SUB_AMT,A.TRAN_CNT,A.DAISO_AMT '
                          +'                ,A.DAIFU_AMT,A.MARKETING_TRAN_CNT,A.MARKETING_TOT_POINT,MARKETING_NOTRAN_POINT,A.MARKETING_CAL_POINT,A.MARKETING_POINT,A.MARKETING_POMO_POINT' + V_RAISEDLIST_OUTER +' ,A.PDEPT_NO '
                          +'     FROM #VT_FUNC_FACT_STMARKETING_TMP_DOWNLOAD A '
                          +'                LEFT JOIN (  '
						  +'	                            		SELECT D.ORG_ID,D.TIME_ID,D.ACT_ID,D.PDEPT_NO,D.DEPT_NO,D.BRANCH_NO,D.STORE_NO,D.STORE_NAME'
						  + V_RAISEDLIST_INNER
						  +'                                           FROM  #VT_FUNC_FACT_STMARKETING_RAISE_TMP_DOWNLOAD D '
						  +'                                   GROUP BY D.ORG_ID,D.TIME_ID,D.ACT_ID,D.PDEPT_NO,D.DEPT_NO,D.BRANCH_NO,D.STORE_NO,D.STORE_NAME'
			              +'                                   )B '
		                  +'                                  ON A.ORG_ID = B.ORG_ID AND A.TIME_ID = B.TIME_ID AND A.ACT_ID = B.ACT_ID AND A.DEPT_NO = B.DEPT_NO AND A.BRANCH_NO = B.BRANCH_NO AND A.STORE_NO = B.STORE_NO '
		    	          + ' ) WITH DATA PRIMARY INDEX(ORG_ID,TIME_ID,ACT_ID,DEPT_NO,BRANCH_NO,STORE_NO) ON COMMIT PRESERVE ROWS;';
    EXECUTE IMMEDIATE SQLSTR;   		
END SP;