REPLACE PROCEDURE PMART.TSC_PRD_MAINTAIN_IMPORT
(
IN  IMPORT_TYPE INTEGER,
IN  IMPORT_CHANNEL INTEGER,
OUT DATA_CNT INTEGER
)
SQL SECURITY INVOKER
SP:BEGIN
DECLARE  DATA_TIMESTAMP TIMESTAMP(0);
SET DATA_TIMESTAMP = CURRENT_TIMESTAMP(0);
IF IMPORT_TYPE = 1 THEN 
MERGE INTO PDATA.TSC_PRD_MAINTAIN AS Z
USING PDATA.TSC_PRD_MAINTAIN_IF B
ON Z.CHANNEL_CODE = B.CHANNEL_CODE AND Z.FM_CODE = B.FM_CODE
WHEN MATCHED THEN UPDATE SET
START_DATE = TO_DATE(B.START_DATE,'YYYY/MM/DD'),
END_DATE = TO_DATE(B.END_DATE,'YYYY/MM/DD'),
UPDATE_TIME = DATA_TIMESTAMP
WHEN NOT MATCHED THEN INSERT
(
CHANNEL_CODE, FM_CODE, START_DATE, END_DATE,UPDATE_TIME
)
VALUES
(
B.CHANNEL_CODE, B.FM_CODE, TO_DATE(B.START_DATE,'YYYY/MM/DD'),TO_DATE(B.END_DATE,'YYYY/MM/DD'),DATA_TIMESTAMP
)
;
ELSE IF  IMPORT_TYPE = 2 THEN
IF  IMPORT_CHANNEL = -1 THEN 
DELETE PDATA.TSC_PRD_MAINTAIN  ALL;
ELSE
DELETE PDATA.TSC_PRD_MAINTAIN  WHERE CHANNEL_CODE=IMPORT_CHANNEL;
END IF;
INSERT INTO PDATA.TSC_PRD_MAINTAIN(CHANNEL_CODE, FM_CODE, START_DATE, END_DATE,UPDATE_TIME)
SELECT CHANNEL_CODE, FM_CODE, START_DATE, END_DATE,DATA_TIMESTAMP FROM PDATA.TSC_PRD_MAINTAIN_IF;
END IF;
END IF;
SET DATA_CNT = (SELECT COUNT(*) FROM PDATA.TSC_PRD_MAINTAIN WHERE UPDATE_TIME =DATA_TIMESTAMP );
END SP;