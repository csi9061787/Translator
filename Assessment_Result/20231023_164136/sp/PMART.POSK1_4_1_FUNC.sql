REPLACE PROCEDURE PMART.POSK1_4_1_FUNC(P_L_X_ID_1 VARCHAR(10000),
									 P_L_Y_ID_1 VARCHAR(10000),
									 P_L_DAY_ID_1 VARCHAR(10000),
									 P_DATA_TYPE VARCHAR(10000))
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR VARCHAR(64000);
   DECLARE V_SQL VARCHAR(20000);  
   CALL PMART.P_DROP_TABLE ('#VT_POSK1_4_1_FUNC'); 
   IF P_DATA_TYPE = '0' THEN
   SET V_SQL = '  SUM(SALES_CNT) AS SALES_CNT , '+
		  '  SUM(SALES_CNT) AS VALUE1 , '+
          '  CASE WHEN SUM(B.STNUM_STORE_NUM) = 0 THEN 0 ELSE CAST(SUM(SALES_CNT) AS DECIMAL(18,6)) / SUM(B.STNUM_STORE_NUM) END AS PSD ,'+
		  '  CASE WHEN SUM(B.STNUM_STORE_NUM) = 0 THEN 0 ELSE CAST(SUM(SALES_AMT) AS DECIMAL(18,6)) / SUM(B.STNUM_STORE_NUM) END AS PSW ';          
   END IF;
   IF P_DATA_TYPE = '1' THEN
   SET V_SQL = '  SUM(SALES_CNT) AS SALES_CNT , '+
          '  SUM(SALES_AMT) AS VALUE1 , '+   
		  '  CASE WHEN SUM(B.STNUM_STORE_NUM) = 0 THEN 0 ELSE CAST(SUM(SALES_CNT) AS DECIMAL(18,6))  / SUM(B.STNUM_STORE_NUM) * 7 END AS PSD, '+
          '  CASE WHEN SUM(B.STNUM_STORE_NUM) = 0 THEN 0 ELSE CAST(SUM(SALES_AMT) AS DECIMAL(18,6))  / SUM(B.STNUM_STORE_NUM) * 7 END AS PSW ';
   END IF;
   SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_POSK1_4_1_FUNC  AS('+
		'SELECT A.MMA_ID,A.PRD_ID, '+
        V_SQL +
        ' FROM PMART.BASIC_MFACT_SHOP A, (SELECT TIME_ID, BIT_EXTRACT(BIT_AND(C.STNUM_STORE_NUM,Y.MASK)) AS STNUM_STORE_NUM FROM PMART.BASIC_MAST_FACT C, PMART.LAST_ORG_DIM_MASK Y WHERE Y.ORG_ID= -1 AND C.TIME_ID IN('+ P_L_DAY_ID_1 +')) B '+
        'WHERE A.TIME_ID IN('+ P_L_DAY_ID_1 +') '+
        'AND A.ORG_ID = -1 '+
        'AND A.MMA_ID IN('+ P_L_X_ID_1 +') '+
        'AND A.PRD_ID IN('+ P_L_Y_ID_1 +') '+
        'AND A.TIME_ID = B.TIME_ID '+
        'GROUP BY A.PRD_ID,A.MMA_ID '+
   ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;'; 
	EXECUTE IMMEDIATE SQLSTR;
END SP;