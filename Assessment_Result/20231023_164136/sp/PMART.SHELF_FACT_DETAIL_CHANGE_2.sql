REPLACE PROCEDURE PMART.SHELF_FACT_DETAIL_CHANGE_2 (IN P_DAY_ID NUMBER)
SQL SECURITY INVOKER
SP:BEGIN
  DECLARE SQLSTR  VARCHAR(4000) DEFAULT '';
  DECLARE P_L_DAY_ID NUMBER;
  DECLARE P_TIME_ID NUMBER;  
  DECLARE STORE_CS CURSOR FOR STORE_SQL;    
  DELETE FROM PMART.SHELF_FACT_CHANGE        ;
  DELETE FROM PMART.SHELF_FACT_DETAIL_CHANGE ;
  DELETE FROM PTEMP.SHELF_FACT_DAY_CHANGE WHERE STYPE ='2' ;
  SET SQLSTR =' SELECT ' +
              ' CAST(CAST(L_DAY_ID AS DATE) + 7 AS INTEGER) ' +  
              ',L_DAY_ID                               ' +  
              '   FROM PMART.YMWD_TIME A INNER JOIN (  ' +
              '   SELECT DISTINCT TIME_ID_S,TIME_ID_E  ' +
              '     FROM PMART.SHELF_DIM A             ' +
              '    WHERE L_DAY_ID  =  '+P_DAY_ID+') B' +
              '       ON A.L_DAY_ID >= B.TIME_ID_S     ' +
              '      AND A.L_DAY_ID <= B.TIME_ID_E     ' +
              '    ORDER BY A.L_DAY_ID                 ' +
              '  ';                  
  PREPARE STORE_SQL FROM SQLSTR;
  OPEN STORE_CS;  
  L1:
  WHILE (SQLCODE =0) 
  DO    
     L1_1:
        BEGIN 
         FETCH STORE_CS INTO P_L_DAY_ID,P_TIME_ID  ;
         IF SQLSTATE <> '00000' THEN LEAVE L1; END IF; 	   
         INSERT INTO PTEMP.SHELF_FACT_DAY_CHANGE (L_DAY_ID,TIME_ID,STYPE,UPDATE_TIME ) 
         VALUES (P_L_DAY_ID,P_TIME_ID,'2',CURRENT_TIMESTAMP(0));              
DELETE FROM PTEMP.TP2_DAY_PRD_SALE_CHANGE;
DELETE FROM PTEMP.TP3_DAY_PRD_INPRD_CHANGE;
DELETE FROM PTEMP.TP4_DAY_PRD_STORE_CHANGE;
INSERT INTO PTEMP.TP2_DAY_PRD_SALE_CHANGE
SELECT CAST(TO_CHAR(P.TX_DTTM, 'YYYYMMDD') AS INTEGER) AS L_DAY_ID,
       P.CD_FMCODE AS PRD_ID,
       P.OSTORE_ID AS OSTORE_ID,
       SUM(P.QT_ITEM * P.DWH_FG) AS SALE_CNT,
       SUM(P.AM_ITEM * P.DWH_FG) AS SALE_AMT,
       SUM((P.AM_ITEM - P.AM_SUB_SUB - P.AM_DIS_SUB) * P.DWH_FG) AS REAL_SALE_AMT
  FROM PDATA.TRANS_PRODUCT_DETAIL P
 WHERE P.TX_DTTM >= CAST(P_L_DAY_ID -19000000 AS DATE) - 7 
   AND P.TX_DTTM <  CAST(P_L_DAY_ID -19000000 AS DATE) - 6 
 GROUP BY CAST(TO_CHAR(P.TX_DTTM, 'YYYYMMDD') AS INTEGER) ,P.CD_FMCODE,P.OSTORE_ID
; 
INSERT INTO  PTEMP.TP3_DAY_PRD_INPRD_CHANGE 
SELECT I.STINDT AS L_DAY_ID,
       I.CMNO AS PRD_ID,
       CAST(S.OSTORE_NO AS INTEGER) AS OSTORE_ID,
       SUM(I.INQTY) AS INPRD_CNT,
       SUM(I.INQTY * I.SLUNT) AS INPRD_AMT
  FROM PDATA.INPRDDETAIL I
  JOIN PDATA.PBMSTOR S ON I.STNO=CAST(S.STORE_NO AS INTEGER)
 WHERE I.STINDT >= CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)
   AND I.STINDT <  CAST(CAST(P_L_DAY_ID AS DATE) - 6 AS INTEGER)
 GROUP BY I.STINDT, I.CMNO,S.OSTORE_NO
; 
INSERT INTO PTEMP.TP4_DAY_PRD_STORE_CHANGE
SELECT CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) AS L_DAY_ID
,D.SHELF_ID
,D.SHELF_ID2
,D.PRD_ID
,T3.OSTORE_ID
,CAST(NVL(T3.SALE_CNT,0) AS BIGINT) AS SALE_CNT
,CAST(NVL(T3.SALE_AMT,0) AS BIGINT)  AS SALE_AMT
,CAST(NVL(T3.REAL_SALE_AMT,0) AS BIGINT)  AS REAL_SALE_AMT
,CAST(0 AS BIGINT) AS INPRD_CNT
,CAST(0 AS BIGINT) AS INPRD_AMT
  FROM PMART.SHELF_DIM D LEFT JOIN (SELECT T2.L_DAY_ID
                                            ,T1.SHELF_GROUP_ID
                                            ,T2.PRD_ID
                                            ,T2.OSTORE_ID
                                            ,T2.SALE_CNT
                                            ,T2.SALE_AMT
                                            ,T2.REAL_SALE_AMT
 					FROM PSTAGE.ST_DAY_STORE_SHELF T1 JOIN PTEMP.TP2_DAY_PRD_SALE_CHANGE T2 
 					  ON T1.L_DAY_ID=T2.L_DAY_ID 
 					 AND T1.PRD_ID=T2.PRD_ID 
 					 AND T1.OSTORE_ID=T2.OSTORE_ID) T3
      ON T3.SHELF_GROUP_ID=D.SHELF_GROUP_ID 
     AND T3.PRD_ID=D.PRD_ID
 WHERE 1=1
   AND CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) >= D.TIME_ID_S 
   AND CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) <= D.TIME_ID_E
;         
MERGE INTO PTEMP.TP4_DAY_PRD_STORE_CHANGE A
USING (
SELECT CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) AS L_DAY_ID,
       D.SHELF_ID,
       D.SHELF_ID2,
       D.PRD_ID,
       T3.OSTORE_ID,
       SUM(NVL(T3.INPRD_CNT, 0)) AS INPRD_CNT,
       SUM(NVL(T3.INPRD_AMT, 0)) AS INPRD_AMT
  FROM PMART.SHELF_DIM D  LEFT JOIN (SELECT T2.L_DAY_ID,
                                              T1.SHELF_GROUP_ID,
                                              T2.PRD_ID,
                                              T2.OSTORE_ID,
                                              SUM(T2.INPRD_CNT) AS INPRD_CNT,
                                              SUM(T2.INPRD_AMT) AS INPRD_AMT
                                         FROM PSTAGE.ST_DAY_STORE_SHELF T1 JOIN PTEMP.TP3_DAY_PRD_INPRD_CHANGE T2 
                                           ON T1.L_DAY_ID = T2.L_DAY_ID 
                                          AND T1.PRD_ID = T2.PRD_ID 
                                          AND T1.OSTORE_ID = T2.OSTORE_ID
                                        GROUP BY T2.L_DAY_ID, T1.SHELF_GROUP_ID, T2.PRD_ID, T2.OSTORE_ID) T3
    ON T3.SHELF_GROUP_ID = D.SHELF_GROUP_ID 
   AND T3.PRD_ID = D.PRD_ID
 WHERE 1=1
 AND CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) >= D.TIME_ID_S 
 AND CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) <= D.TIME_ID_E
 GROUP BY D.L_DAY_ID, D.SHELF_ID, D.SHELF_ID2, D.PRD_ID, T3.OSTORE_ID) B
 ON A.L_DAY_ID =B.L_DAY_ID 
AND A.OSTORE_ID=B.OSTORE_ID 
AND A.PRD_ID   =B.PRD_ID 
AND A.SHELF_ID =B.SHELF_ID
AND A.SHELF_ID2=B.SHELF_ID2
WHEN MATCHED THEN UPDATE SET
 INPRD_AMT = B.INPRD_AMT
,INPRD_CNT = B.INPRD_CNT
WHEN NOT MATCHED THEN INSERT(
 L_DAY_ID
,SHELF_ID
,SHELF_ID2
,PRD_ID
,OSTORE_ID
,SALE_CNT
,SALE_AMT
,REAL_SALE_AMT
,INPRD_AMT
,INPRD_CNT)
VALUES (
 B.L_DAY_ID
,B.SHELF_ID
,B.SHELF_ID2
,B.PRD_ID
,B.OSTORE_ID
,0
,0
,0
,B.INPRD_AMT
,B.INPRD_CNT);
DELETE FROM PMART.SHELF_FACT_CHANGE        WHERE TIME_ID=CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER);
DELETE FROM PMART.SHELF_FACT_DETAIL_CHANGE WHERE TIME_ID=CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER);
INSERT INTO PMART.SHELF_FACT_DETAIL_CHANGE
(TIME_ID
,ORG_ID
,SHELF_ID
,SHELF_ID2
,PRD_ID
,SALES_CNT
,SALES_AMT
,REAL_SALES_AMT
,INPRD_CNT
,INPRD_AMT)
SELECT L_DAY_ID
      ,-1
      ,SHELF_ID
      ,SHELF_ID2
      ,PRD_ID
      ,CASE WHEN SHELF_ID2 IS NULL  THEN SUM(SALE_CNT)  ELSE 0 END AS SALE_CNT
      ,CASE WHEN SHELF_ID2 IS NULL  THEN SUM(SALE_AMT)  ELSE 0 END AS SALE_AMT
      ,CASE WHEN SHELF_ID2 IS NULL  THEN SUM(REAL_SALE_AMT)  ELSE 0 END AS REAL_SALE_AMT
      ,CASE WHEN SHELF_ID2 IS NULL  THEN SUM(INPRD_CNT)  ELSE 0 END AS INPRD_CNT
      ,CASE WHEN SHELF_ID2 IS NULL  THEN SUM(INPRD_AMT)  ELSE 0 END AS INPRD_AMT
  FROM PTEMP.TP4_DAY_PRD_STORE_CHANGE
 GROUP BY L_DAY_ID, SHELF_ID, SHELF_ID2, PRD_ID
;
UPDATE F
  FROM PMART.SHELF_FACT_DETAIL_CHANGE F,
      (SELECT CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) AS L_DAY_ID
             ,-1 AS ORG_ID
             ,V.SHELF_ID
             ,V.SHELF_NO
             ,COUNT(S.OSTORE_ID) AS ST_NUM
         FROM PSTAGE.ST_SHE_SHELF_STORE S INNER JOIN PMART.SHELF_NO_DIM V 
           ON V.SHELF_GROUP_NO = S.SHELF_GROUP_ID
                                            INNER JOIN PMART.REMD_FACT F 
           ON F.OSTORE_ID = S.OSTORE_ID 
          AND F.L_DAY_ID = CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) 
          AND F.UPLOAD_STNUM = 1
        WHERE S.L_DAY_ID = CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)
        GROUP BY V.SHELF_ID, V.SHELF_NO)  B
SET ST_NUM= B.ST_NUM
WHERE F.TIME_ID =B.L_DAY_ID 
  AND F.ORG_ID  =B.ORG_ID 
  AND F.SHELF_ID=B.SHELF_NO
;
UPDATE F
  FROM PMART.SHELF_FACT_DETAIL_CHANGE F,
      (SELECT CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) AS L_DAY_ID
             ,-1 AS ORG_ID
             ,D2.SHELF_ID
             ,D2.SHELF_ID2
             ,COUNT(DISTINCT S.OSTORE_ID) AS ST_NUM
         FROM PSTAGE.ST_SHE_SHELF_STORE S INNER JOIN (SELECT DISTINCT L_DAY_ID,TIME_ID_S,TIME_ID_E,SHELF_GROUP_ID,SHELF_ID 
                                                          FROM PMART.SHELF_DIM 
                                                         WHERE CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)>=TIME_ID_S
		                                           AND CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)<=TIME_ID_E 
		                                           AND STYLE=1) D1 
           ON D1.SHELF_GROUP_ID = S.SHELF_GROUP_ID
		                            INNER JOIN (SELECT DISTINCT L_DAY_ID,TIME_ID_S,TIME_ID_E,SHELF_GROUP_ID,SHELF_ID,SHELF_ID2 
		                                          FROM PMART.SHELF_DIM 
		                                         WHERE CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)>=TIME_ID_S
		                                           AND CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)<=TIME_ID_E 
		                                           AND STYLE=2) D2 
           ON D2.SHELF_ID2 = D1.SHELF_ID
                                            INNER JOIN PMART.REMD_FACT F 
           ON F.OSTORE_ID = S.OSTORE_ID 
          AND F.L_DAY_ID = CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) 
          AND F.UPLOAD_STNUM = 1
        WHERE S.L_DAY_ID = CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) 
        GROUP BY D2.SHELF_ID,D2.SHELF_ID2
      )  B
SET ST_NUM= B.ST_NUM
WHERE F.TIME_ID=B.L_DAY_ID 
  AND F.ORG_ID=B.ORG_ID 
  AND F.SHELF_ID=B.SHELF_ID 
  AND F.SHELF_ID2=B.SHELF_ID2
;
UPDATE F
  FROM PMART.SHELF_FACT_DETAIL_CHANGE F,
      (SELECT CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) AS L_DAY_ID
             ,-1 AS ORG_ID
             ,D2.SHELF_ID
             ,D2.SHELF_ID2
             ,G.PRD_ID
             ,SUM(SALE_CNT) AS SALE_CNT
             ,SUM(SALE_AMT) AS SALE_AMT
             ,SUM(REAL_SALE_AMT) AS REAL_SALE_AMT
             ,SUM(INPRD_CNT) AS INPRD_CNT
             ,SUM(INPRD_AMT) AS INPRD_AMT
         FROM PSTAGE.ST_SHE_SHELF_STORE S INNER JOIN (SELECT DISTINCT L_DAY_ID,TIME_ID_S,TIME_ID_E,SHELF_GROUP_ID,SHELF_ID 
                                                          FROM PMART.SHELF_DIM 
                                                         WHERE CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)>=TIME_ID_S
                                                           AND CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)<=TIME_ID_E 
                                                           AND STYLE=1) D1 
           ON D1.SHELF_GROUP_ID = S.SHELF_GROUP_ID
		                            INNER JOIN (SELECT DISTINCT L_DAY_ID,TIME_ID_S,TIME_ID_E,SHELF_GROUP_ID,SHELF_ID,SHELF_ID2 
		                                          FROM PMART.SHELF_DIM 
		                                         WHERE CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)>=TIME_ID_S
                                                           AND CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)<=TIME_ID_E 
                                                           AND STYLE=2) D2 
           ON D2.SHELF_ID2 = D1.SHELF_ID
                                            INNER JOIN PMART.REMD_FACT F 
           ON F.OSTORE_ID=S.OSTORE_ID 
          AND F.L_DAY_ID=CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) 
          AND F.UPLOAD_STNUM=1
                                            LEFT OUTER JOIN PTEMP.TP4_DAY_PRD_STORE_CHANGE G 
           ON S.L_DAY_ID=G.L_DAY_ID
          AND S.OSTORE_ID = G.OSTORE_ID
          AND D2.SHELF_ID =G.SHELF_ID
          AND D2.SHELF_ID2 =G.SHELF_ID2
        WHERE S.L_DAY_ID=CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) 
        GROUP BY D2.SHELF_ID,D2.SHELF_ID2,G.PRD_ID
      )  B
SET SALES_CNT= B.SALE_CNT
   ,SALES_AMT= B.SALE_AMT
   ,REAL_SALES_AMT= B.REAL_SALE_AMT
   ,INPRD_CNT= B.INPRD_CNT
   ,INPRD_AMT= B.INPRD_AMT
WHERE F.TIME_ID=B.L_DAY_ID 
  AND F.ORG_ID=B.ORG_ID 
  AND F.SHELF_ID=B.SHELF_ID 
  AND F.SHELF_ID2=B.SHELF_ID2 
  AND F.PRD_ID =B.PRD_ID
;
INSERT INTO PMART.SHELF_FACT_CHANGE
  (TIME_ID,
   ORG_ID,
   SHELF_ID,
   SHELF_LEVEL,
   SALES_CNT,
   SALES_AMT,
   REAL_SALES_AMT,
   INPRD_CNT,
   INPRD_AMT)
  SELECT A.L_DAY_ID,
         -1,
         A.SHELF_ID,
         4,
         SUM(A.SALE_CNT) AS SALE_CNT,
         SUM(A.SALE_AMT) AS SALE_AMT,
         SUM(A.REAL_SALE_AMT) AS REAL_SALE_AMT,
         SUM(A.INPRD_CNT) AS INPRD_CNT,
         SUM(A.INPRD_AMT) AS INPRD_AMT       
    FROM (SELECT L_DAY_ID,
                 SHELF_ID,
                 OSTORE_ID,
                 SUM(SALE_CNT) AS SALE_CNT,
                 SUM(SALE_AMT) AS SALE_AMT,
                 SUM(REAL_SALE_AMT) AS REAL_SALE_AMT,
                 SUM(INPRD_CNT) AS INPRD_CNT,
                 SUM(INPRD_AMT) AS INPRD_AMT
            FROM PTEMP.TP4_DAY_PRD_STORE_CHANGE
           WHERE SHELF_ID2 IS NULL
           GROUP BY L_DAY_ID, SHELF_ID,OSTORE_ID) A
   GROUP BY A.L_DAY_ID, A.SHELF_ID
;
UPDATE F
  FROM PMART.SHELF_FACT_CHANGE F,(SELECT CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) AS L_DAY_ID,
              -1 AS ORG_ID,
              4  AS SHELF_LEVEL,
              V.SHELF_ID,
              V.SHELF_NO,
              COUNT(S.OSTORE_ID) AS ST_NUM
         FROM PSTAGE.ST_SHE_SHELF_STORE S
         JOIN PMART.SHELF_NO_DIM V ON V.SHELF_GROUP_NO = S.SHELF_GROUP_ID
         JOIN PMART.REMD_FACT F 
         ON F.OSTORE_ID=S.OSTORE_ID 
         AND F.L_DAY_ID=CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) 
         AND F.UPLOAD_STNUM=1
        WHERE S.L_DAY_ID=CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)
        GROUP BY V.SHELF_ID, V.SHELF_NO) B
SET ST_NUM=B.ST_NUM
WHERE F.TIME_ID = B.L_DAY_ID AND F.ORG_ID = B.ORG_ID AND F.SHELF_ID = B.SHELF_NO AND F.SHELF_LEVEL = B.SHELF_LEVEL
;
INSERT INTO PMART.SHELF_FACT_CHANGE
(TIME_ID
,ORG_ID
,SHELF_ID
,SHELF_ID2
,SHELF_LEVEL
,ST_NUM
,SALES_CNT
,SALES_AMT
,REAL_SALES_AMT
,INPRD_CNT
,INPRD_AMT)
SELECT TIME_ID
      ,ORG_ID
      ,SHELF_ID
      ,SHELF_ID2
      ,4 AS SHELF_LEVEL
      ,0 AS ST_NUM
      ,SUM(SALES_CNT) AS SALES_CNT
      ,SUM(SALES_AMT) AS SALES_AMT
      ,SUM(REAL_SALES_AMT) AS REAL_SALES_AMT
      ,SUM(INPRD_CNT) AS INPRD_CNT
      ,SUM(INPRD_AMT) AS INPRD_AMT
  FROM PMART.SHELF_FACT_DETAIL_CHANGE
 WHERE TIME_ID = CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)
   AND SHELF_ID2 IS NOT NULL
 GROUP BY TIME_ID,ORG_ID,SHELF_ID,SHELF_ID2,ST_NUM
; 
INSERT INTO PMART.SHELF_FACT_CHANGE
(TIME_ID
,ORG_ID
,SHELF_ID
,SHELF_LEVEL
,SALES_CNT
,SALES_AMT
,REAL_SALES_AMT
,INPRD_CNT
,INPRD_AMT)
  SELECT A.L_DAY_ID
        ,-1
        ,A.SHELF_ID
        ,3
        ,SUM(A.SALE_CNT) AS SALE_CNT
        ,SUM(A.SALE_AMT) AS SALE_AMT
        ,SUM(A.REAL_SALE_AMT) AS REAL_SALE_AMT
        ,SUM(A.INPRD_CNT) AS INPRD_CNT
        ,SUM(A.INPRD_AMT) AS INPRD_AMT
    FROM (SELECT P.L_DAY_ID
                ,D.SHELF_GROUP_ID AS SHELF_ID
                ,P.OSTORE_ID
                ,SUM(P.SALE_CNT) AS SALE_CNT
                ,SUM(P.SALE_AMT) AS SALE_AMT
                ,SUM(P.REAL_SALE_AMT) AS REAL_SALE_AMT
                ,SUM(P.INPRD_CNT) AS INPRD_CNT
                ,SUM(P.INPRD_AMT) AS INPRD_AMT 
            FROM (SELECT * FROM PTEMP.TP4_DAY_PRD_STORE_CHANGE WHERE SHELF_ID2 IS NULL ) P INNER JOIN PMART.SHELF_DIM D 
              ON D.L_DAY_ID IN (SELECT CAST(TO_CHAR(MAX(SCH_PUBLISH_DATE_DATE), 'YYYYMMDD') AS INTEGER) 
                                  FROM PSTAGE.DS_SHE_M_PUBLISH 
                                 WHERE SCH_PUBLISH_DATE_DATE <= CAST(P_L_DAY_ID -19000000 AS DATE) -7 )
             AND D.SHELF_ID = P.SHELF_ID 
             AND D.PRD_ID = P.PRD_ID
           GROUP BY P.L_DAY_ID, D.SHELF_GROUP_ID, P.OSTORE_ID) A
   GROUP BY A.L_DAY_ID, A.SHELF_ID
;
UPDATE F
  FROM PMART.SHELF_FACT_CHANGE F,
     (SELECT L_DAY_ID,ORG_ID,SHELF_LEVEL,SHELF_GROUP_NO,COUNT(OSTORE_ID) AS ST_NUM 
        FROM (SELECT DISTINCT CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) AS L_DAY_ID
                    ,-1 AS ORG_ID
                    , 3 AS SHELF_LEVEL
                    ,V.SHELF_GROUP_NO
                    ,S.OSTORE_ID
                FROM PSTAGE.ST_SHE_SHELF_STORE S INNER JOIN PMART.SHELF_NO_DIM V 
                  ON V.SHELF_GROUP_NO = S.SHELF_GROUP_ID
                                                   INNER JOIN PMART.REMD_FACT F 
                  ON F.OSTORE_ID=S.OSTORE_ID 
                 AND F.L_DAY_ID=CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) 
                 AND F.UPLOAD_STNUM=1
               WHERE S.L_DAY_ID=CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)
             ) G 
       GROUP BY L_DAY_ID,ORG_ID,SHELF_LEVEL,SHELF_GROUP_NO) B
SET ST_NUM=B.ST_NUM
WHERE F.TIME_ID = B.L_DAY_ID 
  AND F.ORG_ID = B.ORG_ID 
  AND F.SHELF_ID = B.SHELF_GROUP_NO 
  AND F.SHELF_LEVEL = B.SHELF_LEVEL
; 
INSERT INTO PMART.SHELF_FACT_CHANGE
(TIME_ID
,ORG_ID
,SHELF_ID
,SHELF_ID2
,SHELF_LEVEL
,ST_NUM
,SALES_CNT
,SALES_AMT
,REAL_SALES_AMT
,INPRD_CNT
,INPRD_AMT)
   SELECT P.TIME_ID AS L_DAY_ID
         ,-1 AS ORG_ID
         ,D.SHELF_GROUP_ID AS SHELF_ID
         ,E.SHELF_GROUP_ID AS SHELF_ID2
         ,3  AS SHELF_LEVEL
         ,0  AS ST_NUM
         ,SUM(SALES_CNT) AS SALES_CNT
         ,SUM(SALES_AMT) AS SALES_AMT
         ,SUM(REAL_SALES_AMT) AS REAL_SALES_AMT
         ,SUM(INPRD_CNT) AS INPRD_CNT
         ,SUM(INPRD_AMT) AS INPRD_AMT
     FROM (SELECT * FROM PMART.SHELF_FACT_DETAIL_CHANGE
            WHERE TIME_ID = CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)
              AND SHELF_ID2 IS  NOT NULL ) P
      INNER JOIN (SELECT DISTINCT SHELF_GROUP_ID,SHELF_ID,SHELF_ID2,PRD_ID
                    FROM PMART.SHELF_DIM  
                   WHERE L_DAY_ID IN (SELECT CAST(TO_CHAR(MAX(SCH_PUBLISH_DATE_DATE), 'YYYYMMDD') AS INTEGER) 
                   FROM PSTAGE.DS_SHE_M_PUBLISH 
                  WHERE SCH_PUBLISH_DATE_DATE <= CAST(P_L_DAY_ID -19000000 AS DATE) -7)
                 ) D		        
              ON D.SHELF_ID = P.SHELF_ID 
             AND D.SHELF_ID2 = P.SHELF_ID2
             AND D.PRD_ID = P.PRD_ID	     
      INNER JOIN (SELECT DISTINCT L_DAY_ID,SHELF_GROUP_ID ,SHELF_ID
                    FROM PMART.SHELF_DIM 
                   WHERE L_DAY_ID IN (SELECT CAST(TO_CHAR(MAX(SCH_PUBLISH_DATE_DATE), 'YYYYMMDD') AS INTEGER) 
                                        FROM PSTAGE.DS_SHE_M_PUBLISH 
                                       WHERE SCH_PUBLISH_DATE_DATE <= CAST(P_L_DAY_ID -19000000 AS DATE) -7)  
                 ) E         
              ON D.SHELF_ID2 = E.SHELF_ID
    GROUP BY P.TIME_ID, D.SHELF_GROUP_ID, E.SHELF_GROUP_ID
;
INSERT INTO PMART.SHELF_FACT_CHANGE
(TIME_ID
,ORG_ID
,SHELF_ID
,SHELF_LEVEL
,SALES_CNT
,SALES_AMT
,REAL_SALES_AMT
,INPRD_CNT
,INPRD_AMT)
  SELECT A.L_DAY_ID
        ,-1
        ,A.SHELF_ID
        ,2
        ,SUM(A.SALE_CNT) AS SALE_CNT
        ,SUM(A.SALE_AMT) AS SALE_AMT
        ,SUM(A.REAL_SALE_AMT) AS REAL_SALE_AMT
        ,SUM(A.INPRD_CNT) AS INPRD_CNT
        ,SUM(A.INPRD_AMT) AS INPRD_AMT
    FROM (SELECT P.L_DAY_ID
                ,D.SHELF_TYPE_ID AS SHELF_ID
                ,P.OSTORE_ID
                ,SUM(P.SALE_CNT) AS SALE_CNT
                ,SUM(P.SALE_AMT) AS SALE_AMT
                ,SUM(P.REAL_SALE_AMT) AS REAL_SALE_AMT
                ,SUM(P.INPRD_CNT) AS INPRD_CNT
                ,SUM(P.INPRD_AMT) AS INPRD_AMT
            FROM (SELECT * FROM PTEMP.TP4_DAY_PRD_STORE_CHANGE WHERE SHELF_ID2 IS NULL ) P INNER JOIN PMART.SHELF_DIM D 
              ON D.L_DAY_ID IN (SELECT CAST(TO_CHAR(MAX(SCH_PUBLISH_DATE_DATE), 'YYYYMMDD') AS INTEGER) 
                                  FROM PSTAGE.DS_SHE_M_PUBLISH 
                                 WHERE SCH_PUBLISH_DATE_DATE <= CAST(P_L_DAY_ID -19000000 AS DATE) -7 )
             AND D.SHELF_ID = P.SHELF_ID 
             AND D.PRD_ID = P.PRD_ID 
           GROUP BY P.L_DAY_ID, D.SHELF_TYPE_ID, P.OSTORE_ID) A
   GROUP BY A.L_DAY_ID, A.SHELF_ID
;
UPDATE F
  FROM PMART.SHELF_FACT_CHANGE F,
  (SELECT L_DAY_ID,ORG_ID,SHELF_LEVEL,SHELF_TYPE_NO,COUNT(OSTORE_ID) AS ST_NUM 
     FROM (SELECT DISTINCT CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) AS L_DAY_ID
                 ,-1 AS ORG_ID
                 ,2 AS SHELF_LEVEL
                 ,V.SHELF_TYPE_NO
                 ,S.OSTORE_ID
             FROM PSTAGE.ST_SHE_SHELF_STORE S INNER JOIN PMART.SHELF_NO_DIM V 
               ON V.SHELF_TYPE_NO = S.SHELF_TYPE_ID
                                                INNER JOIN PMART.REMD_FACT F 
               ON F.OSTORE_ID=S.OSTORE_ID 
              AND F.L_DAY_ID=CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) 
              AND F.UPLOAD_STNUM=1
            WHERE S.L_DAY_ID=CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)		 
          ) G 
    GROUP BY L_DAY_ID,ORG_ID,SHELF_LEVEL,SHELF_TYPE_NO
  ) B
SET ST_NUM=B.ST_NUM
WHERE F.TIME_ID = B.L_DAY_ID 
  AND F.ORG_ID = B.ORG_ID 
  AND F.SHELF_ID = B.SHELF_TYPE_NO 
  AND F.SHELF_LEVEL = B.SHELF_LEVEL
;
INSERT INTO PMART.SHELF_FACT_CHANGE
(TIME_ID
,ORG_ID
,SHELF_ID
,SHELF_ID2
,SHELF_LEVEL
,ST_NUM
,SALES_CNT
,SALES_AMT
,REAL_SALES_AMT
,INPRD_CNT
,INPRD_AMT)
  SELECT L_DAY_ID
        ,ORG_ID
        ,SHELF_ID
        ,SHELF_ID2
        ,SHELF_LEVEL
        ,0 AS ST_NUM
        ,SUM(SALES_CNT) AS SALES_CNT
        ,SUM(SALES_AMT) AS SALES_AMT
        ,SUM(REAL_SALES_AMT) AS REAL_SALES_AMT
        ,SUM(INPRD_CNT) AS INPRD_CNT
        ,SUM(INPRD_AMT) AS INPRD_AMT
   FROM (SELECT P.TIME_ID AS L_DAY_ID
               ,-1 AS ORG_ID
               ,D.SHELF_TYPE_ID AS SHELF_ID
               ,E.SHELF_TYPE_ID AS SHELF_ID2
               ,2  AS SHELF_LEVEL
               ,P.ST_NUM
               ,SUM(SALES_CNT) AS SALES_CNT
               ,SUM(SALES_AMT) AS SALES_AMT
               ,SUM(REAL_SALES_AMT) AS REAL_SALES_AMT
               ,SUM(INPRD_CNT) AS INPRD_CNT
               ,SUM(INPRD_AMT) AS INPRD_AMT
           FROM (SELECT * FROM PMART.SHELF_FACT_DETAIL_CHANGE 
                  WHERE TIME_ID = CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)
                    AND SHELF_ID2 IS  NOT NULL ) P                   
     INNER JOIN (SELECT DISTINCT SHELF_TYPE_ID,SHELF_ID,SHELF_ID2,PRD_ID
                   FROM PMART.SHELF_DIM  
                  WHERE L_DAY_ID IN (SELECT CAST(TO_CHAR(MAX(SCH_PUBLISH_DATE_DATE), 'YYYYMMDD') AS INTEGER) 
                                       FROM PSTAGE.DS_SHE_M_PUBLISH 
                                      WHERE SCH_PUBLISH_DATE_DATE <= CAST(P_L_DAY_ID -19000000 AS DATE) -7 )
                ) D		        
             ON D.SHELF_ID = P.SHELF_ID 
            AND D.SHELF_ID2 = P.SHELF_ID2
            AND D.PRD_ID = P.PRD_ID	     
     INNER JOIN (SELECT DISTINCT L_DAY_ID ,SHELF_CLASS_ID,SHELF_TYPE_ID,SHELF_GROUP_ID,SHELF_ID,SHELF_ID2
                   FROM PMART.SHELF_DIM 
                  WHERE L_DAY_ID IN (SELECT CAST(TO_CHAR(MAX(SCH_PUBLISH_DATE_DATE), 'YYYYMMDD') AS INTEGER) 
                                       FROM PSTAGE.DS_SHE_M_PUBLISH 
                                      WHERE SCH_PUBLISH_DATE_DATE <= CAST(P_L_DAY_ID -19000000 AS DATE) -7 )
                )E         
             ON D.SHELF_ID2 = E.SHELF_ID
          GROUP BY P.TIME_ID, D.SHELF_TYPE_ID, E.SHELF_TYPE_ID,P.ST_NUM
          ) ABC
GROUP BY L_DAY_ID,ORG_ID,SHELF_ID,SHELF_ID2,SHELF_LEVEL 
;  
INSERT INTO PMART.SHELF_FACT_CHANGE
(TIME_ID
,ORG_ID
,SHELF_ID
,SHELF_LEVEL
,SALES_CNT
,SALES_AMT
,REAL_SALES_AMT
,INPRD_CNT
,INPRD_AMT)
  SELECT A.L_DAY_ID
        ,-1
        ,A.SHELF_ID
        ,1
        ,SUM(A.SALE_CNT) AS SALE_CNT
        ,SUM(A.SALE_AMT) AS SALE_AMT
        ,SUM(A.REAL_SALE_AMT) AS REAL_SALE_AMT
        ,SUM(A.INPRD_CNT) AS INPRD_CNT
        ,SUM(A.INPRD_AMT) AS INPRD_AMT
    FROM (SELECT P.L_DAY_ID
                ,D.SHELF_CLASS_ID AS SHELF_ID
                ,P.OSTORE_ID
                ,SUM(P.SALE_CNT) AS SALE_CNT
                ,SUM(P.SALE_AMT) AS SALE_AMT
                ,SUM(P.REAL_SALE_AMT) AS REAL_SALE_AMT
                ,SUM(P.INPRD_CNT) AS INPRD_CNT
                ,SUM(P.INPRD_AMT) AS INPRD_AMT
            FROM (SELECT * FROM PTEMP.TP4_DAY_PRD_STORE_CHANGE WHERE SHELF_ID2 IS NULL ) P INNER JOIN PMART.SHELF_DIM D 
              ON D.L_DAY_ID IN (SELECT CAST(TO_CHAR(MAX(SCH_PUBLISH_DATE_DATE), 'YYYYMMDD') AS INTEGER) 
                                  FROM PSTAGE.DS_SHE_M_PUBLISH 
                                 WHERE SCH_PUBLISH_DATE_DATE <= CAST(P_L_DAY_ID -19000000 AS DATE) -7 )
             AND D.SHELF_ID = P.SHELF_ID 
             AND D.PRD_ID = P.PRD_ID
           GROUP BY P.L_DAY_ID, D.SHELF_CLASS_ID, P.OSTORE_ID
         ) A
   GROUP BY A.L_DAY_ID, A.SHELF_ID
;
UPDATE F
  FROM PMART.SHELF_FACT_CHANGE F,
  (SELECT L_DAY_ID,ORG_ID,SHELF_LEVEL,SHELF_CLASS_NO,COUNT(OSTORE_ID) AS ST_NUM 
     FROM (SELECT DISTINCT CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) AS L_DAY_ID
                 ,-1 AS ORG_ID
                 ,1  AS SHELF_LEVEL
                 ,V.SHELF_CLASS_NO
                 ,S.OSTORE_ID
            FROM PSTAGE.ST_SHE_SHELF_STORE S INNER JOIN PMART.SHELF_NO_DIM V 
              ON V.SHELF_CLASS_NO = S.SHELF_CLASS_ID
                                               INNER JOIN PMART.REMD_FACT F 
              ON F.OSTORE_ID=S.OSTORE_ID 
             AND F.L_DAY_ID=CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) 
             AND F.UPLOAD_STNUM=1
           WHERE S.L_DAY_ID=CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)
          ) G GROUP BY L_DAY_ID,ORG_ID,SHELF_LEVEL,SHELF_CLASS_NO) B
SET ST_NUM=B.ST_NUM
WHERE F.TIME_ID = B.L_DAY_ID 
  AND F.ORG_ID = B.ORG_ID 
  AND F.SHELF_ID = B.SHELF_CLASS_NO 
  AND F.SHELF_LEVEL = B.SHELF_LEVEL
;
INSERT INTO PMART.SHELF_FACT_CHANGE
(TIME_ID
,ORG_ID
,SHELF_ID
,SHELF_ID2
,SHELF_LEVEL
,ST_NUM
,SALES_CNT
,SALES_AMT
,REAL_SALES_AMT
,INPRD_CNT
,INPRD_AMT)
SELECT L_DAY_ID
      ,ORG_ID
      ,SHELF_ID
      ,SHELF_ID2
      ,SHELF_LEVEL
      ,0 AS ST_NUM
      ,SUM(SALES_CNT) AS SALES_CNT
      ,SUM(SALES_AMT) AS SALES_AMT
      ,SUM(REAL_SALES_AMT) AS REAL_SALES_AMT
      ,SUM(INPRD_CNT) AS INPRD_CNT
      ,SUM(INPRD_AMT) AS INPRD_AMT
  FROM (SELECT P.TIME_ID AS L_DAY_ID
              ,-1 AS ORG_ID
              ,D.SHELF_CLASS_ID AS SHELF_ID
              ,E.SHELF_CLASS_ID AS SHELF_ID2
              ,1  AS SHELF_LEVEL
              ,P.ST_NUM
              ,SUM(SALES_CNT) AS SALES_CNT
              ,SUM(SALES_AMT) AS SALES_AMT
              ,SUM(REAL_SALES_AMT) AS REAL_SALES_AMT
              ,SUM(INPRD_CNT) AS INPRD_CNT
              ,SUM(INPRD_AMT) AS INPRD_AMT
          FROM (SELECT * FROM PMART.SHELF_FACT_DETAIL_CHANGE 
                 WHERE TIME_ID = CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)
                   AND SHELF_ID2 IS  NOT NULL ) P
    INNER JOIN (SELECT DISTINCT SHELF_CLASS_ID,SHELF_ID,SHELF_ID2,PRD_ID
                  FROM PMART.SHELF_DIM  
                 WHERE L_DAY_ID IN (SELECT CAST(TO_CHAR(MAX(SCH_PUBLISH_DATE_DATE), 'YYYYMMDD') AS INTEGER) 
                 FROM PSTAGE.DS_SHE_M_PUBLISH 
                WHERE SCH_PUBLISH_DATE_DATE <= CAST(P_L_DAY_ID -19000000 AS DATE) -7 )
               ) D		        
            ON D.SHELF_ID = P.SHELF_ID 
           AND D.SHELF_ID2 = P.SHELF_ID2
           AND D.PRD_ID = P.PRD_ID	     
    INNER JOIN (SELECT DISTINCT L_DAY_ID ,SHELF_CLASS_ID,SHELF_TYPE_ID,SHELF_GROUP_ID,SHELF_ID,SHELF_ID2
                  FROM PMART.SHELF_DIM 
                 WHERE L_DAY_ID IN (SELECT CAST(TO_CHAR(MAX(SCH_PUBLISH_DATE_DATE), 'YYYYMMDD') AS INTEGER) 
                                      FROM PSTAGE.DS_SHE_M_PUBLISH 
                                     WHERE SCH_PUBLISH_DATE_DATE <= CAST(P_L_DAY_ID -19000000 AS DATE) -7 )
               )E         
            ON D.SHELF_ID2 = E.SHELF_ID
         GROUP BY P.TIME_ID, D.SHELF_CLASS_ID, E.SHELF_CLASS_ID,P.ST_NUM
         ) ABC
GROUP BY L_DAY_ID,ORG_ID,SHELF_ID,SHELF_ID2,SHELF_LEVEL 
;   
INSERT INTO PMART.SHELF_FACT_CHANGE
(TIME_ID
,ORG_ID
,SHELF_ID
,SHELF_LEVEL
,SALES_CNT
,SALES_AMT
,REAL_SALES_AMT
,INPRD_CNT
,INPRD_AMT)
  SELECT A.L_DAY_ID
        ,-1
        ,SHELF_ID
        ,0
        ,SUM(A.SALE_CNT) AS SALE_CNT
        ,SUM(A.SALE_AMT) AS SALE_AMT
        ,SUM(A.REAL_SALE_AMT) AS REAL_SALE_AMT
        ,SUM(A.INPRD_CNT) AS INPRD_CNT
        ,SUM(A.INPRD_AMT) AS INPRD_AMT
    FROM (SELECT P.L_DAY_ID
                ,-1 AS SHELF_ID
                ,P.OSTORE_ID
                ,SUM(P.SALE_CNT) AS SALE_CNT
                ,SUM(P.SALE_AMT) AS SALE_AMT
                ,SUM(P.REAL_SALE_AMT) AS REAL_SALE_AMT
                ,SUM(P.INPRD_CNT) AS INPRD_CNT
                ,SUM(P.INPRD_AMT) AS INPRD_AMT
            FROM (SELECT * FROM PTEMP.TP4_DAY_PRD_STORE_CHANGE WHERE SHELF_ID2 IS NULL ) P INNER JOIN PMART.SHELF_DIM D 
              ON D.L_DAY_ID IN (SELECT CAST(TO_CHAR(MAX(SCH_PUBLISH_DATE_DATE), 'YYYYMMDD') AS INTEGER) 
                                  FROM PSTAGE.DS_SHE_M_PUBLISH 
                                 WHERE SCH_PUBLISH_DATE_DATE <= CAST(P_L_DAY_ID -19000000 AS DATE) -7 )
             AND D.SHELF_ID = P.SHELF_ID AND D.PRD_ID = P.PRD_ID
           GROUP BY P.L_DAY_ID, P.OSTORE_ID
         ) A
   GROUP BY A.L_DAY_ID, A.SHELF_ID
;
UPDATE F
  FROM PMART.SHELF_FACT_CHANGE F,
  (SELECT L_DAY_ID,ORG_ID,SHELF_LEVEL,SHELF_ALL_NO,COUNT(OSTORE_ID) AS ST_NUM 
     FROM (SELECT DISTINCT CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) AS L_DAY_ID
                 ,CAST(-1 AS INTEGER) AS ORG_ID
                 ,CAST(0  AS INTEGER) AS SHELF_LEVEL
                 ,CAST(-1 AS INTEGER) AS SHELF_ALL_NO
                 ,S.OSTORE_ID
             FROM PSTAGE.ST_SHE_SHELF_STORE S INNER JOIN PMART.REMD_FACT F 
               ON F.OSTORE_ID=S.OSTORE_ID 
              AND F.L_DAY_ID=CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER) 
              AND F.UPLOAD_STNUM=1
            WHERE S.L_DAY_ID=CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)
          ) G 
    GROUP BY L_DAY_ID,ORG_ID,SHELF_LEVEL,SHELF_ALL_NO
  )B
SET ST_NUM=B.ST_NUM
WHERE F.TIME_ID = B.L_DAY_ID 
  AND F.ORG_ID = B.ORG_ID 
  AND F.SHELF_ID = B.SHELF_ALL_NO 
  AND F.SHELF_LEVEL = B.SHELF_LEVEL
;
INSERT INTO PMART.SHELF_FACT_CHANGE
(TIME_ID
,ORG_ID
,SHELF_ID
,SHELF_ID2
,SHELF_LEVEL
,ST_NUM
,SALES_CNT
,SALES_AMT
,REAL_SALES_AMT
,INPRD_CNT
,INPRD_AMT)
SELECT  P.TIME_ID AS L_DAY_ID
       ,-1 AS ORG_ID
       ,-1 AS SHELF_ID
       ,-1 AS SHELF_ID2
       ,0  AS SHELF_LEVEL
       ,0  AS ST_NUM
       ,SUM(SALES_CNT) AS SALES_CNT
       ,SUM(SALES_AMT) AS SALES_AMT
       ,SUM(REAL_SALES_AMT) AS REAL_SALES_AMT
       ,SUM(INPRD_CNT) AS INPRD_CNT
       ,SUM(INPRD_AMT) AS INPRD_AMT
  FROM (SELECT * 
          FROM PMART.SHELF_FACT_DETAIL_CHANGE 
         WHERE TIME_ID = CAST(CAST(P_L_DAY_ID AS DATE) - 7 AS INTEGER)
           AND SHELF_ID2 IS NOT NULL ) P
  GROUP BY P.TIME_ID
;
         UPDATE PTEMP.SHELF_FACT_DAY_CHANGE
         SET FINISH_TIME = CURRENT_TIMESTAMP(0)
         WHERE L_DAY_ID = P_L_DAY_ID
         AND STYPE ='2'
         ;
     END L1_1;
  END WHILE L1;
  CLOSE STORE_CS;
END SP;