REPLACE PROCEDURE PMART.OLD0401_POSI1_5_RPT3_FUNC(P_L_DAY_ID VARCHAR(400),P_RPT VARCHAR(400),P_UNIT VARCHAR(400))
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR  VARCHAR(8000); 
   DECLARE V_SELECT  VARCHAR(4000); 
   DECLARE CONTINUE HANDLER FOR SQLSTATE '52010'  
   DELETE FROM #VT_POSI1_5_RPT3_FUNC ;  
   SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_POSI1_5_RPT3_FUNC  
                (TIME_ID NUMBER , PRD_ID DECIMAL(22,10) ,SALES_AMT_PSD NUMBER ,BUDGET_AMT_PSD NUMBER ,PSD_RATE NUMBER) 
                 NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';  
   EXECUTE IMMEDIATE SQLSTR;
   IF (P_RPT='RPT3_1' AND P_UNIT='GRP' ) THEN
      SET SQLSTR ='INSERT INTO #VT_POSI1_5_RPT3_FUNC(TIME_ID,PRD_ID,SALES_AMT_PSD,BUDGET_AMT_PSD,PSD_RATE) '+
           ' SELECT T.TIME_ID, '+           
           ' CAST(CAST(CAST(T.PRD_ID AS INTEGER) AS VARCHAR(10))+''.''+CAST(A.RESPON_ID AS VARCHAR(10)) AS DECIMAL(22,10)) , '+ 
           ' CASE WHEN T.UPLOAD_STNUM > 0 THEN (T.SALES_AMT-T.DIS_AMT-T.SUB_AMT)/(CAST(T.UPLOAD_STNUM AS DECIMAL(16,6))) ELSE 0 END , '+
           ' T.BUDGET_PSD , '+
           ' CASE WHEN (T.BUDGET_PSD) > 0 THEN (CASE WHEN (T.UPLOAD_STNUM) > 0 THEN (T.SALES_AMT-T.DIS_AMT-T.SUB_AMT)/(CAST(T.UPLOAD_STNUM AS DECIMAL(16,6))) ELSE 0 END)/(CAST(T.BUDGET_PSD AS DECIMAL(16,6)))*100 ELSE 0 END '+
           '  FROM (SELECT * FROM PMART.ORG_DIM_POSI1 WHERE SEQNO=1) A LEFT JOIN PMART.BASIC_MFACT_BUDGET T ON (T.PRD_ID=A.GRP_ID) '+
           ' WHERE T.TIME_ID IN('+ P_L_DAY_ID +') ';
   END IF; 
   IF (P_RPT='RPT3_1' AND P_UNIT='KND' ) THEN
      SET SQLSTR ='INSERT INTO #VT_POSI1_5_RPT3_FUNC(TIME_ID,PRD_ID,SALES_AMT_PSD,BUDGET_AMT_PSD,PSD_RATE) '+           
           ' SELECT T.TIME_ID, '+           
           ' CAST(CAST(CAST(A.KND_ID AS INTEGER) AS VARCHAR(10))+''.''+CAST(A.RESPON_ID AS VARCHAR(10)) AS DECIMAL(22,10)) , '+ 
           ' CASE WHEN MAX(T.UPLOAD_STNUM) > 0 THEN SUM(T.SALES_AMT-T.DIS_AMT-T.SUB_AMT)/MAX(CAST(T.UPLOAD_STNUM AS DECIMAL(16,6))) ELSE 0 END , '+
           ' SUM(T.BUDGET_PSD) , '+
           ' CASE WHEN (SUM(T.BUDGET_PSD)) > 0 THEN (CASE WHEN MAX(T.UPLOAD_STNUM) > 0 THEN SUM(T.SALES_AMT-T.DIS_AMT-T.SUB_AMT)/MAX(CAST(T.UPLOAD_STNUM AS DECIMAL(16,6))) ELSE 0 END)/(SUM(CAST(T.BUDGET_PSD AS DECIMAL(16,6))))*100 ELSE 0 END '+        
           '  FROM PMART.BASIC_MFACT_BUDGET T '+
           ' , (SELECT * FROM PMART.ORG_DIM_POSI1 WHERE SEQNO=1) A '+
           ' WHERE T.TIME_ID IN('+ P_L_DAY_ID +') '+
           '   AND T.PRD_ID = A.GRP_ID '+
           ' GROUP BY T.TIME_ID,A.RESPON_ID,A.KND_ID ';
   END IF;
   IF (P_RPT='RPT3_1' AND P_UNIT='RESPON') THEN
      SET SQLSTR ='INSERT INTO #VT_POSI1_5_RPT3_FUNC(TIME_ID,PRD_ID,SALES_AMT_PSD,BUDGET_AMT_PSD,PSD_RATE) '+
           ' SELECT T.TIME_ID,B.RESPON_ID AS PRD_ID, '+
           ' CASE WHEN MAX(T.UPLOAD_STNUM) > 0 THEN SUM(T.SALES_AMT-T.DIS_AMT-T.SUB_AMT)/MAX(CAST(T.UPLOAD_STNUM AS DECIMAL(16,6))) ELSE 0 END , '+
           ' SUM(T.BUDGET_PSD) , '+
           ' CASE WHEN (SUM(T.BUDGET_PSD)) > 0 THEN (CASE WHEN MAX(T.UPLOAD_STNUM) > 0 THEN SUM(T.SALES_AMT-T.DIS_AMT-T.SUB_AMT)/MAX(CAST(T.UPLOAD_STNUM AS DECIMAL(16,6))) ELSE 0 END)/(SUM(CAST(T.BUDGET_PSD AS DECIMAL(16,6))))*100 ELSE 0 END '+
           '  FROM PMART.BASIC_MFACT_BUDGET T '+
           ' , (SELECT * FROM PMART.ORG_DIM_POSI1 WHERE SEQNO=1) B '+
           ' WHERE T.TIME_ID IN('+ P_L_DAY_ID +') '+
           '   AND T.PRD_ID = B.GRP_ID '+
           ' GROUP BY T.TIME_ID,B.RESPON_ID ';
   END IF;
   IF (P_RPT='RPT3_1' AND P_UNIT='BIGKND') THEN
      SET SQLSTR ='INSERT INTO #VT_POSI1_5_RPT3_FUNC(TIME_ID,PRD_ID,SALES_AMT_PSD,BUDGET_AMT_PSD,PSD_RATE) '+
           ' SELECT T.TIME_ID,B.PRD_ID, '+
           ' CASE WHEN MAX(T.UPLOAD_STNUM) > 0 THEN SUM(T.SALES_AMT-T.DIS_AMT-T.SUB_AMT)/MAX(CAST(T.UPLOAD_STNUM AS DECIMAL(16,6))) ELSE 0 END , '+
           ' SUM(T.BUDGET_PSD) , '+
           ' CASE WHEN (SUM(T.BUDGET_PSD)) > 0 THEN (CASE WHEN MAX(T.UPLOAD_STNUM) > 0 THEN SUM(T.SALES_AMT-T.DIS_AMT-T.SUB_AMT)/MAX(CAST(T.UPLOAD_STNUM AS DECIMAL(16,6))) ELSE 0 END)/(SUM(CAST(T.BUDGET_PSD AS DECIMAL(16,6))))*100 ELSE 0 END '+
           ' FROM PMART.BASIC_MFACT_BUDGET T '+
           ' , (SELECT * FROM PMART.ORG_DIM_POSI1 WHERE SEQNO=1) A , PMART.PRD_DIM_POSI1 B '+
           ' WHERE T.TIME_ID IN('+ P_L_DAY_ID +') '+
           '   AND T.PRD_ID = A.GRP_ID '+
           '   AND A.KND_ID = B.KND_ID '+
           ' GROUP BY T.TIME_ID,B.PRD_ID ';
   END IF;
   IF (P_RPT='RPT3_1' AND P_UNIT='BRANCH') THEN
      SET SQLSTR ='INSERT INTO #VT_POSI1_5_RPT3_FUNC(TIME_ID,PRD_ID,SALES_AMT_PSD,BUDGET_AMT_PSD,PSD_RATE) '+
           ' SELECT T.TIME_ID,B.BRANCH_ID AS PRD_ID, '+
           ' CASE WHEN MAX(T.UPLOAD_STNUM) > 0 THEN SUM(T.SALES_AMT-T.DIS_AMT-T.SUB_AMT)/MAX(CAST(T.UPLOAD_STNUM AS DECIMAL(16,6))) ELSE 0 END , '+
           ' SUM(T.BUDGET_PSD) , '+
           ' CASE WHEN (SUM(T.BUDGET_PSD)) > 0 THEN (CASE WHEN MAX(T.UPLOAD_STNUM) > 0 THEN SUM(T.SALES_AMT-T.DIS_AMT-T.SUB_AMT)/MAX(CAST(T.UPLOAD_STNUM AS DECIMAL(16,6))) ELSE 0 END)/(SUM(CAST(T.BUDGET_PSD AS DECIMAL(16,6))))*100 ELSE 0 END '+
           ' FROM PMART.BASIC_MFACT_BUDGET T '+
           ' , (SELECT * FROM PMART.ORG_DIM_POSI1 WHERE SEQNO=1) B '+
           ' WHERE T.TIME_ID IN('+ P_L_DAY_ID +') '+
           '   AND T.PRD_ID = B.GRP_ID '+
           ' GROUP BY T.TIME_ID,B.BRANCH_ID ';
   END IF;
   IF (P_RPT='RPT3_1' AND P_UNIT='DEPT') THEN
      SET SQLSTR ='INSERT INTO #VT_POSI1_5_RPT3_FUNC(TIME_ID,PRD_ID,SALES_AMT_PSD,BUDGET_AMT_PSD,PSD_RATE) '+
           ' SELECT T.TIME_ID,B.DEPT_ID AS PRD_ID, '+
           ' CASE WHEN MAX(T.UPLOAD_STNUM) > 0 THEN SUM(T.SALES_AMT-T.DIS_AMT-T.SUB_AMT)/MAX(CAST(T.UPLOAD_STNUM AS DECIMAL(16,6))) ELSE 0 END , '+
           ' SUM(T.BUDGET_PSD) , '+
           ' CASE WHEN (SUM(T.BUDGET_PSD)) > 0 THEN (CASE WHEN MAX(T.UPLOAD_STNUM) > 0 THEN SUM(T.SALES_AMT-T.DIS_AMT-T.SUB_AMT)/MAX(CAST(T.UPLOAD_STNUM AS DECIMAL(16,6))) ELSE 0 END)/(SUM(CAST(T.BUDGET_PSD AS DECIMAL(16,6))))*100 ELSE 0 END '+
           ' FROM PMART.BASIC_MFACT_BUDGET T '+
           ' , (SELECT * FROM PMART.ORG_DIM_POSI1 WHERE SEQNO=1) B '+
           ' WHERE T.TIME_ID IN('+ P_L_DAY_ID +') '+
           '   AND T.PRD_ID = B.GRP_ID '+
           ' GROUP BY T.TIME_ID,B.DEPT_ID ';
   END IF;
   IF (P_RPT='RPT3_1' AND P_UNIT='TOT') THEN
      SET SQLSTR ='INSERT INTO #VT_POSI1_5_RPT3_FUNC(TIME_ID,PRD_ID,SALES_AMT_PSD,BUDGET_AMT_PSD,PSD_RATE) '+
           ' SELECT T.TIME_ID,B.TOT_ID AS PRD_ID, '+
           ' CASE WHEN MAX(T.UPLOAD_STNUM) > 0 THEN SUM(T.SALES_AMT-T.DIS_AMT-T.SUB_AMT)/MAX(CAST(T.UPLOAD_STNUM AS DECIMAL(16,6))) ELSE 0 END , '+
           ' SUM(T.BUDGET_PSD) , '+
           ' CASE WHEN (SUM(T.BUDGET_PSD)) > 0 THEN (CASE WHEN MAX(T.UPLOAD_STNUM) > 0 THEN SUM(T.SALES_AMT-T.DIS_AMT-T.SUB_AMT)/MAX(CAST(T.UPLOAD_STNUM AS DECIMAL(16,6))) ELSE 0 END)/(SUM(CAST(T.BUDGET_PSD AS DECIMAL(16,6))))*100 ELSE 0 END '+
           ' FROM PMART.BASIC_MFACT_BUDGET T '+
           ' , (SELECT * FROM PMART.ORG_DIM_POSI1 WHERE SEQNO=1) B '+
           ' WHERE T.TIME_ID IN('+ P_L_DAY_ID +') '+
           '   AND T.PRD_ID = B.GRP_ID '+
           ' GROUP BY T.TIME_ID,B.TOT_ID ';
   END IF;  
      IF (P_RPT='RPT3_1' AND P_UNIT='ALL') THEN
      SET SQLSTR ='INSERT INTO #VT_POSI1_5_RPT3_FUNC(TIME_ID,PRD_ID,SALES_AMT_PSD,BUDGET_AMT_PSD,PSD_RATE) '+
           ' SELECT T.TIME_ID,-99 AS PRD_ID, '+
           ' CASE WHEN MAX(T.UPLOAD_STNUM) > 0 THEN SUM(T.SALES_AMT-T.DIS_AMT-T.SUB_AMT)/MAX(CAST(T.UPLOAD_STNUM AS DECIMAL(16,6))) ELSE 0 END , '+
           ' SUM(T.BUDGET_PSD) , '+
           ' CASE WHEN (SUM(T.BUDGET_PSD)) > 0 THEN (CASE WHEN MAX(T.UPLOAD_STNUM) > 0 THEN SUM(T.SALES_AMT-T.DIS_AMT-T.SUB_AMT)/MAX(CAST(T.UPLOAD_STNUM AS DECIMAL(16,6))) ELSE 0 END)/(SUM(CAST(T.BUDGET_PSD AS DECIMAL(16,6))))*100 ELSE 0 END '+
           ' FROM PMART.BASIC_MFACT_BUDGET T '+
           ' , (SELECT * FROM PMART.ORG_DIM_POSI1 WHERE SEQNO=1) B '+
           ' WHERE T.TIME_ID IN('+ P_L_DAY_ID +') '+
           '   AND T.PRD_ID = B.GRP_ID '+
           ' GROUP BY T.TIME_ID ';
   END IF;  
	EXECUTE IMMEDIATE SQLSTR;
END SP;