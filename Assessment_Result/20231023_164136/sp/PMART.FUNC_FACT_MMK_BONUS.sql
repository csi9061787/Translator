REPLACE PROCEDURE PMART.FUNC_FACT_MMK_BONUS
(
   IN P_RPTID SMALLINT,
   IN P_TIMEID VARCHAR(500),
   IN P_ORGTYPE SMALLINT,
   IN P_ORGID VARCHAR(10),
   IN P_STATUS VARCHAR(2),   
   IN P_BONUS_PRDID VARCHAR(7),
   IN P_MMKTYPE SMALLINT,
   IN P_MMKID VARCHAR(10),               
   IN P_FLAGTYPE SMALLINT,
   IN P_FLAGID VARCHAR(10)               
)
SP:BEGIN
     DECLARE SQLSTR  VARCHAR(20000);
	 DECLARE ORGSELECT VARCHAR(2000);
	 DECLARE ORGWHERE VARCHAR(2000);  
	 DECLARE CONDWHERE VARCHAR(100); 
	 DECLARE STATUSWHERE VARCHAR(100); 
	 DECLARE PRDWHERE VARCHAR(100); 
	 DECLARE BONUSFLAGWHERE VARCHAR(100); 
	 DECLARE MMKWHERE VARCHAR(100); 
	 DECLARE V_GROUP VARCHAR(200);
	 DECLARE V_GROUP_SEL VARCHAR(200);
	 DECLARE V_GROUP_SELBY VARCHAR(200);
	 DECLARE V_CAST_TYPE VARCHAR(50);
	 DECLARE V_YDIM_VAL VARCHAR(50);	 
     SET V_YDIM_VAL ='-1';	 
     SET ORGWHERE = ' WHERE 1=1 ';
     SET CONDWHERE = '';	  
	 SET V_GROUP_SEL ='';
	 SET V_GROUP_SELBY ='';
	 SET STATUSWHERE = '';
	 SET PRDWHERE = '';
	 SET BONUSFLAGWHERE = '';
	 SET MMKWHERE = '';
	  IF TRIM(P_STATUS) <> '-1' THEN
	      SET STATUSWHERE = STATUSWHERE +  ' AND STATUS =''' + TRIM(P_STATUS) + '''  ';	   
	  END IF;  	  
	  IF TRIM(P_BONUS_PRDID) <> '-1' THEN
          SET PRDWHERE = PRDWHERE +  ' AND PRD_ID =''' + TRIM(P_BONUS_PRDID) + '''  ';	   
      END IF;
      IF P_RPTID = 1  THEN   
           SET V_GROUP = 'TIME_ID, STATUS';
		   IF P_STATUS <> -1 THEN
		       SET V_YDIM_VAL = P_STATUS;
		   END IF;			
		   IF TRIM(P_BONUS_PRDID) = '-1' THEN
	           SET PRDWHERE = PRDWHERE +  ' AND PRD_ID = ''-1''  ';	   
	       END IF;		   
		  IF TRIM(P_FLAGID) = '-1' THEN
	          SET BONUSFLAGWHERE = BONUSFLAGWHERE +  ' AND BONUS_FLAG = ''-1'' ';	   
	      END IF;	  		   
		  IF TRIM(P_MMKID) = '-1' THEN
	          SET MMKWHERE = MMKWHERE +  ' AND MMK_ID = ''-1''  ';	   
	      END IF;			  
      ELSEIF P_RPTID = 2  THEN  
		   SET V_GROUP = 'TIME_ID, GROUP_ORG_ID';
		   IF P_ORGTYPE <> -1 THEN
		       SET V_YDIM_VAL = P_ORGID;
		   END IF;		   		   
		   IF TRIM(P_STATUS) = '-1' THEN
		       SET STATUSWHERE = STATUSWHERE +  ' AND STATUS = ''-1'' ';	   
		   END IF;  	 		   
		   IF TRIM(P_BONUS_PRDID) = '-1' THEN
	           SET PRDWHERE = PRDWHERE +  ' AND PRD_ID = ''-1''  ';	   
	       END IF;		   		   
		  IF TRIM(P_FLAGID) = '-1' THEN
	          SET BONUSFLAGWHERE = BONUSFLAGWHERE +  ' AND BONUS_FLAG = ''-1'' ';	   
	      END IF;			   
		  IF TRIM(P_MMKID) = '-1' THEN
	          SET MMKWHERE = MMKWHERE +  ' AND MMK_ID = ''-1''  ';	   
	      END IF;			  		  
      ELSEIF P_RPTID = 3  THEN  
               SET V_GROUP = 'TIME_ID, MMK_ID';
			   IF P_MMKTYPE<>-1  THEN			   
                   SET V_GROUP = 'TIME_ID, PRD_ID';		 
				   SET V_YDIM_VAL =P_MMKID;
				   IF TRIM(CAST(LENGTH(TRIM(P_MMKID)) AS CHAR(2))) = '10' THEN
					    SET CONDWHERE = '   AND MMK_ID+PRD_ID =  ''' + TRIM(P_MMKID)+''' ';	
					ELSE
					    SET CONDWHERE = '   AND MMK_ID =  ''' + TRIM(P_MMKID)+''' ';
					END IF;	 				   
					SET V_GROUP_SEL = 'TIME_ID, MMK_ID+CASE WHEN PRD_ID=''-1'' THEN '''' ELSE PRD_ID END AS PRD_ID';
					SET V_GROUP_SELBY = 'TIME_ID, MMK_ID+CASE WHEN PRD_ID=''-1'' THEN '''' ELSE PRD_ID END';
               ELSE
			          IF TRIM(P_BONUS_PRDID) = '-1' THEN
		                  SET PRDWHERE = PRDWHERE +  ' AND PRD_ID = ''-1''  ';	
				      END IF;	
               END IF;
			   IF TRIM(P_STATUS) = '-1' THEN
			       SET STATUSWHERE = STATUSWHERE +  ' AND STATUS =''-1'' ';	   
			   END IF;    
			   IF TRIM(P_FLAGID) = '-1' THEN
		           SET BONUSFLAGWHERE = BONUSFLAGWHERE +  ' AND BONUS_FLAG = ''-1'' ';	   
		       END IF;				   
      ELSEIF P_RPTID = 4  THEN  
	       SET V_GROUP = 'TIME_ID, BONUS_FLAG';
		   IF P_FLAGTYPE<>-1  THEN			   
               SET V_GROUP = 'TIME_ID, PRD_ID';		 
			   SET V_YDIM_VAL =P_FLAGID;
			   IF TRIM(CAST(LENGTH(TRIM(P_FLAGID)) AS CHAR(2))) = '8' THEN
				    SET CONDWHERE = '   AND BONUS_FLAG+PRD_ID =  ''' + TRIM(P_FLAGID)+''' ';	
				ELSE
				    SET CONDWHERE = '   AND BONUS_FLAG =  ''' + TRIM(P_FLAGID)+''' ';
				END IF;	 
				SET V_GROUP_SEL = 'TIME_ID, BONUS_FLAG+CASE WHEN PRD_ID=''-1'' THEN '''' ELSE PRD_ID END AS PRD_ID';
		  	    SET V_GROUP_SELBY =  'TIME_ID, BONUS_FLAG+CASE WHEN PRD_ID=''-1'' THEN '''' ELSE PRD_ID END';
           ELSE
		          IF TRIM(P_BONUS_PRDID) = '-1' THEN
	                  SET PRDWHERE = PRDWHERE +  ' AND PRD_ID = ''-1''  ';	     			   			   
			      END IF;		   	   
		   END IF;		   
		   IF TRIM(P_STATUS) = '-1' THEN
		       SET STATUSWHERE = STATUSWHERE +  ' AND STATUS =''-1'' ';	   
		   END IF;  		   		   
		   IF TRIM(P_MMKID) = '-1' THEN
	           SET MMKWHERE = MMKWHERE +  ' AND MMK_ID = ''-1''  ';	   
	       END IF;			  		   
      END IF;   
    IF TRIM(V_GROUP_SEL) ='' THEN
	    SET V_GROUP_SEL = V_GROUP;
		SET V_GROUP_SELBY = V_GROUP;
	END IF;					   
    IF P_ORGTYPE = '0' THEN
	    SET ORGSELECT = 'DEPT_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND PDEPT_ID  = ' + P_ORGID;   
	ELSEIF P_ORGTYPE = '1' THEN
	    SET ORGSELECT = 'BRANCH_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND DEPT_ID  = ' + P_ORGID;   
   ELSEIF P_ORGTYPE = '2' THEN
		SET ORGSELECT = 'RESPON_ID AS GROUP_ORG_ID, OSTORE_ID';
	    SET ORGWHERE = ORGWHERE + ' AND BRANCH_ID = ' + P_ORGID;
   ELSEIF P_ORGTYPE = '3' THEN
        SET ORGSELECT = 'OSTORE_ID AS GROUP_ORG_ID, OSTORE_ID';
		SET ORGWHERE = ORGWHERE + ' AND RESPON_ID = ' + P_ORGID;
   ELSEIF P_ORGTYPE = '4' THEN
        SET ORGSELECT = 'OSTORE_ID AS GROUP_ORG_ID, OSTORE_ID';
	    SET ORGWHERE = ORGWHERE + ' AND OSTORE_ID = ' + P_ORGID;
   ELSE
        SET ORGSELECT = 'PDEPT_ID AS GROUP_ORG_ID, OSTORE_ID';
   END IF;    
   SET CONDWHERE = TRIM(CONDWHERE) +' '+ TRIM(STATUSWHERE) +' '+ TRIM(PRDWHERE)  +' '+ TRIM(BONUSFLAGWHERE)   +' '+ TRIM(MMKWHERE) ;
   IF P_RPTID = 1 THEN
       SET V_CAST_TYPE = 'CAST('''+ TRIM(V_YDIM_VAL) +'''  AS VARCHAR(2))';	      
   ELSEIF P_RPTID = 2 THEN
	   SET V_CAST_TYPE = 'CAST('''+ TRIM(V_YDIM_VAL) +'''  AS INTEGER )';
   ELSEIF P_RPTID = 3 THEN
	   SET V_CAST_TYPE = 'CAST('''+ TRIM(V_YDIM_VAL) +'''  AS VARCHAR(10))';	
   ELSEIF P_RPTID = 4 THEN
	   SET V_CAST_TYPE = 'CAST('''+ TRIM(V_YDIM_VAL) +'''  AS VARCHAR(10))';			  
   END IF;   
CALL PMART.P_DROP_TABLE ('#VT_FUNC_FACT_MMK_BONUS_TMP');
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FACT_MMK_BONUS_TMP AS('
						 + '  SELECT ' + TRIM(V_GROUP_SEL) + ', '
					     + '               SUM(T1.TX_CNT) AS TX_CNT,SUM(T1.TX_ITEM_CNT) AS TX_ITEM_CNT,SUM(T1.TX_AMT) AS TX_AMT,SUM(T1.TX_POINT) AS TX_POINT '
						 + '	    FROM PMART.FACT_MMK_BONUS T1 '
						 + '		JOIN ( '
						 + '			SELECT ' + TRIM(ORGSELECT)
						 + '			    FROM PMART.LAST_ORG_STORE S '
						 + '			' + TRIM(ORGWHERE)
						 + '		) T2 ON T1.ORG_ID = T2.OSTORE_ID '
						 + '		WHERE T1.TIME_ID IN ('+P_TIMEID+') '
						 +         TRIM(CONDWHERE)
						 + '	     GROUP BY ' + V_GROUP_SELBY
			             + '  ) WITH DATA PRIMARY INDEX('+ V_GROUP +') ON COMMIT PRESERVE ROWS;';						  					
    EXECUTE IMMEDIATE SQLSTR;   
    CALL PMART.P_DROP_TABLE ('#VT_FUNC_FACT_MMK_BONUS');		
    SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FACT_MMK_BONUS AS('						
							+ '	SELECT 1 DATA_TYPE, CAST(-1 AS INTEGER) AS  TIME_ID,' + V_CAST_TYPE + '  Y_DIM,  '
							+'                SUM(TX_CNT) AS TX_CNT,SUM(TX_ITEM_CNT) AS TX_ITEM_CNT,SUM(TX_AMT) AS TX_AMT,SUM(TX_POINT) AS TX_POINT '
							+ '	FROM #VT_FUNC_FACT_MMK_BONUS_TMP '
							+ '	UNION ALL '
							+ '	SELECT 2 DATA_TYPE, TIME_ID,' + V_CAST_TYPE + '  Y_DIM, '
							+'                SUM(TX_CNT) AS TX_CNT,SUM(TX_ITEM_CNT) AS TX_ITEM_CNT,SUM(TX_AMT) AS TX_AMT,SUM(TX_POINT) AS TX_POINT '
							+ '	FROM #VT_FUNC_FACT_MMK_BONUS_TMP '
							+ '	GROUP BY TIME_ID '
							+ '	UNION ALL '
							+ '	SELECT 3 DATA_TYPE, CAST(-1 AS INTEGER) AS  TIME_ID, ' + Replace(TRIM(V_GROUP),'TIME_ID,','')  + '  Y_DIM, '
							+'                SUM(TX_CNT) AS TX_CNT,SUM(TX_ITEM_CNT) AS TX_ITEM_CNT,SUM(TX_AMT) AS TX_AMT,SUM(TX_POINT) AS TX_POINT '
							+ '	FROM #VT_FUNC_FACT_MMK_BONUS_TMP '
							+ '	GROUP BY Y_DIM '
							+ '	UNION ALL '
							+ '	SELECT 4 DATA_TYPE,TIME_ID, ' + Replace(TRIM(V_GROUP),'TIME_ID,','')  + '  Y_DIM, '
							+'                TX_CNT,TX_ITEM_CNT,TX_AMT,TX_POINT '
							+ '	FROM #VT_FUNC_FACT_MMK_BONUS_TMP '
						    + ' ) WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS; ';
    EXECUTE IMMEDIATE SQLSTR;   				
END SP;