REPLACE PROCEDURE PMART.BI_1_3_1_SUM_FUNC(P_TIME_ID NUMBER,P_LEVEL NUMBER,P_ORG_ID NUMBER,P_PRD_ID VARCHAR(7),P_FILTER_TYPE NUMBER,P_PRD_VALUE NUMBER,P_AVGINPRD NUMBER
,P_C_RATE NUMBER,P_CP_RATE NUMBER)
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR  VARCHAR(8000);
   DECLARE ORG_STR  VARCHAR(200);
   DECLARE V_COL_NM VARCHAR(200);
   CALL PMART.P_DROP_TABLE ('#VT_BI_1_3_1_SUM_FUNC');          
   IF (P_LEVEL=-1) THEN  
      SET ORG_STR  = ' SELECT DISTINCT PDEPT_ID AS DEPT_ID ,PDEPT_NM AS DEPT_NM FROM PMART.LAST_ORG_DIM ';
      SET V_COL_NM = ' A.PDEPT_ID ';
   END IF;
   IF (P_LEVEL=0) THEN  
      SET ORG_STR  = ' SELECT DISTINCT DEPT_ID,DEPT_NM FROM PMART.LAST_ORG_DIM  WHERE PDEPT_ID='+ P_ORG_ID;
      SET V_COL_NM = ' A.DEPT_ID ';
   END IF;   
   IF (P_LEVEL=1) THEN  
      SET ORG_STR  = ' SELECT DISTINCT BRANCH_ID AS DEPT_ID,BRANCH_NM AS DEPT_NM ' + 
   		     '   FROM PMART.LAST_ORG_DIM WHERE DEPT_ID='+ P_ORG_ID;
      SET V_COL_NM = ' A.BRANCH_ID ';
   END IF;
   IF (P_LEVEL=2) THEN  
      SET ORG_STR  = ' SELECT DISTINCT RESPON_ID AS DEPT_ID,RESPON_NM AS DEPT_NM ' +
   		        'FROM PMART.LAST_ORG_DIM WHERE BRANCH_ID='+P_ORG_ID;
      SET V_COL_NM = ' A.RESPON_ID ';
   END IF;
   CALL PMART.BI_1_3_1_FUNC(P_TIME_ID,P_LEVEL,P_ORG_ID,P_PRD_ID,P_FILTER_TYPE,P_PRD_VALUE,P_AVGINPRD,P_C_RATE,P_CP_RATE);
   SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_BI_1_3_1_SUM_FUNC  AS('+
               'SELECT DEPT_ID, DEPT_NM,SUM(CNT) AS CNT '+
               'FROM ( '+
               'SELECT B.DEPT_ID,B.DEPT_NM, '+
               'CASE '+
               'WHEN A.ORG_ID IS NULL THEN 0 ELSE 1 END AS CNT '+
               'FROM  '+
               '('+ORG_STR+') B LEFT OUTER JOIN '+  
               ' #VT_BI_1_3_1_FUNC A '+               
               ' ON B.DEPT_ID = '+V_COL_NM+' ) AA '+              
               'GROUP BY DEPT_ID,DEPT_NM '+
               ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;'; 
	       EXECUTE IMMEDIATE SQLSTR;
END SP;