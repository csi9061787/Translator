REPLACE PROCEDURE PMART.FUNC_FACT_MEMBER_PRD_DOWNLOAD
(
   IN P_RPTID SMALLINT,
   IN P_TIMEID VARCHAR(1000),
   IN P_TIMETYPE VARCHAR(1),   
   IN P_ORGTYPE SMALLINT,
   IN P_ORGID VARCHAR(20),
   IN P_DISTRICTTYPE SMALLINT,
   IN P_DISTRICT VARCHAR(20),
   IN P_PRDTYPE SMALLINT,
   IN P_PRDID VARCHAR(20)
)
SP:BEGIN
   DECLARE SQLSTR  VARCHAR(20000);
   DECLARE ORGWHERE VARCHAR(2000);
   DECLARE DISWHERE VARCHAR(2000);
   DECLARE PRDWHERE VARCHAR(50);
   DECLARE BASETABLE VARCHAR(50);
   DECLARE TIMEQ  VARCHAR(1000);
   DECLARE TIMENAME  VARCHAR(100);
   DECLARE TIMEWHERE  VARCHAR(2000); 
   DECLARE DATSELECT  VARCHAR(500);
   DECLARE JOINT1  VARCHAR(5000);
   SET ORGWHERE = '  ';
   SET DISWHERE = '  ';
   SET PRDWHERE = ' WHERE 1=1 ';
	IF P_TIMETYPE = 'M' THEN
	   SET TIMEQ = 'AND T3.L_MONTH_ID IN ('+P_TIMEID+')';
	   SET TIMENAME = 'T3.L_MONTH_NAME ';
	   SET TIMEWHERE = ' INNER JOIN PMART.TIME_M T3 ON B.TIME_ID = T3.L_MONTH_ID ';
   ELSEIF P_TIMETYPE = 'W' THEN
	   SET TIMEQ = 'AND T3.L_WEEK_ID IN ('+P_TIMEID+')';
	   SET TIMENAME = 'T3.L_WEEK_NAME ';
	   SET TIMEWHERE = ' INNER JOIN PMART.TIME_W T3 ON B.TIME_ID = T3.L_WEEK_ID ';
   ELSE
	   SET TIMEQ = 'AND T3.L_DAY_ID IN ('+P_TIMEID+')';
	   SET TIMENAME = 'T3.L_DAY_NAME ';
	   SET TIMEWHERE = ' INNER JOIN PMART.TIME_D T3 ON B.TIME_ID = T3.L_DAY_ID ';
   END IF;	
   SET BASETABLE = ' PMART.FACT_MEMBER_ORG ';
   IF P_ORGTYPE = 0 THEN
	   SET ORGWHERE = ORGWHERE + ' WHERE S.PDEPT_ID  = ' + TRIM(P_ORGID); 
	ELSEIF P_ORGTYPE = 1 THEN
	   SET ORGWHERE = ORGWHERE + ' WHERE S.DEPT_ID  = ' + TRIM(P_ORGID); 
	ELSEIF P_ORGTYPE = 2 THEN
	   SET ORGWHERE = ORGWHERE + ' WHERE S.BRANCH_ID = ' + TRIM(P_ORGID);
	ELSEIF P_ORGTYPE = 3 THEN
	   SET ORGWHERE = ORGWHERE + ' WHERE S.RESPON_ID = ' + TRIM(P_ORGID);
	ELSEIF P_ORGTYPE = 4 THEN
	   SET ORGWHERE = ORGWHERE + ' WHERE S.OSTORE_ID = ' + TRIM(P_ORGID);
	END IF;
   IF P_DISTRICTTYPE = 1 THEN
	   SET DISWHERE = DISWHERE + ' AND DIST.SHOP_DIST = '''  + TRIM(P_DISTRICT) + ''' ';
   END IF;
   IF P_RPTID = 1 THEN
	   SET DATSELECT = ' ,DAT.PDEPT_NO ,DAT.PDEPT_SNAME ,DAT.DEPT_NO ,DAT.DEPT_SNAME ,DAT.BRANCH_NO ,DAT.BRANCH_SNAME ,DAT.STORE_NO ,DAT.STORE_NAME ';
   ELSEIF P_RPTID = 2 THEN
	   SET DATSELECT = ' ,DAT.SHOP_DISTTRICT_NM ';
   END IF;
	IF P_PRDTYPE = 1 THEN
		SET PRDWHERE = ' AND T4.KND_ID = '''  + P_PRDID + ''' ';
	ELSEIF P_PRDTYPE = 2 THEN
		SET PRDWHERE = ' AND T4.GRP_ID = '''  + P_PRDID + ''' ';
	ELSEIF P_PRDTYPE = 3 THEN
		SET PRDWHERE = ' AND T4.PRD_ID = '''  + P_PRDID + ''' ';
	ELSE
		SET PRDWHERE = ' ';
	END IF;
	CALL PMART.P_DROP_TABLE ('#VT_FACT_MEMBER_PRD_DOWNLOAD');
	SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FACT_MEMBER_PRD_DOWNLOAD AS('	
	   					 +' SELECT DAT.KND_NM ,DAT.GRP_NM ,DAT.PRD_NM '+DATSELECT+' ,DAT.TIME_ID ,DAT.STORE_NUM '
						 +' ,DAT.ALL_CNT ,DAT.ALL_AMT ,DAT.ALL_NUM ,DAT.ALL_NUM_PSD ,DAT.ALL_AMT_PSD '
						 +' ,DAT.MEMBER_CNT ,DAT.MEMBER_AMT ,DAT.MEMBER_NUM ,DAT.MEMBER_NUM_PSD ,DAT.MEMBER_AMT_PSD '
						 +' ,DAT.MEMBER_AMT_RATE ,DAT.MEMBER_NUM_RATE ,DAT.MEMBER_CNT_RATE ,DAT.MEMBER_REP ,DAT.MEMBER_REP_CNT '
	   					 +' FROM ( '
						 +'        SELECT '+TIMENAME+' AS TIME_ID ,B.PRD_ID ,B.STORE_NUM ,B.ALL_CNT ,B.ALL_AMT ,B.ALL_NUM '
						 +'        ,CAST(B.ALL_NUM AS DECIMAL(10,2))/CASE WHEN B.STORE_NUM = 0 THEN 1 ELSE B.STORE_NUM END AS ALL_NUM_PSD '
						 +'        ,CAST(B.ALL_AMT AS DECIMAL(10,2))/CASE WHEN B.STORE_NUM = 0 THEN 1 ELSE B.STORE_NUM END AS ALL_AMT_PSD '
						 +'        ,B.MEMBER_CNT ,B.MEMBER_AMT ,B.MEMBER_NUM '
						 +'        ,CAST(B.MEMBER_NUM AS DECIMAL(10,2))/CASE WHEN B.STORE_NUM = 0 THEN 1 ELSE B.STORE_NUM END AS MEMBER_NUM_PSD '
						 +'        ,CAST(B.MEMBER_AMT AS DECIMAL(10,2))/CASE WHEN B.STORE_NUM = 0 THEN 1 ELSE B.STORE_NUM END AS MEMBER_AMT_PSD '
						 +'        ,CAST(B.MEMBER_AMT AS DECIMAL(10,2))/CASE WHEN B.ALL_AMT = 0 THEN 1 ELSE B.ALL_AMT END AS MEMBER_AMT_RATE '
						 +'        ,CAST(B.MEMBER_NUM AS DECIMAL(10,2))/CASE WHEN B.ALL_NUM = 0 THEN 1 ELSE B.ALL_NUM END AS MEMBER_NUM_RATE '
						 +'        ,CAST(B.MEMBER_CNT AS DECIMAL(10,2))/CASE WHEN B.ALL_CNT = 0 THEN 1 ELSE B.ALL_CNT END AS MEMBER_CNT_RATE '
						 +'        ,B.MEMBER_REP ,B.MEMBER_REP_CNT '
						 +'        ,T4.KND_NO+'' ''+T4.KND_NM AS KND_NM,T4.GRP_NO+'' ''+T4.GRP_NM AS GRP_NM,T4.PRD_NO+'' ''+T4.PRD_NM AS PRD_NM ,T1.* '
						 +'        FROM '+BASETABLE+' B ' 
						 +'        INNER JOIN PMART.PRD_DIM T4 ON B.PRD_ID = T4.PRD_ID '+PRDWHERE
						 +'        INNER JOIN ( SELECT PDEPT.PDEPT_NO ,PDEPT.PDEPT_SNAME ,DEPT.DEPT_NO ,DEPT.DEPT_SNAME '
						 +'        ,BRANCH.BRANCH_NO ,BRANCH.BRANCH_SNAME ,S.OSTORE_ID ,S.STORE_ID ,S.STORE_NO ,S.STORE_NAME '
						 +'        ,DIST.SHOPDIST_NAME AS SHOP_DISTTRICT_NM ,DIST.SHOPDIST_ID AS SHOP_DIST '
						 +'        FROM PMART.LAST_ORG_STORE S '
						 +'        LEFT JOIN PMART.ORG_PDEPT PDEPT ON S.PDEPT_ID = PDEPT.PDEPT_ID'
						 +'        LEFT JOIN PMART.ORG_DEPT DEPT ON S.DEPT_ID = DEPT.DEPT_ID '
						 +'        LEFT JOIN PMART.ORG_BRANCH BRANCH ON S.BRANCH_ID = BRANCH.BRANCH_ID '
						 +'        INNER JOIN PMART.VW_SHOPDIST_DIM DIST ON  S.SHOP_DISTTRICT_MAIN = DIST.SHOPDIST_ID '+TRIM(ORGWHERE)+TRIM(DISWHERE)
						 +'        ) T1 ON B.ORG_ID = T1.OSTORE_ID   AND B.SHOP_DIST = T1.SHOP_DIST '+TIMEWHERE+TIMEQ
						 +'     ) DAT '
			             + ' ) WITH DATA PRIMARY  CHARINDEX(PRD_NM,TIME_ID) ON COMMIT PRESERVE ROWS;';						  					
        EXECUTE IMMEDIATE SQLSTR;   
END SP;