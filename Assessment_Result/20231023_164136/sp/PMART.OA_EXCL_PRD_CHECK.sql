REPLACE PROCEDURE PMART.OA_EXCL_PRD_CHECK
(
	OUT DATA_CNT INTEGER,
	OUT ERR_CNT INTEGER
)
SQL SECURITY INVOKER
SP:BEGIN
	CALL PMART.P_DROP_TABLE ('#TMP_OA_EXCL_PRD_CHECK');
	CREATE MULTISET VOLATILE TABLE #TMP_OA_EXCL_PRD_CHECK AS 
	(
	SELECT DISTINCT TIME_ID, FM_CODE, '生效年月不屬於當下年月' AS ERR_MSG 
	FROM PDATA.OA_EXCL_PRD_IF
	WHERE TIME_ID NOT IN (SELECT CAST((CURRENT_DATE (FORMAT 'YYYYMM')) AS VARCHAR(6)))
	AND (TIME_ID IS NOT NULL AND TRIM(TIME_ID) <> '')
	)
	WITH  DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;
	UPDATE PDATA.OA_EXCL_PRD_IF
	FROM  #TMP_OA_EXCL_PRD_CHECK B
	SET ERR_MSG = NVL(OA_EXCL_PRD_IF.ERR_MSG,'')+','+ B.ERR_MSG
	WHERE OA_EXCL_PRD_IF.TIME_ID = B.TIME_ID
	AND OA_EXCL_PRD_IF.FM_CODE = B.FM_CODE
	;
	CALL PMART.P_DROP_TABLE ('#TMP_OA_EXCL_PRD_CHECK');
	CREATE MULTISET VOLATILE TABLE #TMP_OA_EXCL_PRD_CHECK AS 
	(
	SELECT DISTINCT TIME_ID, FM_CODE, '商品代號不屬於PB商品' AS ERR_MSG 
	FROM PDATA.OA_EXCL_PRD_IF
	WHERE FM_CODE NOT IN (SELECT FM_CODE FROM PDATA.PBMCMDT WHERE GROUP_CODE IN (SELECT GRP_NO FROM PSTAGE.PBOA_KIND))
	AND (FM_CODE IS NOT NULL AND TRIM(FM_CODE) <> '')
	)
	WITH  DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;
	UPDATE PDATA.OA_EXCL_PRD_IF
	FROM  #TMP_OA_EXCL_PRD_CHECK B
	SET ERR_MSG = NVL(OA_EXCL_PRD_IF.ERR_MSG,'')+','+ B.ERR_MSG
	WHERE OA_EXCL_PRD_IF.TIME_ID = B.TIME_ID
	AND OA_EXCL_PRD_IF.FM_CODE = B.FM_CODE
	;
	CALL PMART.P_DROP_TABLE ('#TMP_OA_EXCL_PRD_CHECK');
	CREATE MULTISET VOLATILE TABLE #TMP_OA_EXCL_PRD_CHECK AS 
	(
	SELECT DISTINCT TIME_ID, FM_CODE, '商品代號重複設定' AS ERR_MSG 
	FROM PDATA.OA_EXCL_PRD_IF A
	WHERE EXISTS (SELECT FM_CODE, COUNT(1) FROM PDATA.OA_EXCL_PRD_IF B WHERE A.FM_CODE = B.FM_CODE GROUP BY FM_CODE HAVING COUNT(1) > 1)
	)
	WITH  DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;
	UPDATE PDATA.OA_EXCL_PRD_IF
	FROM  #TMP_OA_EXCL_PRD_CHECK B
	SET ERR_MSG = NVL(OA_EXCL_PRD_IF.ERR_MSG,'')+','+ B.ERR_MSG
	WHERE OA_EXCL_PRD_IF.TIME_ID = B.TIME_ID
	AND OA_EXCL_PRD_IF.FM_CODE = B.FM_CODE
	;
	CALL PMART.P_DROP_TABLE ('#TMP_OA_EXCL_PRD_CHECK');
	UPDATE PDATA.OA_EXCL_PRD_IF
	SET ERR_MSG = NVL(ERR_MSG,'')+','+ '生效年月未設定'
	WHERE TIME_ID IS NULL OR TRIM(TIME_ID) = ''
	;
	UPDATE PDATA.OA_EXCL_PRD_IF
	SET ERR_MSG = NVL(ERR_MSG,'')+','+ '商品代號未設定'
	WHERE FM_CODE IS NULL OR TRIM(FM_CODE) = ''
	;
	SET DATA_CNT = (SELECT COUNT(*) FROM PDATA.OA_EXCL_PRD_IF );
	SET ERR_CNT = (SELECT COUNT(*) FROM PDATA.OA_EXCL_PRD_IF  WHERE ERR_MSG IS NOT NULL);
END SP;