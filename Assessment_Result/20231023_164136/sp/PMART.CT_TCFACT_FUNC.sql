REPLACE PROCEDURE PMART.CT_TCFACT_FUNC(
FP_TIME_TYPE CHAR,FP_TIME_ID NUMBER,
FP_ORG_LEVEL NUMBER,FP_ORG_ID NUMBER,
FP_PRD_LEVEL NUMBER,FP_PRD_ID NUMBER)
SQL SECURITY INVOKER
SP:BEGIN
DECLARE SQLSTR  VARCHAR(4000);
DECLARE V_TABLE_NAME VARCHAR(30);
   CALL PMART.P_DROP_TABLE ('#VT_CT_TCFACT_FUNC'); 
   IF FP_TIME_TYPE='D' AND FP_ORG_LEVEL=3 AND FP_PRD_LEVEL=3 THEN
      SET V_TABLE_NAME = 'PMART.FACT_SALES_TIME_DETAIL';
    ELSE
       SET V_TABLE_NAME = 'PMART.FACT_SALES_TIME';
   END IF;
    SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_CT_TCFACT_FUNC  AS('+
                        'SELECT CT_ID,  TR_ID,  SUM(S_CNT) AS CNT, SUM(S_AMT) AS AMT '+
                        '  FROM (    '+
                        '       SELECT CAST(I.CUST_TYPE AS NUMBER) AS CT_ID,     '+          
	                    '                 CAST(H.X  AS NUMBER) AS TR_ID,       ' +
                        '                 CAST(CASE WHEN I.TIME_RANGE = H.X THEN I.S_CNT ELSE 0 END AS NUMBER) AS S_CNT,  '+
                        '   	          CAST(CASE WHEN I.TIME_RANGE = H.X THEN I.S_AMT ELSE 0 END AS NUMBER) AS S_AMT  '+		
	                    '   FROM '+ V_TABLE_NAME +  ' I ' + 
	                    ' CROSS JOIN (SELECT CAST(DAY_OF_CALENDAR AS INTEGER) -1 AS X FROM SYS_CALENDAR.CALENDAR  WHERE X BETWEEN 0 AND 23 ) AS H '+
                       '  WHERE I.TIME_ID='+ FP_TIME_ID + 
                       '    AND I.ORG_ID='+ FP_ORG_ID + 
					   '    AND I.PRD_ID='+ FP_PRD_ID + 
	                   ' )S GROUP BY CT_ID, TR_ID '+
                    ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';
	EXECUTE IMMEDIATE SQLSTR;
END SP;