REPLACE  PROCEDURE PMART.FUNC_TSC_MEMBER_HOUR_DATA
(
)
SP:BEGIN
     DECLARE SQLSTR  VARCHAR(25000);   
     DECLARE P_TIMERANGE     VARCHAR(2);
	 DECLARE P_TIMERANGE01 VARCHAR(2);
	 DECLARE P_TIMERANGE02 VARCHAR(2);
	 DECLARE P_TIMERANGE03 VARCHAR(2);
	 DECLARE P_TIMERANGE04 VARCHAR(2);
	 DECLARE P_TIMERANGE05 VARCHAR(2);
	 DECLARE P_TIMERANGE06 VARCHAR(2);
	 DECLARE P_TIMERANGE07 VARCHAR(2);
	 DECLARE P_TIMERANGE08 VARCHAR(2);	 
	 DECLARE P_DAY      INTEGER;
	 DECLARE P_DAY01 INTEGER;
	 DECLARE P_DAY02 INTEGER;
	 DECLARE P_DAY03 INTEGER;
	 DECLARE P_DAY04 INTEGER;
	 DECLARE P_DAY05 INTEGER;
	 DECLARE P_DAY06 INTEGER;
	 DECLARE P_DAY07 INTEGER;
	 DECLARE P_DAY08 INTEGER;
	 DECLARE P_LW_DAY      INTEGER;
	 DECLARE P_LW_DAY01 INTEGER;
	 DECLARE P_LW_DAY02 INTEGER;
	 DECLARE P_LW_DAY03 INTEGER;
	 DECLARE P_LW_DAY04 INTEGER;
	 DECLARE P_LW_DAY05 INTEGER;
	 DECLARE P_LW_DAY06 INTEGER;
	 DECLARE P_LW_DAY07 INTEGER;
	 DECLARE P_LW_DAY08 INTEGER;
	 SELECT TO_CHAR(CURRENT_TIMESTAMP - INTERVAL '1' HOUR ,'HH24') INTO P_TIMERANGE;
	 SELECT TO_CHAR(CURRENT_TIMESTAMP - INTERVAL '1' HOUR ,'HH24') INTO P_TIMERANGE01;
	 SELECT TO_CHAR(CURRENT_TIMESTAMP - INTERVAL '2' HOUR ,'HH24') INTO P_TIMERANGE02;
     SELECT TO_CHAR(CURRENT_TIMESTAMP - INTERVAL '3' HOUR ,'HH24') INTO P_TIMERANGE03;
	 SELECT TO_CHAR(CURRENT_TIMESTAMP - INTERVAL '4' HOUR ,'HH24') INTO P_TIMERANGE04;
     SELECT TO_CHAR(CURRENT_TIMESTAMP - INTERVAL '5' HOUR ,'HH24') INTO P_TIMERANGE05;
	 SELECT TO_CHAR(CURRENT_TIMESTAMP - INTERVAL '6' HOUR ,'HH24') INTO P_TIMERANGE06;
	 SELECT TO_CHAR(CURRENT_TIMESTAMP - INTERVAL '7' HOUR ,'HH24') INTO P_TIMERANGE07;
	 SELECT TO_CHAR(CURRENT_TIMESTAMP - INTERVAL '8' HOUR ,'HH24') INTO P_TIMERANGE08;
	 SELECT CAST(TO_CHAR(CURRENT_TIMESTAMP - INTERVAL '1' HOUR ,'YYYYMMDD')  AS INTEGER) INTO P_DAY;
	 SELECT CAST(TO_CHAR(CURRENT_TIMESTAMP - INTERVAL '2' HOUR ,'YYYYMMDD')  AS INTEGER) INTO P_DAY01;
	 SELECT CAST(TO_CHAR(CURRENT_TIMESTAMP - INTERVAL '3' HOUR ,'YYYYMMDD')  AS INTEGER) INTO P_DAY02;
     SELECT CAST(TO_CHAR(CURRENT_TIMESTAMP - INTERVAL '4' HOUR ,'YYYYMMDD')  AS INTEGER) INTO P_DAY03;
	 SELECT CAST(TO_CHAR(CURRENT_TIMESTAMP - INTERVAL '5' HOUR ,'YYYYMMDD')  AS INTEGER) INTO P_DAY04;
     SELECT CAST(TO_CHAR(CURRENT_TIMESTAMP - INTERVAL '6' HOUR ,'YYYYMMDD')  AS INTEGER) INTO P_DAY05;
	 SELECT CAST(TO_CHAR(CURRENT_TIMESTAMP - INTERVAL '7' HOUR ,'YYYYMMDD')  AS INTEGER) INTO P_DAY06;
	 SELECT CAST(TO_CHAR(CURRENT_TIMESTAMP - INTERVAL '8' HOUR ,'YYYYMMDD')  AS INTEGER) INTO P_DAY07;
	 SELECT CAST(TO_CHAR(CURRENT_TIMESTAMP - INTERVAL '9' HOUR ,'YYYYMMDD')  AS INTEGER) INTO P_DAY08;
	 SELECT CAST(TO_CHAR((CURRENT_TIMESTAMP - INTERVAL '7' DAY) - INTERVAL '1' HOUR ,'YYYYMMDD')  AS INTEGER)  INTO P_LW_DAY;
	 SELECT CAST(TO_CHAR((CURRENT_TIMESTAMP - INTERVAL '7' DAY) - INTERVAL '2' HOUR ,'YYYYMMDD')  AS INTEGER) INTO P_LW_DAY01;
	 SELECT CAST(TO_CHAR((CURRENT_TIMESTAMP - INTERVAL '7' DAY) - INTERVAL '3' HOUR ,'YYYYMMDD')  AS INTEGER) INTO P_LW_DAY02;
     SELECT CAST(TO_CHAR((CURRENT_TIMESTAMP - INTERVAL '7' DAY) - INTERVAL '4' HOUR ,'YYYYMMDD')  AS INTEGER) INTO P_LW_DAY03;
	 SELECT CAST(TO_CHAR((CURRENT_TIMESTAMP - INTERVAL '7' DAY) - INTERVAL '5' HOUR ,'YYYYMMDD')  AS INTEGER) INTO P_LW_DAY04;
     SELECT CAST(TO_CHAR((CURRENT_TIMESTAMP - INTERVAL '7' DAY) - INTERVAL '6' HOUR ,'YYYYMMDD')  AS INTEGER) INTO P_LW_DAY05;
	 SELECT CAST(TO_CHAR((CURRENT_TIMESTAMP - INTERVAL '7' DAY) - INTERVAL '7' HOUR ,'YYYYMMDD')  AS INTEGER) INTO P_LW_DAY06;
	 SELECT CAST(TO_CHAR((CURRENT_TIMESTAMP - INTERVAL '7' DAY) - INTERVAL '8' HOUR ,'YYYYMMDD')  AS INTEGER) INTO P_LW_DAY07;
	 SELECT CAST(TO_CHAR((CURRENT_TIMESTAMP - INTERVAL '7' DAY) - INTERVAL '9' HOUR ,'YYYYMMDD')  AS INTEGER) INTO P_LW_DAY08;
	DELETE FROM PMART.TSC_SALES_DAY_MEMBER_8H;
	 SET SQLSTR ='INSERT INTO PMART.TSC_SALES_DAY_MEMBER_8H(DATA_DAY,DEPT_ID,DEPT_NAME' +
	                            '  ,ALL_SALES00,MEMBER_SALES00,ALL_CNT00,MEMBER_CNT00,X_HEADER00 '+
								'  ,ALL_SALES01,MEMBER_SALES01,ALL_CNT01,MEMBER_CNT01,X_HEADER01 '+
								'  ,ALL_SALES02,MEMBER_SALES02,ALL_CNT02,MEMBER_CNT02,X_HEADER02 '+
								'  ,ALL_SALES03,MEMBER_SALES03,ALL_CNT03,MEMBER_CNT03,X_HEADER03 '+
								'  ,ALL_SALES04,MEMBER_SALES04,ALL_CNT04,MEMBER_CNT04,X_HEADER04 '+
								'  ,ALL_SALES05,MEMBER_SALES05,ALL_CNT05,MEMBER_CNT05,X_HEADER05 '+
								'  ,ALL_SALES06,MEMBER_SALES06,ALL_CNT06,MEMBER_CNT06,X_HEADER06 '+
                                '  ,ALL_SALES07,MEMBER_SALES07,ALL_CNT07,MEMBER_CNT07,X_HEADER07 '+
								')' +
                                'SELECT  CAST(TO_CHAR(CURRENT_DATE,''YYYYMMDD'')AS INTEGER)  AS DATA_DAY,' +
                                '                    D.DEPT_ID,' +
                                '                    D.DEPT_NAME,' +
                                '                    SUM(CASE WHEN  DATA.DATA_TYPE=1 AND DATA.DAY_ID='+P_DAY08 +' THEN SALES'+P_TIMERANGE08 +' ELSE 0 END) AS ALL_SALES00,' +
                                '                    CAST( 0 AS INTEGER)  AS MEMBER_SALES00,' +
                                '                    SUM(CASE WHEN  DATA.DATA_TYPE=2 AND DATA.DAY_ID='+P_DAY08 +' THEN SALES'+P_TIMERANGE08 +' ELSE 0 END) AS ALL_CNT00,' +
                                '                    CAST( 0 AS INTEGER)  AS MEMBER_CNT00,' +
                                '                    CAST( '''+P_TIMERANGE08+''' AS VARCHAR(2)) AS X_HEADER00,' +
                                '                    SUM(CASE WHEN  DATA.DATA_TYPE=1 AND DATA.DAY_ID='+P_DAY07 +' THEN SALES'+P_TIMERANGE07 +' ELSE 0 END) AS ALL_SALES01,' +
                                '                    CAST( 0 AS INTEGER)  AS MEMBER_SALES01,' +
                                '                    SUM(CASE WHEN  DATA.DATA_TYPE=2 AND DATA.DAY_ID='+P_DAY07 +' THEN SALES'+P_TIMERANGE07 +' ELSE 0 END) AS ALL_CNT01,' +
                                '                    CAST( 0 AS INTEGER)  AS MEMBER_CNT01,' +
                                '                    CAST( '''+P_TIMERANGE07+''' AS VARCHAR(2)) AS X_HEADER01,' +
                                '                    SUM(CASE WHEN  DATA.DATA_TYPE=1 AND DATA.DAY_ID='+P_DAY06 +' THEN SALES'+P_TIMERANGE06 +' ELSE 0 END) AS ALL_SALES02,' +
                                '                    CAST( 0 AS INTEGER)  AS MEMBER_SALES02,' +
                                '                    SUM(CASE WHEN  DATA.DATA_TYPE=2 AND DATA.DAY_ID='+P_DAY06 +' THEN SALES'+P_TIMERANGE06 +' ELSE 0 END) AS ALL_CNT02,' +
                                '                    CAST( 0 AS INTEGER)  AS MEMBER_CNT02,' +
                                '                    CAST( '''+P_TIMERANGE06+''' AS VARCHAR(2)) AS X_HEADER02,' +	
                                '                    SUM(CASE WHEN  DATA.DATA_TYPE=1 AND DATA.DAY_ID='+P_DAY05 +' THEN SALES'+P_TIMERANGE05 +' ELSE 0 END) AS ALL_SALES03,' +
                                '                    CAST( 0 AS INTEGER)  AS MEMBER_SALES03,' +
                                '                    SUM(CASE WHEN  DATA.DATA_TYPE=2 AND DATA.DAY_ID='+P_DAY05 +' THEN SALES'+P_TIMERANGE05 +' ELSE 0 END) AS ALL_CNT03,' +
                                '                    CAST( 0 AS INTEGER)  AS MEMBER_CNT03,' +
                                '                    CAST( '''+P_TIMERANGE05+''' AS VARCHAR(2)) AS X_HEADER03,' +	
                                '                    SUM(CASE WHEN  DATA.DATA_TYPE=1 AND DATA.DAY_ID='+P_DAY04 +' THEN SALES'+P_TIMERANGE04 +' ELSE 0 END) AS ALL_SALES04,' +
                                '                    CAST( 0 AS INTEGER)  AS MEMBER_SALES04,' +
                                '                    SUM(CASE WHEN  DATA.DATA_TYPE=2 AND DATA.DAY_ID='+P_DAY04 +' THEN SALES'+P_TIMERANGE04 +' ELSE 0 END) AS ALL_CNT04,' +
                                '                    CAST( 0 AS INTEGER)  AS MEMBER_CNT04,' +
                                '                    CAST( '''+P_TIMERANGE04+''' AS VARCHAR(2)) AS X_HEADER04,' +	
                                '                    SUM(CASE WHEN  DATA.DATA_TYPE=1 AND DATA.DAY_ID='+P_DAY03 +' THEN SALES'+P_TIMERANGE03 +' ELSE 0 END) AS ALL_SALES05,' +
                                '                    CAST( 0 AS INTEGER)  AS MEMBER_SALES05,' +
                                '                    SUM(CASE WHEN  DATA.DATA_TYPE=2 AND DATA.DAY_ID='+P_DAY03 +' THEN SALES'+P_TIMERANGE03 +' ELSE 0 END) AS ALL_CNT05,' +
                                '                    CAST( 0 AS INTEGER)  AS MEMBER_CNT05,' +
                                '                    CAST( '''+P_TIMERANGE03+''' AS VARCHAR(2)) AS X_HEADER05,' +						
                                '                    SUM(CASE WHEN  DATA.DATA_TYPE=1 AND DATA.DAY_ID='+P_DAY02 +' THEN SALES'+P_TIMERANGE02 +' ELSE 0 END) AS ALL_SALES06,' +
                                '                    CAST( 0 AS INTEGER)  AS MEMBER_SALES06,' +
                                '                    SUM(CASE WHEN  DATA.DATA_TYPE=2 AND DATA.DAY_ID='+P_DAY02 +' THEN SALES'+P_TIMERANGE02 +' ELSE 0 END) AS ALL_CNT06,' +
                                '                    CAST( 0 AS INTEGER)  AS MEMBER_CNT06,' +
                                '                    CAST( '''+P_TIMERANGE02+''' AS VARCHAR(2)) AS X_HEADER06,' +				
                                '                    SUM(CASE WHEN  DATA.DATA_TYPE=1 AND DATA.DAY_ID='+P_DAY01 +' THEN SALES'+P_TIMERANGE01 +' ELSE 0 END) AS ALL_SALES07,' +
                                '                    CAST( 0 AS INTEGER)  AS MEMBER_SALES07,' +
                                '                    SUM(CASE WHEN  DATA.DATA_TYPE=2 AND DATA.DAY_ID='+P_DAY01 +' THEN SALES'+P_TIMERANGE01 +' ELSE 0 END) AS ALL_CNT07,' +
                                '                    CAST( 0 AS INTEGER)  AS MEMBER_CNT07,' +
                                '                    CAST( '''+P_TIMERANGE01+''' AS VARCHAR(2)) AS X_HEADER07' +								
                                '   FROM PMART.TSC_SALES_DAY DATA' +
	                            '                 INNER JOIN PMART.LAST_ORG_STORE S ON DATA.OSTORE_NO=S.OSTORE_ID' +
                                '                 INNER JOIN (' +
  		                        '                                            SELECT ORG.ORG_ID,P.DEPT_NO AS DEPT_ID,P.DEPT_SNAME AS DEPT_NAME' +
		                        '                                                  FROM PMART.VW_ORG_DIM  ORG' +
			                    '                                                                INNER JOIN PMART.ORG_DEPT P ON  ORG.PARENT_ORG_ID = P.DEPT_ID' +
		                        '                                               WHERE ORG.ORG_LEVEL=2' +
		                        '                                           ) D ON S.BRANCH_ID=D.ORG_ID	 ' +
                                'WHERE (DATA.DAY_ID = '+P_DAY08 +
	       			            '                    OR DATA.DAY_ID = '+P_LW_DAY08+
								'                    OR DATA.DAY_ID = '+P_DAY+
								'                    OR DATA.DAY_ID = '+P_LW_DAY+
				                ') ' +
                                'GROUP BY   D.DEPT_ID,D.DEPT_NAME';	 
	 EXECUTE IMMEDIATE SQLSTR;   
SET SQLSTR ='UPDATE T '+
                           'FROM PMART.TSC_SALES_DAY_MEMBER_8H T, '+
                           '( '+
                           'SELECT D.DEPT_ID,D.DEPT_NAME '+
                           ', SUM(CASE WHEN  DATA.DATA_TYPE=1 AND DATA.DAY_ID='+P_DAY08 +' THEN SALES'+P_TIMERANGE08 +' ELSE 0 END)  AS MEMBER_SALES00,SUM(CASE WHEN  DATA.DATA_TYPE=2 AND DATA.DAY_ID='+P_DAY08 +' THEN SALES'+P_TIMERANGE08 +' ELSE 0 END)AS MEMBER_CNT00 '+
                           ', SUM(CASE WHEN  DATA.DATA_TYPE=1 AND DATA.DAY_ID='+P_DAY07 +' THEN SALES'+P_TIMERANGE07 +' ELSE 0 END)  AS MEMBER_SALES01,SUM(CASE WHEN  DATA.DATA_TYPE=2 AND DATA.DAY_ID='+P_DAY07 +' THEN SALES'+P_TIMERANGE07 +' ELSE 0 END)AS MEMBER_CNT01 '+
                           ', SUM(CASE WHEN  DATA.DATA_TYPE=1 AND DATA.DAY_ID='+P_DAY06 +' THEN SALES'+P_TIMERANGE06 +' ELSE 0 END)  AS MEMBER_SALES02,SUM(CASE WHEN  DATA.DATA_TYPE=2 AND DATA.DAY_ID='+P_DAY06 +' THEN SALES'+P_TIMERANGE06 +' ELSE 0 END)AS MEMBER_CNT02 '+
                           ', SUM(CASE WHEN  DATA.DATA_TYPE=1 AND DATA.DAY_ID='+P_DAY05 +' THEN SALES'+P_TIMERANGE05 +' ELSE 0 END)  AS MEMBER_SALES03,SUM(CASE WHEN  DATA.DATA_TYPE=2 AND DATA.DAY_ID='+P_DAY05 +' THEN SALES'+P_TIMERANGE05 +' ELSE 0 END)AS MEMBER_CNT03 '+
                           ', SUM(CASE WHEN  DATA.DATA_TYPE=1 AND DATA.DAY_ID='+P_DAY04 +' THEN SALES'+P_TIMERANGE04 +' ELSE 0 END)  AS MEMBER_SALES04,SUM(CASE WHEN  DATA.DATA_TYPE=2 AND DATA.DAY_ID='+P_DAY04 +' THEN SALES'+P_TIMERANGE04 +' ELSE 0 END)AS MEMBER_CNT04 '+
                           ', SUM(CASE WHEN  DATA.DATA_TYPE=1 AND DATA.DAY_ID='+P_DAY03 +' THEN SALES'+P_TIMERANGE03 +' ELSE 0 END)  AS MEMBER_SALES05,SUM(CASE WHEN  DATA.DATA_TYPE=2 AND DATA.DAY_ID='+P_DAY03 +' THEN SALES'+P_TIMERANGE03 +' ELSE 0 END)AS MEMBER_CNT05 '+
                           ', SUM(CASE WHEN  DATA.DATA_TYPE=1 AND DATA.DAY_ID='+P_DAY02 +' THEN SALES'+P_TIMERANGE02 +' ELSE 0 END)  AS MEMBER_SALES06,SUM(CASE WHEN  DATA.DATA_TYPE=2 AND DATA.DAY_ID='+P_DAY02 +' THEN SALES'+P_TIMERANGE02 +' ELSE 0 END)AS MEMBER_CNT06 '+
                           ', SUM(CASE WHEN  DATA.DATA_TYPE=1 AND DATA.DAY_ID='+P_DAY01 +' THEN SALES'+P_TIMERANGE01 +' ELSE 0 END)  AS MEMBER_SALES07,SUM(CASE WHEN  DATA.DATA_TYPE=2 AND DATA.DAY_ID='+P_DAY01 +' THEN SALES'+P_TIMERANGE01 +' ELSE 0 END)AS MEMBER_CNT07 '+
	         'FROM PMART.TSC_SALES_DAY_OF_MEMBER DATA '+
	         '              INNER JOIN PMART.LAST_ORG_STORE S ON DATA.OSTORE_NO=S.OSTORE_ID '+
             '              INNER JOIN ( '+
  		     '                                            SELECT ORG.ORG_ID,P.DEPT_NO AS DEPT_ID,P.DEPT_SNAME AS DEPT_NAME '+
		     '                                                FROM PMART.VW_ORG_DIM  ORG '+
			 '                                                               INNER JOIN PMART.ORG_DEPT P ON  ORG.PARENT_ORG_ID = P.DEPT_ID '+
		     '                                            WHERE ORG.ORG_LEVEL=2 '+
		     '                                          ) D ON S.BRANCH_ID=D.ORG_ID	  '+
             ' GROUP BY D.DEPT_ID,D.DEPT_NAME '+
             ') DAT  '+
             'SET MEMBER_SALES00=DAT.MEMBER_SALES00,MEMBER_CNT00=DAT.MEMBER_CNT00 '+
             '         ,MEMBER_SALES01=DAT.MEMBER_SALES01,MEMBER_CNT01=DAT.MEMBER_CNT01 '+
             '         ,MEMBER_SALES02=DAT.MEMBER_SALES02,MEMBER_CNT02=DAT.MEMBER_CNT02 '+
             '         ,MEMBER_SALES03=DAT.MEMBER_SALES03,MEMBER_CNT03=DAT.MEMBER_CNT03 '+
             '         ,MEMBER_SALES04=DAT.MEMBER_SALES04,MEMBER_CNT04=DAT.MEMBER_CNT04 '+
             '         ,MEMBER_SALES05=DAT.MEMBER_SALES05,MEMBER_CNT05=DAT.MEMBER_CNT05 '+
             '         ,MEMBER_SALES06=DAT.MEMBER_SALES06,MEMBER_CNT06=DAT.MEMBER_CNT06 '+
             '         ,MEMBER_SALES07=DAT.MEMBER_SALES07,MEMBER_CNT07=DAT.MEMBER_CNT07 '+
             '         WHERE T.DEPT_ID = DAT.DEPT_ID	  ';
	 EXECUTE IMMEDIATE SQLSTR;   	 	 
END SP;