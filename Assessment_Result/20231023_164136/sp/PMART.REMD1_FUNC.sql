REPLACE PROCEDURE PMART.REMD1_FUNC
(P_YEAR_ID NUMBER,P_ORG_ID NUMBER)
SQL SECURITY INVOKER
SP:BEGIN
DECLARE SQLSTR  VARCHAR(4000) DEFAULT ''; 
  CALL PMART.P_DROP_TABLE ('#VT_REMD1_FUNC'); 
      SET SQLSTR = 
          'CREATE MULTISET VOLATILE TABLE #VT_REMD1_FUNC AS('+    
               'SELECT '+
               'A.L_MONTH_ID AS L_MONTH_ID, '+
               'CAST(B.TOT_AMT AS DECIMAL(16,4))/DECODE(B.TOT_PLAN_STNUM,0,NULL,B.TOT_PLAN_STNUM) AS AVG_AMT, '+
               '((B.TOT_AMT+ 0 + 0 )/DECODE(B.TOT_PLAN_STNUM,0,NULL,B.TOT_PLAN_STNUM))/ '+
               '((CAST(C.TOT_AMT AS DECIMAL(16,4))+0)/DECODE(C.TOT_PLAN_STNUM,0,NULL,C.TOT_PLAN_STNUM))*100 AS AVG_AMT_RATE_LAST_MONTH, '+
			  '  CASE WHEN   ((CAST(B.EX_TOT_AMT_LAST_YEAR AS DECIMAL(16,4))+0)/B.EX_TOT_PLAN_STNUM_LAST_YEAR)*100=0 THEN NULL ELSE   ' + 
               '((CAST(B.EX_TOT_AMT AS DECIMAL(16,4))+0+0)/DECODE(B.EX_TOT_PLAN_STNUM,0,NULL,B.EX_TOT_PLAN_STNUM))/ '+
               '((CAST(B.EX_TOT_AMT_LAST_YEAR AS DECIMAL(16,4))+0)/B.EX_TOT_PLAN_STNUM_LAST_YEAR)*100  END '+
               'AS AVG_AMT_RATE_LAST_YEAR, '+
               'CAST(B.TOT_CUST_NUM AS DECIMAL(16,4))/DECODE(B.TOT_PLAN_STNUM,0,NULL,B.TOT_PLAN_STNUM) AS AVG_CUST_NUM, '+
               '((CAST(B.TOT_CUST_NUM AS DECIMAL(16,4))+0)/DECODE(B.TOT_PLAN_STNUM,0,NULL,B.TOT_PLAN_STNUM))/ '+
               '(CAST(C.TOT_CUST_NUM AS DECIMAL(16,4)) /DECODE(C.TOT_PLAN_STNUM,0,NULL,C.TOT_PLAN_STNUM))*100 AS AVG_CUST_NUM_RATE_LAST_MONTH, '+
			   ' CASE WHEN (CAST(B.EX_TOT_CUST_NUM_LAST_YEAR AS  DECIMAL(16,4))/DECODE(B.EX_TOT_PLAN_STNUM_LAST_YEAR,0,NULL,B.EX_TOT_PLAN_STNUM_LAST_YEAR))*100= 0 THEN NULL ELSE ' +
               '((CAST(B.EX_TOT_CUST_NUM AS  DECIMAL(16,4))+0)/DECODE(B.EX_TOT_PLAN_STNUM,0,NULL,B.EX_TOT_PLAN_STNUM))/ '+
               '(CAST(B.EX_TOT_CUST_NUM_LAST_YEAR AS  DECIMAL(16,4))/DECODE(B.EX_TOT_PLAN_STNUM_LAST_YEAR,0,NULL,B.EX_TOT_PLAN_STNUM_LAST_YEAR))*100 '+
               ' END   AS AVG_CUST_NUM_RATE_LAST_YEAR, '+               
	       'CAST(B.TOT_AMT AS  DECIMAL(16,4))/DECODE(B.TOT_CUST_NUM,0,NULL,B.TOT_CUST_NUM) AS CUST_PRICE, '+
               '((CAST(B.TOT_AMT AS NUMBER)+0)/DECODE(B.TOT_CUST_NUM,0,NULL,B.TOT_CUST_NUM))- '+
               '((CAST(C.TOT_AMT AS NUMBER)+0)/DECODE(C.TOT_CUST_NUM,0,NULL,C.TOT_CUST_NUM)) AS CUST_PRICE_RATE_LAST_MONTH, '+
               '((CAST(B.EX_TOT_AMT AS NUMBER)+0)/DECODE(B.EX_TOT_CUST_NUM,0,NULL,B.EX_TOT_CUST_NUM))- '+
               '((CAST(B.EX_TOT_AMT_LAST_YEAR AS NUMBER)+0) /DECODE(B.EX_TOT_CUST_NUM_LAST_YEAR,0,NULL,B.EX_TOT_CUST_NUM_LAST_YEAR)) '+
               'AS CUST_PRICE_RATE_LAST_YEAR '+
               'FROM '+
               '(SELECT DISTINCT L_MONTH_ID,ROUND(L_DAY_FIRST_DAY_LAST_MONTH/100) AS L_MONTH_LAST_MONTH FROM PMART.YMWD_TIME WHERE L_YEAR_ID='+P_YEAR_ID+') A '+
               'LEFT JOIN '+
               '(SELECT * FROM PMART.REMD_FACT_MONTH_SUM WHERE ORG_ID='+P_ORG_ID+') B '+
               'ON (A.L_MONTH_ID=B.L_MONTH_ID) '+
               'LEFT JOIN '+
               '(SELECT * FROM PMART.REMD_FACT_MONTH_SUM WHERE ORG_ID='+P_ORG_ID+') C '+
               'ON (A.L_MONTH_LAST_MONTH=C.L_MONTH_ID) '+
          ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';
    EXECUTE IMMEDIATE SQLSTR; 
END SP;