REPLACE  PROCEDURE PMART.FUNC_FACT_PRD_RELATED
(
)
SP:BEGIN
	DECLARE SQLSTR  VARCHAR(32000);
	DECLARE SQLCREATE  VARCHAR(30000);
	DECLARE SQLINSERT VARCHAR(20000);
	DECLARE SQLDELETE VARCHAR(20000);
	DECLARE P_PROMO  VARCHAR(20000);
	DECLARE P_TRG_PERSON  VARCHAR(20000);
	DECLARE P_JOB_ID  VARCHAR(20000);
	DECLARE MEMWHERE  VARCHAR(20000);
	DECLARE PROMOWHERE  VARCHAR(20000);
	SET P_JOB_ID = (SELECT JOB_ID FROM PTEMP.PRDREL_SET);	
	SET P_PROMO = (SELECT PROMO FROM PTEMP.PRDREL_SET) ;
	SET P_TRG_PERSON = (SELECT TRG_PERSON FROM PTEMP.PRDREL_SET) ;
 	CALL PMART.P_DROP_TABLE ('#VT_PRD_RELATED');
SET SQLSTR = ' 
SELECT TRANS.TX_SEQ,TRANS.OSTORE_ID ,TRANS.TX_DTTM
,TRANS.SALE_TYPE, TRANS.AM_TOT,TRANS.AM_TAX,TRANS.MEMBER_ID
,PD.ITEM_SEQ,PD.CD_FMCODE,PD.QT_ITEM,PD.AM_ITEM,PD.AM_DIS_SUB
,PD.AM_SUB_SUB,PD.AM_SALE,PD.DWH_FG
FROM 
( 
SELECT * FROM PTEMP.PS_TRANS
			)TRANS
INNER JOIN 
(
SELECT * FROM #VT_PRDREL_PRD_SET
)PD
ON TRANS.TX_SEQ = PD.TX_SEQ
'
;
SET MEMWHERE = '
LEFT JOIN 
(
SELECT * FROM  PDATA.CRM_MEMBER
WHERE CAST((20200604-BIRTHDAY)/100000 AS INTEGER) IN  (SELECT AGE_BGN/10 FROM PDATA.PRDREL_CAGE_SET WHERE JOB_ID = '+P_JOB_ID+'  )
AND SEX IN (SELECT SEX_TYPE  FROM PDATA.PRDREL_CSEX_SET WHERE JOB_ID = '+P_JOB_ID+')
)MEM
ON MEM.CUSTOMER_NO = TRANS.MEMBER_ID
'
;
SET PROMOWHERE = '
WHERE TRANS.TX_SEQ NOT IN 
(
SELECT PROMO.TX_SEQ FROM PTEMP.PS_TRANS_MM_PROMO PROMO
WHERE  MM_ID IN
		(
		SELECT MM_ID FROM PDATA.PRDREL_POMO_SET	
		WHERE JOB_ID =  '+P_JOB_ID+'
		)
)
'
;
  IF P_TRG_PERSON =2
  THEN 
  SET SQLSTR = SQLSTR + MEMWHERE;
   END IF ;
   IF P_PROMO <>1
  THEN 
  SET SQLSTR = SQLSTR + PROMOWHERE;
   END IF ;
   SET SQLCREATE = 
   'CREATE MULTISET VOLATILE TABLE #VT_PRD_RELATED AS( '
   +'SELECT TX_SEQ, CD_FMCODE,SUM(QT_ITEM)  AS QT_ITEM,SUM(AM_TOT) AS AM_TOT,SUM(AM_SALE) AS AM_SALE FROM ('
   +SQLSTR 
   +')A GROUP BY TX_SEQ ,CD_FMCODE'
   +'	) WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;'
   ;
EXECUTE IMMEDIATE SQLCREATE;  
END SP;