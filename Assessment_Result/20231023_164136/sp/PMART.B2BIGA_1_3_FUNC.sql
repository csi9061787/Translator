REPLACE PROCEDURE PMART.B2BIGA_1_3_FUNC
(
	IN P_MRNO_LIST VARCHAR(2000),
	IN P_TIME_TYPE VARCHAR(1),
	IN P_TIME_START VARCHAR(10),
	IN P_TIME_END VARCHAR(10),
	IN P_KND_CODE VARCHAR(2),
	IN P_GRP_CODE VARCHAR(2),
	IN P_ORDER_BY VARCHAR(1)
)
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR VARCHAR(20000);
   DECLARE V_TABLE_NAME VARCHAR(30);
   DECLARE V_TIME_STR VARCHAR(400); 
   DECLARE V_ORDERBY_STR VARCHAR(400); 
   CALL PMART.P_DROP_TABLE ('#VT_B2BIGA_1_3_FUNC'); 
	IF P_TIME_TYPE='M' THEN
		SET V_TABLE_NAME = ' PMART.GCT_MONTH ';
		SET V_TIME_STR = ' A.SDATE IN ( SELECT CAST(CAST(L_MONTH_START_DAY AS VARCHAR(8)) AS DATE FORMAT ''YYYYMMDD'') FROM PMART.YMWD_TIME WHERE L_MONTH_ID = '+ P_TIME_START +' ) ';
	ELSEIF P_TIME_TYPE='W' THEN
		SET V_TABLE_NAME = ' PMART.GCT_WEEK ';
		SET V_TIME_STR = ' A.SDATE IN ( SELECT CAST(CAST(L_WEEK_START_DAY AS VARCHAR(8)) AS DATE FORMAT ''YYYYMMDD'') FROM PMART.YMWD_TIME WHERE L_DAY_ID = '+ P_TIME_START +' ) ';
	ELSEIF P_TIME_TYPE='D' THEN
		SET V_TABLE_NAME = ' PMART.GCT_DAY ';
		SET V_TIME_STR = ' A.SDATE BETWEEN CAST(CAST('+ P_TIME_START +' AS VARCHAR(8)) AS DATE FORMAT ''YYYYMMDD'') AND CAST(CAST('+ P_TIME_END +' AS VARCHAR(8)) AS DATE FORMAT ''YYYYMMDD'') ';
	END IF;
	IF P_ORDER_BY='0' THEN
		SET V_ORDERBY_STR = ' DENSE_RANK() OVER (ORDER BY B.COUNT1 DESC) AS ROWRANK ';
	ELSEIF P_ORDER_BY='1' THEN
		SET V_ORDERBY_STR = ' DENSE_RANK() OVER (ORDER BY B.AMOUNT DESC) AS ROWRANK ';
	END IF;
   SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_B2BIGA_1_3_FUNC  AS( '
        + ' SELECT C.BRAND_DESC AS CMBND, '
		+ ' C.FM_NAME AS CMNM, '
		+ ' B.CMNO, '
		+ ' B.COUNT1, '
		+ ' B.AMOUNT, '
		+ V_ORDERBY_STR 
		+ ' FROM ( '
		+ ' SELECT A.CMNO,SUM(COUNT1) AS COUNT1,SUM(AMOUNT) AS AMOUNT '
		+ ' FROM '+ V_TABLE_NAME +' A '
		+ ' WHERE A.MRNO IN ('+ PMART.CONVERT_STRING_LIST(P_MRNO_LIST) +') '
		+ ' AND '+ V_TIME_STR +' ' 
		+ ' AND A.KND = '''+ P_KND_CODE +''' '
		+ ' AND A.GRP = '''+ P_GRP_CODE +''' '
		+ ' GROUP BY A.CMNO) B, '
		+ ' PDATA.PBMCMDT C '
		+ ' WHERE B.CMNO = C.FM_CODE ' 
		+ ' ) WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;' ; 
	EXECUTE IMMEDIATE SQLSTR;
END SP;