REPLACE PROCEDURE PMART.BI_1_1_RESPON_FUNC(P_WEEK_ID VARCHAR(2000),
									 P_LAST_WEEK_ID VARCHAR(2000),
									 P_ORG_ID VARCHAR(2000))
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR VARCHAR(10000);
   DECLARE V_STRING VARCHAR(4000);
   CALL PMART.P_DROP_TABLE ('#VT_BI_1_1_RESPON_FUNC'); 
   SET V_STRING = ' SELECT '+ 
        ' CAST(A.L_DAY_ID AS INTEGER) AS L_DAY_ID, '+
        ' CAST(A.OSTORE_ID  AS INTEGER) AS ORG_ID, '+
        ' CAST(C.L_WEEK_ID  AS INTEGER) AS L_WEEK_ID, '+ 
        ' DECODE(NVL(A.UPLOAD_STNUM,0),0,0, PMART.DIVIDE_BY_ZERO(CAST(A.AMT AS DECIMAL(18,6)) ,A.UPLOAD_STNUM)) AS AMT, '+ 
        ' DECODE(NVL(A.UPLOAD_STNUM,0),0,0, PMART.DIVIDE_BY_ZERO(CAST(A.CUST_NUM AS DECIMAL(18,6)) ,A.UPLOAD_STNUM)) AS CUST_NUM, '+ 
        ' DECODE(NVL(A.CUST_NUM,0),0,0, PMART.DIVIDE_BY_ZERO(CAST(A.AMT AS DECIMAL(18,6)) ,A.CUST_NUM)) AS CUST_AMT, '+ 
        ' DECODE(NVL(A.UPLOAD_STNUM,0),0,0, PMART.DIVIDE_BY_ZERO(CAST(A.AMT AS DECIMAL(18,6)) ,A.UPLOAD_STNUM)) * 100 / '+
        ' (SELECT DECODE(AMT/UPLOAD_STNUM,0,NULL, CAST(AMT AS DECIMAL(18,6)) /UPLOAD_STNUM) FROM PMART.REMD_FACT M WHERE M.L_DAY_ID = C.L_DAY_LAST_YEAR AND M.OSTORE_ID = A.OSTORE_ID) '+
        ' AS P_AMT, '+  
        ' DECODE(NVL(A.UPLOAD_STNUM,0),0,0, PMART.DIVIDE_BY_ZERO(CAST(A.CUST_NUM AS DECIMAL(18,6)) ,A.UPLOAD_STNUM)) * 100 / '+
        ' (SELECT DECODE(CUST_NUM/UPLOAD_STNUM,0,NULL, CAST(CUST_NUM AS DECIMAL(18,6)) /UPLOAD_STNUM) FROM PMART.REMD_FACT M WHERE M.L_DAY_ID = C.L_DAY_LAST_YEAR AND M.OSTORE_ID = A.OSTORE_ID) '+
        ' AS P_CUST_NUM '+  
        ' FROM PMART.REMD_FACT A, '+
        ' (SELECT OSTORE_ID FROM PMART.LAST_ORG_DIM WHERE RESPON_ID='+P_ORG_ID+') B, '+
        ' PMART.YMWD_TIME C '+
        ' WHERE A.OSTORE_ID=B.OSTORE_ID '+
        ' AND C.L_WEEK_ID='+ P_WEEK_ID +'  '+
        ' AND A.L_DAY_ID=C.L_DAY_ID '+
        ' UNION '+
        ' SELECT '+
        ' 99991231 AS L_DAY_ID,'+
        ' A.OSTORE_ID AS ORG_ID,'+
        '  A.L_WEEK_ID AS L_WEEK_ID,'+
        '  CAST(SUM(A.AMT) AS DECIMAL(18,6)) / SUM(A.UPLOAD_STNUM) AS AMT,'+
        '  CAST(SUM(A.CUST_NUM) AS DECIMAL(18,6)) / SUM(A.UPLOAD_STNUM) AS CUST_NUM,'+
        '  CAST(SUM(A.AMT) AS DECIMAL(18,6))  / SUM(A.CUST_NUM) AS CUST_AMT,'+
        '  (CAST(SUM(A.AMT) AS DECIMAL(18,6)) / SUM(A.UPLOAD_STNUM)) * 100 / ( CAST(SUM(AA.AMT) AS DECIMAL(18,6)) / SUM(AA.UPLOAD_STNUM)) AS P_AMT, '+  
        '  (CAST(SUM(A.CUST_NUM) AS DECIMAL(18,6))  / SUM(A.UPLOAD_STNUM)) * 100 / ( CAST(SUM(AA.CUST_NUM) AS DECIMAL(18,6)) / SUM(AA.UPLOAD_STNUM)) AS P_CUST_NUM '+  
        ' FROM ( '+
        '  SELECT  '+
        '  A.L_DAY_ID, '+
        '  A.OSTORE_ID AS OSTORE_ID, '+
        '  C.L_WEEK_ID AS L_WEEK_ID, '+
        '  A.AMT, '+
        '  A.CUST_NUM, '+
        '  A.UPLOAD_STNUM, '+
        '  C.L_DAY_LAST_YEAR '+
        '  FROM PMART.REMD_FACT A ,  '+
        '        (SELECT OSTORE_ID FROM PMART.LAST_ORG_DIM WHERE RESPON_ID = '+P_ORG_ID+') B, '+
        '        PMART.YMWD_TIME C '+
        '  WHERE A.OSTORE_ID = B.OSTORE_ID '+
        '    AND C.L_WEEK_ID = '+ P_WEEK_ID +'  '+
        '    AND A.L_DAY_ID = C.L_DAY_ID '+
        '  )A LEFT JOIN PMART.REMD_FACT AA ON A.OSTORE_ID = AA.OSTORE_ID AND  AA.L_DAY_ID = A.L_DAY_LAST_YEAR '+
        '  GROUP BY A.OSTORE_ID, A.L_WEEK_ID '+
        ' UNION '+
        ' SELECT '+
        ' 1 AS L_DAY_ID,'+
        ' A.OSTORE_ID AS ORG_ID,'+
        '  A.L_WEEK_ID AS L_WEEK_ID,'+
        '  CAST(SUM(A.AMT) AS DECIMAL(18,6)) / SUM(A.UPLOAD_STNUM) AS AMT,'+
        '  CAST(SUM(A.CUST_NUM)  AS DECIMAL(18,6))  / SUM(A.UPLOAD_STNUM) AS CUST_NUM,'+
        '  CAST(SUM(A.AMT)  AS DECIMAL(18,6)) / SUM(A.CUST_NUM) AS CUST_AMT,'+
        '  (CAST(SUM(A.AMT)  AS DECIMAL(18,6)) / SUM(A.UPLOAD_STNUM)) * 100 / ( CAST(SUM(AA.AMT)  AS DECIMAL(18,6)) / SUM(AA.UPLOAD_STNUM)) AS P_AMT, '+  
        '  (CAST(SUM(A.CUST_NUM)  AS DECIMAL(18,6)) / SUM(A.UPLOAD_STNUM)) * 100 / ( CAST(SUM(AA.CUST_NUM) AS DECIMAL(18,6)) / SUM(AA.UPLOAD_STNUM)) AS P_CUST_NUM '+  
        ' FROM ( '+
        '  SELECT  '+
        '  A.L_DAY_ID, '+
        '  A.OSTORE_ID AS OSTORE_ID, '+
        '  C.L_WEEK_ID AS L_WEEK_ID, '+
        '  A.AMT, '+
        '  A.CUST_NUM, '+
        '  A.UPLOAD_STNUM, '+
        '  C.L_DAY_LAST_YEAR '+
        '  FROM PMART.REMD_FACT A ,  '+
        '        (SELECT OSTORE_ID FROM PMART.LAST_ORG_DIM WHERE RESPON_ID = '+P_ORG_ID+') B, '+
        '        YMWD_TIME C '+
        '  WHERE A.OSTORE_ID = B.OSTORE_ID '+
        '    AND C.L_WEEK_ID = '+ P_LAST_WEEK_ID +'  '+
        '    AND A.L_DAY_ID = C.L_DAY_ID '+
        '  )A LEFT JOIN PMART.REMD_FACT AA ON A.OSTORE_ID = AA.OSTORE_ID AND  AA.L_DAY_ID = A.L_DAY_LAST_YEAR '+
        '  GROUP BY A.OSTORE_ID, A.L_WEEK_ID ';
   SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_BI_1_1_RESPON_FUNC  AS('+
        V_STRING +
   ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;'; 
	EXECUTE IMMEDIATE SQLSTR;
END SP;