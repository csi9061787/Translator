REPLACE  PROCEDURE PDATA.FAMI_TRAFFIC_0300
(
)
SP:BEGIN
CALL PDATA.P_DROP_TABLE('PTEMP.TP1_FACT_MMK_TRAFFIC');
CREATE TABLE PTEMP.TP1_FACT_MMK_TRAFFIC AS PMART.FACT_MMK_TRAFFIC WITH NO DATA;
CALL PDATA.P_DROP_TABLE('PTEMP.TP2_FACT_MMK_TRAFFIC');
CREATE TABLE PTEMP.TP2_FACT_MMK_TRAFFIC AS PMART.FACT_MMK_TRAFFIC WITH NO DATA;
CALL PDATA.P_DROP_TABLE('PTEMP.TP3_FACT_MMK_TRAFFIC');
CREATE TABLE PTEMP.TP3_FACT_MMK_TRAFFIC AS PMART.FACT_MMK_TRAFFIC WITH NO DATA;
INSERT INTO PTEMP.TP1_FACT_MMK_TRAFFIC
SELECT OSTORE_ID,
               COALESCE(B.L_DAY_ID,COALESCE(B.L_MONTH_ID,COALESCE(B.L_YEAR_ID,-1))) AS TIME_ID,
               C.ITEM_ID, 										               
               STATUS,
               SUM(DATA_CNT) TRAN_CNT, SUM(TICKET_COUNT) SLQTY, SUM(TOTAL_PRICE) SLUNT
  FROM PTEMP.TP0_FAMI_TRAFFIC A
  JOIN PMART.TIME_D B ON A.L_DAY_ID=B.L_DAY_ID
  JOIN PDATA.MMK_PRD_D C ON A.MMK_ID = C.MMK_ID AND A.ITEM_NAME = C.ITEM_NAME  
  GROUP BY A.OSTORE_ID, ROLLUP(B.L_YEAR_ID,B.L_MONTH_ID,B.L_DAY_ID), C.ITEM_ID, A.STATUS;
INSERT INTO PTEMP.TP2_FACT_MMK_TRAFFIC
SELECT COALESCE(T2.OSTORE_ID,COALESCE(T2.BRANCH_ID,COALESCE(T2.DEPT_ID,COALESCE(T2.PDEPT_ID,-1)))) AS ORG_ID,
                    TIME_ID, MMK_ID, STATUS,
                    SUM(TRAN_CNT) TRAN_CNT, SUM(SLQTY) SLQTY, SUM(SLUNT) SLUNT
 FROM PTEMP.TP1_FACT_MMK_TRAFFIC T1
 JOIN PMART.LAST_ORG_STORE AS T2 ON T1.ORG_ID=T2.OSTORE_ID
 WHERE T1.TIME_ID <> -1
 GROUP BY TIME_ID,ROLLUP(T2.PDEPT_ID,T2.DEPT_ID,T2.BRANCH_ID,T2.OSTORE_ID),MMK_ID,STATUS;
INSERT INTO PTEMP.TP3_FACT_MMK_TRAFFIC
SELECT ORG_ID,TIME_ID,
       COALESCE(S2.ITEM_ID,COALESCE(S2.MMK_ID,'-1')) AS MMK_ID,STATUS,
       SUM(TRAN_CNT) TRAN_CNT, SUM(SLQTY) SLQTY, SUM(SLUNT) SLUNT
  FROM PTEMP.TP2_FACT_MMK_TRAFFIC S1
  JOIN PDATA.MMK_PRD_D AS S2 ON S2.ITEM_ID = S1.MMK_ID				
  GROUP BY ORG_ID,TIME_ID,ROLLUP(S2.MMK_ID,S2.ITEM_ID),STATUS;
MERGE INTO PMART.FACT_MMK_TRAFFIC A
USING PTEMP.TP3_FACT_MMK_TRAFFIC B
ON A.TIME_ID=B.TIME_ID AND A.ORG_ID=B.ORG_ID AND A.MMK_ID=B.MMK_ID AND A.STATUS = B.STATUS
WHEN MATCHED THEN UPDATE SET
            TRAN_CNT           = A.TRAN_CNT+B.TRAN_CNT,
            SLQTY                    = A.SLQTY+B.SLQTY,
            SLUNT                    = A.SLUNT+B.SLUNT
WHEN NOT MATCHED THEN INSERT(
            ORG_ID, 
	    TIME_ID, 
            MMK_ID, 
            STATUS, 
            TRAN_CNT, 
            SLQTY, 
            SLUNT
)
VALUES (
            B.ORG_ID, 
	        B.TIME_ID, 
            B.MMK_ID, 
            B.STATUS, 
            B.TRAN_CNT, 
            B.SLQTY, 
            B.SLUNT
);
DELETE FROM PMART.FACT_MMK_TRAFFIC WHERE TRAN_CNT = 0;
DROP TABLE PTEMP.TP0_FAMI_TRAFFIC;
DROP TABLE PTEMP.TP1_FACT_MMK_TRAFFIC;
DROP TABLE PTEMP.TP2_FACT_MMK_TRAFFIC;
DROP TABLE PTEMP.TP3_FACT_MMK_TRAFFIC;
END SP;