REPLACE PROCEDURE PMART.FUNC_FACT_CARD_POINT_UNUSUAL
(
   IN P_TIME_S INTEGER,
   IN P_TIME_E INTEGER,
   IN P_ORGTYPE SMALLINT,
   IN P_ORGID VARCHAR(10),
   IN P_CARD_TYPE VARCHAR(10),
   IN P_QUERY_TYPE SMALLINT, 
   IN P_UNUSUAL_CNT SMALLINT
)
SP:BEGIN
     DECLARE SQLSTR  VARCHAR(10000);
	 DECLARE ORGSELECT VARCHAR(2000);
	 DECLARE ORGWHERE VARCHAR(2000);  
	 DECLARE QUERYWHERE VARCHAR(200);  
   SET ORGWHERE = ' WHERE 1=1 ';
   SET QUERYWHERE = '';
   IF P_ORGTYPE = 0 THEN
	    SET ORGSELECT = 'DEPT_ID AS GROUP_ORG_ID, S.OSTORE_ID, SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT, NVL(SHOP_ZONE_MAIN,'''')+NVL(SHOP_ZONE_SEC1,'''')+NVL(SHOP_ZONE_SEC2,'''') AS SEC_DISTRICT,STORE_TYPE,OST.OPEN_YEAR';
		SET ORGWHERE = ORGWHERE + ' AND S.PDEPT_ID  = ' + TRIM(P_ORGID); 
   ELSEIF P_ORGTYPE = 1 THEN
	    SET ORGSELECT = 'BRANCH_ID AS GROUP_ORG_ID, S.OSTORE_ID, SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT, NVL(SHOP_ZONE_MAIN,'''')+NVL(SHOP_ZONE_SEC1,'''')+NVL(SHOP_ZONE_SEC2,'''') AS SEC_DISTRICT,STORE_TYPE,OST.OPEN_YEAR';
		SET ORGWHERE = ORGWHERE + ' AND S.DEPT_ID  = ' + TRIM(P_ORGID); 
   ELSEIF P_ORGTYPE = 2 THEN
        SET ORGSELECT = 'RESPON_ID AS GROUP_ORG_ID, S.OSTORE_ID, SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT, NVL(SHOP_ZONE_MAIN,'''')+NVL(SHOP_ZONE_SEC1,'''')+NVL(SHOP_ZONE_SEC2,'''') AS SEC_DISTRICT,STORE_TYPE,OST.OPEN_YEAR';
	    SET ORGWHERE = ORGWHERE + ' AND S.BRANCH_ID = ' + TRIM(P_ORGID);
   ELSEIF P_ORGTYPE = 3 THEN
        SET ORGSELECT = 'S.OSTORE_ID AS GROUP_ORG_ID, S.OSTORE_ID, SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT, NVL(SHOP_ZONE_MAIN,'''')+NVL(SHOP_ZONE_SEC1,'''')+NVL(SHOP_ZONE_SEC2,'''') AS SEC_DISTRICT,STORE_TYPE,OST.OPEN_YEAR';
	    SET ORGWHERE = ORGWHERE + ' AND S.RESPON_ID = ' + P_ORGID;
   ELSEIF P_ORGTYPE = 4 THEN
        SET ORGSELECT = 'S.OSTORE_ID AS GROUP_ORG_ID, S.OSTORE_ID, SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT, NVL(SHOP_ZONE_MAIN,'''')+NVL(SHOP_ZONE_SEC1,'''')+NVL(SHOP_ZONE_SEC2,'''') AS SEC_DISTRICT,STORE_TYPE,OST.OPEN_YEAR';
	    SET ORGWHERE = ORGWHERE + ' AND S.OSTORE_ID = ' + P_ORGID;
   ELSE
        SET ORGSELECT = 'PDEPT_ID AS GROUP_ORG_ID, S.OSTORE_ID, SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT, NVL(SHOP_ZONE_MAIN,'''')+NVL(SHOP_ZONE_SEC1,'''')+NVL(SHOP_ZONE_SEC2,'''') AS SEC_DISTRICT,STORE_TYPE,OST.OPEN_YEAR';
   END IF;   
   IF P_QUERY_TYPE = 1 THEN 
        SET QUERYWHERE = ' AND T1.FG_EX_TYPE = 1  AND T1.EX_CNT>= '+P_UNUSUAL_CNT;
   ELSEIF P_QUERY_TYPE = 2 THEN 
        SET QUERYWHERE = ' AND T1.FG_EX_TYPE = 1  AND T1.EX_CNT_DIFF_STORE >= '+P_UNUSUAL_CNT;
   ELSEIF P_QUERY_TYPE = 3 THEN 
        SET QUERYWHERE = ' AND T1.FG_EX_TYPE = 2  AND T1.EX_CNT>= '+P_UNUSUAL_CNT;
   ELSEIF P_QUERY_TYPE = 4 THEN 
        SET QUERYWHERE = ' AND T1.FG_EX_TYPE = 2  AND T1.EX_CNT_DIFF_STORE >= '+P_UNUSUAL_CNT;	
   END IF;   
   CALL PMART.P_DROP_TABLE ('#VT_FACT_CARD_POINT_UNUSUAL');
   SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FACT_CARD_POINT_UNUSUAL AS( '		  
	  					 + ' SELECT T2.OSTORE_ID '
						 + '                ,T2.PDEPT_ID AS PDEPT_ID '
	 					  + '                ,T2.PDEPT_SNAME AS PDEPT_NAME '		
	 					  + '                ,T2.DEPT_ID AS DEPT_ID '
	 					  + '                ,T2.DEPT_SNAME AS DEPT_NAME '								 
	 					 + '                  ,T2.BRANCH_ID AS BRANCH_ID '
	 					 + '                  ,T2.BRANCH_SNAME AS BRANCH_NAME '
	 					 + '                  ,T2.RESPON_ID '
	 					 + '                  ,T2.RESPON_NAME AS RESPON_NANE '
	 					 + '                  ,T2.STORE_NO AS STORE_ID '
	 					 + '                  ,T2.STORE_NAME '
	 					 + '                  ,T1.CARD_TYPE '
						 +'                   ,PCODE.CODE_NAME AS CARD_TYPE_NAME '
	 					 + '                  ,T1.CARD_MEMBER_ID '
						 +'                   ,CAST( (SUBSTRING(CAST(T1.TIME_ID  AS VARCHAR(8)),1,4)+''/''+SUBSTRING(CAST(T1.TIME_ID  AS VARCHAR(8)),5,2)+''/''+SUBSTRING(CAST(T1.TIME_ID  AS VARCHAR(8)),7,2)) AS DATE) AS TX_DATE '
	 					 + '                  ,SUM(T1.EX_CNT) AS EX_CNT  '
	 					 + '                  ,SUM(T1.EX_POINT) AS EX_POINT  '
	 					 + '                  ,SUM(T1.EX_AMT) AS EX_AMT '
	 					 + '     FROM PMART.FACT_CARD_POINT_UNUSUAL T1  '
	 					 + '                INNER JOIN (  '
	 					 + '                                              SELECT S.OSTORE_ID,S.RESPON_ID,S.BRANCH_ID,S.DEPT_ID,S.PDEPT_ID,S.STORE_NO,S.STORE_NAME '
	 					 + '                                                               ,P.PDEPT_SNAME,D.DEPT_SNAME,B.BRANCH_SNAME,R.RESPON_NAME '
	 					 + '                                                  FROM PMART.LAST_ORG_STORE S  '
	 					 + '                                                               LEFT JOIN PMART.ORG_DEPT D ON S.DEPT_ID = D.DEPT_ID '
						 + '                                                               LEFT JOIN PMART.ORG_PDEPT P ON S.PDEPT_ID = P.PDEPT_ID '
	 					 + '                                                               LEFT JOIN PMART.ORG_BRANCH B ON S.BRANCH_ID = B.BRANCH_ID '
	 					 + '                                                               LEFT JOIN PMART.ORG_RESPON R ON S.RESPON_ID = R.RESPON_ID  '                  
	 					 +                                               TRIM(ORGWHERE)
	 					 + '                                         ) T2 ON T1.ORG_ID = T2.OSTORE_ID '
						 + '                LEFT JOIN (SELECT CAST(CODE_ID AS SMALLINT) AS CODE_ID,CODE_NAME FROM PDATA.PBMCODE WHERE CODE_TYPE=''CARD_TYPE'' ) PCODE ON T1.CARD_TYPE = PCODE.CODE_ID '
	 					 + '  WHERE T1.TIME_ID >= ' + P_TIME_S +' AND T1.TIME_ID <= ' + P_TIME_E
						 +'         AND T1.CARD_TYPE IN ('+ P_CARD_TYPE +')  '
						 + TRIM(QUERYWHERE)
						 +'  GROUP BY T2.OSTORE_ID,T2.PDEPT_ID,T2.PDEPT_SNAME ,T2.DEPT_ID,T2.DEPT_SNAME ,T2.BRANCH_ID,T2.BRANCH_SNAME,T2.RESPON_ID,T2.RESPON_NAME,T2.STORE_NO,T2.STORE_NAME,T1.CARD_TYPE,PCODE.CODE_NAME,T1.CARD_MEMBER_ID,TIME_ID '
			             + ' ) WITH DATA PRIMARY INDEX(CARD_TYPE,OSTORE_ID,BRANCH_ID,CARD_MEMBER_ID,TX_DATE) ON COMMIT PRESERVE ROWS;';						 
        EXECUTE IMMEDIATE SQLSTR;   
END SP;