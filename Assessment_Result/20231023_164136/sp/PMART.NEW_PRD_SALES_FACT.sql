REPLACE PROCEDURE PMART.NEW_PRD_SALES_FACT
(FP_TIME_LIST  INTEGER  
,FP_ORG_LEVEL  INTEGER  
,FP_ORG_LIST   INTEGER  
,FP_XAXIS      INTEGER  
,FP_STAS       INTEGER  
)
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR  VARCHAR(64000); 	
   DECLARE V_TABLE_NAME VARCHAR(30);
   DECLARE V_STAS_NAME VARCHAR(30);
   DECLARE V_MEAS_NAME VARCHAR(200);
   DECLARE V_ORG_COLUMN VARCHAR(30);
   DECLARE V_MMA_COLUMN VARCHAR(30);
   DECLARE V_TRA_COLUMN VARCHAR(6000);   
   DECLARE V_CTP_COLUMN VARCHAR(1000);    
   CALL PMART.P_DROP_TABLE ('#VT_NEW_PRD_SALES_FACT'); 
   CALL PMART.P_DROP_TABLE ('#VT_NEW_PRD_SALES_FACT_0');    
   CALL PMART.P_DROP_TABLE ('#VT_NEW_PRD_SALES_FACT_1');    
   SET V_TABLE_NAME = ' ';
   IF (FP_XAXIS = 1 )THEN  
       SET V_TABLE_NAME = 'PMART.NEW_FACT' ; 
       SET V_MMA_COLUMN = 'MMA_ID' ; 
   ELSE
       SET V_TABLE_NAME = 'PMART.NEW_TCFACT_SUM' ; 
       SET V_MMA_COLUMN = ' 1 ' ; 
   END IF;
   SET V_ORG_COLUMN = '' ;
   IF (FP_ORG_LEVEL = 1 ) THEN SET V_ORG_COLUMN = '' ; END IF ;
   IF (FP_ORG_LEVEL = 2 ) THEN SET V_ORG_COLUMN = ' AND DEPT_ID ='+FP_ORG_LIST ; END IF ;
   IF (FP_ORG_LEVEL = 3 ) THEN SET V_ORG_COLUMN = ' AND BRANCH_ID ='+FP_ORG_LIST ; END IF ;
   SET V_STAS_NAME = '1';
   IF (FP_STAS = 1 )THEN  SET V_STAS_NAME = '1' ; END IF;   
   IF (FP_STAS = 2 )THEN  SET V_STAS_NAME = 'A.INPRD_FLAG'      ; END IF;
   IF (FP_STAS = 3 )THEN  SET V_STAS_NAME = 'A.SALE_UL_FLAG'    ; END IF;
   IF (FP_STAS = 4 )THEN  SET V_STAS_NAME = 'B.STNUM_STORE_NUM' ; END IF; 
   SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_NEW_PRD_SALES_FACT_0  AS('+
                '  SELECT '+V_MMA_COLUMN+' AS MMA_ID                '+
                '  ,SUM(UPLOAD_STNUM) AS STNUM_STORE_NUM              '+
                '  FROM PMART.REMD_FACT A, PMART.LAST_ORG_MMA_DIM B   '+
                ' WHERE A.OSTORE_ID = B.OSTORE_ID                     '+
                '   AND UPLOAD_STNUM = 1                              '+
                '   AND A.L_DAY_ID ='+ FP_TIME_LIST+ V_ORG_COLUMN+''+
                '  GROUP BY '+V_MMA_COLUMN+'                        '+
                ') WITH DATA UNIQUE PRIMARY INDEX ( MMA_ID ) ON COMMIT PRESERVE ROWS;'; 
	DELETE FROM PTEMP.T2 ;
	INSERT INTO PTEMP.T2(F1,F2) SELECT 50,SQLSTR;
	EXECUTE IMMEDIATE SQLSTR;
IF (FP_XAXIS = 1 )THEN  
   SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_NEW_PRD_SALES_FACT_1  AS('+
                '  SELECT B.PRD_NO                                          '+
                ', SUBSTRING(B.PRD_CMBND, 1, 4) PRD_CMBND                      '+
                ', SUBSTRING(B.PRD_NM, 1, 10) PRD_NUM                          '+
                ', B.PRD_SLUNT                                              '+
                ', C.MMA_ID                                                 '+
                ', SUM(CAST(C.ORDER_AMT AS NUMBER))     AS ORDER_AMT        '+
                ', SUM(CAST(C.ORDER_CNT AS NUMBER))     AS ORDER_CNT        '+
                ', SUM(CAST(C.INPRD_AMT AS NUMBER))     AS INPRD_AMT        '+
                ', SUM(CAST(C.INPRD_CNT AS NUMBER))     AS INPRD_CNT        '+
                ', SUM(CAST(C.SALE_AMT  AS NUMBER))     AS SALE_AMT         '+
                ', SUM(CAST(C.SALE_CNT  AS NUMBER))     AS SALE_CNT         '+
                ', SUM(CAST((C.SALE_AMT - C.DIS_AMT - C.SUB_AMT)  AS NUMBER)) AS SALE_DISSUB_AMT '+
                ', SUM(CAST(C.THROW_AMT  AS NUMBER))    AS THROW_AMT        '+
                ', SUM(CAST(C.THROW_CNT  AS NUMBER))    AS THROW_CNT        '+
                ', SUM(SUM(CAST(C.SALE_AMT AS NUMBER)))  OVER ( PARTITION BY A.PRD_ID) AS TOT_SALE_AMT '+
                ', SUM(SUM(CAST(C.SALE_CNT AS NUMBER)))  OVER ( PARTITION BY A.PRD_ID) AS TOT_SALE_CNT '+
                ', SUM(CAST(C.INPRD_FLAG  AS NUMBER))   AS INPRD_FLAG       '+
                ', SUM(CAST(C.SALE_UL_FLAG  AS NUMBER)) AS SALE_UL_FLAG     '+                
                ',  A.PRD_ID                                                '+
                'FROM ( SELECT PRD_NO AS PRD_ID  FROM PMART.NEW_SET  WHERE PRD_NO<>''2940281'') A                '+
                '     LEFT OUTER JOIN                                       '+
                '( SELECT PRD_ID, PRD_NO, PRD_CMBND, PRD_NM, PRD_SLUNT      '+
                '    FROM PMART.PRD_DIM ) B                                 '+
                'ON A.PRD_ID = B.PRD_ID                                     '+
                '     LEFT OUTER JOIN                                       '+                                
                '( SELECT * FROM '+ V_TABLE_NAME+'                        '+
                '   WHERE L_DAY_ID = '+ FP_TIME_LIST+ V_ORG_COLUMN+'     '+
                '     AND NOT EXISTS ( SELECT STORE_ID                      '+
                '                       FROM PMART.NEW_FACT_ERR             '+
	        '                      WHERE L_DAY_ID =' + FP_TIME_LIST+' '+
                '                        AND NEW_FACT.STORE_ID = STORE_ID)  '+
                '                     ) C                                   '+
                'ON A.PRD_ID = C.PRD_ID                                     '+
                'GROUP BY A.PRD_ID, B.PRD_CMBND, B.PRD_NM, B.PRD_SLUNT, B.PRD_NO, C.MMA_ID  '+
                ') WITH DATA UNIQUE PRIMARY  CHARINDEX(PRD_ID , MMA_ID) ON COMMIT PRESERVE ROWS;'; 
	INSERT INTO PTEMP.T2(F1,F2) SELECT 51,SQLSTR;
	EXECUTE IMMEDIATE SQLSTR;
   SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_NEW_PRD_SALES_FACT  AS('+
                '  SELECT A.PRD_NO,A.PRD_CMBND,A.PRD_NUM,A.PRD_SLUNT,A.MMA_ID,A.PRD_ID '+
                ' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.ORDER_AMT/' + V_STAS_NAME + ' END AS ORDER_AMT '+ 
                ' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.ORDER_CNT/' + V_STAS_NAME + ' END AS ORDER_CNT '+ 
                ' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.INPRD_AMT/' + V_STAS_NAME + ' END AS INPRD_AMT '+ 
                ' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.INPRD_CNT/' + V_STAS_NAME + ' END AS INPRD_CNT '+ 
                ' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT/'  + V_STAS_NAME + ' END AS SALE_AMT '+ 
                ' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT/'  + V_STAS_NAME + ' END AS SALE_CNT '+ 
                ' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT '+ 
                ' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.THROW_AMT/' + V_STAS_NAME + ' END AS THROW_AMT '+ 
                ' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.THROW_CNT/' + V_STAS_NAME + ' END AS THROW_CNT '+
                ' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ' +
                '       WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 '+ 
                '  ELSE ((A.SALE_AMT/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE '+
                ' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ' +
                '       WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 '+ 
                '  ELSE ((A.SALE_CNT/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE '+ 
                ' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ' +
                '       WHEN A.INPRD_CNT/' + V_STAS_NAME + ' = 0 THEN 0 '+ 
                '  ELSE ((A.SALE_CNT/' + V_STAS_NAME + ')/(A.INPRD_CNT/' + V_STAS_NAME + ')) END AS SALES_INPRD_CNT '+ 
                ' ,' + V_STAS_NAME + ' AS STORE_NUM '+
                'FROM #VT_NEW_PRD_SALES_FACT_1 A                            '+
                '     LEFT OUTER JOIN                                       '+
                '     #VT_NEW_PRD_SALES_FACT_0 B                            '+
                'ON A.MMA_ID = B.MMA_ID                                     '+
                ') WITH DATA UNIQUE PRIMARY  CHARINDEX(PRD_ID , MMA_ID) ON COMMIT PRESERVE ROWS;'; 
	INSERT INTO PTEMP.T2(F1,F2) SELECT 52,SQLSTR;
	EXECUTE IMMEDIATE SQLSTR;	
END IF ;
IF (FP_XAXIS = 2 )THEN  
 SET V_TRA_COLUMN = ' ,CAST(A1.SALE_AMT_00 AS NUMBER) AS SALE_AMT_00 ,CAST(A1.SALE_AMT_01 AS NUMBER) AS SALE_AMT_01 ' +
                    ' ,CAST(A1.SALE_AMT_02 AS NUMBER) AS SALE_AMT_02 ,CAST(A1.SALE_AMT_03 AS NUMBER) AS SALE_AMT_03 ' +
                    ' ,CAST(A1.SALE_AMT_04 AS NUMBER) AS SALE_AMT_04 ,CAST(A1.SALE_AMT_05 AS NUMBER) AS SALE_AMT_05 ' +
                    ' ,CAST(A1.SALE_AMT_06 AS NUMBER) AS SALE_AMT_06 ,CAST(A1.SALE_AMT_07 AS NUMBER) AS SALE_AMT_07 ' +
                    ' ,CAST(A1.SALE_AMT_08 AS NUMBER) AS SALE_AMT_08 ,CAST(A1.SALE_AMT_09 AS NUMBER) AS SALE_AMT_09 ' +
                    ' ,CAST(A1.SALE_AMT_10 AS NUMBER) AS SALE_AMT_10 ,CAST(A1.SALE_AMT_11 AS NUMBER) AS SALE_AMT_11 ' +
                    ' ,CAST(A1.SALE_AMT_12 AS NUMBER) AS SALE_AMT_12 ,CAST(A1.SALE_AMT_13 AS NUMBER) AS SALE_AMT_13 ' +
                    ' ,CAST(A1.SALE_AMT_14 AS NUMBER) AS SALE_AMT_14 ,CAST(A1.SALE_AMT_15 AS NUMBER) AS SALE_AMT_15 ' +
                    ' ,CAST(A1.SALE_AMT_16 AS NUMBER) AS SALE_AMT_16 ,CAST(A1.SALE_AMT_17 AS NUMBER) AS SALE_AMT_17 ' +
                    ' ,CAST(A1.SALE_AMT_18 AS NUMBER) AS SALE_AMT_18 ,CAST(A1.SALE_AMT_19 AS NUMBER) AS SALE_AMT_19 ' +
                    ' ,CAST(A1.SALE_AMT_20 AS NUMBER) AS SALE_AMT_20 ,CAST(A1.SALE_AMT_21 AS NUMBER) AS SALE_AMT_21 ' +
                    ' ,CAST(A1.SALE_AMT_22 AS NUMBER) AS SALE_AMT_22 ,CAST(A1.SALE_AMT_23 AS NUMBER) AS SALE_AMT_23 ' +
                    ' ,CAST(A1.SALE_CNT_00 AS NUMBER) AS SALE_CNT_00 ,CAST(A1.SALE_CNT_01 AS NUMBER) AS SALE_CNT_01 ' +
                    ' ,CAST(A1.SALE_CNT_02 AS NUMBER) AS SALE_CNT_02 ,CAST(A1.SALE_CNT_03 AS NUMBER) AS SALE_CNT_03 ' +
                    ' ,CAST(A1.SALE_CNT_04 AS NUMBER) AS SALE_CNT_04 ,CAST(A1.SALE_CNT_05 AS NUMBER) AS SALE_CNT_05 ' +
                    ' ,CAST(A1.SALE_CNT_06 AS NUMBER) AS SALE_CNT_06 ,CAST(A1.SALE_CNT_07 AS NUMBER) AS SALE_CNT_07 ' +
                    ' ,CAST(A1.SALE_CNT_08 AS NUMBER) AS SALE_CNT_08 ,CAST(A1.SALE_CNT_09 AS NUMBER) AS SALE_CNT_09 ' +
                    ' ,CAST(A1.SALE_CNT_10 AS NUMBER) AS SALE_CNT_10 ,CAST(A1.SALE_CNT_11 AS NUMBER) AS SALE_CNT_11 ' +
                    ' ,CAST(A1.SALE_CNT_12 AS NUMBER) AS SALE_CNT_12 ,CAST(A1.SALE_CNT_13 AS NUMBER) AS SALE_CNT_13 ' +
                    ' ,CAST(A1.SALE_CNT_14 AS NUMBER) AS SALE_CNT_14 ,CAST(A1.SALE_CNT_15 AS NUMBER) AS SALE_CNT_15 ' +
                    ' ,CAST(A1.SALE_CNT_16 AS NUMBER) AS SALE_CNT_16 ,CAST(A1.SALE_CNT_17 AS NUMBER) AS SALE_CNT_17 ' +
                    ' ,CAST(A1.SALE_CNT_18 AS NUMBER) AS SALE_CNT_18 ,CAST(A1.SALE_CNT_19 AS NUMBER) AS SALE_CNT_19 ' +
                    ' ,CAST(A1.SALE_CNT_20 AS NUMBER) AS SALE_CNT_20 ,CAST(A1.SALE_CNT_21 AS NUMBER) AS SALE_CNT_21 ' +
                    ' ,CAST(A1.SALE_CNT_22 AS NUMBER) AS SALE_CNT_22 ,CAST(A1.SALE_CNT_23 AS NUMBER) AS SALE_CNT_23 ' +
                    ' ,CAST((A1.SALE_AMT_00 - A1.SALE_DIS_00 - A1.SALE_SUB_00) AS NUMBER) AS SALE_DISSUB_AMT_00 ' +
                    ' ,CAST((A1.SALE_AMT_01 - A1.SALE_DIS_01 - A1.SALE_SUB_01) AS NUMBER) AS SALE_DISSUB_AMT_01 ' +
                    ' ,CAST((A1.SALE_AMT_02 - A1.SALE_DIS_02 - A1.SALE_SUB_02) AS NUMBER) AS SALE_DISSUB_AMT_02 ' +
                    ' ,CAST((A1.SALE_AMT_03 - A1.SALE_DIS_03 - A1.SALE_SUB_03) AS NUMBER) AS SALE_DISSUB_AMT_03 ' +
                    ' ,CAST((A1.SALE_AMT_04 - A1.SALE_DIS_04 - A1.SALE_SUB_04) AS NUMBER) AS SALE_DISSUB_AMT_04 ' +
                    ' ,CAST((A1.SALE_AMT_05 - A1.SALE_DIS_05 - A1.SALE_SUB_05) AS NUMBER) AS SALE_DISSUB_AMT_05 ' +
                    ' ,CAST((A1.SALE_AMT_06 - A1.SALE_DIS_06 - A1.SALE_SUB_06) AS NUMBER) AS SALE_DISSUB_AMT_06 ' +
                    ' ,CAST((A1.SALE_AMT_07 - A1.SALE_DIS_07 - A1.SALE_SUB_07) AS NUMBER) AS SALE_DISSUB_AMT_07 ' +
                    ' ,CAST((A1.SALE_AMT_08 - A1.SALE_DIS_08 - A1.SALE_SUB_08) AS NUMBER) AS SALE_DISSUB_AMT_08 ' +
                    ' ,CAST((A1.SALE_AMT_09 - A1.SALE_DIS_09 - A1.SALE_SUB_09) AS NUMBER) AS SALE_DISSUB_AMT_09 ' +
                    ' ,CAST((A1.SALE_AMT_10 - A1.SALE_DIS_10 - A1.SALE_SUB_10) AS NUMBER) AS SALE_DISSUB_AMT_10 ' +
                    ' ,CAST((A1.SALE_AMT_11 - A1.SALE_DIS_11 - A1.SALE_SUB_11) AS NUMBER) AS SALE_DISSUB_AMT_11 ' +
                    ' ,CAST((A1.SALE_AMT_12 - A1.SALE_DIS_12 - A1.SALE_SUB_12) AS NUMBER) AS SALE_DISSUB_AMT_12 ' +
                    ' ,CAST((A1.SALE_AMT_13 - A1.SALE_DIS_13 - A1.SALE_SUB_13) AS NUMBER) AS SALE_DISSUB_AMT_13 ' +
                    ' ,CAST((A1.SALE_AMT_14 - A1.SALE_DIS_14 - A1.SALE_SUB_14) AS NUMBER) AS SALE_DISSUB_AMT_14 ' +
                    ' ,CAST((A1.SALE_AMT_15 - A1.SALE_DIS_15 - A1.SALE_SUB_15) AS NUMBER) AS SALE_DISSUB_AMT_15 ' +
                    ' ,CAST((A1.SALE_AMT_16 - A1.SALE_DIS_16 - A1.SALE_SUB_16) AS NUMBER) AS SALE_DISSUB_AMT_16 ' +
                    ' ,CAST((A1.SALE_AMT_17 - A1.SALE_DIS_17 - A1.SALE_SUB_17) AS NUMBER) AS SALE_DISSUB_AMT_17 ' +
                    ' ,CAST((A1.SALE_AMT_18 - A1.SALE_DIS_18 - A1.SALE_SUB_18) AS NUMBER) AS SALE_DISSUB_AMT_18 ' +
                    ' ,CAST((A1.SALE_AMT_19 - A1.SALE_DIS_19 - A1.SALE_SUB_19) AS NUMBER) AS SALE_DISSUB_AMT_19 ' +
                    ' ,CAST((A1.SALE_AMT_20 - A1.SALE_DIS_20 - A1.SALE_SUB_20) AS NUMBER) AS SALE_DISSUB_AMT_20 ' +
                    ' ,CAST((A1.SALE_AMT_21 - A1.SALE_DIS_21 - A1.SALE_SUB_21) AS NUMBER) AS SALE_DISSUB_AMT_21 ' +
                    ' ,CAST((A1.SALE_AMT_22 - A1.SALE_DIS_22 - A1.SALE_SUB_22) AS NUMBER) AS SALE_DISSUB_AMT_22 ' +
                    ' ,CAST((A1.SALE_AMT_23 - A1.SALE_DIS_23 - A1.SALE_SUB_23) AS NUMBER) AS SALE_DISSUB_AMT_23 ' + 
                    ' ,CAST( (SALE_AMT_00 + SALE_AMT_01 + SALE_AMT_02 + SALE_AMT_03 + SALE_AMT_04 '+
                    '       + SALE_AMT_05 + SALE_AMT_06 + SALE_AMT_07 + SALE_AMT_08 + SALE_AMT_09 '+
                    '       + SALE_AMT_10 + SALE_AMT_11 + SALE_AMT_12 + SALE_AMT_13 + SALE_AMT_14 '+
                    '       + SALE_AMT_15 + SALE_AMT_16 + SALE_AMT_17 + SALE_AMT_18 + SALE_AMT_19 '+
                    '       + SALE_AMT_20 + SALE_AMT_21 + SALE_AMT_22 + SALE_AMT_23) AS NUMBER) AS TOT_SALE_AMT  '+
                    ' ,CAST( (SALE_CNT_00 + SALE_CNT_01 + SALE_CNT_02 + SALE_CNT_03 + SALE_CNT_04 '+
                    '       + SALE_CNT_05 + SALE_CNT_06 + SALE_CNT_07 + SALE_CNT_08 + SALE_CNT_09 '+
                    '       + SALE_CNT_10 + SALE_CNT_11 + SALE_CNT_12 + SALE_CNT_13 + SALE_CNT_14 '+
                    '       + SALE_CNT_15 + SALE_CNT_16 + SALE_CNT_17 + SALE_CNT_18 + SALE_CNT_19 '+
                    '       + SALE_CNT_20 + SALE_CNT_21 + SALE_CNT_22 + SALE_CNT_23) AS NUMBER) AS TOT_SALE_CNT  ';
   SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_NEW_PRD_SALES_FACT_1  AS('+
                '  SELECT B.PRD_NO, B.BRAND, B.NAME, B.PRICE, 1 AS MMA_ID,C.PRD_ID '+
                ', A.SALE_AMT_00, A.SALE_AMT_01, A.SALE_AMT_02, A.SALE_AMT_03 '+
                ', A.SALE_AMT_04, A.SALE_AMT_05, A.SALE_AMT_06, A.SALE_AMT_07 '+
                ', A.SALE_AMT_08, A.SALE_AMT_09, A.SALE_AMT_10, A.SALE_AMT_11 '+
                ', A.SALE_AMT_12, A.SALE_AMT_13, A.SALE_AMT_14, A.SALE_AMT_15 '+
                ', A.SALE_AMT_16, A.SALE_AMT_17, A.SALE_AMT_18, A.SALE_AMT_19 '+
                ', A.SALE_AMT_20, A.SALE_AMT_21, A.SALE_AMT_22, A.SALE_AMT_23 '+
                ', A.SALE_CNT_00, A.SALE_CNT_01, A.SALE_CNT_02, A.SALE_CNT_03 '+
                ', A.SALE_CNT_04, A.SALE_CNT_05, A.SALE_CNT_06, A.SALE_CNT_07 '+
                ', A.SALE_CNT_08, A.SALE_CNT_09, A.SALE_CNT_10, A.SALE_CNT_11 '+
                ', A.SALE_CNT_12, A.SALE_CNT_13, A.SALE_CNT_14, A.SALE_CNT_15 '+
                ', A.SALE_CNT_16, A.SALE_CNT_17, A.SALE_CNT_18, A.SALE_CNT_19 '+
                ', A.SALE_CNT_20, A.SALE_CNT_21, A.SALE_CNT_22, A.SALE_CNT_23 '+                
                ', A.SALE_DISSUB_AMT_00, A.SALE_DISSUB_AMT_01, A.SALE_DISSUB_AMT_02, A.SALE_DISSUB_AMT_03 '+
                ', A.SALE_DISSUB_AMT_04, A.SALE_DISSUB_AMT_05, A.SALE_DISSUB_AMT_06, A.SALE_DISSUB_AMT_07 '+
                ', A.SALE_DISSUB_AMT_08, A.SALE_DISSUB_AMT_09, A.SALE_DISSUB_AMT_10, A.SALE_DISSUB_AMT_11 '+
                ', A.SALE_DISSUB_AMT_12, A.SALE_DISSUB_AMT_13, A.SALE_DISSUB_AMT_14, A.SALE_DISSUB_AMT_15 '+
                ', A.SALE_DISSUB_AMT_16, A.SALE_DISSUB_AMT_17, A.SALE_DISSUB_AMT_18, A.SALE_DISSUB_AMT_19 '+
                ', A.SALE_DISSUB_AMT_20, A.SALE_DISSUB_AMT_21, A.SALE_DISSUB_AMT_22, A.SALE_DISSUB_AMT_23 '+
                ', A.TOT_SALE_AMT, A.TOT_SALE_CNT,D.INPRD_FLAG,D.SALE_UL_FLAG '+
                'FROM ( SELECT PRD_NO AS PRD_ID FROM PMART.NEW_SET   WHERE PRD_NO<>''2940281'') C                '+
                '     LEFT OUTER JOIN                                       '+
                '( SELECT PRD_ID, PRD_NO, PRD_CMBND BRAND, PRD_NM NAME      '+
                '    , PRD_SLUNT PRICE FROM PMART.PRD_DIM ) B               '+
                'ON C.PRD_ID = B.PRD_ID                                     '+
                '     LEFT OUTER JOIN                                       '+
                '( SELECT A1.L_DAY_ID,A1.ORG_ID,A1.PRD_ID '+ V_TRA_COLUMN +' '+ 
                '    FROM '+ V_TABLE_NAME+' A1                            '+
                '   WHERE L_DAY_ID = '+ FP_TIME_LIST +'                   '+
                '     AND ORG_ID = '+ FP_ORG_LIST +' ) A                  '+
                'ON C.PRD_ID = A.PRD_ID                                     '+
                '     LEFT OUTER JOIN                                       '+
                '( SELECT D1.PRD_ID                                         '+
                ', SUM(CAST(D1.INPRD_FLAG  AS NUMBER))   AS INPRD_FLAG      '+
                ', SUM(CAST(D1.SALE_UL_FLAG  AS NUMBER)) AS SALE_UL_FLAG    '+ 
                '    FROM PMART.NEW_FACT D1                                 '+
                '   WHERE L_DAY_ID = '+ FP_TIME_LIST+ V_ORG_COLUMN+'     '+
                '     AND NOT EXISTS ( SELECT STORE_ID                      '+
                '                       FROM PMART.NEW_FACT_ERR             '+
	        '                      WHERE L_DAY_ID =' + FP_TIME_LIST+' '+
                '                        AND D1.STORE_ID = STORE_ID)        '+
                '   GROUP BY D1.PRD_ID ) D                                  '+
                'ON C.PRD_ID = D.PRD_ID                                     '+
                ') WITH DATA UNIQUE PRIMARY  CHARINDEX(PRD_NO , MMA_ID) ON COMMIT PRESERVE ROWS;'; 
	INSERT INTO PTEMP.T2(F1,F2) SELECT 61,SQLSTR;
	EXECUTE IMMEDIATE SQLSTR;
   SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_NEW_PRD_SALES_FACT  AS('+
'  SELECT A.PRD_NO, A.BRAND, A.NAME, A.PRICE, A.MMA_ID, A.PRD_ID '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_00/'  + V_STAS_NAME + ' END AS SALE_AMT_00 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_01/'  + V_STAS_NAME + ' END AS SALE_AMT_01 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_02/'  + V_STAS_NAME + ' END AS SALE_AMT_02 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_03/'  + V_STAS_NAME + ' END AS SALE_AMT_03 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_04/'  + V_STAS_NAME + ' END AS SALE_AMT_04 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_05/'  + V_STAS_NAME + ' END AS SALE_AMT_05 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_06/'  + V_STAS_NAME + ' END AS SALE_AMT_06 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_07/'  + V_STAS_NAME + ' END AS SALE_AMT_07 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_08/'  + V_STAS_NAME + ' END AS SALE_AMT_08 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_09/'  + V_STAS_NAME + ' END AS SALE_AMT_09 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_10/'  + V_STAS_NAME + ' END AS SALE_AMT_10 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_11/'  + V_STAS_NAME + ' END AS SALE_AMT_11 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_12/'  + V_STAS_NAME + ' END AS SALE_AMT_12 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_13/'  + V_STAS_NAME + ' END AS SALE_AMT_13 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_14/'  + V_STAS_NAME + ' END AS SALE_AMT_14 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_15/'  + V_STAS_NAME + ' END AS SALE_AMT_15 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_16/'  + V_STAS_NAME + ' END AS SALE_AMT_16 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_17/'  + V_STAS_NAME + ' END AS SALE_AMT_17 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_18/'  + V_STAS_NAME + ' END AS SALE_AMT_18 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_19/'  + V_STAS_NAME + ' END AS SALE_AMT_19 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_20/'  + V_STAS_NAME + ' END AS SALE_AMT_20 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_21/'  + V_STAS_NAME + ' END AS SALE_AMT_21 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_22/'  + V_STAS_NAME + ' END AS SALE_AMT_22 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_23/'  + V_STAS_NAME + ' END AS SALE_AMT_23 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_00/'  + V_STAS_NAME + ' END AS SALE_CNT_00 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_01/'  + V_STAS_NAME + ' END AS SALE_CNT_01 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_02/'  + V_STAS_NAME + ' END AS SALE_CNT_02 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_03/'  + V_STAS_NAME + ' END AS SALE_CNT_03 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_04/'  + V_STAS_NAME + ' END AS SALE_CNT_04 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_05/'  + V_STAS_NAME + ' END AS SALE_CNT_05 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_06/'  + V_STAS_NAME + ' END AS SALE_CNT_06 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_07/'  + V_STAS_NAME + ' END AS SALE_CNT_07 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_08/'  + V_STAS_NAME + ' END AS SALE_CNT_08 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_09/'  + V_STAS_NAME + ' END AS SALE_CNT_09 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_10/'  + V_STAS_NAME + ' END AS SALE_CNT_10 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_11/'  + V_STAS_NAME + ' END AS SALE_CNT_11 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_12/'  + V_STAS_NAME + ' END AS SALE_CNT_12 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_13/'  + V_STAS_NAME + ' END AS SALE_CNT_13 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_14/'  + V_STAS_NAME + ' END AS SALE_CNT_14 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_15/'  + V_STAS_NAME + ' END AS SALE_CNT_15 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_16/'  + V_STAS_NAME + ' END AS SALE_CNT_16 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_17/'  + V_STAS_NAME + ' END AS SALE_CNT_17 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_18/'  + V_STAS_NAME + ' END AS SALE_CNT_18 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_19/'  + V_STAS_NAME + ' END AS SALE_CNT_19 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_20/'  + V_STAS_NAME + ' END AS SALE_CNT_20 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_21/'  + V_STAS_NAME + ' END AS SALE_CNT_21 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_22/'  + V_STAS_NAME + ' END AS SALE_CNT_22 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_23/'  + V_STAS_NAME + ' END AS SALE_CNT_23 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_00/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_00 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_01/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_01 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_02/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_02 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_03/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_03 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_04/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_04 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_05/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_05 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_06/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_06 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_07/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_07 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_08/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_08 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_09/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_09 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_10/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_10 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_11/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_11 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_12/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_12 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_13/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_13 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_14/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_14 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_15/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_15 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_16/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_16 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_17/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_17 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_18/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_18 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_19/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_19 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_20/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_20 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_21/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_21 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_22/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_22 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_DISSUB_AMT_23/' + V_STAS_NAME + ' END AS SALE_DISSUB_AMT_23 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_00/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_00 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_01/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_01 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_02/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_02 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_03/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_03 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_04/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_04 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_05/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_05 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_06/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_06 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_07/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_07 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_08/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_08 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_09/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_09 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_10/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_10 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_11/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_11 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_12/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_12 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_13/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_13 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_14/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_14 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_15/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_15 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_16/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_16 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_17/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_17 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_18/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_18 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_19/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_19 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_20/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_20 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_21/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_21 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_22/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_22 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_AMT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_AMT_23/' + V_STAS_NAME + ')/(A.TOT_SALE_AMT/' + V_STAS_NAME + ')) END AS GSALES_AMT_RATE_23 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_00/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_00 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_01/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_01 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_02/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_02 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_03/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_03 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_04/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_04 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_05/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_05 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_06/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_06 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_07/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_07 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_08/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_08 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_09/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_09 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_10/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_10 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_11/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_11 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_12/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_12 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_13/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_13 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_14/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_14 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_15/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_15 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_16/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_16 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_17/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_17 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_18/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_18 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_19/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_19 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_20/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_20 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_21/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_21 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_22/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_22 '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 WHEN A.TOT_SALE_CNT/' + V_STAS_NAME + ' = 0 THEN 0 ELSE ((A.SALE_CNT_23/' + V_STAS_NAME + ')/(A.TOT_SALE_CNT/' + V_STAS_NAME + ')) END AS GSALES_CNT_RATE_23 '+
                ' ,' + V_STAS_NAME + ' AS STORE_NUM '+
                'FROM #VT_NEW_PRD_SALES_FACT_1 A                            '+
                '     LEFT OUTER JOIN                                       '+
                '     #VT_NEW_PRD_SALES_FACT_0 B                            '+
                'ON A.MMA_ID = B.MMA_ID                                     '+
                ') WITH DATA UNIQUE PRIMARY INDEX (PRD_NO ) ON COMMIT PRESERVE ROWS;'; 
	INSERT INTO PTEMP.T2(F1,F2) SELECT 62,SQLSTR;
	EXECUTE IMMEDIATE SQLSTR;
END IF ;
IF (FP_XAXIS = 3 )THEN  
 SET V_TRA_COLUMN = ' ,CAST(A1.SALE_CNT_M12 AS NUMBER) AS SALE_CNT_M12 ' +
                    ' ,CAST(A1.SALE_CNT_M18 AS NUMBER) AS SALE_CNT_M18 ' +
                    ' ,CAST(A1.SALE_CNT_M30 AS NUMBER) AS SALE_CNT_M30 ' +
                    ' ,CAST(A1.SALE_CNT_M50 AS NUMBER) AS SALE_CNT_M50 ' +
                    ' ,CAST(A1.SALE_CNT_MO  AS NUMBER) AS SALE_CNT_MO  ' +
                    ' ,CAST(A1.SALE_CNT_F12 AS NUMBER) AS SALE_CNT_F12 ' +
                    ' ,CAST(A1.SALE_CNT_F18 AS NUMBER) AS SALE_CNT_F18 ' +
                    ' ,CAST(A1.SALE_CNT_F30 AS NUMBER) AS SALE_CNT_F30 ' +
                    ' ,CAST(A1.SALE_CNT_F50 AS NUMBER) AS SALE_CNT_F50 ' +
                    ' ,CAST(A1.SALE_CNT_FO  AS NUMBER) AS SALE_CNT_FO  ' +
                    ' ,CAST(A1.SALE_AMT_M12 AS NUMBER) AS SALE_AMT_M12 ' +
                    ' ,CAST(A1.SALE_AMT_M18 AS NUMBER) AS SALE_AMT_M18 ' +
                    ' ,CAST(A1.SALE_AMT_M30 AS NUMBER) AS SALE_AMT_M30 ' +
                    ' ,CAST(A1.SALE_AMT_M50 AS NUMBER) AS SALE_AMT_M50 ' +
                    ' ,CAST(A1.SALE_AMT_MO  AS NUMBER) AS SALE_AMT_MO  ' +
                    ' ,CAST(A1.SALE_AMT_F12 AS NUMBER) AS SALE_AMT_F12 ' +
                    ' ,CAST(A1.SALE_AMT_F18 AS NUMBER) AS SALE_AMT_F18 ' +
                    ' ,CAST(A1.SALE_AMT_F30 AS NUMBER) AS SALE_AMT_F30 ' +
                    ' ,CAST(A1.SALE_AMT_F50 AS NUMBER) AS SALE_AMT_F50 ' +
                    ' ,CAST(A1.SALE_AMT_FO  AS NUMBER) AS SALE_AMT_FO  ' ;
   SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_NEW_PRD_SALES_FACT_1  AS('+
                '  SELECT B.PRD_NO, B.BRAND, B.NAME, B.PRICE, 1 AS MMA_ID,C.PRD_ID '+
                ', A.SALE_CNT_M12, A.SALE_CNT_M18, A.SALE_CNT_M30, A.SALE_CNT_M50, A.SALE_CNT_MO  '+
                ', A.SALE_CNT_F12, A.SALE_CNT_F18, A.SALE_CNT_F30, A.SALE_CNT_F50, A.SALE_CNT_FO  '+
                ', A.SALE_AMT_M12, A.SALE_AMT_M18, A.SALE_AMT_M30, A.SALE_AMT_M50, A.SALE_AMT_MO  '+
                ', A.SALE_AMT_F12, A.SALE_AMT_F18, A.SALE_AMT_F30, A.SALE_AMT_F50, A.SALE_AMT_FO  '+
                'FROM ( SELECT PRD_NO AS PRD_ID FROM PMART.NEW_SET   WHERE PRD_NO<>''2940281'') C                '+
                '     LEFT OUTER JOIN                                       '+
                '( SELECT PRD_ID, PRD_NO, PRD_CMBND BRAND, PRD_NM NAME      '+
                '    , PRD_SLUNT PRICE FROM PMART.PRD_DIM ) B               '+
                'ON C.PRD_ID = B.PRD_ID                                     '+
                '     LEFT OUTER JOIN                                       '+
                '( SELECT A1.L_DAY_ID,A1.ORG_ID,A1.PRD_ID '+ V_TRA_COLUMN +' '+ 
                '    FROM '+ V_TABLE_NAME+' A1                            '+
                '   WHERE L_DAY_ID = '+ FP_TIME_LIST +'                   '+
                '     AND ORG_ID = '+ FP_ORG_LIST +' ) A                  '+
                'ON C.PRD_ID = A.PRD_ID                                     '+                
                ') WITH DATA UNIQUE PRIMARY  CHARINDEX(PRD_NO , MMA_ID) ON COMMIT PRESERVE ROWS;'; 
	INSERT INTO PTEMP.T2(F1,F2) SELECT 71,SQLSTR;
	EXECUTE IMMEDIATE SQLSTR;
   SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_NEW_PRD_SALES_FACT  AS('+
'  SELECT A.PRD_NO, A.BRAND, A.NAME, A.PRICE, A.MMA_ID, A.PRD_ID '+
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_M12/'  + V_STAS_NAME + ' END AS SALE_CNT_M12 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_M18/'  + V_STAS_NAME + ' END AS SALE_CNT_M18 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_M30/'  + V_STAS_NAME + ' END AS SALE_CNT_M30 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_M50/'  + V_STAS_NAME + ' END AS SALE_CNT_M50 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_MO /'  + V_STAS_NAME + ' END AS SALE_CNT_MO  '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_F12/'  + V_STAS_NAME + ' END AS SALE_CNT_F12 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_F18/'  + V_STAS_NAME + ' END AS SALE_CNT_F18 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_F30/'  + V_STAS_NAME + ' END AS SALE_CNT_F30 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_F50/'  + V_STAS_NAME + ' END AS SALE_CNT_F50 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_CNT_FO /'  + V_STAS_NAME + ' END AS SALE_CNT_FO  '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_M12/'  + V_STAS_NAME + ' END AS SALE_AMT_M12 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_M18/'  + V_STAS_NAME + ' END AS SALE_AMT_M18 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_M30/'  + V_STAS_NAME + ' END AS SALE_AMT_M30 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_M50/'  + V_STAS_NAME + ' END AS SALE_AMT_M50 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_MO /'  + V_STAS_NAME + ' END AS SALE_AMT_MO  '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_F12/'  + V_STAS_NAME + ' END AS SALE_AMT_F12 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_F18/'  + V_STAS_NAME + ' END AS SALE_AMT_F18 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_F30/'  + V_STAS_NAME + ' END AS SALE_AMT_F30 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_F50/'  + V_STAS_NAME + ' END AS SALE_AMT_F50 '+ 
' ,CASE WHEN '+ V_STAS_NAME + ' = 0 THEN 0 ELSE A.SALE_AMT_FO /'  + V_STAS_NAME + ' END AS SALE_AMT_FO  '+
                ' ,' + V_STAS_NAME + ' AS STORE_NUM '+
                'FROM #VT_NEW_PRD_SALES_FACT_1 A                            '+
                '     LEFT OUTER JOIN                                       '+
                '     #VT_NEW_PRD_SALES_FACT_0 B                            '+
                'ON A.MMA_ID = B.MMA_ID                                     '+
                ') WITH DATA UNIQUE PRIMARY INDEX (PRD_NO ) ON COMMIT PRESERVE ROWS;'; 
	INSERT INTO PTEMP.T2(F1,F2) SELECT 72,SQLSTR;
	EXECUTE IMMEDIATE SQLSTR;
END IF ;
END SP;