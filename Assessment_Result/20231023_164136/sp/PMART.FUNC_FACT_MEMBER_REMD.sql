REPLACE PROCEDURE PMART.FUNC_FACT_MEMBER_REMD
(IN P_RPT_ID SMALLINT   
,IN P_TIME_ID INTEGER   
,IN P_ORG_TYPE SMALLINT 
,IN P_ORG_ID INTEGER    
)
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR    VARCHAR(20000);
   DECLARE ORGSELECT VARCHAR(2000);
   DECLARE ORGSELECT_DL VARCHAR(2000);
   IF P_ORG_TYPE = 0 THEN
      SET ORGSELECT    = '(SELECT DISTINCT DEPT_ID FROM PMART.LAST_ORG_DIM WHERE PDEPT_ID='+P_ORG_ID+')';
      SET ORGSELECT_DL = '(SELECT DISTINCT OSTORE_ID FROM PMART.LAST_ORG_DIM WHERE PDEPT_ID='+P_ORG_ID+')';
   ELSEIF P_ORG_TYPE = 1 THEN
      SET ORGSELECT    = '(SELECT DISTINCT BRANCH_ID FROM PMART.LAST_ORG_DIM WHERE DEPT_ID='+P_ORG_ID+')';
      SET ORGSELECT_DL = '(SELECT DISTINCT OSTORE_ID FROM PMART.LAST_ORG_DIM WHERE DEPT_ID='+P_ORG_ID+')';
   ELSEIF P_ORG_TYPE = 2 THEN
      SET ORGSELECT    = '(SELECT DISTINCT RESPON_ID FROM PMART.LAST_ORG_DIM WHERE BRANCH_ID='+P_ORG_ID+')';
      SET ORGSELECT_DL = '(SELECT DISTINCT OSTORE_ID FROM PMART.LAST_ORG_DIM WHERE BRANCH_ID='+P_ORG_ID+')';
   ELSEIF P_ORG_TYPE = 3 THEN
      SET ORGSELECT    = '(SELECT DISTINCT OSTORE_ID FROM PMART.LAST_ORG_DIM WHERE RESPON_ID='+P_ORG_ID+')';
      SET ORGSELECT_DL = '(SELECT DISTINCT OSTORE_ID FROM PMART.LAST_ORG_DIM WHERE RESPON_ID='+P_ORG_ID+')';
   ELSEIF P_ORG_TYPE = 4 THEN
      SET ORGSELECT    = '(SELECT OSTORE_ID FROM PMART.LAST_ORG_DIM WHERE OSTORE_ID='+P_ORG_ID+')';
      SET ORGSELECT_DL = '(SELECT OSTORE_ID FROM PMART.LAST_ORG_DIM WHERE OSTORE_ID='+P_ORG_ID+')';
   ELSE
      SET ORGSELECT    = '(SELECT DISTINCT PDEPT_ID   FROM PMART.LAST_ORG_DIM WHERE TOT_ID='+P_ORG_ID+')';
      SET ORGSELECT_DL = '(SELECT DISTINCT OSTORE_ID FROM PMART.LAST_ORG_DIM WHERE TOT_ID='+P_ORG_ID+')';
   END IF;
   CALL PMART.P_DROP_TABLE ('#VT_FUNC_FACT_MEMBER_REMD_HEAD');
   CALL PMART.P_DROP_TABLE ('#VT_FUNC_FACT_MEMBER_REMD_1');
   CALL PMART.P_DROP_TABLE ('#VT_FUNC_FACT_MEMBER_REMD_2');
   CALL PMART.P_DROP_TABLE ('#VT_FUNC_FACT_MEMBER_REMD_3');
   CALL PMART.P_DROP_TABLE ('#VT_FUNC_FACT_MEMBER_REMD_TEMP');
   CALL PMART.P_DROP_TABLE ('#VT_FUNC_FACT_MEMBER_REMD_XDIM');
   CALL PMART.P_DROP_TABLE ('#VT_FUNC_FACT_MEMBER_REMD');
   CALL PMART.P_DROP_TABLE ('#VT_FUNC_FACT_MEMBER_REMD_DOWNLOAD');
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FACT_MEMBER_REMD_HEAD AS( '
          + ' SELECT B.TIME_ID, B.MEMBER_TOTCNT '
		  + ',C.MEMBER_CCNT  '
		  + ',B.ACCU_MEMBER_NEWCNT,A.MEMBER_TRSCNT, '
		  + ' A.MEMBER_TRSCNT*1.0000/C.MEMBER_CCNT*1.0000 AS MEMBER_ACTIVE_RATE '
          + '   FROM PMART.FACT_MEMBER_CNT B '
		  + '   INNER JOIN PMART.FACT_MEMBER_REMD A ON A.TIME_ID = B.TIME_ID AND A.ORG_ID = '+P_ORG_ID
		  + '  INNER JOIN '
		  + '  ( ' 
		  + ' SELECT  '
    	  + ' B.L_DAY_ID AS TIME_ID '
    	  + ' ,COUNT(1) AS MEMBER_CCNT '
    	  + ' FROM PDATA.CRM_MEMBER A  '
    	  + ' INNER JOIN '
    	  + ' ( '
    	  + '	SELECT L_DAY_ID,L_MONTH_START_DAY FROM PMART.YMWD_TIME  '
    	  + '	 WHERE L_DAY_ID = CAST( '+ P_TIME_ID +  ' AS INTEGER) '
    	  + ' ) B  '
    	  + 'ON 1 = 1  '
    	  + 'WHERE KAIIN_STS = 0 '
    	  + 'AND CUSTOMET_KD = ''01''  '
    	  + 'AND CREATE_DATA <= B.L_DAY_ID '
    	  + 'GROUP BY B.L_DAY_ID  '
		  + ') C '
		  + 'ON B.TIME_ID = C.TIME_ID '
          + '  WHERE B.TIME_ID = '+ P_TIME_ID + ' ' 
          + ') WITH DATA PRIMARY INDEX(TIME_ID) ON COMMIT PRESERVE ROWS;';			
EXECUTE IMMEDIATE SQLSTR;   	
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FACT_MEMBER_REMD_1 AS( '
          + ' SELECT A.TIME_ID,A.ORG_ID '
          + '  ,CAST(A.MEMBER_AMTNET  AS DECIMAL(16,4))/DECODE(A.PLAN_STNUM,0,NULL,A.PLAN_STNUM) AS R102 '
          + '  ,CAST(A.MEMBER_CUSTCNT AS DECIMAL(16,4))/DECODE(A.PLAN_STNUM,0,NULL,A.PLAN_STNUM) AS R103 '
          + '  ,R102/DECODE(R103,0,NULL,R103) AS R104 '
          + '  ,CAST(A.MEMBER_EXGCNT AS DECIMAL(16,4))/DECODE(A.MEMBER_ADDCNT,0,NULL,A.MEMBER_ADDCNT)*100 AS R111 '
		  + '  ,CAST(A.MEMBER_AGNCIGAMTNET  AS DECIMAL(16,4))/DECODE(A.PLAN_STNUM,0,NULL,A.PLAN_STNUM) AS R115 '
		  + '  ,CAST(A.MEMBER_AGNCIGCNT  AS DECIMAL(16,4))/DECODE(A.PLAN_STNUM,0,NULL,A.PLAN_STNUM) AS R116 '
		  + '  ,R115/DECODE(R116,0,NULL,R116) AS R117 '
		  + '  ,CAST(A.MEMBER_AGNCIGAMTNET  AS DECIMAL(16,4))/DECODE(A.MEMBER_NAGNCIGAMT,0,NULL,A.MEMBER_NAGNCIGAMT)*100 AS R118 '
		  + '  ,CAST(A.MEMBER_AGNCIGCNT  AS DECIMAL(16,4))/DECODE(A.MEMBER_NAGNCIGCNT,0,NULL,A.MEMBER_NAGNCIGCNT)*100 AS R119 '
          + '  ,CAST(A.ACCU_MEMBER_EXGCNT AS DECIMAL(16,4))/DECODE(A.ACCU_MEMBER_ADDCNT,0,NULL,A.ACCU_MEMBER_ADDCNT) * 100 AS R201 '
          + '  ,CAST(A.ACCU_MEMBER_TRSCNT AS DECIMAL(16,4)) AS R203 '
          + '  ,CAST(A.ACCU_MEMBER_AMTNET     AS DECIMAL(16,4))/DECODE(A.ACCU_PLAN_STNUM,0,NULL,A.ACCU_PLAN_STNUM) AS R205 '
          + '  ,CAST(A.ACCU_MEMBER_CUSTCNT    AS DECIMAL(16,4))/DECODE(A.ACCU_PLAN_STNUM,0,NULL,A.ACCU_PLAN_STNUM) AS R207 '
		  + '  ,CAST(A.ACCU_MEMBER_AGNCIGAMTNET AS DECIMAL(16,4))/DECODE(A.ACCU_PLAN_STNUM,0,NULL,A.ACCU_PLAN_STNUM) AS R217 '
		  + '  ,CAST(A.ACCU_MEMBER_AGNCIGCNT AS DECIMAL(16,4))/DECODE(A.ACCU_PLAN_STNUM,0,NULL,A.ACCU_PLAN_STNUM) AS R219 '
          + '   FROM PMART.FACT_MEMBER_REMD A INNER JOIN PMART.FACT_MEMBER_CNT B'
          + '     ON A.TIME_ID = B.TIME_ID '
          + '  WHERE A.TIME_ID = '+ P_TIME_ID + ' ' 
          + ') WITH DATA PRIMARY  CHARINDEX(ORG_ID,TIME_ID) ON COMMIT PRESERVE ROWS;';
EXECUTE IMMEDIATE SQLSTR;   
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FACT_MEMBER_REMD_2 AS( '
          + ' SELECT A.TIME_ID,A.ORG_ID '
          + '  ,CAST(A.ACCU_MEMBER_TRSCNT     AS DECIMAL(16,4)) AS LR204 '
          + '  ,CAST(A.ACCU_MEMBER_AMTNET     AS DECIMAL(16,4))/DECODE(A.ACCU_PLAN_STNUM,0,NULL,A.ACCU_PLAN_STNUM) AS LR206 '
          + '  ,CAST(A.ACCU_MEMBER_CUSTCNT    AS DECIMAL(16,4))/DECODE(A.ACCU_PLAN_STNUM,0,NULL,A.ACCU_PLAN_STNUM) AS LR208 '
		  + '  ,CAST(A.ACCU_MEMBER_AGNCIGAMTNET    AS DECIMAL(16,4))/DECODE(A.ACCU_PLAN_STNUM,0,NULL,A.ACCU_PLAN_STNUM) AS LR218 '
		  + '  ,CAST(A.ACCU_MEMBER_AGNCIGCNT    AS DECIMAL(16,4))/DECODE(A.ACCU_PLAN_STNUM,0,NULL,A.ACCU_PLAN_STNUM) AS LR220 '
          + '   FROM PMART.FACT_MEMBER_REMD A INNER JOIN PMART.YMWD_TIME C'
          + '     ON A.TIME_ID = C.L_DAY_LAST_DAY_LAST_MONTH '
          + '  WHERE C.L_DAY_ID = '+ P_TIME_ID + ' ' 
          + ') WITH DATA PRIMARY  CHARINDEX(ORG_ID,TIME_ID) ON COMMIT PRESERVE ROWS;';
EXECUTE IMMEDIATE SQLSTR; 
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FACT_MEMBER_REMD_3 AS( '
          + ' SELECT T1.TIME_ID,T1.ORG_ID '
		  + '  ,T1.R102, T1.R103, T1.R104 , T1.R111'
		  + '  ,T1.R115, T1.R116, T1.R117, T1.R118, T1.R119 '
		  + '  ,T1.R201 '
          + '  ,T1.R203, T1.R203/DECODE(T2.LR204,0,NULL,T2.LR204)*100 AS R204 '
          + '  ,T1.R205, T1.R205/DECODE(T2.LR206,0,NULL,T2.LR206)*100 AS R206 '
          + '  ,T1.R207, T1.R207/DECODE(T2.LR208,0,NULL,T2.LR208)*100 AS R208 '
		  + '  ,T1.R217, T1.R217/DECODE(T2.LR218,0,NULL,T2.LR218)*100 AS R218 '
		  + '  ,T1.R219, T1.R219/DECODE(T2.LR220,0,NULL,T2.LR220)*100 AS R220 '
          + '   FROM #VT_FUNC_FACT_MEMBER_REMD_1 T1 LEFT OUTER JOIN #VT_FUNC_FACT_MEMBER_REMD_2 T2 '
          + '     ON T1.ORG_ID = T2.ORG_ID '
          + ') WITH DATA PRIMARY  CHARINDEX(ORG_ID,TIME_ID) ON COMMIT PRESERVE ROWS;';
EXECUTE IMMEDIATE SQLSTR; 
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FACT_MEMBER_REMD_TEMP AS( '
          + ' SELECT 2 AS DATA_TYPE '
          + '  ,T1.* '
          + '   FROM #VT_FUNC_FACT_MEMBER_REMD_3 T1'
          + '  WHERE T1.ORG_ID = '+P_ORG_ID+ ' ' 
          + ' UNION ALL '
          + ' SELECT 4 AS DATA_TYPE '
          + '  ,T2.* '
          + '   FROM #VT_FUNC_FACT_MEMBER_REMD_3 T2'
          + '  WHERE T2.ORG_ID IN ' +ORGSELECT+ ''
          + ') WITH DATA PRIMARY  CHARINDEX(ORG_ID,TIME_ID) ON COMMIT PRESERVE ROWS;';
EXECUTE IMMEDIATE SQLSTR; 
  SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_FUNC_FACT_MEMBER_REMD_XDIM  
                (    
                  X_DIM      VARCHAR(4) Collate Chinese_Taiwan_Stroke_CI_AS
                 ,X_DIM_NAME VARCHAR(200) Collate Chinese_Taiwan_Stroke_CI_AS
                )
                NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';   
  EXECUTE IMMEDIATE SQLSTR; 
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R102' , '會員日商(PSD)' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R103' , '會員日商來客數(PSD)' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R104' , '會員客單價(日商)' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R111' , '會員人數兌累比%' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R115' , '會員排菸日商(PSD)' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R116' , '會員日商排菸來客數(PSD)' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R117' , '會員排菸客單價(日商)' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R118' , '會員排菸營收佔比%' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R119' , '會員排菸來客數佔比%' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R201' , '當月累計兌累比%' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R203' , '當月累計有交易會員數' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R204' , '有交易會員數前月比%' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R205' , '當月會員貢獻日商(PSD)' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R206' , '會員日商貢獻(PSD)前月比%' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R207' , '當月會員日商來客數(PSD)' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R208' , '會員來客數日商來客(PSD)前月比%' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R217' , '當月會員排菸日商(PSD)' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R218' , '會員排菸日商(PSD)前月比%' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R219' , '當月會員排菸來客(PSD)' ;
  INSERT INTO #VT_FUNC_FACT_MEMBER_REMD_XDIM(X_DIM  ,X_DIM_NAME ) SELECT  'R220' , '會員排菸來客(PSD)前月比' ;
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FACT_MEMBER_REMD AS( '
          + ' SELECT A.DATA_TYPE                          ' 
          + ' ,A.ORG_ID   AS Y_DIM                        '
          + ' ,B.X_DIM    AS X_DIM                        '
		  + ' ,(CASE B.X_DIM  '
          + '                 WHEN ''R102'' THEN A.R102 '
          + '                 WHEN ''R103'' THEN A.R103 '
          + '                 WHEN ''R104'' THEN A.R104 '
          + '                 WHEN ''R111'' THEN A.R111 '
		  + '                 WHEN ''R115'' THEN A.R115 '
		  + '                 WHEN ''R116'' THEN A.R116 '
		  + '                 WHEN ''R117'' THEN A.R117 '
		  + '                 WHEN ''R118'' THEN A.R118 '
		  + '                 WHEN ''R119'' THEN A.R119 '
          + '                 WHEN ''R201'' THEN A.R201 '
          + '                 WHEN ''R203'' THEN A.R203 '
          + '                 WHEN ''R204'' THEN A.R204 '
          + '                 WHEN ''R205'' THEN A.R205 '
          + '                 WHEN ''R206'' THEN A.R206 '
          + '                 WHEN ''R207'' THEN A.R207 '
          + '                 WHEN ''R208'' THEN A.R208 '
		  + '                 WHEN ''R217'' THEN A.R217 '
		  + '                 WHEN ''R218'' THEN A.R218 '
		  + '                 WHEN ''R219'' THEN A.R219 '
		  + '                 WHEN ''R220'' THEN A.R220 '
          + ' ELSE NULL END)   AS FIELD_DATA                '
          + ' FROM #VT_FUNC_FACT_MEMBER_REMD_TEMP A INNER JOIN #VT_FUNC_FACT_MEMBER_REMD_XDIM B ' 
          + '   ON 1 = 1 '
          + ') WITH DATA PRIMARY INDEX(X_DIM) ON COMMIT PRESERVE ROWS;';
EXECUTE IMMEDIATE SQLSTR;  
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FUNC_FACT_MEMBER_REMD_DOWNLOAD AS( '
          + ' SELECT T2.DEPT_NO,T2.DEPT_NM,T2.BRANCH_NO,T2.BRANCH_NM,T2.RESPON_NO,T2.RESPON_NM,T2.STORE_NO,T2.STORE_NM,T1.TIME_ID '
		  + '  ,T1.R102,T1.R103,T1.R104 '
		  + '  ,T1.R111/100 AS R111 '
		  + '  ,T1.R115,T1.R116,T1.R117 '
		  + '  ,T1.R118/100 AS R118,T1.R119/100 AS R119 '
		  + '  ,T1.R201/100 AS R201 '
          + '  ,T1.R203,T1.R204/100 AS R204,T1.R205,T1.R206/100 AS R206 '
		  + '  ,T1.R207,T1.R208/100 AS R208 '
		  + '  ,T1.R217,T1.R218/100 AS R218 '
		  + '  ,T1.R219,T1.R220/100 AS R220 '
		  + '  ,T2.PDEPT_NO,T2.PDEPT_NM '
          + '   FROM #VT_FUNC_FACT_MEMBER_REMD_3 T1 LEFT OUTER JOIN PMART.LAST_ORG_DIM T2 '
          + '     ON T1.ORG_ID = T2.OSTORE_ID '
          + '  WHERE T1.ORG_ID IN ' +ORGSELECT_DL+ ''
          + ') WITH DATA PRIMARY INDEX(TIME_ID) ON COMMIT PRESERVE ROWS;';
EXECUTE IMMEDIATE SQLSTR; 
END SP;