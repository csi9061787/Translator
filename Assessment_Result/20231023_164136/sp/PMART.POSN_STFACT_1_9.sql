REPLACE PROCEDURE PMART.POSN_STFACT_1_9
(
FP_TIME_TYPE CHAR,         
FP_TIME_LIST VARCHAR(400), 
FP_PRD_LEVEL VARCHAR(400), 
FP_PRD_ID    VARCHAR(400), 
FP_PRD_SQL   NUMBER,       
FP_ORG_LEVEL NUMBER,       
FP_ORG_LIST  VARCHAR(400), 
FP_MMA_TYPE  NUMBER,       
FP_MMA_RANGE NUMBER,       
FP_MMA_LIST  VARCHAR(400), 
FP_PRD_TYPE  NUMBER        
)            
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR            VARCHAR(4000);
   DECLARE V_TABLE_NAME2     VARCHAR(100);  
   DECLARE V_LATEST_SHOPDIST VARCHAR(2000);
   DECLARE V_ORG_NAME        VARCHAR(200);  
   CALL PMART.P_DROP_TABLE ('#VT_POSN_STFACT_1_9'); 
   CALL PMART.POSN_STFACT_1_FUNC(FP_TIME_TYPE,FP_TIME_LIST,FP_PRD_LEVEL,FP_PRD_ID,FP_PRD_SQL,FP_ORG_LEVEL,FP_ORG_LIST,-1,'-1',FP_PRD_TYPE);
   SET V_LATEST_SHOPDIST = 'SELECT DISTINCT O.OSTORE_ID AS ORG_ID,O.OSTORE_ID AS OSTORE_ID,O.BRANCH_ID,O.DEPT_ID,O.TOT_ID FROM PMART.LAST_SHOPDIST L, PMART.LATEST_ORG_DIM O WHERE L.OSTORE_NO = O.OSTORE_ID ';
   IF FP_ORG_LEVEL = 0 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.TOT_ID IN ('+FP_ORG_LIST+')'; END IF;
   IF FP_ORG_LEVEL = 1 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.DEPT_ID IN ('+FP_ORG_LIST+')'; END IF;
   IF FP_ORG_LEVEL = 2 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.BRANCH_ID IN ('+FP_ORG_LIST+')'; END IF;
   IF FP_ORG_LEVEL = 3 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.STORE_ID IN ('+FP_ORG_LIST+')'; END IF;
   IF FP_MMA_TYPE = 1 THEN
      IF FP_MMA_RANGE = 1 THEN
         SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND L.LOCAL0 IN ('''+FP_MMA_LIST+''') ';
      ELSE
         SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND ( L.LOCAL0 IN ('''+FP_MMA_LIST+''') '+
                                 ' OR L.SEC_1_LOCAL IN ('''+FP_MMA_LIST+''') OR L.SEC_2_LOCAL IN ('''+FP_MMA_LIST+''') )';
      END IF;
   END IF;
   IF FP_MMA_TYPE = 2 THEN
      IF FP_MMA_RANGE = 1 THEN
         SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND ( L.LOCAL1 IN ('''+FP_MMA_LIST+''') '+
                                 ' OR L.LOCAL2 IN ('''+FP_MMA_LIST+''') )';
   ELSE
         SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND ( L.LOCAL1 IN ('''+FP_MMA_LIST+''') '+
                                 ' OR L.LOCAL2 IN ('''+FP_MMA_LIST+''') OR L.SEC_LOCAL1 IN ('''+FP_MMA_LIST+''') OR L.SEC_LOCAL2 IN ('''+FP_MMA_LIST+''') )';
      END IF;
   END IF;
   IF FP_MMA_TYPE = 3 THEN
      SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND L.LOCAL0 IN ('''+FP_MMA_LIST+''') AND L.SEC_1_LOCAL IS NULL AND L.SEC_2_LOCAL IS NULL ';
   END IF;
   SET V_TABLE_NAME2='PMART.BASIC_MAST_FACT ';
   CASE
      WHEN FP_ORG_LEVEL=0 THEN
           SET V_ORG_NAME = 'L.TOT_ID';
      WHEN FP_ORG_LEVEL=1 THEN
           SET V_ORG_NAME = 'L.DEPT_ID';
      WHEN FP_ORG_LEVEL=2 THEN
           SET V_ORG_NAME = 'L.BRANCH_ID';
      WHEN FP_ORG_LEVEL=3 THEN 
           SET V_ORG_NAME = 'L.OSTORE_ID';
      ELSE 
           SET V_ORG_NAME = '0';
   END CASE;
SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_POSN_STFACT_1_9  AS('+
      'SELECT    '+
      'B.TIME_ID AS TIME_ID,    '+
      'Y.ORG_ID AS ORG_ID, '+
      'B.PRD_ID AS PRD_ID,   '+
      '0 AS MMA_ID, '+
      '0 AS MAST_STORE_NUM,   '+  
      '0 AS STNUM_STORE_NUM,  '+  
      'BIT_EXTRACT(BIT_AND(B.SALES_STORE_NUM,Y.MASK)) AS SALES_STORE_NUM,  '+  
      'BIT_EXTRACT(BIT_AND(B.ORDER_STORE_NUM,Y.MASK)) AS ORDER_STORE_NUM,  '+  
      'BIT_EXTRACT(BIT_AND(B.THROW_STORE_NUM,Y.MASK)) AS THROW_STORE_NUM,  '+  
      'BIT_EXTRACT(BIT_AND(B.INPRD_STORE_NUM,Y.MASK)) AS INPRD_STORE_NUM,  '+  
      'BIT_EXTRACT(BIT_AND(B.RETPRD_STORE_NUM,Y.MASK)) AS RETPRD_STORE_NUM,  '+  
      'BIT_EXTRACT(BIT_AND(B.TRANSPRD_STORE_NUM,Y.MASK)) AS TRANSPRD_STORE_NUM,  '+  
      'BIT_EXTRACT(BIT_AND(B.TRANSPRD_IN_STORE_NUM,Y.MASK)) AS TRANSPRD_IN_STORE_NUM,  '+  
      'BIT_EXTRACT(BIT_AND(B.Y_ORDER_STORE_NUM,Y.MASK)) AS Y_ORDER_STORE_NUM, '+  
      'BIT_EXTRACT(BIT_AND(B.SALES_STORE_NUM,Y.MASK)) AS SALES_STNUM,  '+  
      'BIT_EXTRACT(BIT_AND(B.ORDER_STORE_NUM,Y.MASK)) AS ORDER_STNUM,  '+  
      'BIT_EXTRACT(BIT_AND(B.THROW_STORE_NUM,Y.MASK)) AS THROW_STNUM,  '+  
      'BIT_EXTRACT(BIT_AND(B.INPRD_STORE_NUM,Y.MASK)) AS INPRD_STNUM,  '+  
      'BIT_EXTRACT(BIT_AND(B.RETPRD_STORE_NUM,Y.MASK)) AS RETPRD_STNUM,  '+  
      'BIT_EXTRACT(BIT_AND(B.TRANSPRD_STORE_NUM,Y.MASK)) AS TRANSPRD_STNUM,  '+ 
      'BIT_EXTRACT(BIT_AND(B.TRANSPRD_IN_STORE_NUM,Y.MASK)) AS TRANSPRD_IN_STNUM,  '+  
      'BIT_EXTRACT(BIT_AND(B.Y_ORDER_STORE_NUM,Y.MASK)) AS Y_ORDER_STNUM  '+  
      ' FROM'+
      '( '+
      'SELECT '+
      'B.TIME_ID AS TIME_ID,  '+
      'B.PRD_ID AS PRD_ID,  '+
      '0 AS MMA_ID, '+
      'B.SALES_STORE_NUM AS SALES_STORE_NUM,  '+
      'B.ORDER_STORE_NUM AS ORDER_STORE_NUM,  '+
      'B.THROW_STORE_NUM AS THROW_STORE_NUM,  '+
      'B.INPRD_STORE_NUM AS INPRD_STORE_NUM,  '+
      'B.RETPRD_STORE_NUM AS RETPRD_STORE_NUM,  '+
      'B.TRANSPRD_STORE_NUM AS TRANSPRD_STORE_NUM,  '+
      'B.TRANSPRD_IN_STORE_NUM AS TRANSPRD_IN_STORE_NUM,  '+
      'B.Y_ORDER_STORE_NUM AS Y_ORDER_STORE_NUM,   '+
      'BIT_EXTRACT(BIT_AND(B.SALES_STORE_NUM,A.STNUM_STORE_NUM)) AS SALES_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.ORDER_STORE_NUM,A.STNUM_STORE_NUM)) AS ORDER_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.THROW_STORE_NUM,A.STNUM_STORE_NUM)) AS THROW_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.INPRD_STORE_NUM,A.STNUM_STORE_NUM)) AS INPRD_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.RETPRD_STORE_NUM,A.STNUM_STORE_NUM)) AS RETPRD_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.TRANSPRD_STORE_NUM,A.STNUM_STORE_NUM)) AS TRANSPRD_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.TRANSPRD_IN_STORE_NUM,A.STNUM_STORE_NUM)) AS TRANSPRD_IN_STNUM,  '+
      'BIT_EXTRACT(BIT_AND(B.Y_ORDER_STORE_NUM,A.STNUM_STORE_NUM)) AS Y_ORDER_STNUM  '+
      ' FROM  '+
      ' #VT_POSN_STFACT_1_FUNC B '+
      ', '+ V_TABLE_NAME2 +' A '+
      ' WHERE A.TIME_ID = B.TIME_ID '+
      ') B, '+
      ' ( SELECT '+V_ORG_NAME +' AS ORG_ID,BIT_GEN_AGGT(M.OSTORE_BIT_SEQ) AS MASK FROM ('+ V_LATEST_SHOPDIST +') L, PMART.ORG_BIT_MAPPING M '+
      '   WHERE L.ORG_ID = M.OSTORE_ID GROUP BY '+V_ORG_NAME +' '+
      ' ) Y '+
      ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';    
  EXECUTE IMMEDIATE SQLSTR;
END SP;