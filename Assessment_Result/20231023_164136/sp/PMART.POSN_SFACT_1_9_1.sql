REPLACE PROCEDURE PMART.POSN_SFACT_1_9_1
(
FP_TIME_TYPE CHAR,         
FP_TIME_LIST VARCHAR(400), 
FP_ORG_LEVEL NUMBER,       
FP_ORG_LIST  VARCHAR(400), 
FP_MMA_TYPE  NUMBER,       
FP_MMA_RANGE NUMBER,       
FP_MMA_LIST  VARCHAR(400)  
)            
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR        VARCHAR(4000);
   DECLARE V_MAST_SQL    VARCHAR(2000);
   DECLARE V_REMD_SQL    VARCHAR(2000); 
   DECLARE V_LATEST_SHOPDIST VARCHAR(2000);
   DECLARE V_ORG_NAME    VARCHAR(200);
   CALL PMART.P_DROP_TABLE ('#VT_POSN_SFACT_1_9_1'); 
   SET V_REMD_SQL = ' ';
   SET V_MAST_SQL = ' ';
   SET V_LATEST_SHOPDIST = 'SELECT DISTINCT O.OSTORE_ID AS ORG_ID,O.OSTORE_ID AS OSTORE_ID,O.BRANCH_ID,O.DEPT_ID,O.PDEPT_ID,O.TOT_ID FROM PMART.LAST_SHOPDIST L, PMART.LATEST_ORG_DIM O WHERE L.OSTORE_NO = O.OSTORE_ID ';
   IF FP_ORG_LEVEL = -1 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.TOT_ID IN ('+FP_ORG_LIST+')'; END IF;
   IF FP_ORG_LEVEL = 0 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.PDEPT_ID IN ('+FP_ORG_LIST+')'; END IF;
   IF FP_ORG_LEVEL = 1 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.DEPT_ID IN ('+FP_ORG_LIST+')'; END IF;
   IF FP_ORG_LEVEL = 2 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.BRANCH_ID IN ('+FP_ORG_LIST+')'; END IF;
   IF FP_ORG_LEVEL = 3 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.STORE_ID IN ('+FP_ORG_LIST+')'; END IF;
   IF FP_MMA_TYPE = 1 THEN
      IF FP_MMA_RANGE = 1 THEN
         SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND L.LOCAL0 IN ('''+FP_MMA_LIST+''') ';
      ELSE
         SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND ( L.LOCAL0 IN ('''+FP_MMA_LIST+''') '+
                                 ' OR L.SEC_1_LOCAL IN ('''+FP_MMA_LIST+''') OR L.SEC_2_LOCAL IN ('''+FP_MMA_LIST+''') )';
      END IF;
   END IF;
   IF FP_MMA_TYPE = 2 THEN
      IF FP_MMA_RANGE = 1 THEN
         SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND ( L.LOCAL1 IN ('''+FP_MMA_LIST+''') '+
                                 ' OR L.LOCAL2 IN ('''+FP_MMA_LIST+''') )';
   ELSE
       SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND ( L.LOCAL1 IN ('''+FP_MMA_LIST+''') '+
                               ' OR L.LOCAL2 IN ('''+FP_MMA_LIST+''') OR L.SEC_LOCAL1 IN ('''+FP_MMA_LIST+''') OR L.SEC_LOCAL2 IN ('''+FP_MMA_LIST+''') )';
      END IF;
   END IF;
   IF FP_MMA_TYPE = 3 THEN
      SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND L.LOCAL0 IN ('''+FP_MMA_LIST+''') AND L.SEC_1_LOCAL IS NULL AND L.SEC_2_LOCAL IS NULL ';
   END IF;
   CASE
      WHEN FP_ORG_LEVEL=-1 THEN
           SET V_ORG_NAME = 'L.TOT_ID';
      WHEN FP_ORG_LEVEL=0 THEN
           SET V_ORG_NAME = 'L.PDEPT_ID';
      WHEN FP_ORG_LEVEL=1 THEN
           SET V_ORG_NAME = 'L.DEPT_ID';
      WHEN FP_ORG_LEVEL=2 THEN
           SET V_ORG_NAME = 'L.BRANCH_ID';
      WHEN FP_ORG_LEVEL=3 THEN
           SET V_ORG_NAME = 'L.OSTORE_ID';
      ELSE 
           SET V_ORG_NAME = '0';
   END CASE;
   IF FP_TIME_TYPE = 'D' THEN
      SET V_REMD_SQL =' SELECT B.L_DAY_ID AS TIME_ID,'+V_ORG_NAME +' AS ORG_ID ,SUM(B.UPLOAD_STNUM) AS STNUM_STORE_NUM '+ 
                      ' FROM PMART.REMD_FACT B, ('+ V_LATEST_SHOPDIST +') L '+
                      ' WHERE B.L_DAY_ID IN (  '+ FP_TIME_LIST +') ' +
                      ' AND B.OSTORE_ID = L.ORG_ID '+
                      ' GROUP BY B.L_DAY_ID,'+V_ORG_NAME +' ';
   END IF;
   IF FP_TIME_TYPE = 'W' THEN
      SET V_REMD_SQL =' SELECT Y.L_WEEK_ID AS TIME_ID,'+V_ORG_NAME +' AS ORG_ID ,SUM(B.UPLOAD_STNUM) AS STNUM_STORE_NUM '+ 
                      ' FROM PMART.REMD_FACT B,PMART.YMWD_TIME_W2 Y, ('+ V_LATEST_SHOPDIST +') L '+
                      ' WHERE B.L_DAY_ID = Y.L_DAY_ID AND Y.L_WEEK_ID IN (  '+ FP_TIME_LIST +') ' +
                      ' AND B.L_DAY_ID <> TO_CHAR(CURRENT_DATE,''YYYYMMDD'') '+
                      ' AND B.OSTORE_ID = L.ORG_ID '+
                      ' GROUP BY Y.L_WEEK_ID,'+V_ORG_NAME +' ';
   END IF;
   IF FP_TIME_TYPE = 'M' THEN
      SET V_REMD_SQL =' SELECT Y.L_MONTH_ID AS TIME_ID,'+V_ORG_NAME +' AS ORG_ID ,SUM(B.UPLOAD_STNUM) AS STNUM_STORE_NUM '+ 
                      ' FROM PMART.REMD_FACT B,PMART.YMWD_TIME_W2 Y, ('+ V_LATEST_SHOPDIST +') L '+
                      ' WHERE B.L_DAY_ID = Y.L_DAY_ID AND Y.L_MONTH_ID IN (  '+ FP_TIME_LIST +') ' +
                      ' AND B.L_DAY_ID <> TO_CHAR(CURRENT_DATE,''YYYYMMDD'') '+
                      ' AND B.OSTORE_ID = L.ORG_ID '+
                      ' GROUP BY Y.L_MONTH_ID,'+V_ORG_NAME +' ';
   END IF;
   SET V_MAST_SQL =' SELECT A.TIME_ID AS TIME_ID, '+
                   ' Y.ORG_ID AS ORG_ID, '+
                   ' BIT_EXTRACT(BIT_AND(A.MAST_STORE_NUM,Y.MASK)) AS MAST_STORE_NUM '+  
                   ' FROM PMART.BASIC_MAST_FACT A , '+
                   ' ( SELECT '+V_ORG_NAME +' AS ORG_ID,BIT_GEN_AGGT(M.OSTORE_BIT_SEQ) AS MASK FROM ('+ V_LATEST_SHOPDIST +') L, PMART.ORG_BIT_MAPPING M '+
                   '   WHERE L.ORG_ID = M.OSTORE_ID GROUP BY '+V_ORG_NAME +' '+
                   ' ) Y WHERE A.TIME_ID IN (  '+ FP_TIME_LIST +'  )';
   SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_POSN_SFACT_1_9_1  AS('+
      'SELECT '+
      'A.TIME_ID AS TIME_ID,    '+
      'A.ORG_ID AS ORG_ID,    '+
      '0 AS MMA_ID, '+
      'A.MAST_STORE_NUM,   '+
      'B.STNUM_STORE_NUM  '+
      'FROM '+
      '('+ V_MAST_SQL +') A, ('+V_REMD_SQL+') B  '+
      ' WHERE '+
      ' A.TIME_ID = B.TIME_ID AND A.ORG_ID = B.ORG_ID '+
      ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;';    
  EXECUTE IMMEDIATE SQLSTR;
END SP;