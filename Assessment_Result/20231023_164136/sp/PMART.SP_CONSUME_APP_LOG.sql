REPLACE PROCEDURE PMART.SP_CONSUME_APP_LOG(V_BATCH_NO VARCHAR(20))
SP:BEGIN
	DECLARE V_MAX_ID INTEGER;
	DECLARE P_BATCH_NO VARCHAR(20);
	SET V_MAX_ID = (SELECT CAST(NVL(MAX(ID),'0') AS INTEGER) FROM CONSUME_APP_LOG );
	SET P_BATCH_NO = V_BATCH_NO;
	DELETE FROM CONSUME_APP_LOG
    WHERE BATCH_NO=P_BATCH_NO;
	INSERT INTO PMART.CONSUME_APP_LOG
    (ID, MEMCODE, F_ID, AMOUNT, ROWS_CNT, INV_PERIOD, INV_NUM, PAY_AT, UPDATED_AT, BAN, POINT, IS_RETURN, CARRIER, STORE_NAME, BATCH_NO, CREATE_DT)
	SELECT   CAST(ROW_NUMBER() OVER (ORDER BY A.TM_TXNNO  DESC) AS INTEGER)+V_MAX_ID,
	 A.MEMCODE,
	 A.STORE_NO+A.TM_NO+CAST((A.PAY_AT (FORMAT 'YYYYMMDDHHMISS')) AS VARCHAR(50))+A.TM_TXNNO AS F_ID,
     CAST(AM_TAX+AM_FTAX  AS VARCHAR(10))AS AMOUNT,
     CAST(ROWS_CNT AS VARCHAR(5))
   ,INV_PERIOD,INV_NUM, CAST( CAST(CAST(CAST(PAY_AT  AS DATE)- CAST('1970-01-01 ' AS DATE)  AS INTEGER) *24*3600+ 
(EXTRACT(HOUR FROM PAY_AT) - 8)*3600 + EXTRACT(MINUTE FROM PAY_AT)*60 + EXTRACT(SECOND FROM PAY_AT) AS INTEGER )  AS VARCHAR(50) )AS PAY_AT
   ,CAST( CAST(CAST(CAST(CURRENT_DATE  AS DATE)- CAST('1970-01-01 ' AS DATE)  AS INTEGER) *24*3600+ 
(EXTRACT(HOUR FROM CURRENT_TIME) - 8)*3600 + EXTRACT(MINUTE FROM CURRENT_TIME)*60 + EXTRACT(SECOND FROM CURRENT_TIME) AS INTEGER )  AS VARCHAR(50) )AS UPDATED_AT
,STBS_NO AS BAN
   ,(SELECT SUM(TXN_POINT ) FROM PDATA.TRANS_POINT_APP WHERE BATCH_NO=A.BATCH_NO AND TM_TXNNO=A.TM_TXNNO AND PROC_CODE IN ('2S02','2S03')) AS POINT
   ,(CASE WHEN A.IS_RETURN='Z0' THEN '0' ELSE '1' END) AS IS_RETURN
   ,CARRIER
   ,O.STORE_NAME AS STORENAME
   ,V_BATCH_NO
   ,(CURRENT_TIMESTAMP(0)   (FORMAT 'YYYYMMDDHHMISS') )
FROM 
(
SELECT MEMCODE, STORE_NO,TM_NO,B.TM_TXNNO,INV_PERIOD,INV_NUM,PAY_AT,IS_RETURN,CARRIER,RTNECR_NO,ORG_TXNNO,AM_TOT,AM_TAX,AM_FTAX,
AM_ARG,AM_KSAL,AM_KPAY,AM_XVOICETX,AM_XVOICENX,AM_REINVO,AM_ACC76,AM_ACC78,B.BATCH_NO,ROWS_CNT
FROM PDATA.TRANS_APP B 
LEFT JOIN 
(
SELECT TM_TXNNO, BATCH_NO,COUNT(TM_TXNNO)  AS ROWS_CNT FROM PDATA.TRANS_DETAIL_APP 
GROUP BY TM_TXNNO,BATCH_NO
)A 
ON B.BATCH_NO=A.BATCH_NO 
AND B.TM_TXNNO=A.TM_TXNNO
)AS A
LEFT JOIN PDATA.PBMSTOL O
ON O.STORE_NO = A.STORE_NO
WHERE A.BATCH_NO=CAST(P_BATCH_NO AS TIMESTAMP FORMAT 'YYYYMMDDHHMISS');
END;