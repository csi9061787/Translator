REPLACE PROCEDURE PMART.B2BIGA_1_5_FUNC
(
	IN P_A_ID VARCHAR(40),
	IN P_CPC_ID VARCHAR(30) CHARACTER SET UNICODE CASESPECIFIC,
	IN P_TIME_TYPE VARCHAR(1),
	IN P_TIME_START VARCHAR(10),
	IN P_TIME_END VARCHAR(10),
	IN P_PRD_TYPE VARCHAR(1),
	IN P_PRD_LIST VARCHAR(2000)
)
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR VARCHAR(20000) Collate Chinese_Taiwan_Stroke_CI_AS;
   DECLARE V_TABLE_NAME VARCHAR(30);
   DECLARE V_PRD_ID_STR VARCHAR(2000) Collate Chinese_Taiwan_Stroke_CI_AS; 
   DECLARE V_TIME_STR VARCHAR(400); 
	CALL PMART.P_DROP_TABLE ('#VT_B2BIGA_1_5_FUNC'); 
	IF P_TIME_TYPE='M' THEN
		SET V_TABLE_NAME = ' PMART.A_MONTH ';
		SET V_TIME_STR = ' A.SDATE IN ( SELECT CAST(CAST(L_MONTH_START_DAY AS VARCHAR(8)) AS DATE FORMAT ''YYYYMMDD'') FROM PMART.YMWD_TIME WHERE L_MONTH_ID = '+ P_TIME_START +' ) ';
	ELSEIF P_TIME_TYPE='W' THEN
		SET V_TABLE_NAME = ' PMART.A_WEEK ';
		SET V_TIME_STR = ' A.SDATE IN ( SELECT CAST(CAST(L_WEEK_START_DAY AS VARCHAR(8)) AS DATE FORMAT ''YYYYMMDD'') FROM PMART.YMWD_TIME WHERE L_DAY_ID = '+ P_TIME_START +' ) ';
	ELSEIF P_TIME_TYPE='D' THEN
		SET V_TABLE_NAME = ' PMART.A_DAY ';
		SET V_TIME_STR = ' A.SDATE BETWEEN CAST(CAST('+ P_TIME_START +' AS VARCHAR(8)) AS DATE FORMAT ''YYYYMMDD'') AND CAST(CAST('+ P_TIME_END +' AS VARCHAR(8)) AS DATE FORMAT ''YYYYMMDD'') ';
	END IF;
	IF P_PRD_TYPE = '0' THEN
		SET V_PRD_ID_STR = ' A.CMNO IN (SELECT CMNO FROM PDATA.CPC_PROD WHERE A_ID = '''+ P_A_ID +''' AND CPC_ID = '''+ P_CPC_ID +''') ';
	ELSE
		SET V_PRD_ID_STR = ' A.CMNO IN ('+ PMART.CONVERT_STRING_LIST(P_PRD_LIST) +') ';
	END IF;
   SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_B2BIGA_1_5_FUNC  AS( '
        + ' SELECT B.CMNO AS CMNO, '
		+ ' C.FM_NAME AS CMNM, '
		+ ' B.AREA, '
		+ ' B.COUNT1 AS COUNT1 '
		+ ' FROM ( '
		+ ' SELECT A.CMNO, A.AREA, SUM(COUNT1) AS COUNT1 '
		+ ' FROM '+ V_TABLE_NAME +' A '
		+ ' WHERE '+ V_TIME_STR +' ' 
		+ ' AND '+ V_PRD_ID_STR +' '
		+ ' GROUP BY A.CMNO, A.AREA) B, '
		+ ' PDATA.PBMCMDT C '
		+ ' WHERE B.CMNO = C.FM_CODE ' 
		+ ' ) WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;' ;     
	EXECUTE IMMEDIATE SQLSTR;
END SP;