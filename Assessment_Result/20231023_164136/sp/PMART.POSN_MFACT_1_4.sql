REPLACE PROCEDURE PMART.POSN_MFACT_1_4
(
P_TIME_TYPE VARCHAR(400), 
P_TIME_LIST VARCHAR(400), 
P_PRD_LEVEL VARCHAR(400), 
P_PRD_ID    VARCHAR(1000), 
P_PRD_SQL   NUMBER, 
P_ORG_LEVEL NUMBER, 
P_ORG_LIST  VARCHAR(400), 
P_MMA_LEVEL NUMBER, 
P_MMA_ID    VARCHAR(400), 
P_PRD_TYPE  NUMBER, 
P_AMT_TYPE  VARCHAR(400) 
)
SQL SECURITY INVOKER
SP:BEGIN
   DECLARE SQLSTR VARCHAR(4000);
   DECLARE BASE_AMTUNIT  NUMBER; 
   DECLARE V_SQL_DATA VARCHAR(4000); 
   DECLARE V_TIME_SQL VARCHAR(4000); 
   DECLARE V_TABLE_NAME VARCHAR(4000); 
   DECLARE V_PRD_IN VARCHAR(4000);
   DECLARE V_GRP_ID VARCHAR(4000);
   DECLARE V_LATEST_SHOPDIST VARCHAR(4000);
   CALL PMART.P_DROP_TABLE('#VT_POSN_MFACT_1_4');
   SET V_TIME_SQL = ' ';
   SET V_LATEST_SHOPDIST = 'SELECT DISTINCT OSTORE_NO AS ORG_ID, '+
                           'CASE '+
                           'WHEN LOCAL0=''A'' THEN 10000001 '+
                           'WHEN LOCAL0=''B'' THEN 10000002 '+
                           'WHEN LOCAL0=''C'' THEN 10000003 '+
                           'WHEN LOCAL0=''D'' THEN 10000004 '+
                           'WHEN LOCAL0=''E'' THEN 10000005 '+
                           'WHEN LOCAL0=''F'' THEN 10000006 '+
                           'WHEN LOCAL0=''G'' THEN 10000007 '+
                           'WHEN LOCAL0=''H'' THEN 10000008 '+
                           'WHEN LOCAL0=''I'' THEN 10000009 '+
                           'WHEN LOCAL0=''J'' THEN 10000010 '+
                           'END AS MMA_ID, '+
                           'CASE '+
                           'WHEN SEC_1_LOCAL=''A'' THEN 10000001 '+
                           'WHEN SEC_1_LOCAL=''B'' THEN 10000002 '+
                           'WHEN SEC_1_LOCAL=''C'' THEN 10000003 '+
                           'WHEN SEC_1_LOCAL=''D'' THEN 10000004 '+
                           'WHEN SEC_1_LOCAL=''E'' THEN 10000005 '+
                           'WHEN SEC_1_LOCAL=''F'' THEN 10000006 '+
                           'WHEN SEC_1_LOCAL=''G'' THEN 10000007 '+
                           'WHEN SEC_1_LOCAL=''H'' THEN 10000008 '+
                           'WHEN SEC_1_LOCAL=''I'' THEN 10000009 '+
                           'WHEN SEC_1_LOCAL=''J'' THEN 10000010 '+
                           'ELSE 0 '+
                           'END AS SUB_MMA_ID '+
                           ' FROM PMART.LAST_SHOPDIST L, PMART.LATEST_ORG_DIM O WHERE L.OSTORE_NO = O.OSTORE_ID ';
   IF P_ORG_LEVEL = 0 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.TOT_ID = '+P_ORG_LIST; END IF;
   IF P_ORG_LEVEL = 1 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.DEPT_ID = '+P_ORG_LIST; END IF;
   IF P_ORG_LEVEL = 2 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.BRANCH_ID = '+P_ORG_LIST; END IF;
   IF P_ORG_LEVEL = 3 THEN SET V_LATEST_SHOPDIST = V_LATEST_SHOPDIST + ' AND O.STORE_ID = '+P_ORG_LIST; END IF;
   IF P_AMT_TYPE = 'T' THEN SET BASE_AMTUNIT = 1000;  ELSE SET BASE_AMTUNIT = 1;  END IF;
   IF P_TIME_TYPE = 'W' THEN
        SET V_TIME_SQL ='SELECT L_DAY_ID,L_WEEK_ID AS P_TIME_ID FROM PMART.YMWD_TIME_W2';
   END IF;
   IF P_TIME_TYPE = 'M' THEN
        SET V_TIME_SQL ='SELECT L_DAY_ID,L_MONTH_ID AS P_TIME_ID FROM PMART.YMWD_TIME_W2 ';
   END IF;
      IF  P_PRD_LEVEL='PRD' 
      THEN
          SET V_TABLE_NAME = 'PMART.BASIC_MFACT_DETAIL';
      ELSE
          SET V_TABLE_NAME = 'PMART.BASIC_MFACT';
      END IF;
   SET V_SQL_DATA =
	   'SUM(SALES_CNT) AS SALES_CNT, '+
	   'SUM(CAST(SALES_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS SALES_AMT, '+
	   'SUM(ORDER_CNT) AS ORDER_CNT, '+
	   'SUM(CAST(ORDER_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS ORDER_AMT, '+
	   'SUM(THROW_CNT) AS THROW_CNT, '+
	   'SUM(CAST(THROW_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS THROW_AMT, '+
	   'SUM(INPRD_CNT) AS INPRD_CNT, '+
	   'SUM(CAST(INPRD_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS INPRD_AMT, '+
	   'SUM(RETPRD_CNT) AS RETPRD_CNT, '+
	   'SUM(CAST(RETPRD_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS RETPRD_AMT, '+
	   'SUM(TRANSPRD_CNT) AS TRANSPRD_CNT, '+
	   'SUM(CAST(TRANSPRD_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS TRANSPRD_AMT, '+
	   'SUM(CAST(DIS_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS DIS_AMT, '+
	   'SUM(CAST(SUB_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS SUB_AMT, '+
	   'SUM(CAST(SALES_UNTAX_COST AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS SALES_UNTAX_COST, '+
	   'SUM(CAST(SALES_UNTAX_REAL_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS SALES_UNTAX_REAL_AMT, '+
	   'SUM(ORDER_SALES_CNT) AS ORDER_SALES_CNT, '+
	   'SUM(CAST(ORDER_SALES_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS ORDER_SALES_AMT, '+
	   'SUM(INPRD_SALES_CNT) AS INPRD_SALES_CNT, '+
	   'SUM(CAST(INPRD_SALES_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS INPRD_SALES_AMT, '+
	   'SUM(Y_ORDER_SALES_CNT) AS Y_ORDER_SALES_CNT, '+
	   'SUM(CAST(Y_ORDER_SALES_AMT AS DECIMAL(20,6)))/'+BASE_AMTUNIT+' AS Y_ORDER_SALES_AMT, '+
	   '(SUM(CAST(SALES_AMT AS DECIMAL(20,6)))-SUM(CAST(DIS_AMT AS DECIMAL(20,6)))-SUM(CAST(SUB_AMT AS DECIMAL(20,6))))/'+BASE_AMTUNIT+' AS REAL_SALES_AMT ';
   SET V_PRD_IN = P_PRD_ID ;
   IF (P_TIME_TYPE = 'W' OR P_TIME_TYPE = 'M' ) THEN 
	SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_POSN_MFACT_1_4  AS('+
		    ' SELECT  '+
		    ' TT.P_TIME_ID AS TIME_ID, '+
		    ' 0 AS ORG_ID, '+
		    ' 0 AS PRD_ID, '+
		    ' L.SUB_MMA_ID AS MMA_ID, '+
		    ' '+V_SQL_DATA+' '+
		    ' FROM '+ V_TABLE_NAME +' T ,('+ V_TIME_SQL +') TT,('+ V_LATEST_SHOPDIST +') L '+
		    ' WHERE TT.P_TIME_ID IN ('+ P_TIME_LIST +') '+
		    ' AND T.TIME_ID = TT.L_DAY_ID '+
		    ' AND T.ORG_ID =  L.ORG_ID '+
		    ' AND L.MMA_ID = '+ P_MMA_ID +' '+
		    ' AND T.PRD_ID IN ('+ V_PRD_IN +') '+
		    ' AND T.TIME_ID <> TO_CHAR(CURRENT_DATE,''YYYYMMDD'') '+
		    ' GROUP BY TT.P_TIME_ID,L.SUB_MMA_ID'+
		    ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;'; 
   ELSE
	SET SQLSTR ='CREATE MULTISET VOLATILE TABLE #VT_POSN_MFACT_1_4  AS('+
		    ' SELECT  '+
		    ' T.TIME_ID AS TIME_ID, '+
		    ' 0 AS ORG_ID, '+
		    ' 0 AS PRD_ID, '+
		    ' L.SUB_MMA_ID AS MMA_ID, ' +
		    ' '+V_SQL_DATA+' '+
		    ' FROM '+ V_TABLE_NAME +' T , ('+ V_LATEST_SHOPDIST +') L '+
		    ' WHERE '+
		    ' T.TIME_ID IN ('+ P_TIME_LIST +') '+
		    ' AND T.PRD_ID IN ('+ V_PRD_IN +') '+
		    ' AND T.ORG_ID = L.ORG_ID '+
		    ' AND L.MMA_ID = '+ P_MMA_ID +' '+
		    ' GROUP BY T.TIME_ID,L.SUB_MMA_ID'+
		    ') WITH DATA NO PRIMARY INDEX ON COMMIT PRESERVE ROWS;'; 
   END IF;
   EXECUTE IMMEDIATE SQLSTR;
END SP;