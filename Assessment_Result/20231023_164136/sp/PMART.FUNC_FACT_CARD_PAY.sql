REPLACE PROCEDURE PMART.FUNC_FACT_CARD_PAY
(
   IN P_GROUP VARCHAR(500),
   IN P_TIMEID VARCHAR(2000),
   IN P_ORGID VARCHAR(2000),
   IN P_CARDTYPE VARCHAR(500),
   IN P_TIMERANGE VARCHAR(2000),
   IN P_FGTRANTYPE VARCHAR(10),
   IN P_FGPAYRANGE VARCHAR(100)
)
SP:BEGIN
   DECLARE SQLSTR  VARCHAR(2000);    
CALL PMART.P_DROP_TABLE ('#VT_FACT_CARD_PAY');
SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FACT_CARD_PAY AS('
                          +' SELECT '
                          + CASE WHEN P_GROUP LIKE '%RESPON_ID%' THEN Replace(P_GROUP,'RESPON_ID','RESPON_ID AS ORG_ID') ELSE P_GROUP END +',SUM(PAY_AMT) PAY_AMT,SUM(PAY_CNT) PAY_CNT'
                          + ' FROM PMART.FACT_CARD_PAY'
        + CASE WHEN P_GROUP LIKE '%RESPON_ID%'  THEN  ' JOIN PMART.ORG_STORE ON ORG_ID=OSTORE_ID ' ELSE '' END
                          + ' WHERE ' 
                          + CASE WHEN TRIM(P_ORGID)='' AND POSITION('ORG_ID' IN P_GROUP)=0 THEN 'ORG_ID=-1 ' WHEN TRIM(P_ORGID)='' THEN '1=1'  ELSE 'ORG_ID IN('+P_ORGID+') ' END
                          + ' AND TIME_ID IN ('+P_TIMEID+')' 
                          + CASE WHEN TRIM(P_CARDTYPE)='' AND POSITION('CARD_TYPE' IN P_GROUP)=0 THEN ' AND CARD_TYPE=-1 ' WHEN TRIM(P_CARDTYPE)='' THEN ''  ELSE ' AND CARD_TYPE IN('+P_CARDTYPE+') ' END
                          + CASE WHEN TRIM(P_TIMERANGE)='' AND POSITION('TIME_RANGE' IN P_GROUP)=0 THEN '  AND TIME_RANGE=-1 ' WHEN TRIM(P_TIMERANGE)='' THEN ''  ELSE ' AND TIME_RANGE IN('+P_TIMERANGE+') ' END
                          + CASE WHEN TRIM(P_FGTRANTYPE)='' THEN ''  ELSE ' AND FG_TRAN_TYPE IN('+P_FGTRANTYPE+') ' END
                          + CASE WHEN TRIM(P_FGPAYRANGE)='' THEN ''  ELSE ' AND FG_PAY_RANGE IN('+P_FGPAYRANGE+') ' END
                          + ' GROUP BY '+  P_GROUP                     
                          + ' ) WITH DATA PRIMARY CHARINDEX('RESPON_ID','+CASE WHEN P_GROUP LIKE '%RESPON_ID%' THEN Replace(P_GROUP,'ORG_ID') ELSE P_GROUP END+') ON COMMIT PRESERVE ROWS;';
        EXECUTE IMMEDIATE SQLSTR;   
END SP;