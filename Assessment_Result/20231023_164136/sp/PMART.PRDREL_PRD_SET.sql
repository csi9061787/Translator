REPLACE  PROCEDURE PMART.PRDREL_PRD_SET
(
)
SP:BEGIN
	DECLARE SQLSTR  VARCHAR(32000);
	DECLARE SQLCREATE  VARCHAR(30000);
	DECLARE P_JOB_ID  VARCHAR(20000);
    DECLARE P_PRD_TYPE  VARCHAR(20000);
	DECLARE PRDWHERE  VARCHAR(20000);
	DECLARE SQLDEL  VARCHAR(20000);
	SET P_JOB_ID = (SELECT JOB_ID FROM PTEMP.PRDREL_SET);	
    SET P_PRD_TYPE = (SELECT PRD_TYPE FROM PTEMP.PRDREL_SET) ;
 	CALL PMART.P_DROP_TABLE ('#VT_PRDREL_PRD_SET');
SET SQLSTR = ' 
SELECT * FROM PTEMP.PS_TRANS_PRODUCT_DETAIL
';
IF (P_PRD_TYPE)  = 1
THEN
SET PRDWHERE = '
WHERE  
CD_FMCODE IN 
		(SELECT P.PRD_ID 
		FROM
		(
		SELECT * FROM PDATA.PRDREL_PRD_SET 
		WHERE JOB_ID = '+  P_JOB_ID +'
		AND SET_TYPE=1
		) PS
			LEFT JOIN PMART.PRD_DIM P
			ON 
			(
				CASE PRD_LVL
				WHEN 1 THEN  P.KND_ID
				WHEN 2 THEN  P.GRP_ID
				WHEN 3 THEN  P.PRD_ID
				END
			)=PS.PRD_ID
		)
AND CD_FMCODE NOT IN 
		(
			SELECT P.PRD_ID FROM 
							(
								SELECT * FROM PDATA.PRDREL_PRD_SET 
								WHERE JOB_ID = '+  P_JOB_ID +'
								AND SET_TYPE=2
							) PS
			LEFT JOIN PMART.PRD_DIM P
			ON 
			(
				CASE PRD_LVL
				WHEN 1 THEN  P.KND_ID
				WHEN 2 THEN  P.GRP_ID
				WHEN 3 THEN  P.PRD_ID
				END
			)=PS.PRD_ID
		)
'
; 
ELSEIF P_PRD_TYPE = 2
THEN
SET PRDWHERE = '
WHERE  
CD_FMCODE IN 
		(SELECT P.PRD_ID 
		FROM
		(
		SELECT * FROM PDATA.PRDREL_PRD_SET 
		WHERE JOB_ID = '+  P_JOB_ID +'
		AND SET_TYPE=1
		) PS
			LEFT JOIN PMART.PRD_LINK_DIM P
			ON 
			(
				CASE PRD_LVL
				WHEN 1 THEN  P.LINK_KND_ID
				WHEN 2  THEN  P.PRD_ID
				END
			)=PS.PRD_ID
		)
AND CD_FMCODE NOT IN 
		(
			SELECT P.PRD_ID FROM 
							(
								SELECT * FROM PDATA.PRDREL_PRD_SET 
								WHERE JOB_ID = '+  P_JOB_ID +'
								AND SET_TYPE=2
							) PS
			LEFT JOIN PMART.PRD_LINK_DIM P
			ON 
			(
				CASE PRD_LVL
				WHEN 1 THEN  P.LINK_KND_ID
				WHEN 2  THEN  P.PRD_ID
				END
			)=PS.PRD_ID
		)
'
; 
END IF ;
   SET SQLCREATE = 
   'CREATE MULTISET VOLATILE TABLE #VT_PRDREL_PRD_SET AS( '
   +SQLSTR + PRDWHERE
   +'	) WITH DATA PRIMARY INDEX(TX_SEQ) ON COMMIT PRESERVE ROWS;'
   ;
EXECUTE IMMEDIATE SQLCREATE;   
END SP;