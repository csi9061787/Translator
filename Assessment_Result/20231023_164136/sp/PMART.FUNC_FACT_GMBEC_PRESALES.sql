REPLACE PROCEDURE PMART.FUNC_FACT_GMBEC_PRESALES
(
   IN P_TIMEID VARCHAR(500),   
   IN P_TIMETYPE VARCHAR(1),   
   IN P_YTYPE VARCHAR(1),         
   IN P_ORGTYPE INTEGER,          
   IN P_ORGID INTEGER,               
   IN P_PRDTYPE INTEGER,           
   IN P_PRDID VARCHAR(10),       
   IN P_MMATYPE INTEGER,          
   IN P_MMAID VARCHAR(3)         
)
SP:
BEGIN
   DECLARE SQLSTR  VARCHAR(20000);
   DECLARE ORGWHERE_1 VARCHAR(500);
   DECLARE ORGWHERE_2 VARCHAR(500);
   DECLARE ORG_COL_1 VARCHAR(20);
   DECLARE ORG_COL_2 VARCHAR(20);
   DECLARE TIMEWHERE VARCHAR(500);
   DECLARE PRDWHERE_1 VARCHAR(500);
   DECLARE PRDWHERE_2 VARCHAR(500);
   DECLARE PRD_COL_1 VARCHAR(20);
   DECLARE PRD_COL_2 VARCHAR(20);
   DECLARE SELECTABLE VARCHAR(100);
   DECLARE Y_COL VARCHAR(20);
    CALL PMART.P_DROP_TABLE ('#VT_FACT_GMBEC_PRESALES');
       SET SQLSTR = 'CREATE MULTISET VOLATILE TABLE #VT_FACT_GMBEC_PRESALES,NO FALLBACK,NO JOURNAL,NO LOG ( '
	                     ||'DATA_TYPE  INTEGER, '
						 ||'TIME_ID  INTEGER, '
						 ||'Y_DIM  VARCHAR(50) CHARACTER SET UNICODE, '
					     ||' PRESALES_CNT INTEGER, '
					     ||' PRESALES_AMT INTEGER, '
					     ||' SALES_AMT INTEGER, '
					     ||' PRESALES_ATV DECIMAL(10,2), '
					     ||' UPLOAD_STNUM INTEGER '			 
	                     ||')  PRIMARY INDEX(DATA_TYPE,TIME_ID,Y_DIM) ON COMMIT PRESERVE ROWS; ';
	EXECUTE IMMEDIATE SQLSTR;   
IF P_YTYPE = 'O'
   THEN 
   	IF P_ORGTYPE = 0  THEN
		SET ORG_COL_1 = ' PDEPT_ID ' ;
		SET ORG_COL_2 = ' DEPT_ID ';
	ELSEIF P_ORGTYPE = 1 THEN
		SET ORG_COL_1 = ' DEPT_ID ' ;
		SET ORG_COL_2 = ' BRANCH_ID ';
	ELSEIF P_ORGTYPE = 2 THEN
		SET ORG_COL_1 = ' BRANCH_ID ' ;
		SET ORG_COL_2 = ' RESPON_ID ';
	ELSEIF P_ORGTYPE = 3 THEN
		SET ORG_COL_1 = ' RESPON_ID ' ;
		SET ORG_COL_2 = ' OSTORE_ID ';
	ELSEIF P_ORGTYPE = 4 THEN
		SET ORG_COL_1 = ' OSTORE_ID ' ;
		SET ORG_COL_2 = ' OSTORE_ID ';
	ELSEIF P_ORGTYPE = -1 THEN
		SET ORG_COL_1 = ' TOT_ID ' ;
		SET ORG_COL_2 = ' PDEPT_ID ';
	END IF; 
	IF P_PRDTYPE = 1  THEN
		SET PRD_COL_1 = ' KND_ID ' ;
		SET PRD_COL_2 = ' KND_ID ';
	ELSEIF P_PRDTYPE = 2 THEN
		SET PRD_COL_1 = ' GRP_ID ' ;
		SET PRD_COL_2 = ' GRP_ID ';
	ELSEIF P_PRDTYPE = 3 THEN
		SET PRD_COL_1 = ' PRD_ID ' ;
		SET PRD_COL_2 = ' PRD_ID ';
	ELSEIF P_PRDTYPE = -1 THEN
		SET PRD_COL_1 = ' TOT_ID ' ;
		SET PRD_COL_2 = ' TOT_ID ';
	END IF; 
	SET Y_COL = ' TO_CHAR(ORG_ID) ';
	SET SELECTABLE = ' PMART.FACT_GMBEC_PRESALE_ORG ';
    SET PRDWHERE_1 = 'AND PRD_ID IN (SELECT DISTINCT '||PRD_COL_1 ||' FROM PMART.PRD_DIM WHERE '||PRD_COL_1||' = '''|| P_MMAID || ''') ';
    SET PRDWHERE_2 = 'AND PRD_ID IN (SELECT DISTINCT '||PRD_COL_2 ||' FROM PMART.PRD_DIM WHERE '||PRD_COL_1||' = '''|| P_MMAID || ''')' ;	
ELSEIF 	P_YTYPE = 'P'
THEN 
   	IF P_ORGTYPE = 0  THEN
		SET ORG_COL_1 = ' PDEPT_ID ' ;
		SET ORG_COL_2 = ' PDEPT_ID ';
	ELSEIF P_ORGTYPE = 1 THEN
		SET ORG_COL_1 = ' DEPT_ID ' ;
		SET ORG_COL_2 = ' DEPT_ID ';
	ELSEIF P_ORGTYPE = 2 THEN
		SET ORG_COL_1 = ' BRANCH_ID ' ;
		SET ORG_COL_2 = ' BRANCH_ID ';
	ELSEIF P_ORGTYPE = 3 THEN
		SET ORG_COL_1 = ' RESPON_ID ' ;
		SET ORG_COL_2 = ' RESPON_ID ';
	ELSEIF P_ORGTYPE = 4 THEN
		SET ORG_COL_1 = ' OSTORE_ID ' ;
		SET ORG_COL_2 = ' OSTORE_ID ';
	ELSEIF P_ORGTYPE = -1 THEN
		SET ORG_COL_1 = ' TOT_ID ' ;
		SET ORG_COL_2 = ' TOT_ID ';
	END IF; 
	IF P_PRDTYPE = 1  THEN
		SET PRD_COL_1 = ' KND_ID ' ;
		SET PRD_COL_2 = ' GRP_ID ';
	ELSEIF P_PRDTYPE = 2 THEN
		SET PRD_COL_1 = ' GRP_ID ' ;
		SET PRD_COL_2 = ' PRD_ID ';
	ELSEIF P_PRDTYPE = 3 THEN
		SET PRD_COL_1 = ' PRD_ID ' ;
		SET PRD_COL_2 = ' PRD_ID ';
	ELSEIF P_PRDTYPE = -1 THEN
		SET PRD_COL_1 = ' TOT_ID ' ;
		SET PRD_COL_2 = ' KND_ID ';
	END IF; 
	SET Y_COL = ' PRD_ID ';
	SET SELECTABLE = ' PMART.FACT_GMBEC_PRESALE_ORG ';
   SET PRDWHERE_1 = 'AND PRD_ID IN (SELECT DISTINCT '||PRD_COL_1 ||' FROM PMART.PRD_DIM WHERE '||PRD_COL_1||' = '''|| P_PRDID || ''') ';
   SET PRDWHERE_2 = 'AND PRD_ID IN (SELECT DISTINCT '||PRD_COL_2 ||' FROM PMART.PRD_DIM WHERE '||PRD_COL_1||' = '''|| P_PRDID || ''')' ;
	ELSEIF 	P_YTYPE = 'M'
THEN 
   	IF P_ORGTYPE = 0  THEN
		SET ORG_COL_1 = ' PDEPT_ID ' ;
		SET ORG_COL_2 = ' PDEPT_ID ';
	ELSEIF P_ORGTYPE = 1 THEN
		SET ORG_COL_1 = ' DEPT_ID ' ;
		SET ORG_COL_2 = ' DEPT_ID ';
	ELSEIF P_ORGTYPE = 2 THEN
		SET ORG_COL_1 = ' BRANCH_ID ' ;
		SET ORG_COL_2 = ' BRANCH_ID ';
	ELSEIF P_ORGTYPE = 3 THEN
		SET ORG_COL_1 = ' RESPON_ID ' ;
		SET ORG_COL_2 = ' RESPON_ID ';
	ELSEIF P_ORGTYPE = 4 THEN
		SET ORG_COL_1 = ' OSTORE_ID ' ;
		SET ORG_COL_2 = ' OSTORE_ID ';
	ELSEIF P_ORGTYPE = -1 THEN
		SET ORG_COL_1 = ' TOT_ID ' ;
		SET ORG_COL_2 = ' TOT_ID ';
	END IF; 
	IF P_MMATYPE = 1  THEN
		SET PRD_COL_1 = ' DISTRICT_CODE ' ;
		SET PRD_COL_2 = ' ZONE_CODE ';
	ELSEIF P_MMATYPE = 2 THEN
		SET PRD_COL_1 = ' ZONE_CODE ' ;
		SET PRD_COL_2 = ' ZONE_CODE ';
	ELSEIF P_MMATYPE = -1 THEN
		SET PRD_COL_1 = ' ''-1'' ' ;
		SET PRD_COL_2 = ' DISTRICT_CODE ';
	END IF; 
	SET Y_COL = ' MMA_ID ';
	SET SELECTABLE = ' PMART.FACT_GMBEC_PRESALE_SHOP ';
   SET PRDWHERE_1 = 'AND MMA_ID IN (SELECT DISTINCT '||PRD_COL_1 ||' FROM PDATA.STORE_SHOP WHERE '||PRD_COL_1||' = '''|| P_MMAID || ''') ';
   SET PRDWHERE_2 = 'AND MMA_ID IN (SELECT DISTINCT '||PRD_COL_2 ||' FROM PDATA.STORE_SHOP WHERE '||PRD_COL_1||' = '''|| P_MMAID || ''')' ;
END IF;	
   SET ORGWHERE_1 = 'AND ORG_ID IN (SELECT DISTINCT '||ORG_COL_1||' FROM PMART.LATEST_ORG_DIM WHERE '||ORG_COL_1||' = ' || P_ORGID  ||') ';
   SET ORGWHERE_2 = 'AND ORG_ID IN (SELECT DISTINCT '||ORG_COL_2||' FROM PMART.LATEST_ORG_DIM WHERE '||ORG_COL_1||' = ' || P_ORGID  ||') ';
   SET TIMEWHERE = 'AND TIME_ID IN (' || P_TIMEID || ')'; 
   SET SQLSTR = 'INSERT INTO #VT_FACT_GMBEC_PRESALES(DATA_TYPE,TIME_ID,Y_DIM,PRESALES_CNT,PRESALES_AMT,SALES_AMT,PRESALES_ATV, '
                       || '  UPLOAD_STNUM )';
   SET SQLSTR =SQLSTR 
					||'SELECT '
					||'CASE WHEN (TIME_ID<>-1 AND YDIM_ID<>CAST(-1 AS VARCHAR(2)))  THEN 4    '
					||'WHEN (TIME_ID=-1 AND YDIM_ID<>CAST(-1 AS VARCHAR(2)))  THEN 2    '
					||'WHEN (TIME_ID<>-1 AND YDIM_ID=CAST(-1 AS VARCHAR(2)))  THEN 3 	'	
					||'ELSE  1 END  AS DATA_TYPE ,  '
					||'A.*  '
					||'FROM ' 
					||'(SELECT '
					||'CAST(-1 AS INTEGER)  AS TIME_ID ,YDIM_ID  , '
					||'SUM(PRESALES_CNT) AS PRESALES_CNT, '
					||'SUM(PRESALES_AMT) AS PRESALES_AMT, '
					||'SUM(SALES_AMT) AS SALES_AMT, '
					||'CASE WHEN SUM(TRANS_CNT) = 0 THEN 0 ELSE SUM(SALES_AMT) / SUM(TRANS_CNT) END  PRESALES_ATV, '
					||'SUM(UPLOAD_STNUM)  AS UPLOAD_STNUM '
					||'FROM '
					||'( SELECT DISTINCT * FROM ('
					||'SELECT TIME_ID ,'||Y_COL||' AS YDIM_ID ,PRESALES_CNT ,PRESALES_AMT,SALES_AMT,TRANS_CNT,UPLOAD_STNUM ' 
					||'FROM ' || SELECTABLE
					||'WHERE 1=1 '
					||TIMEWHERE
					||ORGWHERE_1
					||PRDWHERE_1
					||'UNION ALL '
					||'SELECT TIME_ID ,'||Y_COL||' AS YDIM_ID ,PRESALES_CNT ,PRESALES_AMT,SALES_AMT,TRANS_CNT,UPLOAD_STNUM '
					||'FROM ' || SELECTABLE
					||'WHERE 1=1 '
					||TIMEWHERE
					||ORGWHERE_2
					||PRDWHERE_2
					||')F)A '
					||'GROUP BY YDIM_ID '
					||'UNION ALL '
					||'SELECT DISTINCT * FROM '
					||'( '
					||'SELECT TIME_ID ,'||Y_COL||' AS YDIM_ID  ,PRESALES_CNT ,PRESALES_AMT,SALES_AMT, '
					||'CASE WHEN TRANS_CNT=0 THEN 0 ELSE SALES_AMT/TRANS_CNT END PRESALES_ATV, '
					||'UPLOAD_STNUM '
					||'FROM  ' || SELECTABLE
					||'WHERE 1=1 '
					||TIMEWHERE
					||ORGWHERE_1
					||PRDWHERE_1
					||'UNION ALL '
					||'SELECT TIME_ID ,'||Y_COL||' AS YDIM_ID  ,PRESALES_CNT ,PRESALES_AMT,SALES_AMT, '
					||'CASE WHEN TRANS_CNT=0 THEN 0 ELSE SALES_AMT/TRANS_CNT END PRESALES_ATV, '
					||'UPLOAD_STNUM '
					||'FROM  ' || SELECTABLE
					||'WHERE 1=1 '
					||TIMEWHERE
					||ORGWHERE_2
					||PRDWHERE_2
					||') B )A'
					|| ' ;'
					;
    DELETE FROM PMART.T1 WHERE F1 = 999;
	INSERT INTO PMART.T1(F1,F2) SELECT 999,SQLSTR;	
	EXECUTE IMMEDIATE SQLSTR;  
END SP;