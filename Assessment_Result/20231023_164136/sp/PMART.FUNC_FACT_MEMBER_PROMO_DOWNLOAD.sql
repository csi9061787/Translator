REPLACE PROCEDURE PMART.FUNC_FACT_MEMBER_PROMO_DOWNLOAD
(
   IN P_RPTID SMALLINT,
   IN P_TIMEID VARCHAR(1000),
   IN P_TIMETYPE VARCHAR(1),   
   IN P_ORGTYPE SMALLINT,
   IN P_ORGID VARCHAR(20),
   IN P_PRDTYPE SMALLINT,
   IN P_PRDID VARCHAR(20),
   IN P_POMOID VARCHAR(20),
   IN P_ACTID VARCHAR(20),
   IN P_MSG VARCHAR(100) CHARACTER SET UNICODE,
   IN P_PRDNM VARCHAR(50) CHARACTER SET UNICODE
)
SP:BEGIN
	DECLARE SQLSTR  VARCHAR(10000) ;
	DECLARE ORGWHERE VARCHAR(2000);
	DECLARE TIMENAME  VARCHAR(100);
    DECLARE TIMEWHERE  VARCHAR(2000); 
	DECLARE PRDWHERE  VARCHAR(1000) ;
	DECLARE BASETABLE VARCHAR(50);
	DECLARE POMOWHERE VARCHAR(1000) ;
	DECLARE JOINTYPE VARCHAR(50);
	DECLARE JTIMEWHERE  VARCHAR(2000); 
	DECLARE STR VARCHAR(50) ;
	SET ORGWHERE = ' WHERE 1=1 ';  
	SET PRDWHERE = ' ';
	SET BASETABLE = ' PMART.FACT_MEMBER_PROMO ';
	SET POMOWHERE = ' ';
	SET STR = ''''+'全商品'+'''';
	IF P_PRDTYPE = 1 THEN
		SET PRDWHERE = ' AND T4.KND_ID = '''  + P_PRDID + ''' ';
		IF TRIM(P_PRDNM) <> '' THEN
			SET PRDWHERE = PRDWHERE + 'AND GRP_NM LIKE ''%'+TRIM(P_PRDNM)+'%''';
		END IF;
	ELSEIF P_PRDTYPE = 2 THEN
		SET PRDWHERE = ' AND T4.GRP_ID = '''  + P_PRDID + ''' ';
		IF TRIM(P_PRDNM) <> '' THEN
			SET PRDWHERE = PRDWHERE + 'AND PRD_NM LIKE ''%'+TRIM(P_PRDNM)+'%''';
		END IF;
	ELSEIF P_PRDTYPE = 3 THEN
		SET PRDWHERE = ' AND T4.PRD_ID = '''  + P_PRDID + ''' ';
		IF TRIM(P_PRDNM) <> '' THEN
			SET PRDWHERE = PRDWHERE + 'AND PRD_NM LIKE ''%'+TRIM(P_PRDNM)+'%''';
		END IF;
	ELSE
		SET PRDWHERE = ' ';
		IF TRIM(P_PRDNM) <> '' THEN
			SET PRDWHERE = PRDWHERE + 'AND KND_NM LIKE ''%'+TRIM(P_PRDNM)+'%''';
		END IF;
	END IF;
	IF P_ORGTYPE = 0 THEN
		SET ORGWHERE = ORGWHERE + ' AND S.PDEPT_ID  = ' + TRIM(P_ORGID); 
	ELSEIF P_ORGTYPE = 1 THEN
		SET ORGWHERE = ORGWHERE + ' AND S.DEPT_ID  = ' + TRIM(P_ORGID); 
	ELSEIF P_ORGTYPE = 2 THEN
		SET ORGWHERE = ORGWHERE + ' AND S.BRANCH_ID = ' + TRIM(P_ORGID);
	ELSEIF P_ORGTYPE = 3 THEN
		SET ORGWHERE = ORGWHERE + ' AND S.RESPON_ID = ' + TRIM(P_ORGID);
	ELSEIF P_ORGTYPE = 4 THEN
		SET ORGWHERE = ORGWHERE + ' AND S.OSTORE_ID = ' + TRIM(P_ORGID);
	END IF;   
	IF P_TIMETYPE = 'M' THEN
		SET TIMENAME = 'T3.L_MONTH_NAME ';
		SET TIMEWHERE = ' INNER JOIN PMART.YMWD_TIME_W2 T3 ON B.TIME_ID = T3.L_MONTH_ID ';
		SET JTIMEWHERE = ' AND T.L_MONTH_ID IN ('+P_TIMEID+')';
	ELSEIF P_TIMETYPE = 'W' THEN
		SET TIMENAME = 'T3.L_WEEK_NAME ';
		SET TIMEWHERE = ' INNER JOIN PMART.YMWD_TIME_W2 T3 ON B.TIME_ID = T3.L_WEEK_ID ';
		SET JTIMEWHERE = ' AND T.L_WEEK_ID IN ('+P_TIMEID+')';
	ELSE
		SET TIMENAME = 'T3.L_DAY_NAME ';
		SET TIMEWHERE = ' INNER JOIN PMART.YMWD_TIME_W2 T3 ON B.TIME_ID = T3.L_DAY_ID ';
		SET JTIMEWHERE = ' AND T.L_DAY_ID IN ('+P_TIMEID+')';
	END IF;	
	IF P_POMOID <> '-1' THEN
		SET POMOWHERE = POMOWHERE + ' AND P1.POMOYM = SUBSTRING('''+ TRIM(P_POMOID)+''',1,6) ';
	END IF;
	IF P_ACTID <> '-1' THEN
		SET POMOWHERE = POMOWHERE + ' AND P1.POMOID = '+ TRIM(P_ACTID);
	END IF;
	IF P_MSG <> '' THEN
		SET POMOWHERE = POMOWHERE + ' AND P0.MM_MSG LIKE ''%'+TRIM(P_MSG)+'%''';
	END IF;
	IF TRIM(POMOWHERE) = '' THEN
		SET JOINTYPE = ' LEFT JOIN ';
	ELSE
		SET JOINTYPE = ' INNER JOIN ';
	END IF;
    CALL PMART.P_DROP_TABLE ('#VT_FACT_PROMO_DOWNLOAD');
	SET SQLSTR = ' CREATE MULTISET VOLATILE TABLE #VT_FACT_PROMO_DOWNLOAD AS('	
	   					 +' SELECT DAT.PROMO_ID ,DAT.PROMO_ACT ,DAT.MM_MSG ,DAT.PRD_NM '
						 +' ,DAT.PDEPT_NO ,DAT.PDEPT_SNAME ,DAT.DEPT_NO ,DAT.DEPT_SNAME ,DAT.BRANCH_NO ,DAT.BRANCH_SNAME ,DAT.STORE_NO ,DAT.STORE_NAME '
						 +' ,DAT.TIME_ID ,DAT.ALL_NUM ,DAT.ALL_CNT ,DAT.ALL_AMT ,DAT.ALL_ACTNUM ,DAT.ALL_ACTCNT ,DAT.ALL_ACTAMT '
						 +' ,DAT.MEMBER_NUM ,DAT.MEMBER_CNT ,DAT.MEMBER_AMT ,DAT.MEMBER_PCNT '
						 +' ,DAT.MEMBER_ACTNUM ,DAT.MEMBER_ACTCNT ,DAT.MEMBER_ACTAMT ,DAT.MEMBER_ACTPCNT '
	   					 +' FROM ( '
						 +'        SELECT DISTINCT CASE WHEN T5.POMOID IS NULL THEN '+STR+' ELSE T5.POMOID END AS PROMO_ID '
						 +'        ,CASE WHEN T5.POMONM IS NULL THEN '+STR+' ELSE T5.POMONM END AS PROMO_ACT '
						 +'        ,CASE WHEN T5.MM_MSG IS NULL THEN '+STR+' ELSE T5.MM_MSG END AS MM_MSG , '+TIMENAME+' AS TIME_ID '
						 +'        ,B.ALL_NUM ,B.ALL_CNT ,B.ALL_AMT ,B.ALL_ACTNUM ,B.ALL_ACTCNT ,B.ALL_ACTAMT '
						 +'        ,B.MEMBER_NUM ,B.MEMBER_CNT ,B.MEMBER_AMT ,B.MEMBER_PCNT '
						 +'        ,B.MEMBER_ACTNUM ,B.MEMBER_ACTCNT ,B.MEMBER_ACTAMT ,B.MEMBER_ACTPCNT '
						 +'        ,T1.* ,T4.PRD_NO+'' ''+T4.PRD_NM AS PRD_NM '
						 +'        FROM '+BASETABLE+' B ' 
						 +'        INNER JOIN ( '
						 +'          SELECT PDEPT.PDEPT_NO ,PDEPT.PDEPT_SNAME ,DEPT.DEPT_NO ,DEPT.DEPT_SNAME '
						 +'          ,BRANCH.BRANCH_NO ,BRANCH.BRANCH_SNAME ,S.OSTORE_ID ,S.STORE_ID ,S.STORE_NO ,S.STORE_NAME '
						 +'          ,SHOP.SHOPDIST_NAME AS SHOP_DISTTRICT_NM '
						 +'          ,S.SHOP_DISTTRICT_MAIN AS SHOP_DISTTRICT '
						 +'          FROM PMART.LAST_ORG_STORE S '
						 +'          LEFT JOIN PMART.VW_SHOPDIST_DIM SHOP ON S.SHOP_DISTTRICT_MAIN = SHOP.SHOPDIST_ID '
						 +'          LEFT JOIN PMART.ORG_PDEPT PDEPT ON S.PDEPT_ID = PDEPT.PDEPT_ID '
						 +'          LEFT JOIN PMART.ORG_DEPT DEPT ON S.DEPT_ID = DEPT.DEPT_ID '
						 +'          LEFT JOIN PMART.ORG_BRANCH BRANCH ON S.BRANCH_ID = BRANCH.BRANCH_ID '+ ORGWHERE
						 +'         ) T1 ON B.ORG_ID = T1.OSTORE_ID '
						 +'        INNER JOIN PMART.PRD_DIM T4 ON B.PRD_ID = T4.PRD_ID '+PRDWHERE
						 +'        '+JOINTYPE+' (SELECT DISTINCT P0.POMOID,P0.POMONM,P0.MM_MSG,P1.CMNO AS PRD_ID '
						 +'          FROM PDATA.PROMO P0 '
						 +'          JOIN PDATA.PROMO_PRODUCT P1 ON P0.POMOYM = P1.POMOYM AND P0.POMOID = P1.POMOID '
						 +'          JOIN PMART.YMWD_TIME_W2 T '
						 +'          ON T.L_DAY_ID >= P0.BDAY_ID AND T.L_DAY_ID <= P0.EDAY_ID'+JTIMEWHERE +POMOWHERE
						 +'         ) T5 ON T5.PRD_ID = T4.PRD_ID AND B.PROMO_ID = T5.POMOID '+TIMEWHERE
						 +' WHERE B.TIME_ID IN ('+P_TIMEID+')'
						 +'         ) DAT '
			             + ' ) WITH DATA PRIMARY  CHARINDEX(STORE_NO,TIME_ID) ON COMMIT PRESERVE ROWS;';						  					
        EXECUTE IMMEDIATE SQLSTR;   
END SP;